MWF.xApplication=MWF.xApplication||{};MWF.xApplication.process=MWF.xApplication.process||{};MWF.xApplication.process.ViewDesigner=MWF.xApplication.process.ViewDesigner||{};MWF.APPVD=MWF.xApplication.process.ViewDesigner;MWF.require("MWF.widget.Common",null,false);MWF.require("MWF.xScript.Macro",null,false);MWF.xDesktop.requireApp("process.ViewDesigner","lp."+MWF.language,null,false);MWF.xDesktop.requireApp("process.ViewDesigner","Property",null,false);MWF.xApplication.process.ViewDesigner.View=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",isView:false,showTab:true,propertyPath:"/x_component_process_ViewDesigner/$View/view.html"},initialize:function(e,t,i){this.setOptions(i);this.path="/x_component_process_ViewDesigner/$View/";this.cssPath="/x_component_process_ViewDesigner/$View/"+this.options.style+"/css.wcss";this._loadCss();this.designer=e;this.data=t;if(!this.data.data)this.data.data={};this.parseData();this.node=this.designer.designNode;this.areaNode=new Element("div",{styles:{height:"100%",overflow:"auto"}});this.propertyListNode=this.designer.propertyDomArea;if(this.designer.application)this.data.applicationName=this.designer.application.name;if(this.designer.application)this.data.application=this.designer.application.id;this.isNewView=this.data.id?false:true;this.items=[];this.view=this;this.autoSave();this.designer.addEvent("queryClose",function(){if(this.autoSaveTimerID)window.clearInterval(this.autoSaveTimerID)}.bind(this))},autoSave:function(){this.autoSaveTimerID=window.setInterval(function(){if(!this.autoSaveCheckNode)this.autoSaveCheckNode=this.designer.contentToolbarNode.getElement("#MWFDictionaryAutoSaveCheck");if(this.autoSaveCheckNode){if(this.autoSaveCheckNode.get("checked")){this.save()}}}.bind(this),6e4)},parseData:function(){this.json=this.data},showProperty:function(){if(!this.property){this.property=new MWF.xApplication.process.ViewDesigner.Property(this,this.designer.propertyContentArea,this.designer,{path:this.options.propertyPath,onPostLoad:function(){this.property.show()}.bind(this)});this.property.load()}else{this.property.show()}},hideProperty:function(){if(this.property)this.property.hide()},load:function(){this.setAreaNodeSize();this.designer.addEvent("resize",this.setAreaNodeSize.bind(this));this.areaNode.inject(this.node);this.designer.viewListAreaNode.getChildren().each(function(e){var t=e.retrieve("view");if(t.id==this.data.id){if(this.designer.currentListViewItem){this.designer.currentListViewItem.setStyles(this.designer.css.listViewItem)}e.setStyles(this.designer.css.listViewItem_current);this.designer.currentListViewItem=e;this.lisNode=e}}.bind(this));this.domListNode=new Element("div",{styles:{overflow:"hidden"}}).inject(this.designer.propertyDomArea);this.loadView();this.selected();this.setEvent();this.setViewWidth();this.designer.addEvent("resize",this.setViewWidth.bind(this))},setEvent:function(){this.areaNode.addEvent("click",this.selected.bind(this));this.refreshNode.addEvent("click",function(e){this.loadViewData();e.stopPropagation()}.bind(this));this.addColumnNode.addEvent("click",function(e){this.addColumn();e.stopPropagation()}.bind(this))},loadViewData:function(){if(this.data.id){this.saveSilence(function(){this.viewContentBodyNode.empty();this.viewContentTableNode=new Element("table",{styles:this.css.viewContentTableNode,border:"0px",cellPadding:"0",cellSpacing:"0"}).inject(this.viewContentBodyNode);this.designer.actions.loadView(this.data.id,function(e){var t={};e.data.selectEntryList.each(function(e){t[e.column]=e}.bind(this));if(this.json.data.groupEntry.column){if(e.data.groupGrid.length){var i=null;for(var s=0;s<e.data.selectEntryList.length;s++){if(e.data.selectEntryList[s].column===e.data.groupEntry.column){i=e.data.selectEntryList[s];break}}e.data.groupGrid.each(function(s,n){var o=new Element("tr",{styles:this.css.viewContentTrNode}).inject(this.viewContentTableNode);var d=this.items.length;var a=new Element("td",{styles:this.css.viewContentGroupTdNode,colSpan:d}).inject(o);var h=new Element("div",{styles:this.css.viewContentTdGroupNode}).inject(a);var r=new Element("div",{styles:this.css.viewContentTdGroupIconNode}).inject(h);var l=new Element("div",{styles:this.css.viewContentTdGroupTextNode}).inject(h);if(i){l.set("text",i.code?MWF.Macro.exec(i.code,{value:s.group,gridData:e.data.groupGrid,data:e.data,entry:s}):s.group)}else{l.set("text",s.group)}var c=[];s.list.each(function(i){var s=new Element("tr",{styles:this.css.viewContentTrNode}).inject(this.viewContentTableNode);s.setStyle("display","none");var n=new Element("td",{styles:this.css.viewContentTdNode}).inject(s);Object.each(i.data,function(n,o){if(o!=this.json.data.groupEntry.column){var d=new Element("td",{styles:this.css.viewContentTdNode}).inject(s);d.set("text",t[o].code?MWF.Macro.exec(t[o].code,{value:n,gridData:e.data.groupGrid,data:e.data,entry:i}):n)}}.bind(this));c.push(s)}.bind(this));h.store("subtrs",c);var v=this;h.addEvent("click",function(){var e=this.retrieve("subtrs");var t=h.getFirst("div");if(e[0]){if(e[0].getStyle("display")=="none"){e.each(function(e){e.setStyle("display","table-row")});t.setStyle("background","url("+"/x_component_process_ViewDesigner/$View/default/icon/down.png) center center no-repeat")}else{e.each(function(e){e.setStyle("display","none")});t.setStyle("background","url("+"/x_component_process_ViewDesigner/$View/default/icon/right.png) center center no-repeat")}}v.setContentHeight()})}.bind(this));this.setContentColumnWidth();this.setContentHeight()}}else{if(e.data.grid.length){e.data.grid.each(function(i,s){var n=new Element("tr",{styles:this.css.viewContentTrNode}).inject(this.viewContentTableNode);Object.each(i.data,function(s,o){var d=new Element("td",{styles:this.css.viewContentTdNode}).inject(n);d.set("text",t[o].code?MWF.Macro.exec(t[o].code,{value:s,gridData:e.data.grid,data:e.data,entry:i}):s)}.bind(this))}.bind(this));this.setContentColumnWidth();this.setContentHeight()}}}.bind(this))}.bind(this))}},setContentColumnWidth:function(){var e=this.viewTitleTrNode.getElements("td");var t=[];e.each(function(e){t.push(e.getSize().x)});var i=false;debugger;if(this.viewContentTableNode){trs=this.viewContentTableNode.getElements("tr");for(var s=0;s<trs.length;s++){var n=trs[s];var o=n.getElements("td");o.each(function(e,s){if(e.get("colSpan")==1){e.setStyle("width",""+t[s]+"px");i=true}});if(i)break}}},addColumn:function(){debugger;MWF.require("MWF.widget.UUID",function(){var e=(new MWF.widget.UUID).id;var t={id:e,column:e,displayName:this.designer.lp.unnamed,selectType:"attribute",orderType:"original"};if(!this.json.data.selectEntryList)this.json.data.selectEntryList=[];this.json.data.selectEntryList.push(t);var i=new MWF.xApplication.process.ViewDesigner.View.Column(t,this);this.items.push(i);i.selected();if(this.viewContentTableNode){var s=this.viewContentTableNode.getElements("tr");s.each(function(e){new Element("td",{styles:this.css.viewContentTdNode}).inject(e)}.bind(this))}this.setViewWidth();this.addColumnNode.scrollIntoView(true)}.bind(this))},selected:function(){if(this.currentSelectedModule){if(this.currentSelectedModule==this){return true}else{this.currentSelectedModule.unSelected()}}this.currentSelectedModule=this;this.showProperty()},unSelected:function(){this.currentSelectedModule=null;this.hideProperty()},loadViewNodes:function(){this.viewAreaNode=new Element("div#viewAreaNode",{styles:this.css.viewAreaNode}).inject(this.areaNode);this.viewTitleNode=new Element("div#viewTitleNode",{styles:this.css.viewTitleNode}).inject(this.viewAreaNode);this.refreshNode=new Element("div",{styles:this.css.refreshNode}).inject(this.viewTitleNode);this.addColumnNode=new Element("div",{styles:this.css.addColumnNode}).inject(this.viewTitleNode);this.viewTitleContentNode=new Element("div",{styles:this.css.viewTitleContentNode}).inject(this.viewTitleNode);this.viewTitleTableNode=new Element("table",{styles:this.css.viewTitleTableNode,border:"0px",cellPadding:"0",cellSpacing:"0"}).inject(this.viewTitleContentNode);this.viewTitleTrNode=new Element("tr",{styles:this.css.viewTitleTrNode}).inject(this.viewTitleTableNode);this.viewContentScrollNode=new Element("div",{styles:this.css.viewContentScrollNode}).inject(this.viewAreaNode);this.viewContentNode=new Element("div",{styles:this.css.viewContentNode}).inject(this.viewContentScrollNode);MWF.require("MWF.widget.ScrollBar",function(){new MWF.widget.ScrollBar(this.viewContentScrollNode,{style:"view",distance:100,indent:false})}.bind(this));this.contentLeftNode=new Element("div",{styles:this.css.contentLeftNode}).inject(this.viewContentNode);this.contentRightNode=new Element("div",{styles:this.css.contentRightNode}).inject(this.viewContentNode);this.viewContentBodyNode=new Element("div",{styles:this.css.viewContentBodyNode}).inject(this.viewContentNode);this.viewContentTableNode=new Element("table",{styles:this.css.viewContentTableNode,border:"0px",cellPadding:"0",cellSpacing:"0"}).inject(this.viewContentBodyNode)},setContentHeight:function(){var e=this.areaNode.getSize();var t=this.viewTitleNode.getSize();var i=e.y-t.y-2;this.viewContentScrollNode.setStyle("height",i);var s=this.viewContentBodyNode.getSize();if(i<s.y)i=s.y+10;this.viewContentNode.setStyle("height",i);this.contentLeftNode.setStyle("height",i);this.contentRightNode.setStyle("height",i)},loadViewColumns:function(){if(this.json.data.selectEntryList){this.json.data.selectEntryList.each(function(e){this.items.push(new MWF.xApplication.process.ViewDesigner.View.Column(e,this))}.bind(this))}},loadView:function(){this.loadViewNodes();this.loadViewColumns()},setViewWidth:function(){this.viewAreaNode.setStyle("width","auto");this.viewTitleNode.setStyle("width","auto");var e=this.viewTitleTableNode.getSize();var t=this.refreshNode.getSize();var i=this.addColumnNode.getSize();var s=e.x+t.x+t.x;var n=this.areaNode.getSize();if(s>n.x){this.viewTitleNode.setStyle("width",""+s+"px");this.viewAreaNode.setStyle("width",""+s+"px")}else{this.viewTitleNode.setStyle("width",""+n.x+"px");this.viewAreaNode.setStyle("width",""+n.x+"px")}this.setContentColumnWidth();this.setContentHeight()},setAreaNodeSize:function(){},createRootItem:function(){this.items.push(new MWF.xApplication.process.DictionaryDesigner.Dictionary.item("ROOT",this.data.data,null,0,this,true))},saveSilence:function(e){if(!this.data.name){this.designer.notice(this.designer.lp.notice.inputName,"error");return false}this.designer.actions.saveView(this.data,function(t){this.data.id=t.data.id;if(this.lisNode){this.lisNode.getLast().set("text",this.data.name+"("+this.data.alias+")")}if(e)e()}.bind(this))},save:function(e){if(!this.data.name){this.designer.notice(this.designer.lp.notice.inputName,"error");return false}this.designer.actions.saveView(this.data,function(t){this.designer.notice(this.designer.lp.notice.save_success,"success",this.node,{x:"left",y:"bottom"});this.data.id=t.data.id;if(this.lisNode){this.lisNode.getLast().set("text",this.data.name+"("+this.data.alias+")")}if(e)e()}.bind(this))},saveAs:function(){},explode:function(){},implode:function(){},_setEditStyle:function(){}});MWF.xApplication.process.ViewDesigner.View.Column=new Class({initialize:function(e,t,i){this.propertyPath="/x_component_process_ViewDesigner/$View/column.html";this.view=t;this.json=e;this.next=i;this.css=this.view.css;this.content=this.view.viewTitleTrNode;this.domListNode=this.view.domListNode;this.load()},load:function(){this.areaNode=new Element("td",{styles:this.css.viewTitleColumnAreaNode});this.areaNode.store("column",this);if(this.next){this.areaNode.inject(this.next.areaNode,"before")}else{this.areaNode.inject(this.content)}this.node=new Element("div",{styles:this.css.viewTitleColumnNode}).inject(this.areaNode);this.textNode=new Element("div",{styles:this.css.viewTitleColumnTextNode,text:this.json.displayName}).inject(this.node);this.listNode=new Element("div",{styles:this.css.cloumnListNode});if(this.next){this.listNode.inject(this.next.listNode,"before")}else{this.listNode.inject(this.domListNode)}var e=new Element("div",{styles:this.css.cloumnListIconNode}).inject(this.listNode);var t=new Element("div",{styles:this.css.cloumnListTextNode}).inject(this.listNode);this.resetTextNode();this._createIconAction();this.setEvent()},setEvent:function(){this.node.addEvents({click:function(e){this.selected();e.stopPropagation()}.bind(this),mouseover:function(){if(!this.isSelected)this.node.setStyles(this.css.viewTitleColumnNode_over)}.bind(this),mouseout:function(){if(!this.isSelected)if(this.isError){this.node.setStyles(this.css.viewTitleColumnNode_error)}else{this.node.setStyles(this.css.viewTitleColumnNode)}}.bind(this)});this.listNode.addEvents({click:function(e){this.selected();e.stopPropagation()}.bind(this),mouseover:function(){if(!this.isSelected)this.listNode.setStyles(this.css.cloumnListNode_over)}.bind(this),mouseout:function(){if(!this.isSelected)this.listNode.setStyles(this.css.cloumnListNode)}.bind(this)})},_createIconAction:function(){if(!this.actionArea){this.actionArea=new Element("div",{styles:this.css.actionAreaNode}).inject(this.view.areaNode,"after");this._createAction({name:"move",icon:"move1.png",event:"mousedown",action:"move",title:MWF.APPVD.LP.action.move});this._createAction({name:"add",icon:"add.png",event:"click",action:"addColumn",title:MWF.APPVD.LP.action.add});this._createAction({name:"delete",icon:"delete1.png",event:"click",action:"delete",title:MWF.APPVD.LP.action["delete"]})}},_createAction:function(e){var t=new Element("div",{styles:this.css.actionNodeStyles,title:e.title}).inject(this.actionArea);t.setStyle("background","url("+this.view.path+this.view.options.style+"/action/"+e.icon+") no-repeat left center");t.addEvent(e.event,function(t){this[e.action](t)}.bind(this));t.addEvents({mouseover:function(e){e.target.setStyle("border","1px solid #999")}.bind(this),mouseout:function(e){e.target.setStyle("border","1px solid #F1F1F1")}.bind(this)})},_setActionAreaPosition:function(){var e=this.node.getPosition(this.view.areaNode.getOffsetParent());var t=e.y-25;var i=e.x;this.actionArea.setPosition({x:i,y:t})},_showActions:function(){if(this.actionArea){this._setActionAreaPosition();this.actionArea.setStyle("display","block")}},_hideActions:function(){if(this.actionArea)this.actionArea.setStyle("display","none")},selected:function(){if(this.view.currentSelectedModule){if(this.view.currentSelectedModule==this){return true}else{this.view.currentSelectedModule.unSelected()}}this.node.setStyles(this.css.viewTitleColumnNode_selected);this.listNode.setStyles(this.css.cloumnListNode_selected);new Fx.Scroll(this.view.areaNode,{wheelStops:false,duration:100}).toElementEdge(this.node);new Fx.Scroll(this.view.designer.propertyDomArea,{wheelStops:false,duration:100}).toElement(this.listNode);this.view.currentSelectedModule=this;this.isSelected=true;this._showActions();this.showProperty()},unSelected:function(){this.view.currentSelectedModule=null;if(this.isError){this.node.setStyles(this.css.viewTitleColumnNode_error)}else{this.node.setStyles(this.css.viewTitleColumnNode)}this.listNode.setStyles(this.css.cloumnListNode);this.isSelected=false;this._hideActions();this.hideProperty()},showProperty:function(){if(!this.property){this.property=new MWF.xApplication.process.ViewDesigner.Property(this,this.view.designer.propertyContentArea,this.view.designer,{path:this.propertyPath,onPostLoad:function(){this.property.show()}.bind(this)});this.property.load()}else{this.property.show()}},hideProperty:function(){if(this.property)this.property.hide()},_setEditStyle:function(e,t,i){if(e=="displayName")this.resetTextNode();if(e=="selectType")this.resetTextNode();if(e=="attribute")this.resetTextNode();if(e=="path")this.resetTextNode();if(e=="column"){this.view.json.data.orderEntryList.each(function(e){if(e.column==i)e.column=this.json.column}.bind(this));if(this.view.json.data.groupEntry.column==i)this.view.json.data.groupEntry.column=this.json.column}},resetTextNode:function(){var e=this.json.selectType=="attribute"?this.json.attribute||"":this.json.path||"";if(!e)e="unnamed";this.textNode.set("text",this.json.displayName);this.listNode.getLast().set("text",this.json.displayName+"("+e+")")},delete:function(e){var t=this;if(!e)e=this.node;this.view.designer.confirm("warn",e,MWF.APPVD.LP.notice.deleteColumnTitle,MWF.APPVD.LP.notice.deleteColumn,300,120,function(){t.destroy();this.close()},function(){this.close()},null)},destroy:function(){if(this.view.currentSelectedModule==this)this.view.currentSelectedModule=null;if(this.actionArea)this.actionArea.destroy();if(this.listNode)this.listNode.destroy();if(this.property)this.property.propertyContent.destroy();var e=this.view.items.indexOf(this);if(this.view.viewContentTableNode){var t=this.view.viewContentTableNode.getElements("tr");t.each(function(t){t.deleteCell(e)}.bind(this))}if(this.view.json.data.selectEntryList)this.view.json.data.selectEntryList.erase(this.json);if(this.view.json.data.calculate.calculateEntryList)this.view.json.data.calculate.calculateEntryList.erase(this.json);this.view.items.erase(this);this.areaNode.destroy();this.view.selected();this.view.setViewWidth();MWF.release(this);delete this},addColumn:function(e,t){MWF.require("MWF.widget.UUID",function(){var e;if(t){e=Object.clone(t);e.id=(new MWF.widget.UUID).id;e.column=(new MWF.widget.UUID).id}else{var i=(new MWF.widget.UUID).id;e={id:i,column:i,displayName:this.view.designer.lp.unnamed,selectType:"attribute",orderType:"original"}}var s=this.view.json.data.selectEntryList.indexOf(this.json);this.view.json.data.selectEntryList.splice(s,0,e);var n=new MWF.xApplication.process.ViewDesigner.View.Column(e,this.view,this);this.view.items.splice(s,0,n);n.selected();if(this.view.viewContentTableNode){var o=this.view.viewContentTableNode.getElements("tr");o.each(function(e){var t=e.insertCell(s);t.setStyles(this.css.viewContentTdNode)}.bind(this))}this.view.setViewWidth()}.bind(this))},move:function(e){var t=[];this.view.items.each(function(e){if(e!=this){t.push(e.areaNode)}}.bind(this));this._createMoveNode();this._setNodeMove(t,e)},_createMoveNode:function(){this.moveNode=new Element("div",{text:this.node.get("text")});this.moveNode.inject(this.view.designer.content);this.moveNode.setStyles({border:"2px dashed #ffa200",opacity:.7,height:"30px","line-height":"30px",padding:"0px 10px",position:"absolute"})},_setMoveNodePosition:function(e){var t=e.page.x+2;var i=e.page.y+2;this.moveNode.positionTo(t,i)},createMoveFlagNode:function(){this.moveFlagNode=new Element("td",{styles:this.css.moveFlagNode})},_setNodeMove:function(e,t){this._setMoveNodePosition(t);var i=this.moveNode.getPosition();var s=this.moveNode.getSize();var n=this.content.getPosition();var o=this.content.getSize();var d=new Drag.Move(this.moveNode,{droppables:e,limit:{x:[n.x,n.x+o.x],y:[i.y,i.y+s.y]},onEnter:function(e,t){if(!this.moveFlagNode)this.createMoveFlagNode();this.moveFlagNode.inject(t,"before")}.bind(this),onLeave:function(e,t){if(this.moveFlagNode){this.moveFlagNode.dispose()}}.bind(this),onDrop:function(e,t){if(t){this.areaNode.inject(t,"before");var i=t.retrieve("column");this.listNode.inject(i.listNode,"before");var s=this.view.json.data.selectEntryList.indexOf(i.json);this.view.json.data.selectEntryList.erase(this.json);this.view.items.erase(this);this.view.json.data.selectEntryList.splice(s,0,this.json);this.view.items.splice(s,0,this);if(this.moveNode)this.moveNode.destroy();if(this.moveFlagNode)this.moveFlagNode.destroy();this._setActionAreaPosition()}else{if(this.moveNode)this.moveNode.destroy();if(this.moveFlagNode)this.moveFlagNode.destroy()}}.bind(this),onCancel:function(e){if(this.moveNode)this.moveNode.destroy();if(this.moveFlagNode)this.moveFlagNode.destroy()}.bind(this)});d.start(t)}});