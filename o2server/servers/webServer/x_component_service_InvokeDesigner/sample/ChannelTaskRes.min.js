print("远程调用：渠道任务接收拒绝实时接口");var File=Java.type("java.io.File");var Root_Dir_Record="D:"+File.separator+"FTPFile"+File.separator+"ChannelTaskRecorder"+File.separator;var recordFile=null;var BranchWorkId=null;var pw=null;function createRecordFile(){if(BranchWorkId==null)return;var e=Java.type("java.util.Date");var r=new e;var t=Root_Dir_Record+new java.text.SimpleDateFormat("yyyy").format(r)+File.separator+new java.text.SimpleDateFormat("MM").format(r)+File.separator+new java.text.SimpleDateFormat("dd").format(r)+File.separator+"Res";var a=new File(t);if(!a.exists()){if(!a.mkdirs()){print("创建记录文件夹失败："+t);a=null}}if(a!==null){var i=t+File.separator+BranchWorkId+".txt";recordFile=new File(i);if(recordFile.exists()){recordFile.delete()}if(!recordFile.createNewFile()){print("不能记录文件:"+i);recordFile=null}else{print("创建记录文件:"+i)}}}function printRecorder(e,r){if(!r)print(e);if(BranchWorkId==null)return;if(recordFile===null)createRecordFile();if(recordFile===null)return;if(pw===null)pw=new java.io.PrintWriter(recordFile,"GBK");pw.print(e);pw.write(13);pw.write(10)}function getPureText(e){if(e===null)return e;if(e.substr(0,1)==='"'){e=e.substr(1,e.length-1)}if(e.substr(e.length-1,1)==='"'){e=e.substr(0,e.length-1)}return e}function getWorkCompltedId(e){var r={filterList:[{logic:"and",path:"branchWorkId",title:"branchWorkId",comparison:"equals",comparisonTitle:"等于",value:e,formatType:"textValue"}]};var t=resources.getWebservicesClient().jaxrsPut("x_query_assemble_surface","view/flag/workCompletedByBranch/query/channelTask/execute",JSON.stringify(r));var a=t.getAsJsonObject();var i=a.get("grid");if(i){printRecorder("grid="+i);var n=i.getAsJsonArray();if(n.size()>0){printRecorder("workData="+n);var o=n.get(0);if(o&&o!=null){var l=o.get("data");if(l&&l!=null){var s=l.get("workCompletedId");if(s&&s!=null){s=getPureText(s.toString());return s}}}}}return null}function setWorkData(e,r,t){var a=getWorkCompltedId(e);var i=null;if(a===null){i="根据Sub_task_id'"+e+"'不能获取文件";printRecorder(i);return i}else{printRecorder("根据branchWorkId'"+e+"'获取workCompletedId为"+a);printRecorder("文件URL：/x_desktop/work.html?workcompletedid="+a)}var n=resources.getWebservicesClient();try{n.jaxrsPut("x_processplatform_assemble_surface","data/workcompleted/"+a+"/interfaceResTime",r);n.jaxrsPut("x_processplatform_assemble_surface","data/workcompleted/"+a+"/interfaceResStat",t);printRecorder("branchWorkId='"+e+"' workCompletedId='"+a+"'的工作保存完毕");return null}catch(e){return e.getMessage()}}function init(){var r="";var e="";var t;try{print("requestText="+requestText);var a=JSON.parse(requestText);print("type of requestJson = "+typeof a);if(typeof a==="string"){a=JSON.parse(a)}e=a.head.sign.Trans_ido;var i=a.body.msg.Sub_task_id;BranchWorkId=i;var n=a.body.msg.Task_state;var o=a.body.msg.Time;if(BranchWorkId&&BranchWorkId!=null&&BranchWorkId!=""){printRecorder("requestText="+requestText,true)}r=setWorkData(i,o,n);if(r==null){t="0000"}else{t="8888"}}catch(e){t="8888";e.printStackTrace();if(pw==null){print(e.getMessage())}else{printRecorder(e.getMessage())}r=e.getMessage()}finally{var l="成功";if(t=="8888"){l=r||"反馈错误"}var s={head:{sign:{service_name:"ChannelTaskRes",Trans_ido:e}},body:{msg:{Response_code:t,Response_desc:l}}};if(pw==null){print("responseText="+JSON.stringify(s))}else{printRecorder("responseText="+JSON.stringify(s));pw.close()}return s}}init();