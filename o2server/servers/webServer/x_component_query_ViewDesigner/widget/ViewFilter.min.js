MWF.xApplication.query=MWF.xApplication.query||{};MWF.xApplication.query.ViewDesigner=MWF.xApplication.query.ViewDesigner||{};MWF.xApplication.query.ViewDesigner.widget=MWF.xApplication.query.ViewDesigner.widget||{};MWF.xApplication.query.ViewDesigner.widget.ViewFilter=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default",type:"identity",names:[]},initialize:function(t,e,i,s){this.setOptions(s);this.node=$(t);this.app=e;this.filtrData=i;this.path="/x_component_query_ViewDesigner/widget/$ViewFilter/";this.cssPath="/x_component_query_ViewDesigner/widget/$ViewFilter/"+this.options.style+"/css.wcss";this._loadCss();this.items=[];this.load()},load:function(t){this.getInputNodes();this.createActionNode();this.loadData()},loadData:function(){if(this.filtrData.filtrData&&this.filtrData.filtrData.length){this.filtrData.filtrData.each(function(t){this.items.push(new MWF.xApplication.query.ViewDesigner.widget.ViewFilter.Item(this,t))}.bind(this))}if(this.filtrData.customData&&this.filtrData.customData.length){this.filtrData.customData.each(function(t){t.type="custom";this.items.push(new MWF.xApplication.query.ViewDesigner.widget.ViewFilter.ItemCustom(this,t))}.bind(this))}},createScriptArea:function(t){this.scriptValueArea=t;var e=t.get("title");MWF.require("MWF.widget.ScriptArea",function(){this.scriptArea=new MWF.widget.ScriptArea(t,{title:e,maxObj:this.app.formContentNode||this.app.pageContentNode,onChange:function(){this.scriptData=this.scriptArea.toJson()}.bind(this),onSave:function(){}.bind(this),style:"formula"});var i=this.scriptData?this.scriptData.code:"";this.scriptArea.load(i)}.bind(this))},getInputNodes:function(){this.inputAreaNode=this.node.getFirst("div");this.actionAreaNode=this.inputAreaNode.getNext().setStyles(this.css.actionAreaNode);this.listAreaNode=this.actionAreaNode.getNext().getNext();this.fieldListAreaNode=this.listAreaNode.getNext().getNext();this.restrictViewFilterTable=this.inputAreaNode.getLast("table");var t=this.inputAreaNode.getElements("select");var e=this.inputAreaNode.getElements("input");var i=this.node.getElement(".MWFFilterFormulaArea");if(i){this.createScriptArea(i)}this.titleInput=e[0];this.pathInput=e[1];this.datatypeInput=t[0];this.restrictFilterInput=e[2];this.customFilterInput=e[3];this.logicInput=t[1];this.comparisonInput=t[2];this.valueTextInput=e[4];this.valueNumberInput=e[5];this.valueDatetimeInput=e[6];this.valueBooleanInput=t[3];MWF.require("MWF.widget.Calendar",function(){this.calendar=new MWF.widget.Calendar(this.valueDatetimeInput,{style:"xform",isTime:true,target:this.app.content,format:"db",onComplate:function(){this.node.getElement("#"+s+"viewFilterDateFormulaSelector").getElements("input").set("checked",false)}.bind(this)})}.bind(this));this.datatypeInput.addEvent("change",function(){this.changeValueInput()}.bind(this));this.valueTextInput.addEvent("keydown",function(t){debugger;if(t.code==13)this.modifyOrAddFilterItem()}.bind(this));this.valueNumberInput.addEvent("keydown",function(t){if(t.code==13)this.modifyOrAddFilterItem()}.bind(this));if(this.app.view){var s=this.app.view.data.id;var n=this.node.getElement("#"+s+"viewFilterValueArea2");e=n.getElements("input");this.valueTextInput2=e[0]||null;this.valueNumberInput2=e[1]||null;this.valueDatetimeInput2=e[2]||null;this.valueBooleanInput2=n.getElement("select")||null;MWF.require("MWF.widget.Calendar",function(){this.calendar=new MWF.widget.Calendar(this.valueDatetimeInput2,{style:"xform",isTime:true,target:this.app.content,format:"db",onComplate:function(){this.node.getElement("#"+s+"viewFilterDateFormulaSelector2").getElements("input").set("checked",false)}.bind(this)})}.bind(this));this.valueTextInput2.addEvent("keydown",function(t){debugger;if(t.code==13)this.modifyOrAddFilterItem()}.bind(this));this.valueNumberInput2.addEvent("keydown",function(t){if(t.code==13)this.modifyOrAddFilterItem()}.bind(this))}},changeValueInput:function(){var t=this.datatypeInput.options[this.datatypeInput.selectedIndex].value;switch(t){case"textValue":this.valueTextInput.setStyle("display","block");this.valueNumberInput.setStyle("display","none");this.valueDatetimeInput.setStyle("display","none");this.valueBooleanInput.setStyle("display","none");if(this.valueTextInput2)this.valueTextInput2.setStyle("display","block");if(this.valueNumberInput2)this.valueNumberInput2.setStyle("display","none");if(this.valueDatetimeInput2)this.valueDatetimeInput2.setStyle("display","none");if(this.valueBooleanInput2)this.valueBooleanInput2.setStyle("display","none");break;case"numberValue":this.valueTextInput.setStyle("display","none");this.valueNumberInput.setStyle("display","block");this.valueDatetimeInput.setStyle("display","none");this.valueBooleanInput.setStyle("display","none");if(this.valueTextInput2)this.valueTextInput2.setStyle("display","none");if(this.valueNumberInput2)this.valueNumberInput2.setStyle("display","block");if(this.valueDatetimeInput2)this.valueDatetimeInput2.setStyle("display","none");if(this.valueBooleanInput2)this.valueBooleanInput2.setStyle("display","none");break;case"datetimeValue":this.valueTextInput.setStyle("display","none");this.valueNumberInput.setStyle("display","none");this.valueDatetimeInput.setStyle("display","block");this.valueBooleanInput.setStyle("display","none");if(this.valueTextInput2)this.valueTextInput2.setStyle("display","none");if(this.valueNumberInput2)this.valueNumberInput2.setStyle("display","none");if(this.valueDatetimeInput2)this.valueDatetimeInput2.setStyle("display","block");if(this.valueBooleanInput2)this.valueBooleanInput2.setStyle("display","none");break;case"booleanValue":this.valueTextInput.setStyle("display","none");this.valueNumberInput.setStyle("display","none");this.valueDatetimeInput.setStyle("display","none");this.valueBooleanInput.setStyle("display","block");if(this.valueTextInput2)this.valueTextInput2.setStyle("display","none");if(this.valueNumberInput2)this.valueNumberInput2.setStyle("display","none");if(this.valueDatetimeInput2)this.valueDatetimeInput2.setStyle("display","none");if(this.valueBooleanInput2)this.valueBooleanInput2.setStyle("display","block");break}},createActionNode:function(){this.actionNode=new Element("div",{styles:this.css.actionNode}).inject(this.actionAreaNode);this.actionNode.addEvent("click",function(){this.modifyOrAddFilterItem()}.bind(this))},modifyOrAddFilterItem:function(){if(this.currentFilterItem){this.modifyFilterItem()}else{if(this.restrictFilterInput.checked){this.addFilterItem()}else{this.addCustomFilterItem()}}},modifyFilterItem:function(){var t=this.getInputData();if(this.verificationData(t)){this.currentFilterItem.reload(t);this.currentFilterItem.unSelected();this.fireEvent("change")}},addFilterItem:function(){var t=this.getInputData();if(this.verificationData(t)){this.items.push(new MWF.xApplication.query.ViewDesigner.widget.ViewFilter.Item(this,t));this.fireEvent("change")}},addCustomFilterItem:function(){var t=this.getInputData();if(this.verificationDataCustom(t)){this.items.push(new MWF.xApplication.query.ViewDesigner.widget.ViewFilter.ItemCustom(this,t));this.fireEvent("change")}},verificationData:function(t){if(!t.path){this.verificationNode=new Element("div",{styles:this.css.verificationNode}).inject(this.inputAreaNode);new Element("div",{styles:this.css.verificationTextNode,text:this.app.lp.mastInputPath}).inject(this.verificationNode);this.pathInput.focus();this.pathInput.setStyle("background-color","#fbe8e8");this.pathInput.addEvents({keydown:function(){if(this.verificationNode){this.verificationNode.destroy();this.verificationNode=null;this.pathInput.setStyle("background-color","#FFF")}}.bind(this),click:function(){if(this.verificationNode){this.verificationNode.destroy();this.verificationNode=null}}.bind(this)});return false}return true},verificationDataCustom:function(t){if(!t.title){this.verificationNode=new Element("div",{styles:this.css.verificationNode}).inject(this.inputAreaNode);new Element("div",{styles:this.css.verificationTextNode,text:this.app.lp.mastInputTitle}).inject(this.verificationNode);this.titleInput.focus();this.titleInput.setStyle("background-color","#fbe8e8");this.titleInput.addEvents({keydown:function(){if(this.verificationNode){this.verificationNode.destroy();this.verificationNode=null;this.titleInput.setStyle("background-color","#FFF")}}.bind(this),click:function(){if(this.verificationNode){this.verificationNode.destroy();this.verificationNode=null}}.bind(this)});return false}if(!t.path){this.verificationNode=new Element("div",{styles:this.css.verificationNode}).inject(this.inputAreaNode);new Element("div",{styles:this.css.verificationTextNode,text:this.app.lp.mastInputPath}).inject(this.verificationNode);this.pathInput.focus();this.pathInput.setStyle("background-color","#fbe8e8");this.pathInput.addEvents({keydown:function(){if(this.verificationNode){this.verificationNode.destroy();this.verificationNode=null;this.pathInput.setStyle("background-color","#FFF")}}.bind(this),click:function(){if(this.verificationNode){this.verificationNode.destroy();this.verificationNode=null}}.bind(this)});return false}return true},getInputData:function(){var t=this.logicInput.options[this.logicInput.selectedIndex].value;var e=this.pathInput.get("value");var i=this.titleInput.get("value");if(this.restrictFilterInput.checked)var s="restrict";if(this.customFilterInput.checked)var s="custom";var n=this.comparisonInput.options[this.comparisonInput.selectedIndex].value;var a=this.datatypeInput.options[this.datatypeInput.selectedIndex].value;var l="";var u="";switch(a){case"textValue":l=this.valueTextInput.get("value");u=this.valueTextInput2?this.valueTextInput2.get("value"):"";break;case"numberValue":l=this.valueNumberInput.get("value").toFloat();u=this.valueNumberInput2?this.valueNumberInput2.get("value").toFloat():"";break;case"datetimeValue":l=this.valueDatetimeInput.get("value");u=this.valueDatetimeInput2?this.valueDatetimeInput2.get("value"):"";break;case"booleanValue":l=this.valueBooleanInput.options[this.valueBooleanInput.selectedIndex].value;u=this.valueBooleanInput2?this.valueBooleanInput2.options[this.valueBooleanInput.selectedIndex].value:"";if(l=="true"){l=true}else{l=false}if(u=="true"){u=true}else{u=false}break}return{logic:t,path:e,title:i,type:s,comparison:n,formatType:a,value:l||"",otherValue:u||"",code:this.scriptData}},setData:function(t){for(var e=0;e<this.logicInput.options.length;e++){if(this.logicInput.options[e].value===t.logic){this.logicInput.options[e].set("selected",true);break}}this.titleInput.set("value",t.title);this.pathInput.set("value",t.path);for(var e=0;e<this.comparisonInput.options.length;e++){if(this.comparisonInput.options[e].value===t.comparison){this.comparisonInput.options[e].set("selected",true);break}}for(var e=0;e<this.datatypeInput.options.length;e++){if(this.datatypeInput.options[e].value===t.formatType){this.datatypeInput.options[e].set("selected",true);break}}switch(t.formatType){case"textValue":this.valueTextInput.set("value",t.value);if(this.valueTextInput2)this.valueTextInput2.set("value",t.otherValue);break;case"numberValue":this.valueNumberInput.set("value",t.value);if(this.valueNumberInput2)this.valueNumberInput2.set("value",t.otherValue);break;case"datetimeValue":this.valueDatetimeInput.set("value",t.value);if(this.valueDatetimeInput2)this.valueDatetimeInput2.set("value",t.otherValue);break;case"booleanValue":for(var e=0;e<this.valueBooleanInput.options.length;e++){var i=this.valueBooleanInput.options[e].value;if(i=="true"){i=true}else{i=false}if(i===t.value){this.valueBooleanInput.options[e].set("selected",true);break}}if(this.valueBooleanInput2){for(var e=0;e<this.valueBooleanInput2.options.length;e++){var i=this.valueBooleanInput2.options[e].value;if(i=="true"){i=true}else{i=false}if(i===t.otherValue){this.valueBooleanInput2.options[e].set("selected",true);break}}}break}this.scriptData=t.code;if(this.scriptArea.editor)this.scriptArea.editor.setValue(this.scriptData.code)},deleteItem:function(t){if(this.currentFilterItem==t)t.unSelected();this.items.erase(t);t.node.destroy();MWF.release(t);this.fireEvent("change")},getData:function(){var t=[];var e=[];this.items.each(function(i){if(i.data.type==="custom"){e.push(i.data)}else{t.push(i.data)}}.bind(this));return{data:t,customData:e}}});MWF.xApplication.query.ViewDesigner.widget.ViewFilter.Item=new Class({Implements:[Events],initialize:function(t,e){this.filter=t;this.data=e;this.container=this.filter.listAreaNode;this.css=this.filter.css;this.app=this.filter.app;this.load()},load:function(){this.node=new Element("div",{styles:this.css.itemNode}).inject(this.container);this.deleteNode=new Element("div",{styles:this.css.itemDeleteNode}).inject(this.node);this.contentNode=new Element("div",{styles:this.css.itemContentNode}).inject(this.node);this.contentNode.set("text",this.getText());this.contentNode.addEvent("click",function(){this.selected()}.bind(this));this.deleteNode.addEvent("click",function(t){this.deleteItem(t)}.bind(this))},getText:function(){var t=this.app.lp.filter;return t[this.data.logic]+" "+this.data.path+" "+t[this.data.comparison]+' "'+(this.data.value||"")+'"'+(this.data.comparison=="range"?', "'+this.data.otherValue+'"':"")},reload:function(t){this.data=t;this.contentNode.set("text",this.getText())},selected:function(){this.filter.restrictFilterInput.set("checked",true);this.filter.restrictFilterInput.click();if(this.filter.currentFilterItem)this.filter.currentFilterItem.unSelected();this.node.setStyles(this.css.itemNode_current);this.filter.currentFilterItem=this;this.filter.setData(this.data)},unSelected:function(){this.node.setStyles(this.css.itemNode);this.filter.currentFilterItem=null;this.filter.currentItem=this},deleteItem:function(t){var e=this;this.filter.app.confirm("warn",t,this.app.lp.delete_filterItem_title,this.app.lp.delete_filterItem,300,120,function(){e.destroy();this.close()},function(){this.close()})},destroy:function(){this.filter.deleteItem(this)}});MWF.xApplication.query.ViewDesigner.widget.ViewFilter.ItemCustom=new Class({Extends:MWF.xApplication.query.ViewDesigner.widget.ViewFilter.Item,initialize:function(t,e){this.filter=t;this.data=e;this.container=this.filter.fieldListAreaNode;this.css=this.filter.css;this.app=this.filter.app;this.load()},selected:function(){this.filter.customFilterInput.set("checked",true);this.filter.customFilterInput.click();if(this.filter.currentFilterItem)this.filter.currentFilterItem.unSelected();this.node.setStyles(this.css.itemNode_current);this.filter.currentFilterItem=this;this.filter.setData(this.data)},getText:function(){var t=this.app.lp.filter;return this.data.title+"("+this.data.path+")"}});