MWF.xApplication.process.FormDesigner.widget=MWF.xApplication.process.FormDesigner.widget||{};MWF.require("MWF.widget.ScriptArea",null,false);MWF.xApplication.process.FormDesigner.widget.EventsEditor=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default",maxObj:document.body},initialize:function(t,e,i){this.setOptions(i);this.node=$(t);this.app=e;this.path="/x_component_process_FormDesigner/widget/$EventsEditor/";this.cssPath="/x_component_process_FormDesigner/widget/$EventsEditor/"+this.options.style+"/css.wcss";this._loadCss();this.items=[];this.currentEditItem=null;this.createEventsAreaNode()},createEventsAreaNode:function(){this.eventsContainer=new Element("div",{styles:this.css.eventsContainer}).inject(this.node);var t=this.node.getUsefulSize()},load:function(t){this.data=t;Object.each(t,function(t,e){var i=new MWF.xApplication.process.FormDesigner.widget.EventsEditor.Item(this);i.load(e,t);this.items.push(i)}.bind(this))},deleteItem:function(t){this.items.erase(t);if(this.data[t.event]){this.data[t.event].code="";this.data[t.event].html="";delete this.data[t.event]}if(t.container){t.container.destroy()}},addItem:function(t){this.data[t.event]=t.data;this.items.push(t)},addEvent:function(){var t=new MWF.xApplication.process.FormDesigner.widget.EventsEditor.Item(this);t.load("","")}});MWF.xApplication.process.FormDesigner.widget.EventsEditor.Item=new Class({initialize:function(t){this.editor=t},load:function(t,e){if(!t){this.create()}else{this.event=t;this.data=e;this.createContainer();this.createActions()}},create:function(){this.event="";this.data={code:"",html:""};this.createContainerTitle();this.createInput=new Element("input",{styles:this.editor.css.createInput}).inject(this.textNode);this.createInput.focus();this.createInput.addEvents({keydown:function(t){if(t.code==13){this.checkCreate()}}.bind(this),blur:function(){this.checkCreate()}.bind(this)})},checkCreate:function(){var t=this.createInput.get("value");if(!t){this.editor.deleteItem(this);return false}if(this.editor.data[t]){this.iconNode.setStyle("background","url("+this.editor.path+this.editor.options.style+"/icon/error.png) center center no-repeat");this.iconNode.title=MWF.LP.process.repetitionsEvent;this.createInput.focus()}else{this.event=t;this.container.destroy();this.load(this.event,this.data);this.editCode();this.editor.addItem(this)}},createContainerTitle:function(){this.container=new Element("div",{styles:this.editor.css.itemContainer}).inject(this.editor.eventsContainer);this.titleContainer=new Element("div",{styles:this.editor.css.itemTitleContainer}).inject(this.container);this.iconNode=new Element("div",{styles:this.editor.css.iconNode}).inject(this.titleContainer);this.actionNode=new Element("div",{styles:this.editor.css.actionNode}).inject(this.titleContainer);this.textNode=new Element("div",{styles:this.editor.css.textNode,text:this.event}).inject(this.titleContainer)},createContainer:function(){this.createContainerTitle();this.codeNode=new Element("div",{styles:this.editor.css.codeNode}).inject(this.container);this.titleContainer.addEvents({mouseover:function(){this.actionNode.fade("in")}.bind(this),mouseout:function(){this.actionNode.fade("out")}.bind(this)});this.textNode.addEvent("click",function(){this.editCode()}.bind(this));this.checkIcon()},editCode:function(){if(this.editor.currentEditItem){if(this.editor.currentEditItem!=this)this.editor.currentEditItem.editCodeComplete()}if(this.editor.currentEditItem!=this){if(!this.codeEditor){this.codeEditor=new MWF.widget.ScriptArea(this.codeNode,{style:"event",title:"on"+this.event+" (S)",maxObj:this.editor.options.maxObj,onChange:function(){var t=this.codeEditor.toJson();this.data.code=t.code;this.data.html=t.html;this.checkIcon()}.bind(this),onSave:function(){var t=this.codeEditor.toJson();this.data.code=t.code;this.data.html=t.html;this.editor.app.saveForm()}.bind(this)});this.codeEditor.load(this.data)}if(!this.morph){this.morph=new Fx.Morph(this.codeNode,{duration:200})}this.codeNode.setStyle("display","block");this.morph.start({height:[0,300]}).chain(function(){this.codeEditor.resizeContentNodeSize();this.codeEditor.focus()}.bind(this));this.editor.currentEditItem=this}else{this.editCodeComplete()}},editCodeComplete:function(){if(this.codeEditor){var t=this.codeEditor.toJson();this.data.code=t.code;this.data.html=t.html;this.checkIcon()}if(!this.morph){this.morph=new Fx.Morph(this.codeNode,{duration:200})}this.morph.start({height:[300,0]}).chain(function(){this.codeNode.setStyle("display","none")}.bind(this));this.editor.currentEditItem=null},createActions:function(){var t=new Element("div",{styles:this.editor.css.actionNodeDelete}).inject(this.actionNode);t.addEvent("click",function(t){var e=this;this.editor.app.confirm("warn",t,this.editor.app.lp.notice.deleteEventTitle,this.editor.app.lp.notice.deleteEvent,300,120,function(){e.editor.deleteItem(e);this.close()},function(){this.close()},null)}.bind(this));var e=new Element("div",{styles:this.editor.css.actionNodeAdd}).inject(this.actionNode);e.addEvent("click",function(t){this.editor.addEvent()}.bind(this))},checkIcon:function(){if(this.data.code){this.iconNode.setStyle("background","url("+this.editor.path+this.editor.options.style+"/icon/code.png) center center no-repeat")}else{this.iconNode.setStyle("background","url("+this.editor.path+this.editor.options.style+"/icon/code_empty.png) center center no-repeat")}}});