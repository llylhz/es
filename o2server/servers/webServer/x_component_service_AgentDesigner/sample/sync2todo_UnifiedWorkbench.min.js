load("nashorn:mozilla_compat.js");print("----发送待办开始---------");var Todo_Service_URL="http://10.11.198.209:9083/UnifiedWorkbench/ProcessTaskService";var Read_Service_URL="http://10.11.198.209:9083/UnifiedWorkbench/ProcessReadService";var Project_Name="安徽智和";var Project_Password="ahzh";function getServerHost(){return"http://zhtest.ah.unicom.local"}function getServerPort(){var e="8080";return e==""||e=="80"?"":":"+e}function init(){var e=resources.getContext().applications().getQuery(com.x.base.core.project.x_message_assemble_communicate.class,"consume/list/sync2todo/count/30");var r=e.getData().toString();var a=JSON.parse(r);for(var t=0;t<a.length;t++){var s=a[t];switch(s.type){case"task_create":var o=JSON.parse(s.body);send_task_create(s.id,o);break;case"taskCompleted_create":var o=JSON.parse(s.body);send_taskCompleted_create(s.id,o);break;case"taskCompleted_delete":var o=JSON.parse(s.body);send_task_delete(s.id,o);break;case"read_create":var n=JSON.parse(s.body);send_read_create(s.id,n);break;case"readCompleted_create":var n=JSON.parse(s.body);send_readCompleted_create(s.id,n);break;case"task_delete":var o=JSON.parse(s.body);send_task_delete(s.id,o);break;case"read_delete":var n=JSON.parse(s.body);send_read_delete(s.id,n);break;default:break}}}function getPersonFeature(e){return"wangyj733"}function getPersonAttribute(e,r){var a=resources.getOrganization();var t=a.personAttribute().listAttributeWithPersonWithName(e,r);if(t.length===0){return e}else{if(t[0]&&t[0]!=""){return t[0]}else{return e}}}function concatUrl(e){return getServerHost()+getServerPort()+"/x_desktop/work.html?workid="+e.work}function concatTaskUrl(e){return getServerHost()+getServerPort()+"/x_desktop/work.html?taskid="+e.id}function concatTaskCompletedUrl(e){return getServerHost()+getServerPort()+"/x_desktop/work.html?taskcompletedid="+e.id}function concatReadUrl(e){return getServerHost()+getServerPort()+"/x_desktop/work.html?readid="+e.id}function concatReadCompletedUrl(e){return getServerHost()+getServerPort()+"/x_desktop/work.html?readcompletedid="+e.id}function getXMLText(e,r){var a=e.getElementsByTagName(r);if(a==null)return null;var t=a.item(0);if(t==null)return null;return t.getTextContent()}function updateConsume(r){try{resources.getContext().applications().getQuery(com.x.base.core.project.x_message_assemble_communicate.class,"consume/"+r+"/type/sync2todo")}catch(e){print("更新消息,将消息标志为已处理出错，id="+r+"：");print(e.printStackTrace());return false}}function isRespSuccess(e){try{var r=Java.type("javax.xml.parsers.DocumentBuilderFactory");var a=Java.type("java.io.StringReader");var t=Java.type("org.xml.sax.InputSource");var s=r.newInstance();var o=s.newDocumentBuilder();var n=new a(e);var g=new t(n);var c=o.parse(g);var p=c.getDocumentElement();var d=getXMLText(p,"faultcode");var i=getXMLText(p,"faultstring");if(d){return false}else{return true}}catch(e){print("解析返回结果报错：");print(e.printStackTrace());return false}}function sendRequest_task(e){try{print("发起请求:"+e);var r=Java.type("java.util.ArrayList");var a=new r;var t=Java.type("com.x.base.core.project.bean.NameValuePair");var s=new t("Content-Type","text/xml; charset=utf-8");a.add(s);var o=Java.type("com.x.base.core.project.connection.HttpConnection");var n=o.postAsString(Todo_Service_URL,a,e);print("统一待办返回:"+n);return isRespSuccess(n)}catch(e){print("发送请求出错：");print(e.printStackTrace())}}function get_task_create_xml(e){var r="";r+='<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:proc="http://processtask.service.webservice.unifiedworkbench.zoneland.net/">';r+="<soapenv:Header/>";r+="<soapenv:Body>";r+="<proc:update>";r+="<arg0>"+Project_Name+"</arg0>";r+="<arg1>"+Project_Password+"</arg1>";r+="<arg2>"+getPersonFeature(e.person)+"</arg2>";r+="<arg3>"+""+"</arg3>";r+="<arg4>"+getPersonFeature(e.creatorPerson)+"</arg4>";r+="<arg5>"+e.opinion+"</arg5>";r+="<arg6>"+e.title+"</arg6>";r+="<arg7>"+e.work+"</arg7>";r+="<arg8>"+e.job+"</arg8>";r+="<arg9>"+e.id+"</arg9>";r+="<arg10>"+e.routeName+"</arg10>";r+="<arg11>"+e.startTime+"</arg11>";r+="<arg12>"+e.processName+"</arg12>";r+="<arg13>"+e.processName+"</arg13>";r+="<arg14>"+e.activityName+"</arg14>";r+="<arg15>"+"false"+"</arg15>";r+="<arg16>"+e.processName+"</arg16>";r+="<arg17>"+""+"</arg17>";r+="<arg18>"+""+"</arg18>";r+="<arg19>"+e.serial+"</arg19>";r+="<arg20>"+0+"</arg20>";r+="<arg21>"+""+"</arg21>";r+="<arg22>"+false+"</arg22>";r+="<arg23>"+0+"</arg23>";r+="<arg24>"+""+"</arg24>";r+="<arg25>"+"false"+"</arg25>";r+="<arg26>"+"false"+"</arg26>";r+="<arg27>"+concatTaskUrl(e)+"</arg27>";r+="<arg28>"+""+"</arg28>";r+="<arg29>"+""+"</arg29>";r+="<arg30>"+""+"</arg30>";r+="<arg31>"+""+"</arg31>";r+="<arg32>"+""+"</arg32>";r+="<arg33>"+""+"</arg33>";r+="<arg34>"+""+"</arg34>";r+="</proc:update>";r+="</soapenv:Body>";r+="</soapenv:Envelope>";return r}function send_task_create(e,r){print("======send_task_create start========="+", consume id  : "+e);var a=get_task_create_xml(r);if(sendRequest_task(a)){updateConsume(e)}print("======send_task_create end========="+", consume id : "+e)}function get_task_delete_xml(e){var r="";r+='<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:proc="http://processtask.service.webservice.unifiedworkbench.zoneland.net/">';r+="<soapenv:Header/>";r+="<soapenv:Body>";r+="<proc:removeTaskAsFeature>";r+="<arg0>"+Project_Name+"</arg0>";r+="<arg1>"+Project_Password+"</arg1>";r+="<arg2>"+e.id+"</arg2>";r+="</proc:removeTaskAsFeature>";r+="</soapenv:Body>";r+="</soapenv:Envelope>";return r}function send_task_delete(e,r){print("--------send_task_delete start------------"+", consume id : "+e);var a=get_task_delete_xml(r);if(sendRequest_task(a)){updateConsume(e)}print("--------send_task_delete end------------"+", consume id : "+e)}function get_taskCompleted_create_xml(e){var r="";r+='<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:proc="http://processtask.service.webservice.unifiedworkbench.zoneland.net/">';r+="<soapenv:Header/>";r+="<soapenv:Body>";r+="<proc:update>";r+="<arg0>"+Project_Name+"</arg0>";r+="<arg1>"+Project_Password+"</arg1>";r+="<arg2>"+""+"</arg2>";r+="<arg3>"+getPersonFeature(e.person)+"</arg3>";r+="<arg4>"+getPersonFeature(e.creatorPerson)+"</arg4>";r+="<arg5>"+e.opinion+"</arg5>";r+="<arg6>"+e.title+"</arg6>";r+="<arg7>"+e.work+"</arg7>";r+="<arg8>"+e.job+"</arg8>";r+="<arg9>"+e.id+"</arg9>";r+="<arg10>"+e.routeName+"</arg10>";r+="<arg11>"+e.startTime+"</arg11>";r+="<arg12>"+e.processName+"</arg12>";r+="<arg13>"+e.processName+"</arg13>";r+="<arg14>"+e.activityName+"</arg14>";r+="<arg15>"+"false"+"</arg15>";r+="<arg16>"+e.processName+"</arg16>";r+="<arg17>"+""+"</arg17>";r+="<arg18>"+""+"</arg18>";r+="<arg19>"+e.serial+"</arg19>";r+="<arg20>"+0+"</arg20>";r+="<arg21>"+""+"</arg21>";r+="<arg22>"+false+"</arg22>";r+="<arg23>"+0+"</arg23>";r+="<arg24>"+""+"</arg24>";r+="<arg25>"+"false"+"</arg25>";r+="<arg26>"+"false"+"</arg26>";r+="<arg27>"+concatTaskCompletedUrl(e)+"</arg27>";r+="<arg28>"+""+"</arg28>";r+="<arg29>"+""+"</arg29>";r+="<arg30>"+""+"</arg30>";r+="<arg31>"+""+"</arg31>";r+="<arg32>"+""+"</arg32>";r+="<arg33>"+""+"</arg33>";r+="<arg34>"+""+"</arg34>";r+="</proc:update>";r+="</soapenv:Body>";r+="</soapenv:Envelope>";return r}function send_taskCompleted_create(e,r){print("--------send_taskCompleted_create start------------"+", consume id : "+e);var a=get_taskCompleted_create_xml(r);if(sendRequest_task(a)){updateConsume(e)}print("--------send_taskCompleted_create end------------"+", consume id  : "+e)}function sendRequest_read(e){try{print("发起请求:"+e);var r=Java.type("java.util.ArrayList");var a=new r;var t=Java.type("com.x.base.core.project.bean.NameValuePair");var s=new t("Content-Type","text/xml; charset=utf-8");a.add(s);var o=Java.type("com.x.base.core.project.connection.HttpConnection");var n=o.postAsString(Read_Service_URL,a,e);print("统一待办返回:"+n);return isRespSuccess(n)}catch(e){print("发送请求出错：");print(e.printStackTrace())}}function get_read_create_xml(e){var r="";r+='<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:proc="http://processread.service.webservice.unifiedworkbench.zoneland.net/">';r+="<soapenv:Header/>";r+="<soapenv:Body>";r+="<proc:update>";r+="<arg0>"+Project_Name+"</arg0>";r+="<arg1>"+Project_Password+"</arg1>";r+="<arg2>"+getPersonFeature(e.person)+"</arg2>";r+="<arg3>"+""+"</arg3>";r+="<arg4>"+getPersonFeature(e.creatorPerson)+"</arg4>";r+="<arg5>"+e.title+"</arg5>";r+="<arg6>"+e.work+"</arg6>";r+="<arg7>"+e.job+"</arg7>";r+="<arg8>"+e.processName+"</arg8>";r+="<arg9>"+e.processName+"</arg9>";r+="<arg10>"+e.activityName+"</arg10>";r+="<arg11>"+e.processName+"</arg11>";r+="<arg12>"+""+"</arg12>";r+="<arg13>"+""+"</arg13>";r+="<arg14>"+e.serial+"</arg14>";r+="<arg15>"+e.id+"</arg15>";r+="<arg16>"+""+"</arg16>";r+="<arg17>"+"false"+"</arg17>";r+="<arg18>"+"false"+"</arg18>";r+="<arg19>"+e.startTime+"</arg19>";r+="<arg20>"+""+"</arg20>";r+="<arg21>"+""+"</arg21>";r+="<arg22>"+concatReadUrl(e)+"</arg22>";r+="<arg23>"+""+"</arg23>";r+="<arg24>"+""+"</arg24>";r+="<arg25>"+""+"</arg25>";r+="<arg26>"+""+"</arg26>";r+="<arg27>"+""+"</arg27>";r+="<arg28>"+""+"</arg28>";r+="<arg29>"+""+"</arg29>";r+="</proc:update>";r+="</soapenv:Body>";r+="</soapenv:Envelope>";return r}function send_read_create(e,r){print("======send_read_create start========="+", consume id   : "+e);var a=get_read_create_xml(r);if(sendRequest_read(a)){updateConsume(e)}print("======send_read_create end========="+", consume id : "+e)}function get_read_delete_xml(e){var r="";r+='<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:proc="http://processread.service.webservice.unifiedworkbench.zoneland.net/">';r+="<soapenv:Header/>";r+="<soapenv:Body>";r+="<proc:removeReadAsFeature>";r+="<arg0>"+Project_Name+"</arg0>";r+="<arg1>"+Project_Password+"</arg1>";r+="<arg2>"+e.id+"</arg2>";r+="</proc:removeReadAsFeature>";r+="</soapenv:Body>";r+="</soapenv:Envelope>";return r}function send_read_delete(e,r){print("--------send_read_delete start------------"+", consume id : "+e);var a=get_read_delete_xml(r);if(sendRequest_read(a)){updateConsume(e)}print("--------send_read_delete end------------"+", consume id : "+e)}function get_read_create_xml(e){var r="";r+='<soapenv:Envelope xmlns:soapenv="http://schemas.xmlsoap.org/soap/envelope/" xmlns:proc="http://processread.service.webservice.unifiedworkbench.zoneland.net/">';r+="<soapenv:Header/>";r+="<soapenv:Body>";r+="<proc:update>";r+="<arg0>"+Project_Name+"</arg0>";r+="<arg1>"+Project_Password+"</arg1>";r+="<arg2>"+""+"</arg2>";r+="<arg3>"+getPersonFeature(e.person)+"</arg3>";r+="<arg4>"+getPersonFeature(e.creatorPerson)+"</arg4>";r+="<arg5>"+e.title+"</arg5>";r+="<arg6>"+e.work+"</arg6>";r+="<arg7>"+e.job+"</arg7>";r+="<arg8>"+e.processName+"</arg8>";r+="<arg9>"+e.processName+"</arg9>";r+="<arg10>"+e.activityName+"</arg10>";r+="<arg11>"+e.processName+"</arg11>";r+="<arg12>"+""+"</arg12>";r+="<arg13>"+""+"</arg13>";r+="<arg14>"+e.serial+"</arg14>";r+="<arg15>"+e.id+"</arg15>";r+="<arg16>"+""+"</arg16>";r+="<arg17>"+"false"+"</arg17>";r+="<arg18>"+"false"+"</arg18>";r+="<arg19>"+e.startTime+"</arg19>";r+="<arg20>"+""+"</arg20>";r+="<arg21>"+""+"</arg21>";r+="<arg22>"+concatReadCompletedUrl(e)+"</arg22>";r+="<arg23>"+""+"</arg23>";r+="<arg24>"+""+"</arg24>";r+="<arg25>"+""+"</arg25>";r+="<arg26>"+""+"</arg26>";r+="<arg27>"+""+"</arg27>";r+="<arg28>"+""+"</arg28>";r+="<arg29>"+""+"</arg29>";r+="</proc:update>";r+="</soapenv:Body>";r+="</soapenv:Envelope>";return r}function send_readCompleted_create(e,r){print("--------send_readCompleted_create start------------"+", consume id : "+e);var a=get_readCompleted_create_xml(r);if(sendRequest_read(a)){updateConsume(e)}print("--------send_readCompleted_create end------------"+", consume id  : "+e)}init();print("----发送待办结束---------");