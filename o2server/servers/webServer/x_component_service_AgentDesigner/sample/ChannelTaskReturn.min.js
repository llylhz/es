printLog("运行代理渠道任务完成情况反馈");load("nashorn:mozilla_compat.js");var File=Java.type("java.io.File");var Root_Dir="D:"+File.separator+"FTPFile"+File.separator+"ChannelTask"+File.separator+"Result";var Root_Dir_Record="D:"+File.separator+"FTPFile"+File.separator+"ChannelTaskRecorder"+File.separator;function createRecordFloder(){var e=Java.type("java.util.Date");var r=new e;var a=Root_Dir_Record+new java.text.SimpleDateFormat("yyyy").format(r)+File.separator+new java.text.SimpleDateFormat("MM").format(r)+File.separator+new java.text.SimpleDateFormat("dd").format(r)+File.separator+"Return";var t=new File(a);if(!t.exists()){if(!t.mkdirs()){print("创建记录文件夹失败："+a);return null}}return a}function getFileList(){var e=Root_Dir;var r=new File(e);var a=Java.type("java.util.ArrayList");var t=new a;if(r.exists()){var i=r.listFiles();for(var n=0;n<i.length;n++){if(i[n].isFile()){var l=i[n].getName().split(".");if(l[l.length-1].toUpperCase().equals("REQ")){t.add(i[n])}}}}else{printLog("目录不存在:"+e)}return t}function printLog(e){print(e)}function getPureText(e){if(e===null)return e;if(e.substr(0,1)==='"'){e=e.substr(1,e.length-1)}if(e.substr(e.length-1,1)==='"'){e=e.substr(0,e.length-1)}return e}function getWorkCompltedId(e){var r={filterList:[{logic:"and",path:"branchWorkId",title:"branchWorkId",comparison:"equals",comparisonTitle:"等于",value:e,formatType:"textValue"}]};var a=resources.getWebservicesClient().jaxrsPut("x_query_assemble_surface","view/flag/workCompletedByBranch/query/channelTask/execute",JSON.stringify(r));var t=a.getAsJsonObject();var i=t.get("grid");if(i){print("grid="+i);var n=i.getAsJsonArray();if(n.size()>0){var l=n.get(0);print("workData="+l);if(l&&l!=null){var o=l.get("data");if(o&&o!=null){var s=o.get("workCompletedId");if(s&&s!=null){s=getPureText(s.toString());return s}}}}}return null}function setWorkData(e,r,a,t){var i=true;var n=getWorkCompltedId(e);if(n===null){print("根据branchWorkId'"+e+"'不能获取workCompletedId");return false}else{print("根据branchWorkId'"+e+"'获取workCompletedId为"+n)}try{var l=resources.getWebservicesClient();var o=l.jaxrsGet("x_processplatform_assemble_surface","data/workcompleted/"+n+"/finishedLog");print(o);var s;if(o!=null&&o!==""){var u=o.toString();s=JSON.parse(u);s.push({dateStr:r,finishCount:t})}else{s=[{dateStr:r,finishCount:t}]}l.jaxrsPut("x_processplatform_assemble_surface","data/workcompleted/"+n+"/finishedLog",JSON.stringify(s));l.jaxrsPut("x_processplatform_assemble_surface","data/workcompleted/"+n+"/finishCount",t);print("branchWorkId='"+e+"' workCompletedId='"+n+"'的工作保存完毕")}catch(e){i=false;e.printStackTrace()}finally{return i}}function readFileByLines(e){var r=true;var a=Java.type("java.io.FileInputStream");var t=Java.type("java.io.InputStreamReader");var i=Java.type("java.io.BufferedReader");var n=null;try{n=new t(new a(e),"GBK")}catch(e){e.printStackTrace();r=false;return r}var l=null;try{print("正在读取文件"+e.getName()+"：");l=new i(n);var o=null;var s=1;while((o=l.readLine())!=null){print("line "+s+": "+o);var u=o.split("|");if(u.length>5){var p=u[2];print("branchWorkId="+p);if(!setWorkData(p,u[0],u[3],u[4])){r=false}}s++}l.close()}catch(e){r=false;e.printStackTrace()}finally{if(l!=null){try{l.close()}catch(e){return r}}return r}}function init(){var e=getFileList();var r=null;if(e.size()>0){r=createRecordFloder()}for(var a=0;a<e.size();a++){try{var t=e.get(a);var i=readFileByLines(t);if(i&&r!==null){print("正在修改文件目录："+t.getName());var n=r+File.separator+t.getName();var l=new File(n);if(l.exists()){l.delete()}if(t.renameTo(l)){print("文件移动到了:"+n)}else{print(t.getName()+" is failed to move!")}}}catch(e){e.printStackTrace()}}}init();