printLog("运行代理渠道任务明细下发文件");load("nashorn:mozilla_compat.js");var File=Java.type("java.io.File");var Root_Dir="D:"+File.separator+"FTPFile"+File.separator+"ChannelTask"+File.separator+"Detail"+File.separator;var Root_Dir_Record="D:"+File.separator+"FTPFile"+File.separator+"ChannelTaskRecorder"+File.separator;function getSeq(e){var t=resources.getWebservicesClient().jaxrsGet("x_processplatform_assemble_surface","applicationdict/ChannelTaskDetail_Seq/application/channelTaskProcess/seq/data");t=getPureText(t.toString());var r=t.split("-");var a=0;if(r.length>1&&r[0]===e)a=parseInt(r[1]);a++;var i="0000"+a;i=i.substr(i.length-4,4);resources.getWebservicesClient().jaxrsPut("x_processplatform_assemble_surface","applicationdict/ChannelTaskDetail_Seq/application/channelTaskProcess/seq/data",e+"-"+i);return i}function createRecordFloder(){var e=Java.type("java.util.Date");var t=new e;var r=Root_Dir_Record+new java.text.SimpleDateFormat("yyyy").format(t)+File.separator+new java.text.SimpleDateFormat("MM").format(t)+File.separator+new java.text.SimpleDateFormat("dd").format(t)+File.separator+"Detail";var a=new File(r);if(!a.exists()){if(!a.mkdirs()){print("创建记录文件夹失败："+r);return null}}return a}function createFile(){var e=Java.type("java.util.Date");var t=new e;var r=new java.text.SimpleDateFormat("yyyyMMdd").format(t);var a=getSeq(r);var i=Root_Dir+r+"_ChannelTaskDetail_"+(a||"0001")+".REQ";print("path="+i);var n=new File(i);if(n.exists()){n.delete()}if(!n.createNewFile()){printLog("不能创建文件:"+i);return null}else{printLog("创建文件:"+i);return n}}function printLog(e){print(e)}function setWorkFlag(e,t){printLog("设置标志位");if(t===""){resources.getWebservicesClient().jaxrsPut("x_processplatform_assemble_surface","data/workcompleted/"+e+"/interfaceStatus","detailNone")}else{resources.getWebservicesClient().jaxrsPut("x_processplatform_assemble_surface","data/workcompleted/"+e+"/interfaceStatus","detailDone");resources.getWebservicesClient().jaxrsPut("x_processplatform_assemble_surface","data/workcompleted/"+e+"/File_Name",t)}}function getWorkData(){var e={filterList:[{logic:"and",path:"interfaceStatus",title:"接口状态",comparison:"equals",comparisonTitle:"等于",value:"wait",formatType:"textValue"}]};var t=resources.getWebservicesClient().jaxrsPut("x_query_assemble_surface","view/flag/workCompletedByBranch/query/channelTask/execute",JSON.stringify(e));var r=t.getAsJsonObject();return r.get("grid")}function getNumberData(e,t){var r={filterList:[{logic:"and",path:"workId",title:"workId",comparison:"equals",comparisonTitle:"等于",value:e,formatType:"textValue"},{logic:"and",path:"branch",title:"branch",comparison:"equals",comparisonTitle:"等于",value:t,formatType:"textValue"}]};var a=resources.getWebservicesClient().jaxrsPut("x_query_assemble_surface",encodeURI("view/flag/byPhoneNumber/query/channelTask/execute"),JSON.stringify(r));var i=a.get("grid");return i.getAsJsonArray()}function isEmpty(e){if(e===null)return true;var t=e.trim();if(t==='""')return true;if(t.equals('""'))return true;if(t==="")return true;if(t.equals(""))return true;return false}function getPureText(e){if(e===null)return e;if(e.substr(0,1)==='"'){e=e.substr(1,e.length-1)}if(e.substr(e.length-1,1)==='"'){e=e.substr(0,e.length-1)}return e}function ouputNumberList(e,t,r,a){var i=createFile();if(i===null)return null;printLog("输出数据");var n=new java.io.PrintWriter(i,"GBK");n.print(a||e.size());n.write(13);n.write(10);n.write(13);n.write(10);var s=e.iterator();while(s.hasNext()){var o=s.next();var l=o.get("data");var u=getPureText(l.get("subject").toString());n.print(u);n.print("|");n.print(t);n.print("|");n.print(r);n.write(13);n.write(10)}n.close();return i}function init(){var e=Java.type("org.apache.commons.io.FileUtils");var t=getWorkData();print("workList="+t);if(t.size()>0){var r=createRecordFloder()}var a=t.iterator();while(a.hasNext()){var i=a.next();var n=i.get("data");var s=n.get("currentUnit").toString();var o=n.get("provinceWorkId").toString();if(isEmpty(o))o=n.get("cityWorkId").toString();if(isEmpty(o))o=n.get("countyWorkId").toString();if(isEmpty(o))o=n.get("branchWorkId").toString();var l=n.get("branchWorkId").toString();var u=n.get("numberCount").toString();var c=n.get("workCompletedId").toString();c=getPureText(c);print("workId="+o);print("branch="+s);var p=null;if(!isEmpty(o)&&!isEmpty(s)){o=getPureText(o);s=getPureText(s);l=getPureText(l);u=getPureText(u);var g=getNumberData(o,s);if(g.size()>0){p=ouputNumberList(g,o,l,u)}else{print("根据workId="+o+",branch="+s+"未找到号码！")}}if(c&&c!==""&&p!==null){setWorkFlag(c,p.getName());if(r!==null){try{e.copyFileToDirectory(p,r);print("明细文件拷贝到记录文件夹成功："+r.getCanonicalPath())}catch(e){e.printStackTrace();print("明细文件拷贝到记录文件夹出错："+r.getCanonicalPath()+" 错误："+e.getMessage())}}print("根据workId="+o+",branch="+s+"下发明细文件成功！")}}}init();