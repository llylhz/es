MWF.xDesktop.requireApp("process.ProcessManager","Explorer",null,false);MWF.xApplication.portal.PortalManager.SourceExplorer=new Class({Extends:MWF.xApplication.process.ProcessManager.Explorer,Implements:[Options,Events],options:{style:"default",tooltip:{create:MWF.xApplication.portal.PortalManager.LP.source.create,search:MWF.xApplication.portal.PortalManager.LP.source.search,searchText:MWF.xApplication.portal.PortalManager.LP.source.searchText,noElement:MWF.xApplication.portal.PortalManager.LP.source.noNoticeText}},_createElement:function(e){this.pageTemplateList=null;this.defalutPageTemplateList=null;var t=this;var s=function(e,s){layout.desktop.getPageDesignerStyle(function(){var i={style:layout.desktop.pageDesignerStyle,template:s,onQueryLoad:function(){this.actions=t.app.restActions;this.application=t.app.options.application}};layout.desktop.openApplication(e,"portal.SourceDesigner",i)}.bind(this))};var i=function(e,s){layout.desktop.getPageDesignerStyle(function(){var i={style:layout.desktop.pageDesignerStyle,templateId:s,onQueryLoad:function(){this.actions=t.app.restActions;this.application=t.app.options.application}};layout.desktop.openApplication(e,"portal.SourceDesigner",i)}.bind(this))};var o=new Element("div",{styles:this.css.createTemplateMaskNode}).inject(this.app.content);var n=new Element("div",{styles:this.css.createFormTemplateAreaNode}).inject(this.app.content);n.fade("in");var a=new Element("div",{styles:this.css.createTemplateFormTitleNode,text:this.app.lp.createSelectTemplate}).inject(n);var r=new Element("div",{styles:this.css.createTemplateFormCategoryNode}).inject(n);var l=new Element("div",{styles:this.css.createTemplateFormCategoryTitleNode,text:this.app.lp.templateCategory}).inject(r);var p=new Element("div",{styles:this.css.createTemplateFormContentNode}).inject(n);var c=new Element("div",{styles:this.css.createTemplateFormCategoryItemNode,text:this.app.lp.all}).inject(r);c.addEvent("click",function(){v()});this.app.restActions.listPageTemplateCategory(function(e){e.data.each(function(e){var s=new Element("div",{styles:this.css.createTemplateFormCategoryItemNode,text:e.name+"("+e.count+")",value:e.name}).inject(r);s.addEvent("click",function(){p.empty();r.getElements("div").each(function(e,s){if(s>0)e.setStyles(t.css.createTemplateFormCategoryItemNode)});this.setStyles(t.css.createTemplateFormCategoryItemNode_current);f(this.get("value"))})}.bind(this))}.bind(this));var m=function(){var e=this.app.content.getSize();var t=e.y*.1/2;var s=e.x*.1/2;if(t<0)t=0;if(s<0)s=0;n.setStyles({top:""+t+"px",left:""+s+"px"});t=e.y*.9-r.getSize().y-70;p.setStyle("height",""+t+"px")}.bind(this);m();this.app.addEvent("resize",m);var d=function(e){if(this.defalutPageTemplateList){if(e)e()}else{var t="/x_component_portal_PageDesigner/Module/Page/template/templates.json";MWF.getJSON(t,function(t){this.defalutPageTemplateList=t;if(e)e()}.bind(this))}}.bind(this);var h=function(){d(function(){this.defalutPageTemplateList.each(function(e){var i=new Element("div",{styles:this.css.formTemplateNode}).inject(p);var a=new Element("div",{styles:this.css.formTemplateIconNode}).inject(i);var r=new Element("div",{styles:this.css.formTemplateTitleNode,text:e.title}).inject(i);i.store("template",e.name);var l=new Element("img",{styles:this.css.formTemplateIconImgNode}).inject(a);l.set("src","/x_component_portal_PageDesigner/Module/Page/template/"+e.icon);i.addEvents({mouseover:function(){this.setStyles(t.css.formTemplateNode_over)},mouseout:function(){this.setStyles(t.css.formTemplateNode)},mousedown:function(){this.setStyles(t.css.formTemplateNode_down)},mouseup:function(){this.setStyles(t.css.formTemplateNode_over)},click:function(e){s(e,this.retrieve("template"));t.app.removeEvent("resize",m);n.destroy();o.destroy()}})}.bind(this))}.bind(this))}.bind(this);var u=function(e){if(this.pageTemplateList){if(e)e()}else{this.app.restActions.listPageTemplate(function(t){this.pageTemplateList=t.data;if(e)e()}.bind(this))}}.bind(this);var f=function(e){u(function(){Object.each(this.pageTemplateList,function(s,i){var a=e?i==e:true;if(a){s.each(function(e){var s=new Element("div",{styles:this.css.formTemplateNode}).inject(p);var i=new Element("div",{styles:this.css.formTemplatePreviewNode}).inject(s);var a=new Element("div",{styles:this.css.formTemplateTitleNode,text:e.name}).inject(s);s.store("template",e.id);i.set("html",e.outline);var r=new Element("img",{styles:this.css.formTemplateActionNode}).inject(i);r.addEvent("click",function(e){var s=this.getParent().getParent();var i=s.retrieve("template");t.app.confirm("wram",e,t.app.lp.page.deletePageTemplateTitle,t.app.lp.page.deletePageTemplate,300,120,function(){t.app.restActions.deletePageTemplate(i,function(e){s.destroy()}.bind(this));this.close()},function(){this.close()});e.stopPropagation()});s.addEvents({mouseover:function(){this.setStyles(t.css.formTemplateNode_over);if(r)r.setStyle("display","block")},mouseout:function(){this.setStyles(t.css.formTemplateNode);if(r)r.setStyle("display","none")},mousedown:function(){this.setStyles(t.css.formTemplateNode_down)},mouseup:function(){this.setStyles(t.css.formTemplateNode_over)},click:function(e){createForm(e,this.retrieve("template"));t.app.removeEvent("resize",m);n.destroy();o.destroy()}})}.bind(this))}}.bind(this))}.bind(this))}.bind(this);var v=function(){p.empty();r.getElements("div").each(function(e,s){if(s>0)e.setStyles(t.css.createTemplateFormCategoryItemNode)});c.setStyles(t.css.createTemplateFormCategoryItemNode_current);h();f()};v();o.addEvent("click",function(){this.app.removeEvent("resize",m);n.destroy();o.destroy()}.bind(this))},_loadItemDataList:function(e){this.app.restActions.listSource(this.app.options.application.id,e)},_getItemObject:function(e){return new MWF.xApplication.portal.PortalManager.SourceExplorer.Source(this,e)},deleteItems:function(){this.hideDeleteAction();while(this.deleteMarkItems.length){var e=this.deleteMarkItems.shift();if(this.deleteMarkItems.length){e.deleteSource()}else{e.deleteSource(function(){}.bind(this))}}}});MWF.xApplication.portal.PortalManager.SourceExplorer.Source=new Class({Extends:MWF.xApplication.process.ProcessManager.Explorer.Item,_open:function(e){var t=this;var s={onQueryLoad:function(){this.actions=t.explorer.actions;this.category=t;this.options.id=t.data.id;this.application=t.explorer.app.options.application}};this.explorer.app.desktop.openApplication(e,"portal.SourceDesigner",s)},_getIcon:function(){var e=(Math.random()*49).toInt();return"process_icon_"+e+".png"},_getLnkPar:function(){return{icon:this.explorer.path+this.explorer.options.style+"/processIcon/lnk.png",title:this.data.name,par:'portal.SourceDesigner#{"id": "'+this.data.id+'"}'}},deleteSource:function(e){this.explorer.actions.deleteSource(this.data.id,function(){this.node.destroy();if(e)e()}.bind(this))}});