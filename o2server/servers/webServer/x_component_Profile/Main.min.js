MWF.xApplication.Profile.options.multitask=false;MWF.xApplication.Profile.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{style:"default",name:"Profile",icon:"icon.png",width:"800",height:"600",isResize:false,isMax:false,title:MWF.xApplication.Profile.LP.title},onQueryLoad:function(){this.lp=MWF.xApplication.Profile.LP},loadApplication:function(t){this.loadTitle();this.loadContent()},loadTitle:function(){this.loadTitleBar();this.loadTitleUserNode();this.loadTitleTextNode()},loadTitleBar:function(){this.titleBar=new Element("div",{styles:this.css.titleBar}).inject(this.content)},loadTitleUserNode:function(){this.titleUserNode=new Element("div",{styles:this.css.titleUserNode}).inject(this.titleBar);this.titleUserIconNode=new Element("div",{styles:this.css.titleUserIconNode}).inject(this.titleUserNode);this.titleUserTextNode=new Element("div",{styles:this.css.titleUserTextNode,text:this.desktop.session.user.name}).inject(this.titleUserNode)},loadTitleTextNode:function(){this.taskTitleTextNode=new Element("div",{styles:this.css.titleTextNode,text:this.lp.title}).inject(this.titleBar)},loadContent:function(){this.contentNode=new Element("div",{styles:this.css.contentNode}).inject(this.content);MWF.require("MWF.widget.Tab",function(){this.tab=new MWF.widget.Tab(this.contentNode,{style:"profile"});this.tab.load();this.loadInforConfigNode();this.loadLayoutConfigNode();this.loadIdeaConfigNode();this.loadPasswordConfigNode();this.inforConfigPage=this.tab.addTab(this.inforConfigNode,this.lp.inforConfig);this.layoutConfigPage=this.tab.addTab(this.layoutConfigNode,this.lp.layoutConfig);this.ideaConfigPage=this.tab.addTab(this.ideaConfigNode,this.lp.ideaConfig);this.passwordConfigPage=this.tab.addTab(this.passwordConfigNode,this.lp.passwordConfig);if(this.options.tab){this[this.options.tab].showIm()}else{this.inforConfigPage.showIm()}}.bind(this))},loadInforConfigNode:function(){this.inforConfigNode=new Element("div",{styles:this.css.configNode}).inject(this.content);this.inforConfigAreaNode=new Element("div",{styles:this.css.inforConfigAreaNode}).inject(this.inforConfigNode);this.getAction(function(){this.action.getPerson(function(t){this.personData=t.data;var e=this;var s=new Element("div",{styles:this.css.inforLineNode}).inject(this.inforConfigAreaNode);var i=new Element("div",{styles:this.css.inforIconTitleNode,text:this.lp.icon}).inject(s);var n=new Element("div",{styles:this.css.inforIconContentNode}).inject(s);this.contentImgNode=new Element("img",{styles:this.css.inforIconContentImgNode,src:this.action.getPersonIcon()}).inject(n);var o=new Element("div",{styles:this.css.inforChangeIconNode,text:this.lp.changeIcon,events:{click:function(){this.changeIcon()}.bind(this)}}).inject(s);var s=new Element("div",{styles:this.css.inforLineNode}).inject(this.inforConfigAreaNode);var i=new Element("div",{styles:this.css.inforTitleNode,text:this.lp.name}).inject(s);var n=new Element("div",{styles:this.css.inforContentNode,text:t.data.name}).inject(s);var s=new Element("div",{styles:this.css.inforLineNode}).inject(this.inforConfigAreaNode);var i=new Element("div",{styles:this.css.inforTitleNode,text:this.lp.employee}).inject(s);var n=new Element("div",{styles:this.css.inforContentNode,text:t.data.employee}).inject(s);var s=new Element("div",{styles:this.css.inforLineNode}).inject(this.inforConfigAreaNode);var i=new Element("div",{styles:this.css.inforTitleNode,text:this.lp.mail}).inject(s);var n=new Element("div",{styles:this.css.inforContentNode}).inject(s);this.mailInputNode=new Element("input",{styles:this.css.inforContentInputNode,value:t.data.mail,events:{blur:function(){this.setStyles(e.css.inforContentInputNode)},focus:function(){this.setStyles(e.css.inforContentInputNode_focus)}}}).inject(n);var s=new Element("div",{styles:this.css.inforLineNode}).inject(this.inforConfigAreaNode);var i=new Element("div",{styles:this.css.inforTitleNode,text:this.lp.mobile}).inject(s);var n=new Element("div",{styles:this.css.inforContentNode}).inject(s);this.mobileInputNode=new Element("input",{styles:this.css.inforContentInputNode,value:t.data.mobile,events:{blur:function(){this.setStyles(e.css.inforContentInputNode)},focus:function(){this.setStyles(e.css.inforContentInputNode_focus)}}}).inject(n);var s=new Element("div",{styles:this.css.inforLineNode}).inject(this.inforConfigAreaNode);var i=new Element("div",{styles:this.css.inforTitleNode,text:this.lp.officePhone}).inject(s);var n=new Element("div",{styles:this.css.inforContentNode}).inject(s);this.officePhoneInputNode=new Element("input",{styles:this.css.inforContentInputNode,value:t.data.officePhone,events:{blur:function(){this.setStyles(e.css.inforContentInputNode)},focus:function(){this.setStyles(e.css.inforContentInputNode_focus)}}}).inject(n);var s=new Element("div",{styles:this.css.inforLineNode}).inject(this.inforConfigAreaNode);var i=new Element("div",{styles:this.css.inforTitleNode,text:this.lp.weixin}).inject(s);var n=new Element("div",{styles:this.css.inforContentNode}).inject(s);this.weixinInputNode=new Element("input",{styles:this.css.inforContentInputNode,value:t.data.weixin,events:{blur:function(){this.setStyles(e.css.inforContentInputNode)},focus:function(){this.setStyles(e.css.inforContentInputNode_focus)}}}).inject(n);var s=new Element("div",{styles:this.css.inforLineNode}).inject(this.inforConfigAreaNode);var i=new Element("div",{styles:this.css.inforTitleNode,text:this.lp.QQ}).inject(s);var n=new Element("div",{styles:this.css.inforContentNode}).inject(s);this.qqInputNode=new Element("input",{styles:this.css.inforContentInputNode,value:t.data.qq,events:{blur:function(){this.setStyles(e.css.inforContentInputNode)},focus:function(){this.setStyles(e.css.inforContentInputNode_focus)}}}).inject(n);var s=new Element("div",{styles:this.css.inforLineNode}).inject(this.inforConfigAreaNode);var i=new Element("div",{styles:this.css.inforTitleNode,text:this.lp.signature}).inject(s);var n=new Element("div",{styles:this.css.inforContentNode}).inject(s);this.signatureInputNode=new Element("input",{styles:this.css.inforContentInputNode,value:t.data.signature,events:{blur:function(){this.setStyles(e.css.inforContentInputNode)},focus:function(){this.setStyles(e.css.inforContentInputNode_focus)}}}).inject(n);var s=new Element("div",{styles:this.css.inforLineNode}).inject(this.inforConfigAreaNode);this.saveAction=new Element("div",{styles:this.css.saveAction,text:this.lp.saveInfor}).inject(s);this.saveAction.addEvent("click",function(){this.savePersonInfor()}.bind(this))}.bind(this),null,this.desktop.session.user.name)}.bind(this))},changeIcon:function(){var t={};var e="668";var s="510";e=e.toInt();s=s.toInt();var i=this.content.getSize();var n=(i.x-e)/2;var o=(i.y-s)/2;if(n<0)n=0;if(o<0)o=0;if(layout.mobile){n=20;o=0}var a=this;MWF.require("MWF.xDesktop.Dialog",function(){MWF.require("MWF.widget.ImageClipper",function(){var t=new MWF.xDesktop.Dialog({title:this.lp.changePersonIcon,style:"image",top:o,left:n-20,fromTop:o,fromLeft:n-20,width:e,height:s,html:"<div></div>",maskNode:this.content,container:this.content,buttonList:[{text:MWF.LP.process.button.ok,action:function(){a.image.uploadImage(function(t){a.action.getPerson(function(t){if(t.data){this.personData=t.data;a.contentImgNode.set("src",a.action.getPersonIcon())}this.close()}.bind(this))}.bind(this),null)}},{text:MWF.LP.process.button.cancel,action:function(){a.image=null;this.close()}}]});t.show();this.image=new MWF.widget.ImageClipper(t.content.getFirst(),{aspectRatio:1,description:"",imageUrl:this.action.getPersonIcon(),resetEnable:false,data:null,parameter:null,action:this.action.action,method:"changeIcon"});this.image.load()}.bind(this))}.bind(this))},uploadPersonIcon:function(){if(this.image){if(this.image.getResizedImage()){this.action.changeIcon(function(){this.action.getPerson(function(t){if(t.data){this.personData=t.data;this.contentImgNode.set("src",this.action.getPersonIcon())}}.bind(this))}.bind(this),null,this.image.getFormData(),this.image.resizedImage)}}},savePersonInfor:function(){this.personData.officePhone=this.officePhoneInputNode.get("value");this.personData.mail=this.mailInputNode.get("value");this.personData.mobile=this.mobileInputNode.get("value");this.personData.weixin=this.weixinInputNode.get("value");this.personData.qq=this.qqInputNode.get("value");this.personData.signature=this.signatureInputNode.get("value");this.action.updatePerson(this.personData,function(){this.notice(this.lp.saveInforOk,"success")}.bind(this))},loadLayoutConfigNode:function(){this.layoutConfigNode=new Element("div",{styles:this.css.configNode}).inject(this.content);new Element("div",{styles:this.css.layoutTitleNode,text:this.lp.layoutAction}).inject(this.layoutConfigNode);var t=new Element("div",{styles:this.css.buttonNodeArea}).inject(this.layoutConfigNode);this.clearDataAction=new Element("div",{styles:this.css.clearDataAction,text:this.lp.clear}).inject(t);this.clearDataAction.addEvent("click",function(){MWF.require("MWF.widget.UUID",function(){debugger;MWF.UD.deleteData("layout",function(){this.notice(this.lp.clearok,"success");this.desktop.notRecordStatus=true}.bind(this))}.bind(this))}.bind(this));if(MWF.AC.isAdministrator()){var e=new Element("div",{styles:{overflow:"hidden",clear:"left"}}).inject(t);this.defaultDataAction=new Element("div",{styles:this.css.setDefaultDataAction,text:this.lp.setDefault}).inject(e);this.defaultDataAction.addEvent("click",function(){MWF.require("MWF.widget.UUID",function(){var t=this.lp.setDefaultOk;this.close();var e=layout.desktop.getLayoutStatusData();MWF.UD.putPublicData("defaultLayout",e,function(){MWF.xDesktop.notice("success",{x:"right",y:"top"},t,layout.desktop.desktopNode)}.bind(this))}.bind(this))}.bind(this));this.clearDefaultDataAction=new Element("div",{styles:this.css.setDefaultDataAction,text:this.lp.clearDefault}).inject(e);this.clearDefaultDataAction.addEvent("click",function(){MWF.require("MWF.widget.UUID",function(){MWF.UD.deletePublicData("defaultLayout",function(){this.notice(this.lp.clearok,"success");this.desktop.notRecordStatus=true}.bind(this))}.bind(this))}.bind(this));this.forceDataAction=new Element("div",{styles:this.css.setDefaultDataAction,text:this.lp.setForce}).inject(t);this.forceDataAction.setStyle("float","left");this.forceDataAction.addEvent("click",function(){MWF.require("MWF.widget.UUID",function(){var t=this.lp.setForceOk;this.close();var e=layout.desktop.getLayoutStatusData();MWF.UD.putPublicData("forceLayout",e,function(){MWF.xDesktop.notice("success",{x:"right",y:"top"},t,layout.desktop.desktopNode)}.bind(this))}.bind(this))}.bind(this));this.deleteForceDataAction=new Element("div",{styles:this.css.setDefaultDataAction,text:this.lp.clearForce}).inject(t);this.deleteForceDataAction.addEvent("click",function(){MWF.require("MWF.widget.UUID",function(){MWF.UD.deletePublicData("forceLayout",function(){this.notice(this.lp.clearok,"success");this.desktop.notRecordStatus=true}.bind(this))}.bind(this))}.bind(this))}new Element("div",{styles:this.css.layoutTitleNode,text:this.lp.desktopBackground}).inject(this.layoutConfigNode);var s=new Element("div",{styles:this.css.buttonNodeArea}).inject(this.layoutConfigNode);this.loadDesktopBackground(s)},loadDesktopBackground:function(t){var e=layout.desktop.options.style;MWF.UD.getDataJson("layoutDesktop",function(t){if(t)e=t.src}.bind(this),false);MWF.getJSON(layout.desktop.path+"styles.json",function(s){s.each(function(s){var i=MWF.defaultPath+"/xDesktop/$Layout/"+s.style+"/preview.jpg";var n=new Element("div",{styles:this.css.previewBackground}).inject(t);if(e==s.style){n.setStyles({border:"4px solid #ffea00"})}new Element("img",{src:i}).inject(n);n.store("dskimg",s.style);var o=this;n.addEvent("click",function(){o.selectDesktopImg(this,t)})}.bind(this))}.bind(this));if(MWF.AC.isAdministrator()){}},selectDesktopImg:function(t,e){var s=t.retrieve("dskimg");MWF.UD.putData("layoutDesktop",{src:s},function(){e.getChildren().each(function(t){t.setStyles({border:"4px solid #eeeeee"})}.bind(this));t.setStyles({border:"4px solid #ffea00"});var i=MWF.defaultPath+"/xDesktop/$Layout/"+s+"/desktop.jpg";layout.desktop.node.setStyle("background-image","url("+i+")")}.bind(this))},loadIdeaConfigNode:function(){this.ideaConfigNode=new Element("div",{styles:this.css.configNode}).inject(this.content);this.ideasArea=new Element("textarea",{styles:this.css.ideasArea}).inject(this.ideaConfigNode);this.ideasSaveAction=new Element("div",{styles:this.css.ideasSaveAction,text:this.lp.saveIdea}).inject(this.ideaConfigNode);if(MWF.AC.isAdministrator()){this.ideasSaveDefaultAction=new Element("div",{styles:this.css.ideasSaveAction,text:this.lp.saveIdeaDefault}).inject(this.ideaConfigNode);this.ideasSaveDefaultAction.addEvent("click",function(){MWF.require("MWF.widget.UUID",function(){var t={};t.ideas=this.ideasArea.get("value").split("\n");MWF.UD.putPublicData("idea",t,function(){this.notice(this.lp.ideaSaveOk,"success")}.bind(this))}.bind(this))}.bind(this))}MWF.require("MWF.widget.UUID",function(){MWF.UD.getDataJson("idea",function(t){if(t){if(t.ideas)this.ideasArea.set("value",t.ideas.join("\n"))}}.bind(this))}.bind(this));this.ideasSaveAction.addEvent("click",function(){MWF.require("MWF.widget.UUID",function(){var t={};t.ideas=this.ideasArea.get("value").split("\n");MWF.UD.putData("idea",t,function(){this.notice(this.lp.ideaSaveOk,"success")}.bind(this))}.bind(this))}.bind(this))},loadPasswordConfigNode:function(){this.passwordConfigNode=new Element("div",{styles:this.css.configNode});this.passwordConfigAreaNode=new Element("div",{styles:this.css.inforConfigAreaNode}).inject(this.passwordConfigNode);var t=this;var e=new Element("div",{styles:this.css.inforLineNode}).inject(this.passwordConfigAreaNode);var s=new Element("div",{styles:this.css.inforTitleNode,text:this.lp.oldPassword}).inject(e);var i=new Element("div",{styles:this.css.inforContentNode}).inject(e);this.oldPasswordInputNode=new Element("input",{type:"password",styles:this.css.inforContentInputNode,events:{blur:function(){this.setStyles(t.css.inforContentInputNode)},focus:function(){this.setStyles(t.css.inforContentInputNode_focus)}}}).inject(i);var e=new Element("div",{styles:this.css.inforLineNode}).inject(this.passwordConfigAreaNode);var s=new Element("div",{styles:this.css.inforTitleNode,text:this.lp.password}).inject(e);var i=new Element("div",{styles:this.css.inforContentNode}).inject(e);this.passwordInputNode=new Element("input",{type:"password",styles:this.css.inforContentInputNode,events:{blur:function(){this.setStyles(t.css.inforContentInputNode)},focus:function(){this.setStyles(t.css.inforContentInputNode_focus)},keyup:function(){this.checkPassowrdStrength(this.passwordInputNode.get("value"))}.bind(this)}}).inject(i);var e=new Element("div",{styles:this.css.inforLineNode}).inject(this.passwordConfigAreaNode);var s=new Element("div",{styles:this.css.inforTitleNode}).inject(e);this.passwordRemindContainer=new Element("div",{styles:this.css.inforContentNode}).inject(e);var e=new Element("div",{styles:this.css.inforLineNode}).inject(this.passwordConfigAreaNode);var s=new Element("div",{styles:this.css.inforTitleNode,text:this.lp.morePassword}).inject(e);var i=new Element("div",{styles:this.css.inforContentNode}).inject(e);this.morePasswordInputNode=new Element("input",{type:"password",styles:this.css.inforContentInputNode,events:{blur:function(){this.setStyles(t.css.inforContentInputNode)},focus:function(){this.setStyles(t.css.inforContentInputNode_focus)}}}).inject(i);var e=new Element("div",{styles:this.css.inforLineNode}).inject(this.passwordConfigAreaNode);this.saveAction=new Element("div",{styles:this.css.saveAction,text:this.lp.passwordConfig}).inject(e);this.saveAction.addEvent("click",function(){this.changePassword()}.bind(this));this.createPasswordStrengthNode();this.passworRemindNode=new Element("div",{styles:this.css.passwordRemindNode,text:this.lp.paswordRule}).inject(this.passwordRemindContainer)},changePassword:function(){var t=this.oldPasswordInputNode.get("value");var e=this.passwordInputNode.get("value");var s=this.morePasswordInputNode.get("value");if(e!=s){this.notice(this.lp.passwordNotMatch,"error");this.passwordInputNode.setStyles(this.css.inforContentInputNode_error);this.morePasswordInputNode.setStyles(this.css.inforContentInputNode_error)}else{this.action.changePassword(t,e,s,function(){this.oldPasswordInputNode.set("value","");this.passwordInputNode.set("value","");this.morePasswordInputNode.set("value","");this.notice(this.lp.changePasswordOk,"success")}.bind(this));if(layout.config.mail){var i="http://"+layout.config.mail+"//names.nsf?changepassword&password="+encodeURIComponent(t)+"&passwordnew="+encodeURIComponent(e)+"&passwordconfirm="+encodeURIComponent(e);var n=new Element("iframe",{styles:{display:"none"}}).inject(this.desktop.desktopNode);n.set("src",i);window.setTimeout(function(){n.destroy()}.bind(this),2e3)}}},getAction:function(t){if(!this.acrion){this.action=MWF.Actions.get("x_organization_assemble_personal");if(t)t()}else{if(t)t()}},createPasswordStrengthNode:function(){var t=this.passwordRemindContainer;var e=new Element("div",{styles:this.css.passwordStrengthNode}).inject(t);this.lowColorNode=new Element("div",{styles:this.css.passwordStrengthColor}).inject(e);this.lowTextNode=new Element("div",{styles:this.css.passwordStrengthText,text:this.lp.weak}).inject(e);var s=new Element("div",{styles:this.css.passwordStrengthNode}).inject(t);this.middleColorNode=new Element("div",{styles:this.css.passwordStrengthColor}).inject(s);this.middleTextNode=new Element("div",{styles:this.css.passwordStrengthText,text:this.lp.middle}).inject(s);var i=new Element("div",{styles:this.css.passwordStrengthNode}).inject(t);this.highColorNode=new Element("div",{styles:this.css.passwordStrengthColor}).inject(i);this.highTextNode=new Element("div",{styles:this.css.passwordStrengthText,text:this.lp.high}).inject(i)},getPasswordLevel:function(t,e){this.getAction(function(){this.action.checkPassword(t,function(t){debugger;if(e)e(t.data.value)}.bind(this),null,false)}.bind(this))},checkPassowrdStrength:function(t){this.lowColorNode.setStyles(this.css.passwordStrengthColor);this.lowTextNode.setStyles(this.css.passwordStrengthText);this.middleColorNode.setStyles(this.css.passwordStrengthColor);this.middleTextNode.setStyles(this.css.passwordStrengthText);this.highColorNode.setStyles(this.css.passwordStrengthColor);this.highTextNode.setStyles(this.css.passwordStrengthText);if(t==null||t==""){}else{this.getPasswordLevel(t,function(t){switch(t){case 0:case 1:case 2:case 3:this.lowColorNode.setStyles(this.css.passwordStrengthColor_low);this.lowTextNode.setStyles(this.css.passwordStrengthText_current);break;case 4:case 5:case 6:this.middleColorNode.setStyles(this.css.passwordStrengthColor_middle);this.middleTextNode.setStyles(this.css.passwordStrengthText_current);break;default:this.highColorNode.setStyles(this.css.passwordStrengthColor_high);this.highTextNode.setStyles(this.css.passwordStrengthText_current)}}.bind(this))}}});