MWF.xApplication.Strategy=MWF.xApplication.Strategy||{};MWF.xDesktop.requireApp("Template","MDomItem",null,false);MWF.xDesktop.requireApp("Strategy","Template",null,false);MWF.require("MWF.widget.Identity",null,false);MWF.xApplication.Strategy.MeasureList=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default"},initialize:function(t,e,i,s){this.setOptions(s);this.app=e;this.lp=e.lp.measure;this.path="/x_component_Strategy/$MeasureList/";this.loadCss();this.actions=i;this.node=$(t)},loadCss:function(){this.cssPath=this.path+this.options.style+"/css.wcss";this._loadCss()},load:function(){this.allArrowArr=[];this.node.addEvents({click:function(){if(this.listContentDiv){$(this.listContentDiv).destroy()}if(this.allArrowArr.length>0){this.allArrowArr.each(function(t){$(t).setStyles({background:"url(/x_component_Strategy/$Template/default/icons/arrow.png) no-repeat center"})}.bind(this))}}.bind(this)});this.createYearContent(function(){this.resizeContent()}.bind(this));this.app.addEvent("resize",function(){this.resizeContent()}.bind(this))},reload:function(t){this.currentYear=t;this.createYearContent()},createYearContent:function(t){this.node.empty();this.yearContent=new Element("div.yearContent",{styles:this.css.yearContent}).inject(this.node);this.yearContentList=new Element("div.yearContentList",{styles:this.css.yearContentList}).inject(this.yearContent);this.actions.getMeasureListYear(function(e){if(e.type=="success"){if(e.data&&e.data.valueList){this.yearList=e.data.valueList;this.yearList.each(function(t,e){if(e<3){new Element("div.year",{styles:this.css.year,value:t,name:t,text:t}).inject(this.yearContentList).addEvents({click:function(){this.changeYearSelected(t);this.openList(t)}.bind(this)})}}.bind(this));if(this.yearList.length>3){new Element("div.yearMore",{styles:this.css.year,id:"yearMore"}).inject(this.yearContentList).setStyles({width:"30px"}).set({text:"..."}).addEvents({click:function(){this.expandYears()}.bind(this)})}if(this.currentYear){if(this.yearContentList.getElements("div[name='"+this.currentYear+"']").length>0){this.yearContentList.getElements("div[name='"+this.currentYear+"']")[0].click()}}else{if(this.yearContentList.getElements("div").length>0){this.yearContentList.getElements("div")[0].click()}}if(t)t()}}}.bind(this))},expandYears:function(){this.yearContentList.getElementById("yearMore").destroy();this.yearList.each(function(t,e){if(e>2){new Element("div.year",{styles:this.css.year,value:t,name:t,text:t}).inject(this.yearContentList).addEvents({click:function(){this.changeYearSelected(t);this.openList(t)}.bind(this)})}}.bind(this))},openList:function(t){this.currentYear=t;this.createSearch();this.createViewContent();this.resizeContent()},changeYearSelected:function(t){this.yearContentList.getElements("div").each(function(e){if(e.get("text")==t){e.setStyles({"background-color":"#4990E2",color:"#FFFFFF"})}else{e.setStyles({"background-color":"",color:"#666666"})}}.bind(this))},createSearch:function(){if(this.searchContent)this.searchContent.destroy();this.searchContent=new Element("div.searchContent",{styles:this.css.searchContent}).inject(this.node);this.searchBar=new Element("div.searchBar",{styles:this.css.searchBar}).inject(this.searchContent);this.searchIn=new Element("input.searchIn",{styles:this.css.searchIn,placeholder:this.lp.defaultSearchIn}).inject(this.searchBar).addEvents({keydown:function(t){if(this.searchIn.get("value")!=""&&t.event.keyCode=="13"){this.searchReset.setStyles({display:""});this.createViewContent({measuresinfotitle:this.searchIn.get("value")})}}.bind(this)});this.searchImg=new Element("div.searchImg",{styles:this.css.searchImg}).inject(this.searchBar);this.searchImg.addEvents({click:function(){if(this.searchIn.get("value")!=""){this.searchReset.setStyles({display:""});this.createViewContent({measuresinfotitle:this.searchIn.get("value")})}}.bind(this)});this.searchReset=new Element("div.searchReset",{styles:this.css.searchReset}).inject(this.searchBar).addEvents({click:function(){this.searchIn.set("value","");this.searchReset.setStyles({display:"none"});this.createViewContent()}.bind(this)});this.searchDeptBar=new Element("div.searchDeptBar",{styles:this.css.searchDeptBar}).inject(this.searchContent);this.searchDeptLabel=new Element("div.searchDeptBar",{styles:this.css.searchDeptLabel,text:this.lp.deptList}).inject(this.searchDeptBar);this.searchDeptList=new Element("div.searchDeptList",{styles:this.css.searchDeptList}).inject(this.searchDeptBar);var t={width:230,height:30};this.searchDeptSelector=new MWF.xApplication.Strategy.Template.Select(this.searchDeptList,this,this.actions,t);this.searchDeptSelector.load();this.actions.getMeasureDepartmentByYear(this.currentYear,function(t){if(t.type=="success"&&t.data.valueList){this.searchDeptSelector.setDeptList(t.data.valueList,function(t){this.createViewContent({deptlist:[t]},this.currentCountPerPage)}.bind(this))}}.bind(this))},createViewContent:function(t,e,i){this.searchObj=t;this.perPageJson={text:this.app.lp.template.paging.perPageText.split(","),value:this.app.lp.template.paging.perPageValue.split(",")};this.currentCountPerPage=e||this.perPageJson.value[0];if(this.viewContent)this.viewContent.destroy();this.viewContent=new Element("div.viewContent",{styles:this.css.viewContent}).inject(this.node);this.viewContentList=new Element("div.viewContentList",{styles:this.css.viewContentList}).inject(this.viewContent);this.createPageContent();this.filter={measuresinfoyear:this.currentYear,ordersymbol:"ASC"};for(var s in t){if(t[s]!=this.app.lp.template.defaultSelect){this.filter[s]=t[s]}}var n=this.path+"Measure.json";this.view=new MWF.xApplication.Strategy.MeasureList.View(this.viewContentList,this.app,{lp:this.lp.view,css:this.css,actions:this.actions},{pagingEnable:true,pagingPar:{currentPage:i||this.options.viewPageNum,countPerPage:this.currentCountPerPage||this.perPageJson.value[0],hasJumper:false,hasNextPage:false,hasReturn:false,position:["bottom"],hiddenWithDisable:false,text:{prePage:this.app.lp.template.paging.prePage,nextPage:this.app.lp.template.paging.nextPage,firstPage:this.app.lp.template.paging.firstPage,lastPage:this.app.lp.template.paging.lastPage},onPostLoad:function(){if(this.view&&this.view.paging){this.perPageChangeContent=new Element("div.perPageChangeContent",{styles:this.css.perPageChangeContent}).inject(this.view.paging.node);this.countPerPageItem=new MDomItem(this.perPageChangeContent,{name:"countPerPageSelect",type:"select",selectValue:this.perPageJson.value,selectText:this.perPageJson.text,defaultValue:this.currentCountPerPage||this.perPageJson.value[0],attr:{style:"border-radius:2px;border:1px solid #cccccc;height:24px"},event:{change:function(t,e){if(t.get("value")!=""){this.currentCountPerPage=t.get("value");this.createViewContent(this.searchObj,t.get("value"))}}.bind(this)}},this,this.app,this.css);this.countPerPageItem.load()}}.bind(this)},templateUrl:n,filterData:this.filter});this.view.pagingContainerBottom=this.pageContent;this.view.load();this.resizeContent()},createPageContent:function(){if(this.pageContent)$(this.pageContent).destroy();this.pageContent=new Element("div.pageContent",{styles:this.css.pageContent}).inject(this.viewContent)},dragItemData:function(){var t=new Sortables("tabBody",{clone:true,opacity:.3,onStart:function(t,e){e.setStyles({position:"absolute","margin-top":160-this.viewContentList.getScrollTop()+"px",border:"1px dotted #000",width:this.viewContentList.getWidth()-10+"px",height:t.getHeight()+"px",overflow:"hidden","max-height":t.getHeight()+"px"})}.bind(this),onSort:function(t,e){}.bind(this),onComplete:function(e){var i=e.get("id");var s=t.serialize();var n={ordersymbol:this.filter.ordersymbol,ids:s}}.bind(this)})},resizeContent:function(){var t=this.node.getSize();if(this.yearContentList.getElements("div").length>0){var e=this.searchContent.getSize();this.searchBar.setStyles({width:e.x-this.searchDeptBar.getWidth()-100+"px"});this.viewContent.setStyles({height:t.y-this.yearContent.getHeight()-this.searchContent.getHeight()+"px"});this.viewContentList.setStyles({height:this.viewContent.getHeight()-this.pageContent.getHeight()-20+"px",width:this.viewContent.getWidth-60+"px"})}}});MWF.xApplication.Strategy.MeasureList.View=new Class({Extends:MWF.xApplication.Strategy.Template.view,_createDocument:function(t){return new MWF.xApplication.Strategy.MeasureList.Document(this.viewBodyNode,t,this.explorer,this)},_getCurrentPageData:function(t,e,i){this.clearBody();if(!e)e=10;if(!i)i=1;var s=this.options.filterData||{};this.actions.getMeasureListPage(i,e,s,function(e){if(t)t(e);if(!(this.app.measureList.filter.deptlist||this.app.measureList.filter.measuresinfotitle)){this.app.measureList.dragItemData()}this.app.destroyShade()}.bind(this))},_removeDocument:function(t){},_create:function(){},_openDocument:function(t){MWF.xDesktop.requireApp("Strategy","MeasureForm",function(){this.MeasureForm=new MWF.xApplication.Strategy.MeasureForm(this,this.actions,{id:t.id,maxAction:true},{isEdited:false});this.MeasureForm.load()}.bind(this))},_queryCreateViewNode:function(){},_postCreateViewNode:function(){},_queryCreateViewHead:function(){},_postCreateViewHead:function(t){}});MWF.xApplication.Strategy.MeasureList.Document=new Class({Extends:MWF.xApplication.Strategy.Template.Document,openActionReturn:function(t){var e=false;if(t.actions&&t.actions.length==1){e=true}return e},editActionReturn:function(t){var e=false;if(t.actions&&t.actions.indexOf("EDIT")>-1)e=true;return e},deleteActionReturn:function(t){var e=false;if(t.actions&&t.actions.indexOf("DELETE")>-1)e=true;return e},action_open:function(){MWF.xDesktop.requireApp("Strategy","MeasureForm",function(){this.MeasureForm=new MWF.xApplication.Strategy.MeasureForm(this,this.actions,{id:this.data.id},{isEdited:false});this.MeasureForm.load()}.bind(this))},action_edit:function(){MWF.xDesktop.requireApp("Strategy","MeasureForm",function(){this.Measureform=new MWF.xApplication.Strategy.MeasureForm(this,this.app.actions,{id:this.data.id},{isNew:false,isEdited:true,onPostSave:function(){var t=this.app.measureList;var e={};var i=t.searchIn.get("value");if(i!=""){e.measuresinfotitle=i}var s=t.searchDeptList.get("unit");if(s){e.deptlist=[s]}t.createViewContent(e,t.currentCountPerPage,t.view.currentPage)}.bind(this)});this.Measureform.load()}.bind(this))},action_delete:function(t){var e=this;e.view.app.confirm("warn",t,e.view.app.lp.measure.submitWarn.title,e.view.app.lp.measure.submitWarn.content.deleted,300,120,function(){e.actions.deleteMeasure(e.data.id,function(t){if(t.type&&t.type=="success"){this.app.notice(e.view.app.lp.prompt.measure.deleteOK,"success");e.app.measureList.openList(this.app.measureList.currentYear)}}.bind(e));this.close()},function(){this.close()})},_postCreateDocumentNode:function(t,e){t.set("id",e.id);if(!this.openActionReturn(e)){t.getElements("[item='action_open']").destroy()}if(!this.editActionReturn(e)){t.getElements("[item='action_edit']").destroy()}if(!this.deleteActionReturn(e)){t.getElements("[item='action_delete']").destroy()}}});