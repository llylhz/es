MWF.xApplication.Strategy=MWF.xApplication.Strategy||{};MWF.xDesktop.requireApp("Strategy","Template",null,false);MWF.xDesktop.requireApp("Template","MPopupForm",null,false);MWF.xDesktop.requireApp("Template","MForm",null,false);MWF.xDesktop.requireApp("Strategy","Attachment",null,false);MWF.xApplication.Strategy.MeasureForm=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"default",width:"90%",height:"100%",hasTop:true,hasIcon:false,hasBottom:false,title:"",draggable:false,maxAction:true,closeAction:true},initialize:function(t,e,s,i){this.setOptions(i);this.explorer=t;this.app=t.app;this.lp=this.app.lp.measure.popupForm;this.actions=this.app.restActions;this.path="/x_component_Strategy/$MeasureForm/";this.cssPath=this.path+this.options.style+"/css.wcss";this._loadCss();this.options.title=this.lp.title;this.defaultYear=this.options.year;this.data=s||{};this.actions=e},load:function(){var t=new Date;this.thisYear=t.getFullYear();if(this.options.isNew){this.create()}else if(this.options.isEdited){this.edit()}else{this.open()}},createTopNode:function(){if(!this.formTopNode){this.formTopNode=new Element("div.formTopNode",{styles:this.css.formTopNode}).inject(this.formNode);this.formTopTextNode=new Element("div",{styles:this.css.formTopTextNode,text:this.data.title?this.data.title:this.lp.addTitle}).inject(this.formTopNode);if(this.options.closeAction){this.formTopCloseActionNode=new Element("div",{styles:this.css.formTopCloseActionNode}).inject(this.formTopNode);this.formTopCloseActionNode.addEvent("click",function(){this.close()}.bind(this))}this._createTopContent()}},_createTopContent:function(){},_createTableContent:function(){if(this.data.parentid){this.actions.getMeasureMaxNumber(this.data.parentid,function(t){if(t.type=="success"){if(t.data&&t.data.value){this.data.sequencenumber=t.data.value}}}.bind(this),null,false)}this.getData(function(){this.createTableInfo()}.bind(this))},getData:function(t){if(!this.options.isNew){if(this.data.id){this.id=this.data.id}else if(this.options.id){this.id=this.options.id}this.actions.getMeasureById(this.id,function(e){if(e.type=="success"){this.data=e.data;this.formTopTextNode.set("text",this.data.measuresinfotitle);if(e.data.measuresinfoyear){this.currentYear=e.data.measuresinfoyear}if(t)t()}}.bind(this))}else{if(t)t()}},createTableInfo:function(){var t="<table width='100%' border='0' cellpadding='5' cellspacing='0' styles='formTable'>"+"<tr>"+"   <td styles='formTableTitle' lable='sequencenumber'></td>"+"   <td styles='formTableValue' item='sequencenumber'></td>"+"</tr>"+"<tr>"+"   <td styles='formTableTitle' lable='measuresinfotitle'></td>"+"   <td styles='formTableValue' item='measuresinfotitle'></td>"+"</tr>"+"<tr>"+"   <td styles='formTableTitle' lable='measuresyear'></td>"+"   <td styles='formTableYearValue' item='measuresyear'></td>"+"</tr>"+"<tr>"+"   <td styles='formTableTitle' lable='deptlist'></td>"+"   <td styles='formTableValue' item='measuresdutydept'></td>"+"</tr>"+"<tr>"+"   <td styles='formTableTitle' lable='measuresdutydept'></td>"+"   <td styles='formTableValue' item='deptlist'></td>"+"</tr>"+"<tr>"+"   <td styles='formTableTitle' lable='measuressupportdepts'></td>"+"   <td styles='formTableValue' item='measuressupportdepts'></td>"+"</tr>"+"<tr>"+"   <td styles='formTableTitle' lable='measuresinfoparentid'></td>"+"   <td styles='formTableValue'><div styles='keyWorkList' item='measuresinfoparentid' id='keyWorkList'></div></td>"+"</tr>"+"<tr>"+"   <td styles='formTableTitle' lable='measuresinfodescribe'></td>"+"   <td styles='formTableValue' item='measuresinfodescribe'></td>"+"</tr>"+"<tr>"+"   <td styles='formTableTitle' lable='measuresinfotargetvalue'></td>"+"   <td styles='formTableValue' item='measuresinfotargetvalue'></td>"+"</tr>"+"</table>";this.formTableArea.set("html",t);if(this.options.isEdited||this.options.isNew){this.getKeyWorkList(this.currentYear||this.defaultYear||this.thisYear,function(){this.loadForm()}.bind(this));this.createActionBar()}else{this.loadForm()}},getKeyWorkList:function(t,e){this.keyWorkListTitle=[];this.keyWorkListId=[];this.actions.getKeyWorkListNext("(0)",100,{strategydeployyear:t||this.thisYear},function(t){if(t.type=="success"){t.data.each(function(t){this.keyWorkListTitle.push(t.strategydeploytitle);this.keyWorkListId.push(t.id)}.bind(this));if(e)e()}}.bind(this))},loadForm:function(){this.measureForm=new MForm(this.formTableArea,this.data,{style:"default",isEdited:this.isEdited||this.isNew,itemTemplate:this.getItemTemplate(this.lp)},this.app,this.css);this.measureForm.load();if(!(this.options.isEdited||this.options.isNew)||this.options.from&&this.options.from=="portal"){var t=this.formTableArea.getElementById("keyWorkList");if(t){t.setStyles({border:"0px","min-height":"0px"});t.set("html","");this.keyWorkItem=new Element("div.keyWorkItem",{name:"measuresinfoparentid",styles:{cursor:"pointer"}}).inject(t);this.actions.getKeyWorkById(this.data.measuresinfoparentid,function(t){if(t.type=="success"&&t.data&&t.data.strategydeploytitle){this.keyWorkItem.set("text",t.data.strategydeploytitle);this.keyWorkItem.addEvents({click:function(){MWF.xDesktop.requireApp("Strategy","KeyWorkForm",function(){var t=this.options.width||"100%";var e=this.options.height||"100%";this.KeyWorkForm=new MWF.xApplication.Strategy.KeyWorkForm(this,this.actions,{id:this.data.measuresinfoparentid},{isEdited:false,width:isNaN(t)?parseInt(t)-10+"%":t-50,height:isNaN(e)?parseInt(e)-10+"%":e-50});this.KeyWorkForm.container=this.app.portalContainer||this.app.content;this.KeyWorkForm.load()}.bind(this))}.bind(this)})}}.bind(this))}}var e=this.formTableArea.getElements("textarea");e.setStyles({height:"100px"})},getItemTemplate:function(t){_self=this;return{sequencenumber:{text:t.sequencenumber+":",name:"sequencenumber",notEmpty:true},measuresinfotitle:{text:t.title+":",notEmpty:true},measuresyear:{text:t.year+":",notEmpty:true,type:this.options.isNew?"select":"innerText",value:this.currentYear||this.defaultYear||this.thisYear,attr:{style:"width:100%;height:30px;border-radius:3px;"},selectValue:t.selectYears.split(","),selectText:t.selectYears.split(","),event:{change:function(t){var e=t.getValue();_self.currentYear=e;_self.getKeyWorkList(e,function(){_self.loadForm()})}}},deptlist:{text:t.department+":",notEmpty:true,type:"org",orgType:"unit",name:"deptlist",count:0,attr:{readonly:true}},measuresdutydept:{text:t.resDepartment+":",notEmpty:true,type:"org",orgType:"unit",name:"measuresdutydept",count:1,attr:{readonly:true}},measuressupportdepts:{text:t.measuressupportdepts+":",notEmpty:true,type:"text",name:"measuressupportdepts",attr:{}},measuresinfoparentid:{text:t.keyWork+":",isEdited:this.options.from=="portal"?false:true,name:"measuresinfoparentid",notEmpty:true,type:"radio",style:{height:"25px"},event:{click:function(t){var e=typeof t["getValue"];if(e=="function"){var s=t.getValue();if(s){_self.actions.getMeasureMaxNumber(s,function(t){if(t.type=="success"){if(t.data&&t.data.value){var e=_self.formTableArea.getElements("[name='sequencenumber']");e[0].set("value",t.data.value)}}}.bind(this))}}}},selectText:this.keyWorkListTitle?this.keyWorkListTitle.join("##").split("##"):"",selectValue:this.keyWorkListId?this.keyWorkListId.join("##").split("##"):""},measuresinfodescribe:{type:"textarea",attr:{style:"height:100px"},text:t.description+":"},measuresinfotargetvalue:{type:"textarea",attr:{style:"height:100px"},text:t.measuresinfotargetvalue+":"}}},loadAttachment:function(t){},createActionBar:function(){this.actionContent=new Element("div.actionContent",{styles:this.css.actionContent}).inject(this.formTableContainer);this.actionBar=new Element("div.actionBar",{styles:this.css.actionBar}).inject(this.actionContent);this.saveAction=new Element("div.saveAction",{styles:this.css.saveAction,text:this.lp.saveAction}).inject(this.actionBar).addEvents({click:function(){this.save()}.bind(this)});this.cancelAction=new Element("div.cancelAction",{styles:this.css.cancelAction,text:this.lp.cancelAction}).inject(this.actionBar).addEvents({click:function(){this.close()}.bind(this)})},save:function(t){var e=this.data.measuresinfoparentid;var s=this.measureForm.getResult(true,",",true,false,true);if(s){this.app.createShade();if(this.options.from=="portal"){s.measuresinfoparentid=this.data.measuresinfoparentid||e}s.deptlist=s.deptlist.split(",");s.measuresinfoyear=s.measuresyear;this.actions.saveMeasure(s,function(e){if(e.type=="success"){this.close();this.fireEvent("postSave",e)}else if(e.type=="error"){this.app.notice(e.message,"error")}this.app.destroyShade();if(t)t()}.bind(this),function(t,e,s){this.app.showErrorMessage(t,e,s);this.app.destroyShade()}.bind(this))}},createShade:function(t,e){var s=this.content;var i=t||s;var a=e||"loading...";if(this.shadeDiv){this.shadeDiv.destroy()}if(this["shadeTxtDiv"])this["shadeTxtDiv"].destroy();this.shadeDiv=new Element("div.shadeDiv").inject(i);this.inforDiv=new Element("div.inforDiv",{styles:{height:"16px",display:"inline-block",position:"absolute","background-color":"#000000","border-radius":"3px",padding:"5px 10px"}}).inject(this.shadeDiv);this.loadImg=new Element("img.loadImg",{styles:{width:"16px",height:"16px",float:"left"},src:this.path+"default/icon/loading.gif"}).inject(this.inforDiv);this.shadeTxtSpan=new Element("span.shadeTxtSpan").inject(this.inforDiv);this.shadeTxtSpan.set("text",a);this.shadeDiv.setStyles({width:"100%",height:"100%",position:"absolute",opacity:"0.6","background-color":"#cccccc","z-index":"999"});this.shadeTxtSpan.setStyles({color:"#ffffff","font-size":"12px",display:"inline-block","line-height":"16px","padding-left":"5px"});var o=i.getSize().x;var r=i.getSize().y;this.shadeDiv.setStyles({left:i.getLeft()-s.getLeft()+"px",top:i.getTop()-s.getTop()+"px",width:o+"px",height:r+"px"});if(i.getStyle("position")=="absolute"){this.shadeDiv.setStyles({left:"0px",top:"0px"})}this.inforDiv.setStyles({left:o/2+"px",top:r/2+"px"})},destroyShade:function(){if(this.shadeDiv)this.shadeDiv.destroy()},showErrorMessage:function(t,e,s){var i=s;var a;if(t)a=t.responseText;if(a!=""){var o=JSON.parse(a);if(o.message){this.notice(o.message,"error")}else{this.notice(i,"error")}}else{this.notice(i,"error")}},aa:function(){var t="";if(d.configValue&&d.configValue!=""){var e=d.configValue.split(",");for(i=0;i<e.length;i++){if(t==""){t=e[i].split("@")[0]}else{t=t+","+e[i].split("@")[0]}}}return t}});