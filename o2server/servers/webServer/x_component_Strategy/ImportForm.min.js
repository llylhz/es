MWF.xApplication.Strategy=MWF.xApplication.Strategy||{};MWF.xDesktop.requireApp("Strategy","Template",null,false);MWF.xDesktop.requireApp("Template","MPopupForm",null,false);MWF.xDesktop.requireApp("Template","MForm",null,false);MWF.xDesktop.requireApp("Template","MDomItem",null,false);MWF.xDesktop.requireApp("Strategy","Attachment",null,false);MWF.xApplication.Strategy.ImportForm=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"default",width:"500",height:"200",hasTop:true,hasIcon:false,hasBottom:false,title:"",draggable:true,maxAction:true,closeAction:true},initialize:function(t,e,i,s){this.setOptions(i);this.explorer=t;this.app=t.app;this.lp=this.app.lp.importForm;this.actions=this.app.restActions;this.path="/x_component_Strategy/$ImportForm/";this.cssPath=this.path+this.options.style+"/css.wcss";if(this.options.from){this.cssPath=this.path+this.options.style+"/css_portal.wcss"}this._loadCss();this.options.title=this.lp.title;this.data=e||{};if(s)this.para=s},load:function(){var t=new Date;this.thisYear=t.getFullYear();if(this.options.isNew){this.create()}else if(this.options.isEdited){this.edit()}else{this.open()}},createTopNode:function(){if(!this.formTopNode){this.formTopNode=new Element("div.formTopNode",{styles:this.css.formTopNode}).inject(this.formNode);this.formTopIconNode=new Element("div.formTopIconNode",{styles:this.css.formTopIconNode}).inject(this.formTopNode);this.formTopTextNode=new Element("div",{styles:this.css.formTopTextNode,text:this.data.title?this.data.title:this.lp.title}).inject(this.formTopNode);if(this.options.closeAction){this.formTopCloseActionNode=new Element("div",{styles:this.css.formTopCloseActionNode}).inject(this.formTopNode);this.formTopCloseActionNode.addEvent("click",function(){this.close()}.bind(this))}this._createTopContent()}},_createTopContent:function(){},_createTableContent:function(){this.createTableInfo()},getData:function(t){if(!this.options.isNew){if(this.data.id){this.id=this.data.id}else if(this.options.id){this.id=this.options.id}this.actions.getMeasureById(this.id,function(e){if(e.type=="success"){this.data=e.data;this.formTopTextNode.set("text",this.data.measuresinfotitle);if(e.data.measuresinfoyear){this.currentYear=e.data.measuresinfoyear}if(t)t()}}.bind(this))}else{if(t)t()}},createTableInfo:function(){this.templateDiv=new Element("div.templateDiv",{styles:this.css.templateDiv}).inject(this.formTableArea);this.templateText=new Element("span.templateText",{styles:this.css.templateText,text:this.lp.template}).inject(this.templateDiv);this.templateText.addEvents({click:function(){}.bind(this)});this.inputDiv=new Element("div.inputDiv",{styles:this.css.inputDiv}).inject(this.formTableArea);this.input=new Element("input.input",{styles:this.css.input,type:"file",name:"file"}).inject(this.inputDiv);this.sheetDiv=new Element("div.sheetDiv",{styles:this.css.sheetDiv}).inject(this.formTableArea);this.sheetSel=new MDomItem(this.sheetDiv,{text:"sheet页",name:"sheet",type:"MSelector",selectValue:"1,2,3,4,5,6,7,8,9,10",selectText:"1,2,3,4,5,6,7,8,9,10",mSelectorOptions:{width:"150px",defaultOptionLp:"请选择Sheet",tooltipsOptions:{axis:"y",position:{x:"auto",y:"auto"},event:"click",hiddenDelay:200,displayDelay:0}}},null,this.app,this.css);this.sheetSel.load();this.importAction=new Element("div.importAction",{styles:this.css.importAction,text:this.lp.importAction}).inject(this.formTableArea);this.importAction.addEvents({click:function(){var t=this.inputDiv.getFirst();var e=t.files;if(e.length){for(var i=0;i<e.length;i++){var s=e.item(i);var o=new FormData;o.append("file",s);o.append("year",this.data.year||"");o.append("parentid",this.data.parentid||"");o.append("sheetsequence",this.sheetSel.get("value")||"");this.actions.importMeasure(function(t){if(t.data.isPersist){this.app.notice(t.data.describe,"success");this.fireEvent("importSave",t);this.close()}else{this.app.notice(t.data.describe,"error");var e=this.actions.action.address;var i=e+"/jaxrs/measuresimport/result/flag/"+t.data.flag;window.open(i)}}.bind(this),function(t,e,i){this.app.notice("导入失败","error");this.close()}.bind(this),o,s)}}else{this.app.notice(this.lp.notice.fileEmpty,"error")}if(this.sheetSel.get("value")==""){this.app.notice(this.lp.notice.sheetEmpty,"error")}}.bind(this)});this.closeAction=new Element("div.closeAction",{styles:this.css.closeAction,text:this.lp.importClose}).inject(this.formTableArea);this.closeAction.addEvents({click:function(){this.close()}.bind(this)})},createShade:function(t,e){var i=this.content;var s=t||i;var o=e||"loading...";if(this.shadeDiv){this.shadeDiv.destroy()}if(this["shadeTxtDiv"])this["shadeTxtDiv"].destroy();this.shadeDiv=new Element("div.shadeDiv").inject(s);this.inforDiv=new Element("div.inforDiv",{styles:{height:"16px",display:"inline-block",position:"absolute","background-color":"#000000","border-radius":"3px",padding:"5px 10px"}}).inject(this.shadeDiv);this.loadImg=new Element("img.loadImg",{styles:{width:"16px",height:"16px",float:"left"},src:this.path+"default/icon/loading.gif"}).inject(this.inforDiv);this.shadeTxtSpan=new Element("span.shadeTxtSpan").inject(this.inforDiv);this.shadeTxtSpan.set("text",o);this.shadeDiv.setStyles({width:"100%",height:"100%",position:"absolute",opacity:"0.6","background-color":"#cccccc","z-index":"999"});this.shadeTxtSpan.setStyles({color:"#ffffff","font-size":"12px",display:"inline-block","line-height":"16px","padding-left":"5px"});var n=s.getSize().x;var a=s.getSize().y;this.shadeDiv.setStyles({left:s.getLeft()-i.getLeft()+"px",top:s.getTop()-i.getTop()+"px",width:n+"px",height:a+"px"});if(s.getStyle("position")=="absolute"){this.shadeDiv.setStyles({left:"0px",top:"0px"})}this.inforDiv.setStyles({left:n/2+"px",top:a/2+"px"})},destroyShade:function(){if(this.shadeDiv)this.shadeDiv.destroy()},showErrorMessage:function(t,e,i){var s=i;var o;if(t)o=t.responseText;if(o!=""){var n=JSON.parse(o);if(n.message){this.notice(n.message,"error")}else{this.notice(s,"error")}}else{this.notice(s,"error")}},aa:function(){var t="";if(d.configValue&&d.configValue!=""){var e=d.configValue.split(",");for(var i=0;i<e.length;i++){if(t==""){t=e[i].split("@")[0]}else{t=t+","+e[i].split("@")[0]}}}return t}});