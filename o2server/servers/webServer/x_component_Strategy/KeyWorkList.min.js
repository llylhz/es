MWF.xApplication.Strategy=MWF.xApplication.Strategy||{};MWF.xDesktop.requireApp("Template","MDomItem",null,false);MWF.xDesktop.requireApp("Strategy","Template",null,false);MWF.require("MWF.widget.Identity",null,false);MWF.xApplication.Strategy.KeyWorkList=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default"},initialize:function(t,e,i,s){this.setOptions(s);this.app=e;this.lp=e.lp.keyWork;this.path="/x_component_Strategy/$KeyWorkList/";this.loadCss();this.actions=i;this.node=$(t)},loadCss:function(){this.cssPath=this.path+this.options.style+"/css.wcss";this._loadCss()},load:function(){this.allArrowArr=[];this.node.addEvents({click:function(){if(this.listContentDiv){$(this.listContentDiv).destroy()}if(this.allArrowArr.length>0){this.allArrowArr.each(function(t){$(t).setStyles({background:"url(/x_component_Strategy/$Template/default/icons/arrow.png) no-repeat center"})}.bind(this))}}.bind(this)});this.createYearContent(function(){this.resizeContent()}.bind(this));this.app.addEvent("resize",function(){this.resizeContent()}.bind(this))},reload:function(t){this.currentYear=t;this.createYearContent()},createYearContent:function(t){this.node.empty();this.yearContent=new Element("div.yearContent",{styles:this.css.yearContent}).inject(this.node);this.yearContentList=new Element("div.yearContentList",{styles:this.css.yearContentList}).inject(this.yearContent);this.actions.getKeyWorkListYear(function(e){if(e.type=="success"){if(e.data&&e.data.valueList){this.yearList=e.data.valueList;this.yearList.each(function(t,e){if(e<3){new Element("div.year",{styles:this.css.year,value:t,name:t,text:t}).inject(this.yearContentList).addEvents({click:function(){this.changeYearSelected(t);this.openList(t)}.bind(this)})}}.bind(this));if(this.yearList.length>3){new Element("div.yearMore",{styles:this.css.year,id:"yearMore"}).inject(this.yearContentList).setStyles({width:"30px"}).set({text:"..."}).addEvents({click:function(){this.expandYears()}.bind(this)})}if(this.currentYear){if(this.yearContentList.getElements("div[name='"+this.currentYear+"']").length>0){this.yearContentList.getElements("div[name='"+this.currentYear+"']")[0].click()}}else{if(this.yearContentList.getElements("div").length>0){this.yearContentList.getElements("div")[0].click()}}if(t)t()}}}.bind(this))},expandYears:function(){this.yearContentList.getElementById("yearMore").destroy();this.yearList.each(function(t,e){if(e>2){}}.bind(this))},openList:function(t){this.currentYear=t;this.createSearch();this.createViewContent();this.resizeContent()},changeYearSelected:function(t){this.yearContentList.getElements("div").each(function(e){if(e.get("text")==t){e.setStyles({"background-color":"#4990E2",color:"#FFFFFF"})}else{e.setStyles({"background-color":"",color:"#666666"})}}.bind(this))},createSearch:function(){if(this.searchContent){this.searchContent.destroy()}this.searchContent=new Element("div.searchContent",{styles:this.css.searchContent}).inject(this.node);this.searchBar=new Element("div.searchBar",{styles:this.css.searchBar}).inject(this.searchContent);this.searchIn=new Element("input.searchIn",{styles:this.css.searchIn,placeholder:this.lp.defaultSearchIn}).inject(this.searchBar).addEvents({keydown:function(t){if(this.searchIn.get("value")!=""&&t.event.keyCode=="13"){this.searchReset.setStyles({display:""});this.createViewContent({strategydeploytitle:this.searchIn.get("value")})}}.bind(this)});this.searchImg=new Element("div.searchImg",{styles:this.css.searchImg}).inject(this.searchBar);this.searchImg.addEvents({click:function(){if(this.searchIn.get("value")!=""){this.searchReset.setStyles({display:""});this.createViewContent({strategydeploytitle:this.searchIn.get("value")})}}.bind(this)});this.searchReset=new Element("div.searchReset",{styles:this.css.searchReset}).inject(this.searchBar).addEvents({click:function(){this.searchIn.set("value","");this.searchReset.setStyles({display:"none"});this.createViewContent()}.bind(this)});this.searchDeptBar=new Element("div.searchDeptBar",{styles:this.css.searchDeptBar}).inject(this.searchContent);this.searchDeptLabel=new Element("div.searchDeptBar",{styles:this.css.searchDeptLabel,text:this.lp.deptList}).inject(this.searchDeptBar);this.searchDeptList=new Element("div.searchDeptList",{styles:this.css.searchDeptList}).inject(this.searchDeptBar);var t={width:230,height:30};this.searchDeptSelector=new MWF.xApplication.Strategy.Template.Select(this.searchDeptList,this,this.actions,t);this.searchDeptSelector.load();this.actions.getKeyWorkDepartmentByYear(this.currentYear,function(t){if(t.type=="success"&&t.data.valueList){this.searchDeptSelector.setDeptList(t.data.valueList,function(t){this.createViewContent({deptlist:[t]})}.bind(this))}}.bind(this))},createViewContent:function(t){if(this.viewContent)this.viewContent.destroy();this.viewContent=new Element("div.viewContent",{styles:this.css.viewContent}).inject(this.node);this.viewContentList=new Element("div.viewContentList",{styles:this.css.viewContentList}).inject(this.viewContent);this.filter={strategydeployyear:this.currentYear,ordersymbol:"ASC"};for(var e in t){if(t[e]!=this.app.lp.template.defaultSelect){this.filter[e]=t[e]}}var i=this.path+"KeyWork.json";this.view=new MWF.xApplication.Strategy.KeyWorkList.View(this.viewContentList,this.app,{lp:this.lp.view,css:this.css,actions:this.actions},{templateUrl:i,filterData:this.filter});this.view.load();this.resizeContent()},dragItemData:function(){var t=new Sortables("tabBody",{clone:true,opacity:.3,onStart:function(t,e){e.setStyles({position:"absolute","margin-top":160-this.viewContentList.getScrollTop()+"px",border:"1px dotted #000",width:this.viewContentList.getWidth()-10+"px",height:t.getHeight()+"px",overflow:"hidden","max-height":t.getHeight()+"px"})}.bind(this),onSort:function(t,e){}.bind(this),onComplete:function(e){var i=e.get("id");var s=t.serialize();var n={ordersymbol:this.filter.ordersymbol,ids:s};this.actions.changeKeyWorkPosition(n,function(){this.createViewContent()}.bind(this))}.bind(this)})},resizeContent:function(){var t=this.node.getSize();if(this.yearContentList.getElements("div").length>0){var e=this.searchContent.getSize();this.searchBar.setStyles({width:e.x-this.searchDeptBar.getWidth()-100+"px"});this.viewContent.setStyles({height:t.y-this.yearContent.getHeight()-this.searchContent.getHeight()+"px"});this.viewContentList.setStyles({height:this.viewContent.getHeight()-20+"px",width:this.viewContent.getWidth-60+"px"})}}});MWF.xApplication.Strategy.KeyWorkList.View=new Class({Extends:MWF.xApplication.Strategy.Template.view,_createDocument:function(t){return new MWF.xApplication.Strategy.KeyWorkList.Document(this.viewBodyNode,t,this.explorer,this)},loadScrollElementList:function(t){if(!this.isItemsLoaded){if(!this.isItemLoadding){this.isItemLoadding=true;this._getCurrentPageData(function(t){var e=this.dataCount=t.count;if(e<=this.items.length){this.isItemsLoaded=true}if(t.data&&typeOf(t.data)=="array"){t.data.each(function(t){var e=t[this.options.documentKeyWord||"id"];if(!this.documents[e]){var i=this._createDocument(t,this.items.length);this.items.push(i);this.documents[e]=i}}.bind(this))}this.isItemLoadding=false;if(!(this.app.keyWorkList.filter.deptlist||this.app.keyWorkList.filter.strategydeploytitle)){this.app.keyWorkList.dragItemData()}if(this.loadItemQueue>0){this.loadItemQueue--;this.loadElementList()}}.bind(this),t)}else{this.loadItemQueue++}}},_getCurrentPageData:function(t,e){if(!e)e=100;var i=this.items.length?this.items[this.items.length-1].data.id:"(0)";if(i=="(0)")this.app.createShade();var s=this.options.filterData||{};this.actions.getKeyWorkListNext(i,e,s,function(e){if(t)t(e);this.app.destroyShade()}.bind(this))},_removeDocument:function(t){},_create:function(){},_openDocument:function(t){MWF.xDesktop.requireApp("Strategy","KeyWorkForm",function(){this.KeyWorkForm=new MWF.xApplication.Strategy.KeyWorkForm(this,this.actions,{id:t.id},{isEdited:false});this.KeyWorkForm.load()}.bind(this))},_queryCreateViewNode:function(){},_postCreateViewNode:function(){},_queryCreateViewHead:function(){},_postCreateViewHead:function(t){}});MWF.xApplication.Strategy.KeyWorkList.Document=new Class({Extends:MWF.xApplication.Strategy.Template.Document,openActionReturn:function(t){var e=false;if(t.actions&&t.actions.length==1){e=true}return e},editActionReturn:function(t){var e=false;if(t.actions&&t.actions.indexOf("EDIT")>-1)e=true;return e},deleteActionReturn:function(t){var e=false;if(t.actions&&t.actions.indexOf("DELETE")>-1)e=true;return e},action_open:function(){MWF.xDesktop.requireApp("Strategy","KeyWorkForm",function(){this.keyWorkform=new MWF.xApplication.Strategy.KeyWorkForm(this,this.actions,{id:this.data.id},{isEdited:false});this.keyWorkform.load()}.bind(this))},action_edit:function(){MWF.xDesktop.requireApp("Strategy","KeyWorkForm",function(){this.keyWorkform=new MWF.xApplication.Strategy.KeyWorkForm(this,this.app.actions,{id:this.data.id},{isNew:false,isEdited:true,onPostSave:function(){this.app.keyWorkList.openList(this.app.keyWorkList.currentYear)}.bind(this)});this.keyWorkform.load()}.bind(this))},action_delete:function(t){var e=this;e.view.app.confirm("warn",t,e.view.app.lp.keyWork.submitWarn.title,e.view.app.lp.keyWork.submitWarn.content.deleted,300,120,function(){e.actions.deleteKeyWork(e.data.id,function(t){if(t.type&&t.type=="success"){this.app.notice(e.view.app.lp.prompt.keyWork.deleteOK,"success");e.app.keyWorkList.openList(this.app.keyWorkList.currentYear)}}.bind(e));this.close()},function(){this.close()})},_postCreateDocumentNode:function(t,e){t.set("id",e.id);if(!this.openActionReturn(e)){t.getElements("[item='action_open']").destroy()}if(!this.editActionReturn(e)){t.getElements("[item='action_edit']").destroy()}if(!this.deleteActionReturn(e)){t.getElements("[item='action_delete']").destroy()}}});