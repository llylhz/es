MWF.xDesktop.requireApp("Template","MPopupForm",null,false);MWF.xApplication.cms=MWF.xApplication.cms||{};MWF.xApplication.cms.Index=MWF.xApplication.cms.Index||{};MWF.require("MWF.xAction.org.express.RestActions",null,false);MWF.require("MWF.widget.Mask",null,false);MWF.xApplication.cms.Index.Newer=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"default",popupStyle:"o2platform",width:"850",height:"510",hasTop:true,hasIcon:false,hasTopContent:true,hasBottom:false,draggable:true,closeAction:true,ignoreDrafted:false,selectColumnEnable:true,restrictToColumn:false},initialize:function(t,e,s,i,n){this.path="/x_component_cms_Index/$Newer/";this.cssPath="/x_component_cms_Index/$Newer/"+this.options.style+"/css.wcss";this._loadCss();MWF.xDesktop.requireApp("cms.Index","$Newer.lp."+MWF.language,null,false);this.lp=MWF.xApplication.cms.Index.Newer.lp;this.options.title=this.lp.createDocument;this.setOptions(n);this.columnData=t;this.categoryData=e;this.app=s;this.view=i;this.container=this.app.content;this.documentAction=MWF.Actions.get("x_cms_assemble_control")},load:function(){if(!this.categoryData){this._load();this.fireEvent("postLoad")}else if(this.options.ignoreDrafted){this._load();this.fireEvent("postLoad")}else if(this.categoryData.workflowAppId&&this.categoryData.workflowFlag){this._load();this.fireEvent("postLoad")}else{var t={categoryIdList:[this.categoryData.id],creatorList:[layout.desktop.session.user.distinguishedName]};this.documentAction.listDraftNext("(0)",1,t,function(t){if(t.data.length>0){this._openDocument(t.data[0].id);this.fireEvent("postLoad")}else{this._load();this.fireEvent("postLoad")}}.bind(this))}},_load:function(){this.isNew=true;this.isEdited=true;this._open();if(this.options.selectColumnEnable){this.openSel()}},openSel:function(){this.formTopTextNode.set("text",this.lp.selCategory);if(this.sel){this.sel.load()}else{this.sel=new MWF.xApplication.cms.Index.Newer.CategorySel(this.app,this.formContentNode,this,this.columnData,this.categoryData,{restrictToColumn:this.options.restrictToColumn});this.sel.load()}},_loadCss:function(){var s=encodeURIComponent(this.cssPath);if(MWF.widget.css[s]){this.css=MWF.widget.css[s]}else{this.cssPath=this.cssPath.indexOf("?")!=-1?this.cssPath+"&v="+COMMON.version:this.cssPath+"?v="+COMMON.version;var t=new Request.JSON({url:this.cssPath,secure:false,async:false,method:"get",noCache:false,onSuccess:function(t,e){this.css=t;MWF.widget.css[s]=t}.bind(this),onError:function(t,e){alert(e+t)}});t.send()}},_createTableContent:function(){var t=this.categoryData?this.categoryData.name||this.categoryData.categoryName:this.lp.selectCategory;var e="";if(this.options.selectColumnEnable){this.selectArea=new Element("div",{styles:this.css.selectArea}).inject(this.formTableArea);this.selectContainer=new Element("div",{styles:this.css.selectContainer}).inject(this.selectArea);e="<div id='form_startColumn' style='float:left'></div><div id='form_startCategory' style='float:left'></div>";this.selectContainer.set("html",e);this.setSelectContent()}this.inputContainer=new Element("div",{styles:this.css.inputContainer}).inject(this.formTableArea);e="<table width='100%' height='90%' border='0' cellPadding='0' cellSpacing='0'; >"+"<tr><td colSpan='2' style='height: 60px; line-height: 60px; text-align: center; font-size: 24px; ' id='form_startTitle'>"+this.lp.start+" - "+t+"</td></tr>"+"<tr><td style='height: 38px; line-height: 38px; text-align: left; font-size:16px;color:#333;min-width: 100px;'>"+this.lp.department+"：</td>"+"<td style='; text-align: left;' id='form_startDepartment'></td></tr>"+"<tr><td style='height: 38px; line-height: 38px;  text-align: left; font-size:16px;color:#333'>"+this.lp.identity+"：</td>"+"<td style='; text-align: left;'><div id='form_startIdentity'></div></td></tr>"+"<tr><td style='height: 38px; line-height: 38px;  text-align: left; font-size:16px;color:#333'>"+this.lp.date+"：</td>"+"<td style='; text-align: left;'><div id='form_startDate'></div></td></tr>"+"<tr><td style='height: 38px; line-height: 38px;  text-align: left; font-size:16px;color:#333'>"+this.lp.subject+"：</td>"+"<td style='; text-align: left;'><input type='text' id='form_startSubject' "+"style='width: 99%; border:1px solid #999; background-color:#FFF; border-radius: 3px; box-shadow: 0px 0px 6px #CCC; "+"height: 26px;'/></td></tr>"+"<tr><td style='height: 38px; line-height: 38px; text-align: left; font-size:16px;color:#333'></td>"+"<td style='text-align: left;' id='form_startAction'></td></tr>"+"</table>";this.inputContainer.set("html",e);this.setStartFormContent();this.startActionContainer=this.inputContainer.getElementById("form_startAction");this.startTitleNode=this.inputContainer.getElementById("form_startTitle");this.startOkActionNode=new Element("div",{styles:this.css.startOkActionNode,text:this.lp.ok}).inject(this.startActionContainer);this.cancelActionNode=new Element("div",{styles:this.css.cancelActionNode,text:this.lp.cancel}).inject(this.startActionContainer);this.cancelActionNode.addEvent("click",function(t){this.cancelStart(t)}.bind(this));this.startOkActionNode.addEvent("click",function(t){this.okStart(t)}.bind(this))},setSelectContent:function(){this.columnContainer=this.selectContainer.getElementById("form_startColumn");this.columnContainer.setStyles(this.css.columnContainer);this.selectContainer.addEvents({mouseover:function(){this.columnSelectNode.setStyles(this.css.columnSelectNode_over)}.bind(this),mouseout:function(){this.columnSelectNode.setStyles(this.css.columnSelectNode)}.bind(this),click:function(){this.openSel()}.bind(this)});this.columnIconNode=new Element("img",{styles:this.css.columnIconNode}).inject(this.columnContainer);if(this.columnData){if(this.columnData.appIcon){this.columnIconNode.set("src","data:image/png;base64,"+this.columnData.appIcon+"")}else{this.columnIconNode.set("src","/x_component_cms_Index/$Main/default/icon/column.png")}}else{this.columnIconNode.set("src","/x_component_cms_Index/$Main/default/icon/all_40.png")}this.columnTextNode=new Element("div",{styles:this.css.columnTextNode,text:this.lp.all}).inject(this.columnContainer);this.columnSelectNode=new Element("div",{styles:this.css.columnSelectNode}).inject(this.columnContainer);this.categoryContainer=this.selectContainer.getElementById("form_startCategory");this.categoryContainer.setStyles(this.css.categoryContainer);this.categoryTextNode=new Element("div",{styles:this.css.categoryTextNode,text:this.lp.clickForSelect}).inject(this.categoryContainer)},setCurrentColumn:function(t){if(this.currentColumn&&this.currentColumn!=t){this.currentColumn.node.setStyles(this.css.columnItemNode);this.currentColumn.options.isCurrent=false}this.currentColumn=t},setCurrentCategory:function(e){if(this.currentCategory&&this.currentCategory!=e){this.currentCategory.node.setStyles(this.css.categoryItemNode);this.currentCategory.options.isCurrent=false}this.currentCategory=e;var t={categoryIdList:[e.data.id],creatorList:[layout.desktop.session.user.distinguishedName]};this.documentAction.listDraftNext("(0)",1,t,function(t){if(t.data&&t.data.length>0){this._openDocument(t.data[0].id);this.close()}else{this.documentAction.getColumn(e.data.appId,function(t){this.columnData=t.data;if(this.columnData.appIcon){this.columnIconNode.set("src","data:image/png;base64,"+this.columnData.appIcon+"")}else{this.columnIconNode.set("src","/x_component_cms_Index/$Main/default/icon/column.png")}this.columnTextNode.set("text",this.columnData.appName);this.formTopTextNode.set("text",this.lp.createDocument);this.categoryData=e.data;this.categoryTextNode.set("text",this.categoryData.categoryName);this.startTitleNode.set("text",this.lp.start+" - "+this.categoryData.categoryName);this.sel.closeArea()}.bind(this))}}.bind(this))},setStartFormContent:function(){this.dateArea=this.formTableArea.getElementById("form_startDate");var t=new Date;this.dateArea.set("text",t.format("%Y-%m-%d %H:%M"));this.departmentSelArea=this.formTableArea.getElementById("form_startDepartment");this.identityArea=this.formTableArea.getElementById("form_startIdentity");this.subjectInput=this.formTableArea.getElementById("form_startSubject");this.loadDepartments()},loadDepartments:function(){MWF.Actions.get("x_organization_assemble_personal").getPerson(function(t){var e=t.data&&t.data.woIdentityList?t.data.woIdentityList:[];var s=[];e.each(function(t){if(t.distinguishedName)s.push(t)}.bind(this));var i=s.length==1?true:false;s.each(function(t){var e=new MWF.xApplication.cms.Index.Newer.DepartmentSel(t,this,this.departmentSelArea,this.identityArea);if(i)e.selected()}.bind(this))}.bind(this),null)},cancelStart:function(t){var e=this;if(this.subjectInput.get("value")){this.app.confirm("warn",t,this.lp.start_cancel_title,this.lp.start_cancel,"320","120",function(){e.close();this.close()},function(){this.close()})}else{this.close()}},okStart:function(){if(!this.categoryData){this.app.notice(this.lp.selectCategory,"error")}else{if(this.categoryData.workflowAppId&&this.categoryData.workflowFlag){this._createProcessDocument()}else{this._createDocument()}}},_createDocument:function(t){var e=this.subjectInput.get("value");var s={id:this.documentAction.getUUID(),isNewDocument:true,title:e,creatorIdentity:this.identityArea.get("value"),appId:this.categoryData.appId,categoryId:this.categoryData.id,form:this.categoryData.formId,formName:this.categoryData.formName,docStatus:"draft",categoryName:this.categoryData.name||this.categoryData.categoryName,categoryAlias:this.categoryData.alias||this.categoryData.categoryAlias,attachmentList:[]};if(!s.title){this.subjectInput.setStyle("border-color","red");this.subjectInput.focus();this.app.notice(this.lp.inputSubject,"error")}else if(!s.creatorIdentity){this.departmentSelArea.setStyle("border-color","red");this.app.notice(this.lp.selectStartId,"error")}else{this.mask=new MWF.widget.Mask({style:"desktop"});this.mask.loadNode(this.formAreaNode);this.documentAction.addDocument(s,function(t){this.mask.hide();this.close();this._openDocument(t.data.id);this.app.notice(this.lp.Started,"success")}.bind(this),null)}},_openDocument:function(t,e){var s=this;var i="cms.Document"+t;if(s.app.desktop.apps[i]){s.app.desktop.apps[i].setCurrent()}else{var n={readonly:false,documentId:t,appId:i,postPublish:function(){if(s.view&&s.view.reload)s.view.reload();this.fireEvent("postPublish")}.bind(this)};this.app.desktop.openApplication(e,"cms.Document",n)}},_createProcessDocument:function(t){var e=this.subjectInput.get("value");var s=this.categoryData.workflowFlag;var i={title:this.subjectInput.get("value"),identity:this.identityArea.get("value")};if(!i.title){this.subjectInput.setStyle("border-color","red");this.subjectInput.focus();this.app.notice(this.lp.inputSubject,"error")}else if(!i.identity){this.departmentSelArea.setStyle("border-color","red");this.app.notice(this.lp.selectStartId,"error")}else{var n={cmsDocument:{isNewDocument:true,title:e,creatorIdentity:i.identity,appId:this.categoryData.appId,categoryId:this.categoryData.id,docStatus:"draft",categoryName:this.categoryData.name,categoryAlias:this.categoryData.alias,createTime:(new Date).format("db"),attachmentList:[]}};this.mask=new MWF.widget.Mask({style:"desktop"});this.mask.loadNode(this.formAreaNode);MWF.Actions.get("x_processplatform_assemble_surface").startWork(function(t){this.mask.hide();this.close();this.afterStartProcess(t.data,i.title,this.categoryData.workflowName,n);this.app.notice(this.lp.Started,"success")}.bind(this),null,s,i)}},afterStartProcess:function(t,e,s,i){var n=[];var o=[];t.each(function(t){if(t.currentTaskIndex!=-1)o.push(t.taskList[t.currentTaskIndex].work);n.push(this.getStartWorkInforObj(t))}.bind(this));var a=o[0];MWF.Actions.get("x_processplatform_assemble_surface").saveData(function(){if(o.length==1){var t={workId:a};this.app.desktop.openApplication(null,"process.Work",t);this.createStartWorkResault(n,e,s,false)}else{this.createStartWorkResault(n,e,s,true)}}.bind(this),null,a,i)},getStartWorkInforObj:function(s){var i=[];var n="";s.taskList.each(function(t,e){i.push(t.identity.split("@")[0]+"("+t.unit.split("@")[0]+")");if(s.currentTaskIndex==e)n=t.id}.bind(this));return{activity:s.fromActivityName,users:i,currentTask:n}},createStartWorkResault:function(t,e,s,i){var n="";t.each(function(t){n+="<div><b>"+this.lp.nextActivity+"<font style='color: #ea621f'>"+t.activity+"</font>, "+this.lp.nextUser+"<font style='color: #ea621f'>"+t.users.join(", ")+"</font></b>";if(t.currentTask&&i){n+="&nbsp;&nbsp;&nbsp;&nbsp;<span value='"+t.currentTask+"'>"+this.lp.deal+"</span></div>"}else{n+="</div>"}}.bind(this));var o={subject:this.lp.processStarted,content:"<div>"+this.lp.processStartedMessage+"“["+s+"]"+e+"”</div>"+n};var a=layout.desktop.message.addTooltip(o);var r=layout.desktop.message.addMessage(o);this.setStartWorkResaultAction(a);this.setStartWorkResaultAction(r)},setStartWorkResaultAction:function(t){var e=t.node.getElements("span");e.setStyles(this.css.dealStartedWorkAction);var s=this;e.addEvent("click",function(t){var e={taskId:this.get("value")};s.app.desktop.openApplication(t,"process.Work",e)})}});MWF.xApplication.cms.Index.Newer.DepartmentSel=new Class({initialize:function(t,e,s,i){this.data=t;this.starter=e;this.container=s;this.idArea=i;this.css=this.starter.css;this.isSelected=false;this.load()},load:function(){this.node=new Element("div",{styles:this.css.departSelNode}).inject(this.container);var t=this.data.woUnit?this.data.woUnit.name:this.lp.unnamedUnit;this.node.set("text",this.data.woUnit.name);this.node.addEvents({mouseover:function(){if(!this.isSelected)this.node.setStyles(this.css.departSelNode_over)}.bind(this),mouseout:function(){if(!this.isSelected)this.node.setStyles(this.css.departSelNode_out)}.bind(this),click:function(){this.selected()}.bind(this)})},selected:function(){if(!this.isSelected){if(this.starter.currentDepartment)this.starter.currentDepartment.unSelected();this.node.setStyles(this.css.departSelNode_selected);this.isSelected=true;this.starter.currentDepartment=this;this.idArea.set({text:this.data.name,value:this.data.distinguishedName})}},unSelected:function(){if(this.isSelected){if(this.starter.currentDepartment)this.starter.currentDepartment=null;this.node.setStyles(this.css.departSelNode);this.isSelected=false}}});MWF.xApplication.cms.Index.Newer.CategorySel=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",restrictToColumn:false},initialize:function(t,e,s,i,n,o){this.setOptions(o);this.node=e;this.newer=s;this.lp=s.lp;this.css=s.css;this.action=s.documentAction;this.columnData=i;this.categoryData=n},load:function(){if(!this.areaNode){this.createArea()}this.areaNode.fade("1")},closeArea:function(){if(this.areaNode)this.areaNode.fade("out")},createArea:function(){this.areaNode=new Element("div.categorySelAreaNode",{styles:this.css.categorySelAreaNode}).inject(this.node);this.areaNode.addEvent("click",function(t){}.bind(this));this.columnContainer=new Element("div",{styles:this.css.selColumnAreaNode}).inject(this.areaNode);this.columnScrollNode=new Element("div.columnScrollNode",{styles:this.css.selColumnScrollNode}).inject(this.columnContainer);this.setScrollBar(this.columnScrollNode);this.columnContentNode=new Element("div.selColumnContentNode",{styles:this.css.selColumnContentNode}).inject(this.columnScrollNode);this.categoryContainer=new Element("div",{styles:this.css.selCategoryAreaNode}).inject(this.areaNode);this.categoryScrollNode=new Element("div",{styles:this.css.selCategoryScrollNode}).inject(this.categoryContainer);this.setScrollBar(this.categoryScrollNode);this.categoryContentNode=new Element("div",{styles:this.css.selCategoryContentNode}).inject(this.categoryScrollNode);if(this.options.restrictToColumn&&this.columnData){new MWF.xApplication.cms.Index.Newer.CategorySel.Column(this.columnData,this.app,this.newer,this.columnContentNode,this.categoryContentNode,{needGetCategorys:true,isCurrent:true,currentCategory:this.categoryData?this.categoryData.id:"",restrictToColumn:this.options.restrictToColumn})}else{this.listColumns()}},listColumns:function(){var e={wrapOutCategoryList:[]};this.action.listColumnByPublish(function(t){t.data.each(function(t){if(!t.name)t.name=t.appName;if(t.wrapOutCategoryList&&t.wrapOutCategoryList.length){t.wrapOutCategoryList.each(function(t){e.wrapOutCategoryList.push(t)}.bind(this))}}.bind(this));new MWF.xApplication.cms.Index.Newer.CategorySel.Column(e,this.app,this.newer,this.columnContentNode,this.categoryContentNode,{needGetCategorys:false,isAll:true,isCurrent:this.columnData?false:true,currentCategory:this.categoryData?this.categoryData.id:"",restrictToColumn:this.options.restrictToColumn});t.data.each(function(t){if(!t.name)t.name=t.appName;new MWF.xApplication.cms.Index.Newer.CategorySel.Column(t,this.app,this.newer,this.columnContentNode,this.categoryContentNode,{needGetCategorys:false,isCurrent:this.columnData&&this.columnData.id==t.id?true:false,currentCategory:this.categoryData?this.categoryData.id:"",restrictToColumn:this.options.restrictToColumn})}.bind(this))}.bind(this))}});MWF.xApplication.cms.Index.Newer.CategorySel.Column=new Class({Implements:[Options],options:{needGetCategorys:false,isAll:false,isCurrent:false,currentCategory:"",restrictToColumn:false},initialize:function(t,e,s,i,n,o){this.setOptions(o);this.data=t;this.app=e;this.newer=s;this.lp=s.lp;this.css=s.css;this.action=s.documentAction;this.container=i;this.categoryContainer=n;this.load()},load:function(){this.node=new Element("div",{styles:this.css.columnItemNode}).inject(this.container);var t=this.iconNode=new Element("img",{styles:this.css.columnItemIconNode}).inject(this.node);if(this.options.isAll){this.iconNode.set("src","/x_component_cms_Index/$Main/default/icon/all_40.png")}else if(this.data.appIcon){this.iconNode.set("src","data:image/png;base64,"+this.data.appIcon+"")}else{this.iconNode.set("src","/x_component_cms_Index/$Main/default/icon/column.png")}this.textNode=new Element("div",{styles:this.css.columnItemTextNode}).inject(this.node);if(this.options.isAll){this.textNode.set("text",this.lp.all)}else{this.textNode.set("text",this.data.name||this.data.appName)}if(this.options.isAll){}this.node.addEvents({mouseover:function(){if(!this.options.isCurrent)this.node.setStyles(this.css.columnItemNode_over)}.bind(this),mouseout:function(){if(!this.options.isCurrent)this.node.setStyles(this.css.columnItemNode)}.bind(this),click:function(){this.setCurrent()}.bind(this)});if(this.options.isCurrent)this.setCurrent()},setCurrent:function(){this.options.isCurrent=true;this.node.setStyles(this.css.columnItemNode_current);this.newer.setCurrentColumn(this);this.loadCategory()},loadCategory:function(){this.categoryContainer.empty();if(this.options.needGetCategorys){this.action.listCategoryByPublisher(this.data.id,function(t){if(t.data.length){var e=t.data.length==1&&(this.options.restrictToColumn||this.options.isAll);t.data.each(function(t){new MWF.xApplication.cms.Index.Newer.CategorySel.Category(t,this,this.categoryContainer,{isCurrent:this.options.currentCategory==t.id||e})}.bind(this))}else{this.node.setStyle("display","none")}}.bind(this),null,this.data.id)}else{if(this.data.wrapOutCategoryList&&this.data.wrapOutCategoryList.length){var e=this.data.wrapOutCategoryList.length==1&&(this.options.restrictToColumn||this.options.isAll);this.data.wrapOutCategoryList.each(function(t){new MWF.xApplication.cms.Index.Newer.CategorySel.Category(t,this,this.categoryContainer,{isCurrent:this.options.currentCategory==t.id||e})}.bind(this))}else{this.node.setStyle("display","none")}}}});MWF.xApplication.cms.Index.Newer.CategorySel.Category=new Class({Implements:[Options],options:{isCurrent:false},initialize:function(t,e,s,i){this.setOptions(i);this.data=t;this.column=e;this.app=this.column.app;this.newer=this.column.newer;this.container=s;this.css=this.newer.css;this.load()},load:function(){if(!this.data.name)this.data.name=this.data.categoryName;this.node=new Element("div.categoryItem",{styles:this.css.categoryItemNode}).inject(this.container);if(this.options.isCurrent)this.node.setStyles(this.css.categoryItemNode_over);this.textNode=new Element("div",{styles:this.css.categoryItemTextNode}).inject(this.node);this.textNode.set({text:this.data.categoryName});var t=this;this.node.addEvents({mouseover:function(t){if(!this.options.isCurrent)this.node.setStyles(this.css.categoryItemNode_over)}.bind(this),mouseout:function(t){if(!this.options.isCurrent)this.node.setStyles(this.css.categoryItemNode)}.bind(this),click:function(t){this.setCurrent()}.bind(this)});if(this.options.isCurrent)this.setCurrent()},setCurrent:function(){this.options.isCurrent=true;this.node.setStyles(this.css.categoryItemNode_current);this.newer.setCurrentCategory(this)}});