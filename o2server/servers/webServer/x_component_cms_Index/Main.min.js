MWF.xApplication.cms=MWF.xApplication.cms||{};MWF.CMSE=MWF.xApplication.cms.Index=MWF.xApplication.cms.Index||{};MWF.require("MWF.widget.O2Identity",null,false);MWF.xApplication.cms.Index.options={multitask:false,executable:true};MWF.xApplication.cms.Index.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{style:"default",name:"cms.Index",icon:"icon.png",width:"1220",height:"680",isResize:true,isMax:true,title:MWF.CMSE.LP.title},onQueryLoad:function(){this.lp=MWF.xApplication.cms.Index.LP},loadApplication:function(t){this.columns=[];this.restActions=MWF.Actions.get("x_cms_assemble_control");this.createNode();this.loadApplicationContent()},reload:function(){this.scrollNode.destroy();this.loadContent()},createNode:function(){this.content.setStyle("overflow","hidden");this.node=new Element("div",{styles:this.css.container}).inject(this.content)},loadApplicationContent:function(){this.loadTitle();this.loadContent()},loadTitle:function(){this.loadTitleBar();this.loadCreateDocumentActionNode();this.loadSearchNode()},loadTitleBar:function(){this.titleBarContainer=new Element("div",{styles:this.css.titleBarContainer}).inject(this.node);this.titleBar=new Element("div",{styles:this.css.titleBar}).inject(this.titleBarContainer)},loadCreateDocumentActionNode:function(){this.createDocumentAction=new Element("div",{styles:this.css.createDocumentAction,text:this.lp.start}).inject(this.titleBar);this.createDocumentAction.addEvents({click:function(t){MWF.xDesktop.requireApp("cms.Index","Newer",function(){this.creater=new MWF.xApplication.cms.Index.Newer(null,null,this,this);this.creater.load()}.bind(this))}.bind(this),mouseover:function(t){this.createDocumentAction.setStyles(this.css.createDocumentAction_over)}.bind(this),mouseout:function(t){this.createDocumentAction.setStyles(this.css.createDocumentAction)}.bind(this)})},loadSearchNode:function(){this.searchBarAreaNode=new Element("div",{styles:this.css.searchBarAreaNode}).inject(this.titleBar);this.searchBarNode=new Element("div",{styles:this.css.searchBarNode}).inject(this.searchBarAreaNode);this.searchBarActionNode=new Element("div",{styles:this.css.searchBarActionNode}).inject(this.searchBarNode);this.searchBarResetActionNode=new Element("div",{styles:this.css.searchBarResetActionNode}).inject(this.searchBarNode);this.searchBarResetActionNode.setStyle("display","none");this.searchBarInputBoxNode=new Element("div",{styles:this.css.searchBarInputBoxNode}).inject(this.searchBarNode);this.searchBarInputNode=new Element("input",{type:"text",value:this.lp.searchKey,styles:this.css.searchBarInputNode}).inject(this.searchBarInputBoxNode);var t=this;this.searchBarActionNode.addEvent("click",function(){this.search()}.bind(this));this.searchBarResetActionNode.addEvent("click",function(){this.reset()}.bind(this));this.searchBarInputNode.addEvents({focus:function(){if(this.value==t.lp.searchKey)this.set("value","")},blur:function(){if(!this.value)this.set("value",t.lp.searchKey)},keydown:function(t){if(t.code==13){this.search();t.preventDefault()}}.bind(this),selectstart:function(t){t.preventDefault()}})},loadContent:function(t){this.scrollNode=new Element("div",{styles:this.css.scrollNode}).inject(this.node);this.contentWarpNode=new Element("div",{styles:this.css.node}).inject(this.scrollNode);this.contentContainerNode=new Element("div",{styles:this.css.contentContainerNode}).inject(this.contentWarpNode);this.contentNode=new Element("div",{styles:this.css.contentNode}).inject(this.contentContainerNode);this.createColumnNodes();this.setContentSize();this.addEvent("resize",function(){this.setContentSize()}.bind(this))},createColumnNodes:function(){this.restActions.listColumn(function(t){if(typeOf(t.data)!="array")return;var e=t.data;e.sort(function(t,e){return parseFloat(t.appInfoSeq)-parseFloat(e.appInfoSeq)});t.data=e;var s=0;t.data.each(function(t){var t=new MWF.xApplication.cms.Index.Column(this,t,{index:s++});t.load();this.columns.push(t)}.bind(this))}.bind(this))},search:function(e){if(!e)e=this.searchBarInputNode.get("value");if(e==this.lp.searchKey)e="";if(e!=""){this.searchBarResetActionNode.setStyle("display","block");this.searchBarActionNode.setStyle("display","none")}this.columns.each(function(t){t.search(e)}.bind(this))},reset:function(){this.searchBarInputNode.set("value",this.lp.searchKey);this.searchBarResetActionNode.setStyle("display","none");this.searchBarActionNode.setStyle("display","block");this.columns.each(function(t){t.loadList()}.bind(this))},clearContent:function(){},openManager:function(){var t="cms.Column";if(this.desktop.apps[t]){this.desktop.apps[t].setCurrent()}else{this.desktop.openApplication(null,"cms.Column",{appId:t,onQueryLoad:function(){}})}},recordStatus:function(){},setContentSize:function(){var t=this.content.getSize();var e=this.titleBarContainer?this.titleBarContainer.getSize():{x:0,y:0};this.scrollNode.setStyle("height",""+(t.y-e.y)+"px");if(this.contentWarpNode){var s=(t.x/550).toInt();var i=550*s;var n=(t.x-i)/2-10;this.contentWarpNode.setStyles({width:""+i+"px","margin-left":""+n+"px"});this.titleBar.setStyles({"margin-left":""+(n+10)+"px","margin-right":""+(n+10)+"px"})}}});MWF.xApplication.cms.Index.Column=new Class({Implements:[Options,Events],options:{where:"bottom",index:0},initialize:function(t,e,s){this.setOptions(s);this.app=t;this.container=this.app.contentNode;this.data=e;this.isNew=false;this.defaultColumnIcon="/x_component_cms_Index/$Main/"+this.app.options.style+"/icon/column.png"},load:function(){this.loadNode();this.loadTop();this.loadCategory();this.loadList()},loadNode:function(){this.node=new Element("div.columnItem",{styles:this.app.css.columnItemNode}).inject(this.container,this.options.where);var t=this.leftNode=new Element("div.columnItemLeftNode",{styles:this.app.css.columnItemLeftNode}).inject(this.node);var e=this.rightNode=new Element("div.columnItemRightNode",{styles:this.app.css.columnItemRightNode}).inject(this.node);this.categoryContainer=new Element("div.categoryContainer",{styles:this.app.css.categoryContainer}).inject(this.rightNode);this.categoryList=new Element("div.categoryList",{styles:this.app.css.categoryList}).inject(this.categoryContainer);this.documentList=new Element("div",{styles:this.app.css.documentList}).inject(this.rightNode)},loadTop:function(){this.data.name=this.data.appName;var t=this.data.appName;var e=this.data.appAlias;var s=this.data.description;var i=this.data.appInfoSeq;var n=this.data.creatorUid;var o=this.data.createTime;var a=this.leftNode;var c=this.iconAreaNode=new Element("div",{styles:this.app.css.columnItemIconAreaNode}).inject(a);var r=this.iconNode=new Element("img",{styles:this.app.css.columnItemIconNode}).inject(c);if(this.data.appIcon){this.iconNode.set("src","data:image/png;base64,"+this.data.appIcon+"")}else{this.iconNode.set("src",this.defaultColumnIcon)}r.makeLnk({par:this._getLnkPar()});var h=new Element("div",{styles:this.app.css.columnItemTextNode}).inject(a);var d=new Element("div",{styles:this.app.css.columnItemTitleNode,text:t,title:e?t+" ("+e+") ":t}).inject(h);var l=s&&s!=""?s:this.app.lp.noDescription;var p=new Element("div",{styles:this.app.css.columnItemDescriptionNode,text:l,title:l}).inject(h);var u=this;a.addEvents({click:function(t){u.clickColumnNode(u,this,t)}})},_getLnkPar:function(){var t=this.defaultColumnIcon;if(this.data.appIcon)t="data:image/png;base64,"+this.data.appIcon;var e="cms.Module"+this.data.id;return{icon:t,title:this.data.appName,par:'cms.Module#{"columnId": "'+this.data.id+'", "appId": "'+e+'"}'}},clickColumnNode:function(t,e,s){this.openModule("all",s)},clickMoreLink:function(t){var e=this.app.searchBarInputNode.get("value");if(e==this.app.lp.searchKey)e="";this.openModule("all",t,e)},openModule:function(t,e,s,i){var n="cms.Module"+this.data.id;if(this.app.desktop.apps[n]){if(s){this.app.desktop.apps[n].close()}else{this.app.desktop.apps[n].setCurrent();return}}this.app.desktop.openApplication(e,"cms.Module",{columnData:this.data,appId:n,categoryId:t,isCategory:i||false,searchKey:s})},loadCategory:function(){var s=this;if(typeOf(this.data.wrapOutCategoryList)!="array")return;var t=this.data.wrapOutCategoryList;t.sort(function(t,e){return parseFloat(t.categorySeq)-parseFloat(e.categorySeq)});this.data.wrapOutCategoryList=t;this.data.wrapOutCategoryList.each(function(t){var e=new Element("div.categoryItem",{text:t.categoryName,styles:this.app.css.categoryItem}).inject(this.categoryList,"top");e.store("category",t);e.addEvents({mouseover:function(){this.setStyles(s.app.css.categoryItem_over)},mouseout:function(){this.setStyles(s.app.css.categoryItem)},click:function(t){s.openModule(this.retrieve("category").id,t,"",true)}})}.bind(this));if(this.categoryList.getScrollSize().y>this.categoryContainer.getSize().y){this.categoryArrowNode=new Element("div.categoryArrowNode",{styles:this.app.css.categoryArrowNode}).inject(this.categoryContainer);this.categoryArrowNode.addEvents({mouseover:function(){this.categoryArrowNode.setStyles(this.categoryArrow!="down"?this.app.css.categoryArrowNode_over:this.app.css.categoryArrowNode_down_over)}.bind(this),mouseout:function(){this.categoryArrowNode.setStyles(this.categoryArrow!="down"?this.app.css.categoryArrowNode:this.app.css.categoryArrowNode_down)}.bind(this),click:function(t){if(this.categoryArrow!="down"){this.openCategoryList(t)}else{this.closeCategoryList(t)}}.bind(this)})}},openCategoryList:function(t){this.categoryArrow="down";this.categoryArrowNode.setStyles(this.app.css.categoryArrowNode_down_over);this.categoryList.setStyles(this.app.css.categoryList_all);window.closeCategoryList=this.closeCategoryList.bind(this);this.app.content.addEvent("click",window.closeCategoryList);t.stopPropagation()},closeCategoryList:function(t){this.categoryArrow="up";this.categoryArrowNode.setStyles(this.app.css.categoryArrowNode);this.categoryList.setStyles(this.app.css.categoryList);this.app.content.removeEvent("click",window.closeCategoryList);t.stopPropagation()},destroy:function(){this.node.destroy();MWF.release(this);delete this},search:function(t){if(!t||t==""){this.loadList();return}if(this.documentList)this.documentList.empty();if(this.moreArea)this.moreArea.destroy();var e={title:t,appIdList:[this.data.id],statusList:["published"]};this.getDocumentData(function(t){if(t.count>t.size){this.loadMoreItem(t.count,t.size)}t.data.each(function(t){this.listDocument(t)}.bind(this))}.bind(this),null,e)},loadList:function(){if(this.documentList)this.documentList.empty();if(this.moreArea)this.moreArea.destroy();this.getDocumentData(function(t){t.data.each(function(t){this.listDocument(t)}.bind(this))}.bind(this))},listDocument:function(t){var i=this;var e=new Element("div",{text:t.title,title:t.title,styles:this.app.css.documentItem}).inject(this.documentList);e.store("documentId",t.id);e.addEvents({mouseover:function(){this.setStyles(i.app.css.documentItem_over)},mouseout:function(){this.setStyles(i.app.css.documentItem)},click:function(){var t=this.retrieve("documentId");var e="cms.Document"+t;if(i.app.desktop.apps[e]){i.app.desktop.apps[e].setCurrent()}else{var s={documentId:t,appId:e,readonly:true};i.app.desktop.openApplication(null,"cms.Document",s)}}})},getDocumentData:function(e,t,s){if(!t)t=6;var i="(0)";if(!s){s={appIdList:[this.data.id],statusList:["published"]}}this.app.restActions.listDocumentFilterNext(i,t,s,function(t){if(e)e(t)})},loadMoreItem:function(t,e){var s=this;this.moreArea=new Element("div",{styles:this.app.css.moreArea}).inject(this.rightNode);this.moreLinkText=new Element("div",{styles:this.app.css.moreLinkText,text:"更多("+(t-e)+")"}).inject(this.moreArea);this.moreLinkImage=new Element("div",{styles:this.app.css.moreLinkImage}).inject(this.moreArea);this.moreArea.addEvents({mouseover:function(){this.moreLinkText.setStyles(s.app.css.moreLinkText_over);this.moreLinkImage.setStyles(s.app.css.moreLinkImage_over)}.bind(this),mouseout:function(){this.moreLinkText.setStyles(s.app.css.moreLinkText);this.moreLinkImage.setStyles(s.app.css.moreLinkImage)}.bind(this),click:function(t){s.clickMoreLink(t)}})}});