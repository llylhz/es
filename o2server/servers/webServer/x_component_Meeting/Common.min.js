MWF.xDesktop.requireApp("Template","MPopupForm",null,false);MWF.xDesktop.requireApp("Template","MTooltips",null,false);MWF.require("MWF.widget.O2Identity",null,false);MWF.xDesktop.requireApp("Selector","package",null,false);MWF.require("MWF.widget.AttachmentController",null,false);MWF.xApplication.Meeting=MWF.xApplication.Meeting||{};MWF.xApplication.Meeting.BuildingForm=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"meeting",width:"800",height:"300",hasTop:true,hasIcon:false,hasTopIcon:false,hasTopContent:false,hasBottom:false,draggable:true,closeAction:true},_createTableContent:function(){this.formTopTextNode.set("text",this.lp.editBuilding);var t="<table width='100%' bordr='0' cellpadding='7' cellspacing='0' styles='formTable'>"+"<tr><td styles='formTableTitle' lable='name'></td>"+"    <td styles='formTableValue' item='name' colspan='3' ></td></tr>"+"<tr><td styles='formTableTitle' lable='address'></td>"+"    <td styles='formTableValue' item='address' colspan='3'></td></tr>"+"<tr><td styles='formTableTitle'></td>"+"    <td styles='formTableValue' colspan='3' style='padding-top: 30px;'>"+"       <div item='saveAction' style='float:left;display:"+(this.isEdited||this.isNew?"":"none")+";'></div>"+"       <div item='removeAction' style='float:left;display:"+(this.isEdited?"":"none")+";'></div>"+"       <div item='cancelAction' style='"+(this.isEdited||this.isNew?"float:left;":"float:right;margin-right:15px;")+"'></div>"+"   </td></tr>"+"</table>";this.formTableArea.set("html",t);MWF.xDesktop.requireApp("Template","MForm",function(){this.form=new MForm(this.formTableArea,this.data,{isEdited:this.isEdited||this.isNew,style:"meeting",itemTemplate:{name:{text:this.lp.name,notEmpty:true},address:{text:this.lp.address},saveAction:{type:"button",className:"inputOkButton",value:this.lp.save,event:{click:function(){this.save()}.bind(this)}},removeAction:{type:"button",className:"inputCancelButton",value:this.lp.delete,event:{click:function(t,e){this.removeBuilding(e)}.bind(this)}},cancelAction:{type:"button",className:"inputCancelButton",value:this.lp.close,event:{click:function(){this.close()}.bind(this)}}}},this.app);this.form.load()}.bind(this),true)},save:function(){var t=this.form.getResult(true,null,true,false,true);this.actions.saveBuilding(t,function(t){this.app.notice(this.lp.save_success,"success");var e=this.view;this.close();e.reload()}.bind(this))},removeBuilding:function(t){var e=this.app.lp.delete_building;e=e.replace(/{name}/g,this.data.name);var i=this;this.app.confirm("warn",t,this.app.lp.delete_building_title,e,300,120,function(){i.remove();this.close()},function(){this.close()})},remove:function(){var t=this.view;this.app.actions.deleteBuilding(this.data.id,function(){t.reload()}.bind(this))}});MWF.xApplication.Meeting.BuildingTooltip=new Class({Extends:MTooltips,_loadCustom:function(t){this.loadActionBar();if(t)t()},_getHtml:function(){var t=this.data;var e="<div item='containr' style='height:16px;line-height:16px;'><div style='font-size: 14px;color:#666;float:left; '>"+(t.address?t.address:this.lp.noAddress)+"</div></div>";return e},loadActionBar:function(){if(MWF.AC.isMeetingAdministrator()){var t=this.node.getElement("[item='containr']");this.editAction=new Element("div",{styles:this.css.action_edit,title:this.lp.editAddress,events:{mouseover:function(){this.editAction.setStyles(this.css.action_edit_over)}.bind(this),mouseout:function(){this.editAction.setStyles(this.css.action_edit)}.bind(this),click:function(){this.editBuilding()}.bind(this)}}).inject(t);this.removeAction=new Element("div",{styles:this.css.action_remove,title:this.lp.removeBuilding,events:{mouseover:function(){this.removeAction.setStyles(this.css.action_remove_over)}.bind(this),mouseout:function(){this.removeAction.setStyles(this.css.action_remove)}.bind(this),click:function(t){this.removeBuilding(t)}.bind(this)}}).inject(t)}},editBuilding:function(){var t=new MWF.xApplication.Meeting.BuildingForm(this,this.data,{},{app:this.app});t.edit()},removeBuilding:function(s){this.app.actions.getBuilding(this.data.id,function(t){if(t.data.roomList&&t.data.roomList.length>0){this.app.notice(this.app.lp.delete_building_hasRoom.replace(/{name}/g,this.data.name),"error",s.target)}else{var e=this.app.lp.delete_building;e=e.replace(/{name}/g,this.data.name);var i=this;this.app.confirm("warn",s,this.app.lp.delete_building_title,e,300,120,function(){i.remove();this.close()},function(){this.close()})}}.bind(this))},remove:function(){var t=this.view;this.app.actions.deleteBuilding(this.data.id,function(){t.reload()}.bind(this))},reload:function(){this.view.reload()}});MWF.xApplication.Meeting.RoomForm=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"meeting",width:"900",height:"500",hasTop:true,hasIcon:false,hasTopIcon:false,hasTopContent:false,hasBottom:false,draggable:true,closeAction:true},_createTableContent:function(){if(this.isNew){this.formTopTextNode.set("text",this.lp.addRoom)}else if(this.isEdited){this.formTopTextNode.set("text",this.lp.editRoom)}else{this.formTopTextNode.set("text",this.lp.room)}var t=this.lp.roomForm;var e=!this.isEdited&&!this.isNew&&MWF.AC.isMeetingAdministrator();var i=this.isEdited||this.isNew?"border:1px solid #ccc; border-radius: 4px;overflow: hidden;padding:8px;":"";var s="<table width='100%' bordr='0' cellpadding='7' cellspacing='0' styles='formTable'>"+"<tr><td styles='formTableTitle'>"+t.name+":</td>"+"    <td styles='formTableValue' item='name' colspan='3' ></td></tr>"+"<tr><td styles='formTableTitle'>"+t.building+":</td>"+"    <td styles='formTableValue' item='buildingName' colspan='3'></td></tr>"+"<tr><td styles='formTableTitle'>"+t.floor+":</td>"+"    <td styles='formTableValue' item='floor'></td>"+"    <td styles='formTableTitle2'>"+t.capacity+":</td>"+"    <td styles='formTableValue' item='capacity'></td></tr>"+"<tr><td styles='formTableTitle'>"+t.roomNumber+":</td>"+"    <td styles='formTableValue' item='roomNumber'></td>"+"    <td styles='formTableTitle2'>"+t.phone+":</td>"+"    <td styles='formTableValue' item='phoneNumber'></td></tr>"+"<tr><td styles='formTableTitle'>"+t.device+":</td>"+"    <td styles='formTableValue' colspan='3'>"+"       <div item='deviceList' style='"+i+"'></div>"+"</td></tr>"+"<tr><td styles='formTableTitle'>"+t.available+":</td>"+"    <td styles='formTableValue' colspan='3'>"+"       <div item='available' style='"+i+"'></div>"+"</td></tr>"+"<tr><td styles='formTableTitle'></td>"+"    <td styles='formTableValue' colspan='3' style='padding-top: 30px;'>"+"       <div item='saveAction' style='float:left;display:"+(this.isEdited||this.isNew?"":"none")+";'></div>"+"       <div item='editAction' style='float:left;display:"+(e?"":"none")+";'></div>"+"       <div item='removeAction' style='float:left;display:"+(this.isEdited?"":"none")+";'></div>"+"       <div item='cancelAction' style='"+(this.isEdited||this.isNew||e?"float:left;":"float:right;margin-right:15px;")+"'></div>"+"   </td></tr>"+"</table>";this.formTableArea.set("html",s);var n=this.data||{};this.buildingId=n.building;if(this.buildingId){this.getBuliding()}MWF.xDesktop.requireApp("Template","MForm",function(){this.form=new MForm(this.formTableArea,n,{isEdited:this.isEdited||this.isNew,style:"meeting",itemTemplate:{name:{text:t.name,notEmpty:true},buildingName:{text:t.building,notEmpty:true,value:this.buildingName||"",event:{click:function(){this.listBuilding()}.bind(this),change:function(){this.buildingId=null}.bind(this),keydown:function(t){if(t.code==13){this.listBuildingHide();this.listBuilding()}if(t.code==40)this.selectBuildingNext();if(t.code==38)this.selectBuildingPrev();if(t.code==32)this.selectBuildingConfirm(t)}.bind(this)}},floor:{type:"select",defaultValue:"1",notEmpty:true,text:t.floor,selectText:function(){var t=[];for(var e=-2;e<=50;e++){if(e!=0)t.push(e+this.lp.floor)}return t}.bind(this),selectValue:function(){var t=[];for(var e=-2;e<=50;e++){if(e!=0)t.push(e)}return t}.bind(this)},capacity:{notEmpty:true,tType:"number",text:t.capacity},roomNumber:{},phoneNumber:{},deviceList:{type:"checkbox",value:this.data.device?this.data.device.split("#"):"",selectValue:function(){return Object.keys(this.lp.device)}.bind(this),selectText:function(){return Object.values(this.lp.device)}.bind(this)},available:{type:"radio",defaultValue:"true",selectValue:["true","false"],selectText:[this.lp.enable,this.lp.disable]},saveAction:{type:"button",className:"inputOkButton",value:this.lp.save,event:{click:function(){this.save()}.bind(this)}},removeAction:{type:"button",className:"inputCancelButton",value:this.lp.delete,event:{click:function(t,e){this.removeRoom(e)}.bind(this)}},editAction:{type:"button",className:"inputOkButton",value:this.lp.editRoom,event:{click:function(){this.editRoom()}.bind(this)}},cancelAction:{type:"button",className:"inputCancelButton",value:this.lp.close,event:{click:function(){this.close()}.bind(this)}}}},this.app);this.form.load()}.bind(this),true)},editRoom:function(){this.formTopNode=null;if(this.setFormNodeSizeFun&&this.app){this.app.removeEvent("resize",this.setFormNodeSizeFun)}if(this.formMaskNode)this.formMaskNode.destroy();this.formAreaNode.destroy();this.edit()},getBuliding:function(){this.actions.getBuilding(this.buildingId,function(t){this.buildingName=t.data.name}.bind(this),null,false)},reset:function(){this.formTableArea.empty();this._createTableContent()},removeRoom:function(t){var e=this.app.lp.delete_room;e=e.replace(/{name}/g,this.data.name);var i=this;this.app.confirm("warn",t,this.app.lp.delete_building_title,e,300,120,function(){i.remove();this.close()},function(){this.close()})},remove:function(){var t=this.view;this.app.actions.deleteRoom(this.data.id,function(){t.reload()}.bind(this))},selectBuildingNext:function(){if(this.selectBuildingNode){var t=null;if(this.selectBuildingNode.selectedNode){var t=this.selectBuildingNode.selectedNode.getNext();if(!t)t=this.selectBuildingNode.getFirst();this.selectBuildingNode.selectedNode.setStyle("background-color",this.selectBuildingNode.selectedNode.retrieve("bg"))}else{t=this.selectBuildingNode.getFirst()}if(t){var e=t.getStyle("background-color");t.store("bg",e);t.setStyles(this.css.createRoomBuildingSelectItem_over);this.selectBuildingNode.selectedNode=t}}},selectBuildingPrev:function(){if(this.selectBuildingNode){var t=null;if(this.selectBuildingNode.selectedNode){var t=this.selectBuildingNode.selectedNode.getPrevious();if(!t)t=this.selectBuildingNode.getLast();this.selectBuildingNode.selectedNode.setStyle("background-color",this.selectBuildingNode.selectedNode.retrieve("bg"))}else{t=this.selectBuildingNode.getLast()}if(t){var e=t.getStyle("background-color");t.store("bg",e);t.setStyles(this.css.createRoomBuildingSelectItem_over);this.selectBuildingNode.selectedNode=t}}},selectBuildingConfirm:function(t){if(this.selectBuildingNode.selectedNode){this.selectBuilding(this.selectBuildingNode.selectedNode);t.preventDefault()}},listBuilding:function(){var e=this.form.getItem("buildingName");var t=e.getValue();this.actions.listBuildingByKey(t,function(t){if(t.data&&t.data.length){this.selectBuildingNode=new Element("div",{styles:this.css.createRoomSelectBuildingNode}).inject(e.container);this.setSelectBuildingNodeSize();this.listBuildingHideFun=this.listBuildingHide.bind(this);this.formMaskNode.addEvent("mousedown",this.listBuildingHideFun);this.formNode.addEvent("mousedown",this.listBuildingHideFun);var o=this;t.data.each(function(t,e){var i=new Element("div",{styles:this.css.createRoomBuildingSelectItem}).inject(this.selectBuildingNode);var s=new Element("div",{styles:this.css.createRoomBuildingSelectItemName,text:t.name}).inject(i);var n=new Element("div",{styles:this.css.createRoomBuildingSelectItemAddr,text:t.address}).inject(i);if(e%2==1)i.setStyle("background-color","#f1f6ff");i.store("building",t.id);i.addEvents({mouseover:function(t){var e=this.getStyle("background-color");this.store("bg",e);this.setStyles(o.css.createRoomBuildingSelectItem_over)},mouseout:function(t){this.setStyle("background-color",this.retrieve("bg"))},mousedown:function(t){t.stopPropagation()},click:function(t){o.selectBuilding(this)}})}.bind(this))}}.bind(this))},selectBuilding:function(t){var e=t.retrieve("building");var i=t.getFirst().get("text");this.form.getItem("buildingName").setValue(i);this.buildingId=e;this.listBuildingHide()},setSelectBuildingNodeSize:function(){var t=this.form.getItem("buildingName").getElements()[0];this.selectBuildingNode.position({relativeTo:t,position:"bottomLeft",edge:"upperCenter",offset:{x:4,y:0}});var e=t.getSize();var i=e.x-8;this.selectBuildingNode.setStyle("width",""+i+"px")},listBuildingHide:function(){if(this.selectBuildingNode){this.selectBuildingNode.destroy();this.selectBuildingNode=null;this.formMaskNode.removeEvent("mousedown",this.listBuildingHideFun);this.formNode.removeEvent("mousedown",this.listBuildingHideFun)}},save:function(){this.getData(function(t){this.actions.saveRoom(t,function(t){this.app.notice(this.lp.roomForm.save_success,"success");var e=this.view;this.close();e.reload()}.bind(this))}.bind(this))},getData:function(e){var i=this.form.getResult(true,null,true,false,true);if(!i)return;i.device=i.deviceList.join("#");i.available=i.available=="true";if(!this.buildingId){this.actions.saveBuilding({name:i.buildingName,address:""},function(t){i.building=t.data.id;if(e)e(i)}.bind(this))}else{i.building=this.buildingId;if(e)e(i)}}});MWF.xApplication.Meeting.RoomTooltip=new Class({Extends:MTooltips,_loadCustom:function(t){this.loadBuilding(function(){if(t)t()}.bind(this))},_getHtml:function(){var t=this.data;var e=this.lp.device;var i="font-size:14px;color:#333";var s="font-size:14px;color:#666;padding-right:20px";var n=[];t.device.split("#").each(function(t){n.push(e[t])}.bind(this));e=this.lp.roomForm;var o="<div style='overflow: hidden;padding:15px 20px 20px 10px;height:16px;line-height:16px;'>"+"   <div style='font-size: 16px;color:#333;float: left'>"+this.lp.room+"</div>"+"</div>"+"<div style='font-size: 18px;color:#333;padding:0px 10px 15px 20px;'>"+t.name+"</div>"+"<div style='height:1px;margin:0px 20px;border-bottom:1px solid #ccc;'></div>"+"<table width='100%' bordr='0' cellpadding='7' cellspacing='0' style='margin:13px 13px 13px 13px;'>"+"<tr><td style='"+i+"' width='100'>"+e.building+":</td>"+"    <td style='"+s+"' item='building'></td></tr>"+"<tr><td style='"+i+"'>"+e.floor+":</td>"+"    <td style='"+s+"'>"+t.floor+"</td></tr>"+"<tr><td style='"+i+"'>"+e.capacity+":</td>"+"    <td style='"+s+"'>"+t.capacity+"</td></tr>"+"<tr><td style='"+i+"'>"+e.roomNumber+":</td>"+"    <td style='"+s+"'>"+t.roomNumber+"</td></tr>"+"<tr><td style='"+i+"'>"+e.phone+":</td>"+"    <td style='"+s+"'>"+t.phoneNumber+"</td></tr>"+"<tr><td style='"+i+"'>"+e.device+":</td>"+"    <td style='"+s+"'>"+n.join(",")+"</td></tr>"+"<tr><td style='"+i+"'>"+e.available+":</td>"+"    <td style='"+s+"'>"+(!t.available?this.lp.disable:this.lp.enable)+"</td></tr>"+"</table>";return o},loadBuilding:function(e){var i=this.node.getElement("[item='building']");if(this.data.building){this.app.actions.getBuilding(this.data.building,function(t){i.set("text",t.data.name);if(e)e()}.bind(this))}}});MWF.xApplication.Meeting.MeetingForm=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"meeting",width:"900",height:"640",hasTop:true,hasIcon:false,hasTopIcon:false,hasTopContent:false,hasBottom:false,draggable:true,closeAction:true},open:function(t){this.fireEvent("queryOpen");this.isNew=false;this.isEdited=false;this.getMeetingData(function(){this._open()}.bind(this));this.fireEvent("postOpen")},create:function(){this.fireEvent("queryCreate");this.isNew=true;this._open();this.fireEvent("postCreate")},edit:function(){this.fireEvent("queryEdit");this.isEdited=true;this.getMeetingData(function(){this._open()}.bind(this));this.fireEvent("postEdit")},_createTableContent:function(){this.userName=layout.desktop.session.user.distinguishedName;this.userId=layout.desktop.session.user.id;if(this.isNew){this.formTopTextNode.set("text",this.lp.addMeeting)}else if(this.isEdited){this.formTopTextNode.set("text",this.lp.editMeeting);this.options.height="590"}else{this.formTopTextNode.set("text",this.lp.metting);this.options.height="500"}var t,e,i,s;if(this.options.date||this.options.minute){this.date=typeOf(this.options.date)=="string"?Date.parse(this.options.date):this.options.date;t=this.date.clone().format("%Y-%m-%d");if(this.date.getHours()){e=this.getString(this.date.getHours())+":"+this.getString(this.date.getMinutes());i=this.date.clone().increment("hour",this.options.hour?parseInt(this.options.hour):1);if(this.options.minute)i=i.increment("minute",parseInt(this.options.minute));s=this.getString(i.getHours())+":"+this.getString(i.getMinutes())}else{var n=new Date;e=n.getHours()+1+":"+"00";i=n.clone().increment("hour",this.options.hour?parseInt(this.options.hour):1);if(this.options.minute)i=i.increment("minute",parseInt(this.options.minute));s=i.getHours()+1+":"+"00"}}else{this.date=new Date;t=this.date.clone().format("%Y-%m-%d");e=this.date.getHours()+1+":"+"00";i=this.date.clone().increment("hour",this.options.hour?parseInt(this.options.hour):1);if(this.options.minute)i=i.increment("minute",parseInt(this.options.minute));s=i.getHours()+1+":"+"00"}var o=this.data;var a=!this.isEdited&&!this.isNew&&this.data.status=="wait"&&(this.userName==this.data.applicant||this.userId==this.data.applicant||MWF.AC.isMeetingAdministrator());var l="<table width='100%' bordr='0' cellpadding='7' cellspacing='0' styles='formTable'>"+"<tr>"+"   <td styles='formTableTitle' width='70'>"+this.lp.applyPerson+":</td>"+"    <td styles='formTableValue' item='applicant'></td>"+"</tr>"+"<tr><td styles='formTableTitle' width='100'>"+this.lp.beginDate+":</td>"+"    <td styles='formTableValue' item='dateInput'></td>"+"</tr>"+"<tr><td styles='formTableTitle'>"+this.lp.time+":</td>"+"    <td styles='formTableValue'>"+"       <div item='beginTimeInput' style='float:left'></div>"+"       <div style='float:left; "+(this.isNew?"margin:5px;":"margin:0px 5px;")+"'>"+this.lp.to+"</div>"+"       <div item='endTimeInput' style='float:left'></div>"+"   </td></tr>"+"<tr><td styles='formTableTitle'>"+this.lp.selectRoom+":</td>"+"    <td styles='formTableValue' item='meetingRoom'></td></tr>"+"<tr><td styles='formTableTitle'>"+this.lp.invitePerson2+":</td>"+"    <td styles='formTableValue'>"+"       <div item='invitePersonList'></div>"+"       <div style='display:"+(this.isEdited?"":"none")+";' item='selectinvitePerson'></div>"+(!this.isNew&&this.data.myWaitAccept?"       <tr><td></td><td styles='formTableValue'><div item='acceptAction'></div><div item='rejectAction'></div></td></tr>":"")+"   </td>"+"</tr>"+"<tr><td styles='formTableTitle'>"+this.lp.meetingSubject+":</td>"+"    <td styles='formTableValue' item='subject'></td></tr>"+"<tr><td styles='formTableTitle'>"+this.lp.meetingDescription+":</td>"+"    <td styles='formTableValue' item='description'></td></tr>"+"<tr style='display:none ;' item='attachmentTr'><td styles='formTableTitle'>"+this.lp.meetingAttachment+":</td>"+"    <td styles='formTableValue' item='attachment'></td></tr>"+"<tr><td styles='formTableTitle'></td>"+"    <td styles='formTableValue' style='padding-top: 10px;'>"+"       <div item='saveAction' style='float:left;display:"+(this.isEdited||this.isNew?"":"none")+";'></div>"+"       <div item='editAction' style='float:left;display:"+(a?"":"none")+";'></div>"+"       <div item='removeAction' style='float:left;display:"+(this.isEdited?"":"none")+";'></div>"+"       <div item='cancelAction' style='"+(this.isEdited||this.isNew||a?"float:left;":"float:right;margin-right:15px;")+"'></div>"+"   </td></tr>"+"</table>";this.formTableArea.set("html",l);if(o.startTime){var d=Date.parse(o.startTime);o.dateInput=d.format("%Y-%m-%d");o.beginTimeInput=this.getString(d.getHours())+":"+this.getString(d.getMinutes())}if(o.completedTime){var c=Date.parse(o.completedTime);o.endTimeInput=this.getString(c.getHours())+":"+this.getString(c.getMinutes())}this.meetingRoomArea=this.formTableArea.getElement("[item='meetingRoom']");this.attachmentTr=this.formTableArea.getElement("[item='attachmentTr']");this.attachmentArea=this.formTableArea.getElement("[item='attachment']");MWF.xDesktop.requireApp("Template","MForm",function(){this.form=new MForm(this.formTableArea,o,{isEdited:this.isEdited||this.isNew,style:"meeting",itemTemplate:{applicant:{type:"org",orgType:"person",isEdited:false,defaultValue:this.userName},dateInput:{tType:"date",isEdited:this.isNew,defaultValue:t,event:{change:function(t,e){this.clearRoom()}.bind(this)}},beginTimeInput:{tType:"time",isEdited:this.isNew,defaultValue:e,className:this.isNew?"inputTimeUnformatWidth":"",event:{change:function(t,e){this.clearRoom()}.bind(this)}},endTimeInput:{tType:"time",isEdited:this.isNew,defaultValue:s,className:this.isNew?"inputTimeUnformatWidth":"",event:{change:function(t,e){this.clearRoom()}.bind(this)}},invitePersonList:{type:"org",isEdited:this.isNew,orgType:["identity","person"],count:0,orgWidgetOptions:{onLoadedInfor:function(t){this.loadAcceptAndReject(t)}.bind(this)}},selectinvitePerson:{type:"button",value:this.lp.addInvitePerson1,style:{"margin-left":"20px"},event:{click:function(n){var t={type:"",types:["identity","person"],values:[],count:0,onComplete:function(t){MWF.require("MWF.widget.O2Identity",function(){var s=[];t.each(function(t){var e=this;if(t.data.distinguishedName.split("@").getLast().toLowerCase()=="i"){var i=new MWF.widget.O2Identity(t.data,n.form.getItem("invitePersonList").container,{style:"room"});s.push(t.data.distinguishedName)}else{var i=new MWF.widget.O2Person(t.data,n.form.getItem("invitePersonList").container,{style:"room"});s.push(t.data.distinguishedName)}}.bind(this));this.app.actions.addMeetingInvite(this.data.id,{invitePersonList:s,id:this.data.id},function(t){this.app.actions.getMeeting(t.data.id,function(t){this.invitePersonList=t.data.invitePersonList;this.app.notice(this.app.lp.addedInvitePerson1,"success",this.node)}.bind(this))}.bind(this))}.bind(this))}.bind(this)};var e=new MWF.O2Selector(this.app.content,t)}.bind(this)}},subject:{},description:{type:"textarea"},acceptAction:{type:"button",value:this.lp.accept,className:"inputAcceptButton",event:{click:function(t,e){this.accept(e)}.bind(this)}},rejectAction:{type:"button",value:this.lp.reject,style:{"margin-left":"20px"},className:"inputDenyButton",event:{click:function(t,e){this.reject(e)}.bind(this)}},saveAction:{type:"button",className:"inputOkButton",value:this.lp.save,event:{click:function(){this.save()}.bind(this)}},removeAction:{type:"button",className:"inputCancelButton",value:this.lp.cancelMeeting,event:{click:function(t,e){this.cancelMeeting(e)}.bind(this)}},editAction:{type:"button",className:"inputOkButton",value:this.lp.editMeeting,event:{click:function(){this.editMeeting()}.bind(this)}},cancelAction:{type:"button",className:"inputCancelButton",value:this.lp.close,event:{click:function(){this.close()}.bind(this)}}}},this.app);this.form.load();this.loadSelectRoom();if(this.data.id)this.loadAttachment()}.bind(this),true)},getString:function(t){var e="00"+t;return e.substr(e.length-2,2)},loadAcceptAndReject:function(t){var e=t.data.distinguishedName;if(this.data.acceptPersonList){if(this.data.acceptPersonList.indexOf(e)!==-1){var i=new Element("div",{styles:this.css.acceptIconNode}).inject(t.node,"top");new Element("div",{styles:this.css.acceptTextNode,text:this.app.lp.accepted}).inject(t.inforNode)}}if(this.data.rejectPersonList){if(this.data.rejectPersonList.indexOf(e)!==-1){var s=new Element("div",{styles:this.css.rejectIconNode}).inject(t.node,"top");new Element("div",{styles:this.css.rejectTextNode,text:this.app.lp.rejected}).inject(t.inforNode)}}},getMeetingData:function(e){if(this.data&&this.data.id){this.app.actions.getMeeting(this.data.id,function(t){this.data=t.data;if(e)e()}.bind(this))}else{if(e)e()}},editMeeting:function(){this.formTopNode=null;if(this.setFormNodeSizeFun&&this.app){this.app.removeEvent("resize",this.setFormNodeSizeFun)}if(this.formMaskNode)this.formMaskNode.destroy();this.formAreaNode.destroy();this.edit()},cancelMeeting:function(t){var e=this;var i=this.app.lp.cancel_confirm.replace(/{name}/g,this.data.subject);this.app.confirm("infor",t,this.app.lp.cancel_confirm_title,i,380,200,function(){e._cancelMeeting();this.close();e.close()},function(){this.close()})},_cancelMeeting:function(){var t=this.view;this.app.actions.deleteMeeting(this.data.id,function(){t.reload()}.bind(this))},reset:function(){this.formTableArea.empty();this._createTableContent()},clearRoom:function(){this.roomId="";if(this.roomInput)this.roomInput.set("text","")},loadSelectRoom:function(){var t=new Element("div",{styles:this.css.createMeetingInfoLineNode}).inject(this.meetingRoomArea);var e=new Element("div",{styles:this.css.createMeetingInfoItemEditNode,html:"<div></div>"}).inject(t);this.roomInput=e.getFirst();this.roomInput.setStyles(this.css.createMeetingInfoItemDivNode);if(this.isNew){this.roomInput.addEvents({click:function(t){this.selectRooms()}.bind(this)})}var i=this.data.room||this.options.room;if(i){this.app.actions.getRoom(i,function(e){this.app.actions.getBuilding(e.data.building,function(t){this.roomId=i;this.roomInput.set("text",e.data.name+" ("+t.data.name+")")}.bind(this))}.bind(this))}},selectRooms:function(){this.createRoomNode(function(){this.loadSelectRooms();this.selectRoomNode.setStyle("display","block");this.hideRoomNodeFun=this.hideRoomNode.bind(this);document.body.addEvent("mousedown",this.hideRoomNodeFun);this.selectRoomNode.position({relativeTo:this.roomInput,position:"bottomLeft",edge:"upperLeft",offset:{x:0,y:0}});var t=this.roomInput.getSize();var e=t.x-2;this.selectRoomNode.setStyle("width",""+e+"px")}.bind(this))},createRoomNode:function(t){if(!this.selectRoomNode){this.selectRoomNode=new Element("div",{styles:this.css.createMeetingInfoSelectRoomNode}).inject(this.formNode);this.selectRoomNode.addEvent("mousedown",function(t){t.stopPropagation()});if(t)t()}else{if(t)t()}},loadSelectRooms:function(){var t=this.form.getResult(false,null,false,false,true);var e=t.dateInput;var i=t.beginTimeInput;var s=t.endTimeInput;var n=e+" "+i;var o=e+" "+s;this.app.actions.listBuildingByRange(n,o,function(t){t.data.each(function(i){var t=new Element("div",{styles:this.css.createMeetingInfoSelectRoomItem1Node}).inject(this.selectRoomNode);var e=new Element("div",{styles:this.css.createMeetingInfoSelectRoomItem1NameNode,text:i.name}).inject(t);var s=new Element("div",{styles:this.css.createMeetingInfoSelectRoomItem1AddrNode,text:i.address}).inject(t);i.roomList.each(function(t,e){if(t.available&&t.idle)this.createRoomSelectNode(t,e,i)}.bind(this))}.bind(this))}.bind(this))},createRoomSelectNode:function(t,e,i){var s=new Element("div",{styles:this.css.roomTitleNode}).inject(this.selectRoomNode);var n=new Element("div",{styles:this.css.roomTitleCapacityNode,text:t.capacity+this.lp.person}).inject(s);var o=new Element("div",{styles:this.css.roomTitleInforNode}).inject(s);var a=new Element("div",{styles:{height:"20px"}}).inject(o);var l=new Element("div",{styles:this.css.roomTitleNumberNode,text:t.roomNumber?"#"+t.roomNumber:""}).inject(a);var d=new Element("div",{styles:this.css.roomTitleNameNode,text:t.name}).inject(a);var c=new Element("div",{styles:this.css.roomTitleIconsNode}).inject(o);var h=t.device.split("#");h.each(function(t){var e=new Element("div",{styles:this.css.roomTitleIconNode,title:this.lp.device[t]}).inject(c);e.setStyle("background-image","url(/x_component_Meeting/$RoomView/default/icon/device/"+t+"_disable.png)")}.bind(this));if(e%2!=0)s.setStyle("background-color","#f4f8ff");s.store("room",t);var r=this;if(t.idle){s.addEvents({mouseover:function(t){var e=s.getStyle("background-color");this.store("bgcolor",e);this.setStyle("background-color","#e4edfc")},mouseout:function(){var t=this.retrieve("bgcolor","#FFF");this.setStyle("background-color",t)},click:function(){var t=this.retrieve("room");r.roomId=t.id;r.roomInput.set("text",t.name+" ("+i.name+")");r.hideRoomNode()}})}else{s.setStyle("background-color","#fff6f6");var p=new Element("div",{styles:this.css.roomTitleDisabledIconNode}).inject(s)}},hideRoomNode:function(){this.selectRoomNode.empty();this.selectRoomNode.setStyle("display","none");document.body.removeEvent("mousedown",this.hideRoomNodeFun)},setCreateRoomSelectBuildingNodeSize:function(){var t=this.createRoomBuildingInput.getPosition(this.createRoomBuildingInput.getOffsetParent());this.createRoomSelectBuildingNode.position({relativeTo:this.createRoomBuildingInput,position:"bottomCenter",edge:"upperCenter",offset:{x:0,y:0}});this.createRoomSelectBuildingNode.setStyle("left",t.x);var e=this.createRoomBuildingInput.getSize();var i=e.x-2;this.createRoomSelectBuildingNode.setStyle("width",""+i+"px")},loadAttachment:function(){this.attachmentTr.setStyle("display","");this.attachmentNode=new Element("div",{styles:this.css.createMeetingAttachmentNode}).inject(this.attachmentArea);var t=new Element("div",{styles:this.css.createMeetingAttachmentContentNode}).inject(this.attachmentNode);MWF.require("MWF.widget.AttachmentController",function(){this.attachmentController=new MWF.widget.AttachmentController(t,this,{size:"min",isSizeChange:false,isReplace:false,isUpload:this.isNew||this.isEdited,isDelete:this.isNew||this.isEdited,isDownload:true,readonly:!this.isNew&&!this.isEdited});this.attachmentController.load();if(this.data.attachmentList){this.data.attachmentList.each(function(t){t.person=t.lastUpdatePerson.split("@")[0];var e=this.attachmentController.addAttachment(t)}.bind(this))}}.bind(this))},uploadAttachment:function(t,e){if(!this.uploadFileAreaNode){this.createUploadFileNode()}this.fileUploadNode.click()},createUploadFileNode:function(){this.uploadFileAreaNode=new Element("div");var t='<input name="file" type="file" multiple/>';this.uploadFileAreaNode.set("html",t);this.fileUploadNode=this.uploadFileAreaNode.getFirst();this.fileUploadNode.addEvent("change",function(){var t=this.fileUploadNode.files;if(t.length){for(var e=0;e<t.length;e++){var i=t.item(e);var s=new FormData;s.append("file",i);this.app.actions.addAttachment(this.data.id,s,i,function(t,e){if(t.id){this.app.actions.getAttachment(t.id,function(t){if(t.data)this.attachmentController.addAttachment(t.data);this.attachmentController.checkActions()}.bind(this))}this.attachmentController.checkActions()}.bind(this))}}}.bind(this))},deleteAttachments:function(t,e,i){var s=[];i.each(function(t){s.push(t.data.name)}.bind(this));var n=this;this.app.confirm("warn",t,this.lp.deleteAttachmentTitle,this.lp.deleteAttachment+"( "+s.join(", ")+" )",300,120,function(){while(i.length){attachment=i.shift();n.deleteAttachment(attachment)}this.close()},function(){this.close()},null)},deleteAttachment:function(e){this.app.actions.deleteFile(e.data.id,function(t){this.attachmentController.removeAttachment(e);this.attachmentController.checkActions()}.bind(this))},downloadAttachment:function(t,e,i){i.each(function(t){this.app.actions.getFileDownload(t.data.id)}.bind(this))},openAttachment:function(t,e,i){i.each(function(t){this.app.actions.getFile(t.data.id)}.bind(this))},getAttachmentUrl:function(t,e){this.app.actions.getFileUrl(t.data.id,e)},save:function(){this._save(function(){this.app.notice(this.lp.meeting_saveSuccess,"success");if(!this.attachmentNode){this.loadAttachment()}}.bind(this))},_save:function(e){this.getSaveData();var t=new Date;var i="";if(!this.data.subject)i+=this.lp.meeting_input_subject_error;if(!this.data.room)i+=this.lp.meeting_input_room_error;if(!this.data.invitePersonList.length)i+=this.lp.meeting_input_person_error;if(this.data.startTimeDate){if(this.data.startTimeDate.diff(this.data.completedTimeDate,"minute")<1)i+=this.lp.meeting_input_time_error;if(t.diff(this.data.startTimeDate,"minute")<0)i+=this.lp.meeting_input_date_error;delete this.data.startTimeDate;delete this.data.completedTimeDate}if(i){this.app.notice(this.lp.meeting_input_error+i,"error");return false}this.app.actions.saveMeeting(this.data,function(t){this.data.id=t.data.id;this.waitReload=true;if(e)e()}.bind(this))},getSaveData:function(){this.data=this.form.getResult(false,null,false,false,true);this.data.room=this.roomId;if(this.invitePersonList){this.data.invitePersonList=this.invitePersonList}var t=this.data.dateInput;if(this.isNew){var e=t+" "+this.data.beginTimeInput+":0";var i=t+" "+this.data.endTimeInput+":0";var s=Date.parse(e);var n=Date.parse(i);this.data.startTime=e;this.data.completedTime=i;this.data.startTimeDate=s;this.data.completedTimeDate=n}if(this.isNew){delete this.data.applicant}else{this.data.applicant=this.data.applicant.join(",")}},getPersonByIdentity:function(t){},getPerson:function(t){if(typeOf(t)!="array")t=[t];var e=[];t.each(function(t){if(t.split("@").getLast().toLowerCase()=="i"){e.push(this.getPersonByIdentity(t))}else{e.push(t)}}.bind(this));return e},reject:function(t){var e=this;var i=this.app.lp.reject_confirm.replace(/{name}/g,this.data.subject);this.app.confirm("infor",t,this.app.lp.reject_confirm_title,i,300,120,function(){e.rejectMeeting();this.close();e.close()},function(){this.close()})},rejectMeeting:function(){var t=this.view;this.app.actions.rejectMeeting(this.data.id,function(){t.reload()}.bind(this))},accept:function(t){var e=this;var i=this.app.lp.accept_confirm.replace(/{name}/g,this.data.subject);this.app.confirm("infor",t,this.app.lp.accept_confirm_title,i,300,120,function(){e.acceptMeeting();this.close();e.close()},function(){this.close()})},acceptMeeting:function(){var t=this.view;this.app.actions.acceptMeeting(this.data.id,function(){t.reload()}.bind(this))},close:function(t){this.fireEvent("queryClose");this._close();if(this.setFormNodeSizeFun&&this.app){this.app.removeEvent("resize",this.setFormNodeSizeFun)}if(this.formMaskNode)this.formMaskNode.destroy();this.formAreaNode.destroy();this.fireEvent("postClose");if(this.waitReload)this.view.reload();delete this}});MWF.xApplication.Meeting.MeetingTooltip=new Class({Extends:MTooltips,_loadCustom:function(t){this.loadRoom(function(){this.loadInvite();this.loadAttachment();if(t)t()}.bind(this))},_getHtml:function(){var t=this.data;var e="font-size:14px;color:#333";var i="font-size:14px;color:#666;padding-right:20px";var s=[];t.invitePersonList.each(function(t){s.push(t.split("@")[0])}.bind(this));var n="#ccc";switch(t.status){case"wait":n="#4990E2";break;case"processing":n="#66CC7F";break;case"completed":n="#666";break}if(t.myWaitAccept){n="#F6A623"}if(t.confilct){n="#FF7F7F"}var o=Date.parse(t.startTime);var a=Date.parse(t.completedTime);var l=o.format(this.app.lp.dateFormatDay);var d=this.getString(o.getHours())+":"+this.getString(o.getMinutes());var c=this.getString(a.getHours())+":"+this.getString(a.getMinutes());var h=l+" "+d+"-"+c;var r="<div style='overflow: hidden;padding:15px 20px 20px 10px;height:16px;line-height:16px;'>"+"   <div style='font-size: 12px;color:#666; float: right'>"+this.lp.applyPerson+":"+t.applicant.split("@")[0]+"</div>"+"   <div style='font-size: 16px;color:#333;float: left'>"+this.lp.meetingDetail+"</div>"+"</div>"+"<div style='font-size: 18px;color:#333;padding:0px 10px 15px 20px;'>"+t.subject+"</div>"+"<div style='height:1px;margin:0px 20px;border-bottom:1px solid #ccc;'></div>"+"<table width='100%' bordr='0' cellpadding='7' cellspacing='0' style='margin:13px 13px 13px 13px;'>"+"<tr><td style='"+e+";' width='70'>"+this.lp.meetingTime+":</td>"+"    <td style='"+i+";color:"+n+"'>"+h+"</td></tr>"+"<tr><td style='"+e+"'>"+this.lp.selectRoom+":</td>"+"    <td style='"+i+"' item='meetingRoom'></td></tr>"+"<tr><td style='"+e+"'>"+this.lp.invitePerson2+":</td>"+"    <td style='"+i+"' item='invitePerson'>"+s.join(",")+"</td></tr>"+"<tr><td style='"+e+"'>"+this.lp.meetingDescription+":</td>"+"    <td style='"+i+"'>"+t.description+"</td></tr>"+(this.options.isHideAttachment?"":"<tr><td style='"+e+"'>"+this.lp.meetingAttachment+":</td>"+"    <td style='"+i+"' item='attachment'></td></tr>")+"</table>";return r},getString:function(t){var e="00"+t;return e.substr(e.length-2,2)},loadRoom:function(i){var s=this.node.getElement("[item='meetingRoom']");if(this.data.room){this.app.actions.getRoom(this.data.room,function(e){this.app.actions.getBuilding(e.data.building,function(t){s.set("text",e.data.name+" ("+t.data.name+")");if(i)i()}.bind(this))}.bind(this))}},loadInvite:function(){this.O2PersonList=[];var i=this.node.getElement("[item='invitePerson']");MWF.require("MWF.widget.O2Identity",function(){i.empty();this.data.invitePersonList.each(function(t){var e=new MWF.widget.O2Person({name:t},i,{style:"room",onLoadedInfor:function(t){this.loadAcceptAndReject(t)}.bind(this)});this.O2PersonList.push(e)}.bind(this))}.bind(this))},loadAcceptAndReject:function(t){var e=t.data.distinguishedName;if(this.data.acceptPersonList){if(this.data.acceptPersonList.indexOf(e)!==-1){var i=new Element("div",{styles:{height:"20px",width:"14px","margin-right":"3px",float:"left",background:"url(/x_component_Template/$MPopupForm/meeting/icon/accept.png) no-repeat center center"}}).inject(t.node,"top");new Element("div",{styles:{color:"#1fbf04",clear:"both","text-align":"center"},text:this.app.lp.accepted}).inject(t.inforNode)}}if(this.data.rejectPersonList){if(this.data.rejectPersonList.indexOf(e)!==-1){var s=new Element("div",{styles:{height:"20px",width:"14px","margin-right":"3px",float:"left",background:"url(/x_component_Template/$MPopupForm/meeting/icon/reject.png) no-repeat center center"}}).inject(t.node,"top");new Element("div",{styles:{color:"#FF0000",clear:"both","text-align":"center"},text:this.app.lp.rejected}).inject(t.inforNode)}}},destroy:function(){if(this.O2PersonList){this.O2PersonList.each(function(t){t.destroy()})}if(this.node){this.node.destroy();this.node=null}},loadAttachment:function(){if(this.options.isHideAttachment)return;if(typeOf(this.data.attachmentList)=="array"&&this.data.attachmentList[0]){var t=this.node.getElement("[item='attachment']");this.attachmentNode=new Element("div").inject(t);var e=new Element("div",{}).inject(this.attachmentNode);this.attachmentController=new MWF.xApplication.Meeting.MeetingTooltip.AttachmentController(e,this,{size:"min",isSizeChange:false,isReplace:false,isUpload:false,isDelete:false,isDownload:true,readonly:true});this.attachmentController.load();this.data.attachmentList.each(function(t){t.person=t.lastUpdatePerson.split("@")[0];var e=this.attachmentController.addAttachment(t)}.bind(this))}},downloadAttachment:function(t,e,i){i.each(function(t){this.app.actions.getFileDownload(t.data.id)}.bind(this))},openAttachment:function(t,e,i){i.each(function(t){this.app.actions.getFile(t.data.id)}.bind(this))},getAttachmentUrl:function(t,e){this.app.actions.getFileUrl(t.data.id,e)}});MWF.xApplication.Meeting.MeetingTooltip.AttachmentController=new Class({Extends:MWF.widget.AttachmentController,loadMin:function(){if(!this.node)this.node=new Element("div",{styles:this.css.container_min});if(!this.minActionAreaNode){this.minContent=new Element("div",{styles:this.css.minContentNode}).inject(this.node);this.minContent.setStyles({"margin-right":"0px"});this.node.inject(this.container);this.checkActions();this.setEvent()}else{this.minContent.setStyle("display","block");this.minContent.empty()}var t=[];while(this.attachments.length){var e=this.attachments.shift();t.push(new MWF.xApplication.Meeting.MeetingTooltip.AttachmentMin(e.data,this))}this.attachments=t},addAttachment:function(t){if(this.options.size=="min"){this.attachments.push(new MWF.xApplication.Meeting.MeetingTooltip.AttachmentMin(t,this))}else{this.attachments.push(new MWF.widget.AttachmentController.Attachment(t,this))}}});MWF.xApplication.Meeting.MeetingTooltip.AttachmentMin=new Class({Extends:MWF.widget.AttachmentController.AttachmentMin,setEvent:function(){this.node.addEvents({mouseover:function(){if(!this.isSelected)this.node.setStyles(this.css["minAttachmentNode_list_over"])}.bind(this),mouseout:function(){if(!this.isSelected)this.node.setStyles(this.css["minAttachmentNode_list"])}.bind(this),mousedown:function(t){this.selected(t)}.bind(this),click:function(t){this.downloadAttachment(t)}.bind(this)})},downloadAttachment:function(t){if(this.controller.module)this.controller.module.downloadAttachment(t,null,[this])}});MWF.xApplication.Meeting.MeetingArea=new Class({initialize:function(t,e,i){this.container=t;this.view=e;this.css=this.view.css;this.app=this.view.app;this.data=i;this.beginDate=Date.parse(this.data.startTime);this.endDate=Date.parse(this.data.completedTime);this.userName=layout.desktop.session.user.distinguishedName;this.userId=layout.desktop.session.user.id;this.parseData();this.path="/x_component_Meeting/$Common/default/meetingarea/";this.cssPath="/x_component_Meeting/$Common/default/meetingarea/css.wcss";this._loadCss();this.load()},load:function(){this.node=new Element("div",{styles:this.css.meetingNode}).inject(this.container);this.node.addEvents({mouseenter:function(){this.node.setStyles(this.css.meetingNode_over);this.subjectNode.setStyles(this.css.meetingSubjectNode_over)}.bind(this),mouseleave:function(){this.node.setStyles(this.css.meetingNode);this.subjectNode.setStyles(this.css.meetingSubjectNode)}.bind(this),click:function(){this.openMeeting()}.bind(this)});this.colorNode=new Element("div",{styles:this.css.meetingColorNode}).inject(this.node);this.contentNode=new Element("div",{styles:this.css.meetingContentNode}).inject(this.node);var t=(this.beginDate.getHours()<12?this.app.lp.am:this.app.lp.pm)+" "+this.getString(this.beginDate.getHours())+":"+this.getString(this.beginDate.getMinutes());var e=(this.endDate.getHours()<12?this.app.lp.am:this.app.lp.pm)+" "+this.getString(this.endDate.getHours())+":"+this.getString(this.endDate.getMinutes());this.timeNode=new Element("div",{styles:this.css.meetingTimeNode,text:t+"-"+e}).inject(this.contentNode);this.subjectNode=new Element("div",{styles:this.css.meetingSubjectNode,text:this.data.subject}).inject(this.contentNode);this.descriptionNode=new Element("div",{styles:this.css.meetingDescriptionNode,text:this.data.description}).inject(this.contentNode);this.loadActionBar();switch(this.data.status){case"wait":this.colorNode.setStyles({"background-color":"#4990E2"});this.timeNode.setStyles({color:"#4990E2"});break;case"processing":this.colorNode.setStyles({"background-color":"#66CC7F"});this.timeNode.setStyles({color:"#66CC7F"});break;case"completed":this.colorNode.setStyles({"background-color":"#ccc"});this.timeNode.setStyles({color:"#ccc"});break}if(this.data.myWaitAccept){this.colorNode.setStyles({"background-color":"#F6A623"});this.timeNode.setStyles({color:"#F6A623"})}this.resetNodeSize();this.loadTooltip()},parseData:function(){if(!this.data.status){var t=new Date;var e;if(this.beginDate>t){e="wait"}else if(this.endDate<t){e="completed"}else{e="processing"}this.data.status=e}if(typeOf(this.data.myWaitAccept)!="boolean"){if(this.data.invitePersonList.contains(this.userName)||this.data.invitePersonList.contains(this.userId)){this.data.myWaitAccept=(!this.data.acceptPersonList.contains(this.userName)||this.data.acceptPersonList.contains(this.userId))&&(!this.data.rejectPersonList.contains(this.userName)||!this.data.rejectPersonList.contains(this.userId))}}},loadActionBar:function(){if(this.userName==this.data.applicant||this.userId==this.data.applicant||MWF.AC.isMeetingAdministrator()||this.data.myWaitAccept){}else{return}this.actionBar=new Element("div",{styles:this.css.actionBar}).inject(this.contentNode);if(this.userName==this.data.applicant||this.userId==this.data.applicant||MWF.AC.isMeetingAdministrator()){if(this.data.status=="wait"){this.editAction=new Element("div",{styles:this.css.action_edit,events:{mouseover:function(){this.editAction.setStyles(this.css.action_edit_over)}.bind(this),mouseout:function(){this.editAction.setStyles(this.css.action_edit)}.bind(this),click:function(t){this.editMeeting();t.stopPropagation()}.bind(this)}}).inject(this.actionBar);this.removeAction=new Element("div",{styles:this.css.action_remove,events:{mouseover:function(){this.removeAction.setStyles(this.css.action_remove_over)}.bind(this),mouseout:function(){this.removeAction.setStyles(this.css.action_remove)}.bind(this),click:function(t){this.cancel(t);t.stopPropagation()}.bind(this)}}).inject(this.actionBar)}}if(this.data.myWaitAccept){this.acceptAction=new Element("div",{styles:this.css.action_accept,title:this.app.lp.accept,events:{mouseover:function(){this.acceptAction.setStyles(this.css.action_accept_over)}.bind(this),mouseout:function(){this.acceptAction.setStyles(this.css.action_accept)}.bind(this),click:function(t){this.accept(t);t.stopPropagation()}.bind(this)}}).inject(this.actionBar);this.rejectAction=new Element("div",{styles:this.css.action_reject,title:this.app.lp.reject,events:{mouseover:function(){this.rejectAction.setStyles(this.css.action_reject_over)}.bind(this),mouseout:function(){this.rejectAction.setStyles(this.css.action_reject)}.bind(this),click:function(t){this.reject(t);t.stopPropagation()}.bind(this)}}).inject(this.actionBar)}},getString:function(t){var e="00"+t;return e.substr(e.length-2,2)},_loadCss:function(){var i=encodeURIComponent(this.cssPath);if(MWF.widget.css[i]){this.css=MWF.widget.css[i]}else{var t=new Request.JSON({url:this.cssPath,secure:false,async:false,method:"get",noCache:false,onSuccess:function(t,e){this.css=t;MWF.widget.css[i]=t}.bind(this),onError:function(t,e){alert(e+t)}});t.send()}},loadTooltip:function(t){this.tooltip=new MWF.xApplication.Meeting.MeetingTooltip(this.app.content,this.node,this.app,this.data,{axis:"x",hiddenDelay:300,displayDelay:300,isHideAttachment:t})},showTooltip:function(){if(this.tooltip){this.tooltip.load()}else{this.tooltip=new MWF.xApplication.Meeting.MeetingTooltip(this.app.content,this.viewAction,this.app,this.data);this.tooltip.load()}},openMeeting:function(){var t=new MWF.xApplication.Meeting.MeetingForm(this,this.data,{},{app:this.app});t.view=this.view;t.open()},resetNodeSize:function(){var t=this.contentNode.getSize();this.colorNode.setStyle("height",t.y)},destroy:function(){if(this.tooltip)this.tooltip.destroy();this.node.destroy();MWF.release(this)},editMeeting:function(){var t=new MWF.xApplication.Meeting.MeetingForm(this,this.data,{},{app:this.app});t.view=this.view;t.edit()},cancel:function(t){var e=this;var i=this.app.lp.cancel_confirm.replace(/{name}/g,this.data.subject);this.app.confirm("infor",t,this.app.lp.cancel_confirm_title,i,380,150,function(){e.cancelMeeting();this.close()},function(){this.close()})},cancelMeeting:function(){var t=this.view;this.app.actions.deleteMeeting(this.data.id,function(){t.reload()}.bind(this))},reject:function(t){var e=this;var i=this.app.lp.reject_confirm.replace(/{name}/g,this.data.subject);this.app.confirm("infor",t,this.app.lp.reject_confirm_title,i,300,120,function(){e.rejectMeeting();this.close()},function(){this.close()})},rejectMeeting:function(){var t=this.view;this.app.actions.rejectMeeting(this.data.id,function(){t.reload()}.bind(this))},accept:function(t){var e=this;var i=this.app.lp.accept_confirm.replace(/{name}/g,this.data.subject);this.app.confirm("infor",t,this.app.lp.accept_confirm_title,i,300,120,function(){e.acceptMeeting();this.close()},function(){this.close()})},acceptMeeting:function(){var t=this.view;this.app.actions.acceptMeeting(this.data.id,function(){t.reload()}.bind(this))},disagree:function(t){var e=this;var i=this.app.lp.disagree_confirm.replace(/{name}/g,this.data.subject);this.app.confirm("infor",t,this.app.lp.disagree_confirm_title,i,300,120,function(){e.disagreeMeeting();this.close()},function(){this.close()})},disagreeMeeting:function(){var t=this.view;this.app.actions.denyMeeting(this.data.id,function(){t.reload()}.bind(this))},agree:function(t){var e=this;var i=this.app.lp.agree_confirm.replace(/{name}/g,this.data.subject);this.app.confirm("infor",t,this.app.lp.agree_confirm_title,i,300,120,function(){e.agreeMeeting();this.close()},function(){this.close()})},agreeMeeting:function(){var t=this.view;this.app.actions.allowMeeting(this.data.id,function(){t.reload()}.bind(this))}});MWF.xApplication.Meeting.SideBar=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default"},initialize:function(t,e,i){this.setOptions(i);this.container=t;this.app=e;this.lp=this.app.lp;this.isHidden=false;this.cssPath="/x_component_Meeting/$Common/"+this.options.style+"/sidebar/css.wcss";this._loadCss();this.load()},load:function(){this.node=new Element("div.sideBar",{styles:this.css.node,events:{mousedown:function(t){t.stopPropagation()}}}).inject(this.container);this.contentNode=new Element("div",{styles:this.css.contentNode}).inject(this.node);this.loadStatusArea();new Element("div.contentLine",{styles:this.css.contentLine}).inject(this.contentNode);this.loadTodayMeetingNode();this.trapezoid=new Element("div.trapezoid",{styles:this.css.trapezoid_toRight,events:{click:function(){this.trigger()}.bind(this)}}).inject(this.node);this.loadTodayMeeting(function(){var t=this.node.getSize().x-8;this.node.setStyle("right","-"+t+"px");this.resetNodeSize();this.resetNodeSizeFun=this.resetNodeSize.bind(this);this.app.addEvent("resize",this.resetNodeSizeFun);this.hideFun=this.hide.bind(this);this.app.node.addEvent("mousedown",this.hideFun)}.bind(this))},loadStatusArea:function(){var t=new Element("div",{styles:this.css.statusArea}).inject(this.contentNode);var e="<div class='titleDiv'>"+this.lp.config.meetingStatus+"</div>"+"<div class = 'statusStyle'>"+"   <div class='statusIconStyle' style='background-color:#4990E2'></div>"+"   <div class = 'statusTextStyle'>"+this.lp.config.wait+"</div></div>"+"</div>"+"<div class = 'statusStyle'>"+"   <div class='statusIconStyle' style='background-color:#66CC7F'></div>"+"   <div class = 'statusTextStyle'>"+this.lp.config.progress+"</div></div>"+"</div>"+"<div class = 'statusStyle'>"+"   <div class='statusIconStyle' style='background-color:#F6A623'></div>"+"   <div class = 'statusTextStyle'>"+this.lp.config.invite+"</div></div>"+"</div>"+"<div class = 'statusStyle'>"+"   <div  class='statusIconStyle' style='background-color:#ccc'></div>"+"   <div class = 'statusTextStyle'>"+this.lp.config.completed+"</div></div>"+"</div>"+"<div class = 'statusStyle'>"+"   <div  class='statusIconStyle2' style='border:2px solid #FF7F7F;'></div>"+"   <div class = 'statusTextStyle'>"+this.lp.config.conflict+"</div></div>"+"</div>";t.set("html",e);t.getElements("div.titleDiv").setStyles(this.css.titleDiv);t.getElements("div.statusStyle").setStyles(this.css.statusStyle);t.getElements("div.statusIconStyle").setStyles(this.css.statusIconStyle);t.getElements("div.statusIconStyle2").setStyles(this.css.statusIconStyle2);t.getElements("div.statusTextStyle").setStyles(this.css.statusTextStyle)},loadTodayMeetingNode:function(){var t=new Element("div.meetingArea",{styles:this.css.meetingArea}).inject(this.contentNode);new Element("div.titleDiv",{styles:this.css.titleDiv,text:this.lp.meetingNotice}).inject(t);this.meetingNode=Element("div",{styles:this.css.meetingNode}).inject(t)},loadTodayMeeting:function(n){var t=new Date;var o=layout.desktop.session.user;var a=o.distinguishedName;var e=t.getFullYear();var i=t.getMonth()+1;var s=t.getDate();this.app.actions.listMeetingDay(e,i,s,function(t){var e=[];t.data.each(function(t){if(t.invitePersonList.contains(a)||t.applicant==a){if(!t.rejectPersonList.contains(a)){e.push(t)}}}.bind(this));if(o.distinguishedName){var i=o.distinguishedName.split("@")[0]}else{var i=o.name}var s=e.length?this.lp.meetingTopInfor:this.lp.noMeetingTopInfor;this.meetingTopNode=new Element("div",{styles:this.css.meetingTopNode,html:s.replace("{userName}",i).replace("{count}",e.length)}).inject(this.meetingNode);this.scrollNode=new Element("div.scrollNode",{styles:this.css.scrollNode}).inject(this.meetingNode);this.meetingItemContainer=new Element("div.meetingItemContainer",{styles:this.css.meetingItemContainer}).inject(this.scrollNode);e.each(function(t,e){var i=new Element("div.meetingItemNode",{styles:this.css.meetingItemNode,events:{click:function(){this.obj.openMeeting(this.data)}.bind({obj:this,data:t})}}).inject(this.meetingItemContainer);this.tooltipList=this.tooltipList||[];this.tooltipList.push(new MWF.xApplication.Meeting.MeetingTooltip(this.app.content,i,this.app,t,{axis:"x",hiddenDelay:300,displayDelay:300}));var s=new Element("div.meetingItemColorNode",{styles:this.css.meetingItemColorNode,text:e+1}).inject(i);var n=new Element("div.meetingItemTextNode",{styles:this.css.meetingItemTextNode,text:t.subject}).inject(i);switch(t.status){case"wait":s.setStyles({"background-color":"#4990E2"});break;case"processing":s.setStyles({"background-color":"#66CC7F"});break;case"completed":s.setStyles({"background-color":"#ccc"});break}if(t.myWaitAccept){s.setStyles({"background-color":"#F6A623"})}var o=i.getSize().y;s.setStyle("margin-top",(o-20)/2)}.bind(this));this.setScrollBar(this.scrollNode);if(n)n()}.bind(this))},trigger:function(){this.isHidden?this.show(true):this.hide(true)},hide:function(t){var e=this.node.getSize().x-9;var i=new Fx.Morph(this.node,{duration:"300",transition:Fx.Transitions.Expo.easeOut});i.start({}).chain(function(){this.isHidden=true;this.node.setStyles({right:"-"+e+"px"});this.trapezoid.setStyles(this.css.trapezoid_toLeft)}.bind(this))},show:function(t){this.node.setStyles(this.css.node);this.trapezoid.setStyles(this.css.trapezoid_toRight);var e=new Fx.Morph(this.node,{duration:"500",transition:Fx.Transitions.Expo.easeOut});this.app.fireAppEvent("resize");e.start({opacity:1}).chain(function(){this.node.setStyles({right:"0px"});this.isHidden=false}.bind(this))},resetNodeSize:function(){var t=this.container.getSize();this.node.setStyle("height",t.y-50);this.trapezoid.setStyle("top",(t.y-50)/2-this.trapezoid.getSize().y/2);var e=t.y-395;var i=this.meetingItemContainer.getSize().y+12;this.scrollNode.setStyle("height",Math.min(e,i))},getSize:function(){return{x:9,y:0}},showByType:function(t){},reload:function(){this.destory();this.app.reload()},openMeeting:function(t){var e=new MWF.xApplication.Meeting.MeetingForm(this,t,{},{app:this.app});e.view=this.app;e.open()},destory:function(){this.tooltipList.each(function(t){t.destory()});this.app.removeEvent("resize",this.resetNodeSizeFun);this.app.node.removeEvent("mousedown",this.hideFun);this.node.destory()}});