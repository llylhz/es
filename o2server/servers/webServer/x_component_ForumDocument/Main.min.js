MWF.xApplication.Forum=MWF.xApplication.Forum||{};MWF.xApplication.ForumDocument=MWF.xApplication.ForumDocument||{};MWF.require("MWF.widget.O2Identity",null,false);MWF.xDesktop.requireApp("Forum","Attachment",null,false);MWF.xDesktop.requireApp("Forum","lp."+MWF.language,null,false);MWF.xDesktop.requireApp("Forum","Access",null,false);MWF.xDesktop.requireApp("Template","Explorer",null,false);MWF.xDesktop.requireApp("Template","MPopupForm",null,false);MWF.xDesktop.requireApp("Forum","TopNode",null,false);MWF.xApplication.ForumDocument.options={multitask:true,executable:true};MWF.xApplication.ForumDocument.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{style:"default",name:"ForumDocument",icon:"icon.png",width:"1324",height:"720",isResize:true,isMax:true,isNew:false,isEdited:true,index:1,replyIndex:null,viewPageNum:1,title:MWF.xApplication.ForumDocument.LP.title},onQueryLoad:function(){this.lp=MWF.xApplication.Forum.LP},onQueryClose:function(){if(this.userCache){for(var t in this.userCache){delete this.userCache[t]}}this.userCache},loadApplication:function(t){this.userData=layout.desktop.session.user;this.userName=this.userData.distinguishedName;this.restActions=this.actions=MWF.Actions.get("x_bbs_assemble_control");this.path="/x_component_ForumDocument/$Main/"+this.options.style+"/";if(this.status){this.setOptions(this.status)}if(this.options.isNew&&!this.options.id){if(this.options.advanceId){this.advanceId=this.options.advanceId;this.createNode();this.loadApplicationContent()}else{this.actions.getUUID(function(t){this.advanceId=t;this.createNode();this.loadApplicationContent()}.bind(this))}}else{this.createNode();this.loadApplicationContent()}},loadController:function(t){this.access=new MWF.xApplication.Forum.Access(this.restActions,this.lp);if(t)t()},createNode:function(){this.content.setStyle("overflow","hidden");this.node=new Element("div",{styles:this.css.node}).inject(this.content)},loadApplicationContent:function(){this.loadController(function(){this.access.login(function(){this.loadApplicationLayout()}.bind(this))}.bind(this))},clearContent:function(){this.node.empty();this.pagingBarTop=null;this.pagingContainerTop=null;delete this.pagingBarTop;delete this.pagingContainerTop},reload:function(t,e){this.node.empty();this.pagingBarTop=null;this.pagingContainerTop=null;delete this.pagingBarTop;delete this.pagingContainerTop;this.loadApplicationLayout();if(t&&e&&t!=e){delete this.desktop.apps[t];this.appId=e;this.desktop.apps[e]=this}},loadApplicationLayout:function(){this.contentContainerNode=new Element("div.contentContainerNode",{styles:this.css.contentContainerNode}).inject(this.node);if(this.options.id){this.restActions.listSubjectPermission(this.options.id,function(t){this.permission=t.data;if(this.options.isEdited){this.restActions.getSubject(this.options.id,function(t){this.data=t.data;this._loadApplicationLayout(this.data.sectionId,this.data.title)}.bind(this))}else{this.restActions.getSubjectView(this.options.id,function(t){this.data=t.data.currentSubject;this.nextSubject=t.data.nextSubject;this.lastSubject=t.data.lastSubject;this._loadApplicationLayout(this.data.sectionId,this.data.title)}.bind(this))}}.bind(this))}else{this._loadApplicationLayout(this.options.sectionId,this.lp.createSubject)}},_loadApplicationLayout:function(e,i){this.options.sectionId=e;this.restActions.listSectionPermission(e,function(t){this.sectionPermission=t.data;this.restActions.getSection(e,function(t){this.sectionData=t.data;this.restActions.getCategory(this.sectionData.forumId,function(t){this.forumData=t.data;this.setTitle(i);this.createTopNode();this.createMiddleNode()}.bind(this))}.bind(this))}.bind(this))},createTopNode:function(){var t=new MWF.xApplication.Forum.TopNode(this.contentContainerNode,this,this,{type:this.options.style});t.load();var e=this.topNode=new Element("div.topNode",{styles:this.css.topNode}).inject(this.contentContainerNode);var i=new Element("div.topTitleMiddleNode",{styles:this.css.topTitleMiddleNode}).inject(e);var s=new Element("div.topItemTitleNode",{styles:this.css.topItemTitleNode,text:this.lp.title}).inject(i);s.addEvent("click",function(){var t="Forum";if(this.desktop.apps[t]){this.desktop.apps[t].setCurrent()}else{this.desktop.openApplication(null,"Forum",{appId:t})}if(!this.inBrowser){this.close()}}.bind(this));var o=new Element("div.topItemSepNode",{styles:this.css.topItemSepNode,text:">"}).inject(i);var s=new Element("div.topItemTitleNode",{styles:this.css.topItemTitleNode,text:this.sectionData.forumName}).inject(i);s.addEvent("click",function(){var t="ForumCategory"+this.forumId;if(this.obj.desktop.apps[t]){this.obj.desktop.apps[t].setCurrent()}else{this.obj.desktop.openApplication(null,"ForumCategory",{categoryId:this.forumId,appId:t})}if(!this.obj.inBrowser){this.obj.close()}}.bind({obj:this,forumId:this.sectionData.forumId}));var o=new Element("div.topItemSepNode",{styles:this.css.topItemSepNode,text:">"}).inject(i);var s=new Element("div.topItemTitleNode",{styles:this.css.topItemTitleNode,text:this.sectionData.sectionName}).inject(i);s.addEvent("click",function(){var t="ForumSection"+this.sectionData.id;if(this.desktop.apps[t]){this.desktop.apps[t].setCurrent()}else{this.desktop.openApplication(null,"ForumSection",{sectionId:this.sectionData.id,appId:t})}if(!this.inBrowser){this.close()}}.bind(this));var o=new Element("div.topItemSepNode",{styles:this.css.topItemSepNode,text:">"}).inject(i);var s=new Element("div.topItemTitleNode",{styles:this.css.topItemTitleLastNode,text:this.options.isNew?this.lp.createSubject:"["+this.data.type+"]"+this.data.title}).inject(i)},createMiddleNode:function(){this.middleNode=new Element("div.middleNode",{styles:this.css.middleNode}).inject(this.contentContainerNode);this.addEvent("resize",function(){this.setContentSize()}.bind(this));this.setContentSize();this.middleNode.addEvent("selectstart",function(t){t.stopPropagation()});if(this.options.isNew||this.options.isEdited){this._createMiddleNode_eidt()}else{this._createMiddleNode_read()}},_createMiddleNode_eidt:function(){this.data=this.data||{};var t=this;this.contentDiv=new Element("div.contentDiv",{styles:this.css.contentDiv}).inject(this.middleNode);var e="<table width='100%' bordr='0' cellpadding='5' cellspacing='0' styles='formTable'>"+"<tr>"+"   <td styles='formTableTitle' lable='title' width='10%' style='min-width:100px;'></td>"+"   <td styles='formTableValue' item='typeCategory' width='10%'></td>"+"   <td styles='formTableValue' item='type' width='10%'></td>"+"   <td styles='formTableValue' item='title' width='70%'></td>"+"</tr><tr>"+"   <td></td>"+"   <td item='tipNode' colspan='3'></td>"+"</tr><tr>"+"   <td styles='formTableTitle' lable='summary'></td>"+"   <td styles='formTableValue' item='summary' colspan='3'></td>"+"</tr><tr item='portalImageTr' style='display:none'>"+"   <td styles='formTableTitle' lable='picId'></td>"+"   <td styles='formTableValue' colspan='3'><div item='picId' styles='portalImageAre' ></div></td>"+"</tr><tr>"+"   <td styles='formTableTitle' lable='content'></td>"+"   <td styles='formTableValue' item='content' colspan='3'></td>"+"</tr><tr>"+"   <td styles='formTableTitle'>"+this.lp.attachment+"</td>"+"   <td item='attachment' colspan='3'></td>"+"</tr><tr style='display:none' item='voteArea'>"+"   <td styles='formTableTitle'>"+this.lp.vote+"</td>"+"   <td item='voteContainer' colspan='3'></td>"+"</tr><tr>"+"   <td styles='formTableTitle' lable=''></td>"+"   <td item='action' colspan='3'></td>"+"</tr>"+"</table>";this.contentDiv.set("html",e);var i=this.contentDiv.getElement("[item='tipNode']");var s=this._loadTypeSetting();var o=s[this.forumData.indexListStyle];if(o.image){this.contentDiv.getElements("[item='portalImageTr']")[0].setStyle("display","")}var n;if(this.sectionData.subjectType){n=this.sectionData.subjectType.split("|")}else if(this.forumData.subjectType){n=this.forumData.subjectType.split("|")}else{n=this.lp.subjectTypeDefaultValue.split("|")}var a;if(this.sectionData.typeCategory){a=this.sectionData.typeCategory.split("|")}else if(this.forumData.typeCategory){a=this.forumData.typeCategory.split("|")}else{a=this.lp.typeCategoryDefaultValue.split("|")}MWF.xDesktop.requireApp("Template","MForm",function(){this.form=new MForm(this.contentDiv,this.data,{style:"forum",verifyType:"batch",isEdited:true,itemTemplate:{title:{text:this.lp.subject,notEmpty:true,onPostLoad:function(t){t.tipNode=i}},typeCategory:{type:"select",selectValue:a,notEmpty:true,event:{change:function(t,e){if(t.getValue()==this.lp.vote){this.contentDiv.getElements("[item='voteArea']").setStyle("display","");this.loadVoteArea()}else{this.contentDiv.getElements("[item='voteArea']").setStyle("display","none")}}.bind(this)}},type:{text:this.lp.type,type:"select",selectValue:n,notEmpty:true},summary:{text:this.lp.summary,type:"text",event:{keyup:function(t,e){if(t.getValue().length>70){t.setValue(t.getValue().substr(0,70))}}}},picId:{text:this.lp.portalImage,type:"imageClipper",disable:!o.image,style:{imageStyle:this.css.portalImageNode,actionStyle:this.css.uploadActionNode},aspectRatio:1.5,reference:this.advanceId||this.data.id,referenceType:"forumDocument"},content:{text:this.lp.content,type:"rtf",notEmpty:true,RTFConfig:{isSetImageMaxWidth:true,reference:this.advanceId||this.data.id,referenceType:"forumDocument",skin:"bootstrapck"}}}},this,this.css);this.form.load()}.bind(this),true);if(this.data.typeCategory==this.lp.vote){this.contentDiv.getElement("[item='voteArea']").setStyle("display","");this.loadVoteArea()}var c=this.contentDiv.getElements("[item='action']")[0];this.saveAction=new Element("div",{styles:this.css.actionNode,text:this.lp.saveSubject}).inject(c);this.saveAction.addEvent("click",function(t){this.saveSubject(t)}.bind(this));var l=this.contentDiv.getElements("[item='attachment']")[0];this.loadAttachment(l)},_loadTypeSetting:function(){var t="/x_component_Forum/$ColumnTemplate/template/setting.json";var i;MWF.xApplication.Forum.ColumnTemplate=MWF.xApplication.Forum.ColumnTemplate||{};if(MWF.xApplication.Forum.ColumnTemplate.Setting){i=MWF.xApplication.Forum.ColumnTemplate.Setting}else{var e=new Request.JSON({url:t,secure:false,async:false,method:"get",noCache:false,onSuccess:function(t,e){i=MWF.xApplication.Forum.ColumnTemplate.Setting=t}.bind(this),onError:function(t,e){alert(e+t)}});e.send()}return i},loadVoteArea:function(){this.voteContainer=this.contentDiv.getElement("[item='voteContainer']");MWF.xDesktop.requireApp("ForumDocument","Vote",function(){this.vote=new MWF.xApplication.ForumDocument.Vote(this.voteContainer,this,{isNew:this.options.isNew,isEdited:this.options.isEdited},this.data);this.vote.load()}.bind(this),true)},reloadAllParents:function(){var t="Forum";if(this.desktop.apps[t]){this.desktop.apps[t].reload()}t="ForumCategory"+this.sectionData.forumId;if(this.desktop.apps[t]){this.desktop.apps[t].reload()}t="ForumSection"+this.sectionData.id;if(this.desktop.apps[t]){this.desktop.apps[t].reload()}},saveSubject:function(t){var e=this;var i=this.form.getResult(true,",",true,false,true);if(!i){var s=this.form.getItem("typeCategory");if(s.getValue()==this.lp.vote){this.vote.getVoteInfor()}return}if(i.typeCategory==this.lp.vote){var o=this.vote.getVoteInfor();if(!o)return;for(var n in o){i[n]=o[n]}this.confirm("warn",t,this.lp.confirmPublishVoteDocumentTitle,this.lp.confirmPublishVoteDocumentContent,350,120,function(){e._saveSubject(i);this.close()},function(){this.close()})}else{this._saveSubject(i)}},_saveSubject:function(t){if(this.advanceId)t.id=this.advanceId;t.attachmentList=this.attachment.getAttachmentIds();if(t){t.sectionId=this.sectionData.id;this.restActions.saveSubject(t,function(t){this.notice(this.options.isNew?this.lp.createSuccess:this.lp.updateSuccess,"success");this.fireEvent("postPublish");this.reloadAllParents();var e="ForumDocument"+(this.options.isNew?this.sectionData.id:this.data.id);var i="ForumDocument"+t.data.id;this.advanceId="";this.setOptions({id:t.data.id,appId:i,isEdited:false,isNew:false});this.reload(e,i)}.bind(this))}},_createMiddleNode_read:function(){this.isReplyPublisher=this.permission.replyPublishAble;this.createSidebar();this.createPagingBar();this.createToolbar_read();var t=new Element("div.subjectConainer",{styles:this.css.contentConainer}).inject(this.middleNode);this.subjectConainer=new Element("div.subjectConainer",{styles:this.css.subjectConainer}).inject(t);if(this.data.typeCategory==this.lp.question){this.satisfiedReplyViewConainer=new Element("div.satisfiedReplyViewConainer",{styles:this.css.replyViewConainer}).inject(t)}this.replyViewConainer=new Element("div.replyViewConainer",{styles:this.css.replyViewConainer}).inject(t);this.createPagingBar();this.createSubject();if(this.data.typeCategory==this.lp.question){if(this.data.acceptReplyId){this.createSatisfiedReplyView()}}this.createReplyView();if(!this.data.stopReply&&this.isReplyPublisher){if(this.access.isAnonymous()){this.createReplyEditor_Anonymous()}else{this.createReplyEditor()}}},createPagingBar:function(){var t=new Element("div",{styles:this.css.pagingArea}).inject(this.middleNode);if(this.pagingBarTop){this.pagingBarBottom=t}else{this.pagingBarTop=t}if(this.sectionPermission.subjectPublishAble){var e=new Element("div",{styles:this.css.pagingActionNode,text:this.lp.createSubject}).inject(t);e.addEvents({mouseover:function(){this.node.setStyles(this.obj.css.pagingActionNode_over)}.bind({obj:this,node:e}),mouseout:function(){this.node.setStyles(this.obj.css.pagingActionNode)}.bind({obj:this,node:e}),click:function(){if(this.access.isAnonymousDynamic()){this.openLoginForm(function(){this.createNewDocument()}.bind(this))}else{this.createNewDocument()}}.bind(this)})}var i=new Element("div").inject(t);if(this.pagingContainerTop){this.pagingContainerBottom=i}else{this.pagingContainerTop=i}},setContentSize:function(){var t={x:0,y:0};var e=this.node.getSize();var i=this.contentContainerNode.getStyle("padding-top").toFloat();var s=this.contentContainerNode.getStyle("padding-bottom").toFloat();var o=e.y-t.y-i-s;this.contentContainerNode.setStyle("height",""+o+"px")},recordStatus:function(){return{sectionId:this.options.sectionId,id:this.data?this.data.id:"",advanceId:this.advanceId,appId:this.data&&this.data.id?"ForumDocument"+this.data.id:"ForumDocument"+this.advanceId,isEdited:this.options.isEdited,isNew:this.options.isNew,viewPageNum:this.replyView?this.replyView.getCurrentPageNum():1}},loadAttachment:function(t){this.attachment=new MWF.xApplication.Forum.Attachment(t,this,this.restActions,this.lp,{documentId:this.advanceId||this.data.id,isNew:this.options.isNew,isEdited:this.options.isEdited,size:"min",onQueryUploadAttachment:function(){this.attachment.isQueryUploadSuccess=true}.bind(this),onDelete:function(t){}.bind(this)});this.attachment.load()},createToolbar_read:function(){this.toolBarReadTop=new Element("div.toolBarReadTop",{styles:this.css.toolBarReadTop}).inject(this.middleNode);this.toolBarRead=new Element("div.toolBarRead",{styles:this.css.toolBarRead}).inject(this.middleNode);this.toolbarLeft=new Element("div.toolbarLeft",{styles:this.css.toolbarLeft}).inject(this.toolBarRead);var t=new Element("div.toolbarViewItem",{styles:this.css.toolbarViewItem}).inject(this.toolbarLeft);new Element("span.toolbarLeftTextItem",{styles:this.css.toolbarLeftTextItem,text:this.lp.readed+"："}).inject(t);new Element("span.toolbarLeftCountItem",{styles:this.css.toolbarLeftCountItem,text:this.data.viewTotal}).inject(t);new Element("div.toolbarSepItem",{styles:this.css.toolbarSepItem}).inject(this.toolbarLeft);var t=new Element("div.toolbarReplyItem",{styles:this.css.toolbarReplyItem}).inject(this.toolbarLeft);new Element("span.toolbarLeftTextItem",{styles:this.css.toolbarLeftTextItem,text:this.lp.reply+"："}).inject(t);this.replyTotal=new Element("span.toolbarLeftCountItem",{styles:this.css.toolbarLeftCountItem,text:this.data.replyTotal}).inject(t);this.toolbarRight=new Element("div.toolbarRight",{styles:this.css.toolbarRight}).inject(this.toolBarRead);if(this.data.isTopSubject){new Element("div.top",{styles:this.css.toolbarZhiding,title:this.lp.setTop}).inject(this.toolbarRight)}else if(this.data.isCreamSubject){new Element("div.prime",{styles:this.css.toolbarPrime,title:(this.data.screamSetterName||"").split("@")[0]+this.lp.at+this.data.screamSetterTime+this.lp.setPrime}).inject(this.toolbarRight)}else if(this.data.typeCategory==this.lp.vote){new Element("div.vote",{styles:this.css.toolbarVote,title:this.lp.vote}).inject(this.toolbarRight)}else if(this.data.typeCategory==this.lp.question){new Element("div.question",{styles:this.css.toolbarQuestion,title:this.lp.question}).inject(this.toolbarRight)}this.toolbarRightTitle=new Element("div.toolbarRightTitle",{styles:this.css.toolbarRightTitle,text:"["+this.data.type+"]"+this.data.title}).inject(this.toolbarRight);this.toolbarRightTools=new Element("div.toolbarRightTools",{styles:this.css.toolbarRightTools}).inject(this.toolbarRight);if(this.nextSubject){this.toolbarNext=new Element("div.toolbarNext",{styles:this.css.toolbarNext,title:this.lp.nextSubject+"："+this.nextSubject.title}).inject(this.toolbarRightTools);this.toolbarNext.addEvents({click:function(){this.gotoDocument(1)}.bind(this),mouseover:function(){this.toolbarNext.setStyles(this.css.toolbarNext_over)}.bind(this),mouseout:function(){this.toolbarNext.setStyles(this.css.toolbarNext)}.bind(this)})}if(this.lastSubject){this.toolbarPrev=new Element("div.toolbarRightTools",{styles:this.css.toolbarPrev,title:this.lp.prevSubject+"："+this.lastSubject.title}).inject(this.toolbarRightTools);this.toolbarPrev.addEvents({click:function(){this.gotoDocument(-1)}.bind(this),mouseover:function(){this.toolbarPrev.setStyles(this.css.toolbarPrev_over)}.bind(this),mouseout:function(){this.toolbarPrev.setStyles(this.css.toolbarPrev)}.bind(this)})}},adjustReplyCount:function(t){this.data.replyTotal=this.data.replyTotal+t;this.replyTotal.set("text",this.data.replyTotal)},createNewDocument:function(){var t=this;var e="ForumDocument"+this.sectionData.id;if(t.desktop.apps[e]){t.desktop.apps[e].setCurrent()}else{this.desktop.openApplication(null,"ForumDocument",{sectionId:this.sectionData.id,appId:e,isNew:true,isEdited:true,onPostPublish:function(){}.bind(this)})}},edit:function(){var t="ForumDocument"+this.data.id;this.options.isEdited=true;this.reload(t,t)},delete:function(t){var e=this;this.confirm("warn",t,this.lp.deleteDocumentTitle,this.lp.deleteDocument,350,120,function(){e.restActions.deleteSubject(e.data.id,function(){e.notice(e.lp.deleteDocumentOK,"ok");e.reloadAllParents();e.close()}.bind(this));this.close()},function(){this.close()})},postCreateReply:function(t){this.restActions.getReply(t,function(t){var e=this.replyView._createDocument(t.data);this.adjustReplyCount(1);var i=e.node.getTop()-this.contentContainerNode.getCoordinates().top+this.contentContainerNode.scrollTop.toFloat();this.contentContainerNode.scrollTo(0,i)}.bind(this))},createReply:function(){var t=new MWF.xApplication.ForumDocument.ReplyForm(this,{},{toMain:true,onPostOk:function(t){this.postCreateReply(t)}.bind(this)},{app:this,lp:this.lp,css:this.css,actions:this.restActions});t.mainData=this.data;t.create()},createActionBar:function(t){this.actionBar=new Element("div",{styles:this.css.actionBar,html:"&nbsp;"}).inject(t);if(this.permission.manageAble){if(this.data.isCreamSubject){action=new Element("div",{styles:this.css.actionItem,text:this.lp.cancelPrime}).inject(this.actionBar);action.setStyle("background-image","url("+this.path+"icon/action_cancelprime.png)");action.addEvents({mouseover:function(){this.itemNode.setStyles(this.obj.css.actionItem_over)}.bind({obj:this,itemNode:action}),mouseout:function(){this.itemNode.setStyles(this.obj.css.actionItem)}.bind({obj:this,itemNode:action}),click:function(){this.cancelPrime()}.bind(this)})}else{action=new Element("div",{styles:this.css.actionItem,text:this.lp.setPrime}).inject(this.actionBar);action.setStyle("background-image","url("+this.path+"icon/action_prime.png)");action.addEvents({mouseover:function(){this.itemNode.setStyles(this.obj.css.actionItem_over)}.bind({obj:this,itemNode:action}),mouseout:function(){this.itemNode.setStyles(this.obj.css.actionItem)}.bind({obj:this,itemNode:action}),click:function(){this.setPrime()}.bind(this)})}action=new Element("div",{styles:this.css.actionItem,text:this.lp.moveto}).inject(this.actionBar);action.setStyle("background-image","url("+this.path+"icon/action_moveto.png)");action.addEvents({mouseover:function(){this.itemNode.setStyles(this.obj.css.actionItem_over)}.bind({obj:this,itemNode:action}),mouseout:function(){this.itemNode.setStyles(this.obj.css.actionItem)}.bind({obj:this,itemNode:action}),click:function(){this.moveTo()}.bind(this)});if(this.data.stopReply){action=new Element("div",{styles:this.css.actionItem,text:this.lp.unlock}).inject(this.actionBar);action.setStyle("background-image","url("+this.path+"icon/action_unlock.png)");action.addEvents({mouseover:function(){this.itemNode.setStyles(this.obj.css.actionItem_over)}.bind({obj:this,itemNode:action}),mouseout:function(){this.itemNode.setStyles(this.obj.css.actionItem)}.bind({obj:this,itemNode:action}),click:function(){this.unlock()}.bind(this)})}else{action=new Element("div",{styles:this.css.actionItem,text:this.lp.lock}).inject(this.actionBar);action.setStyle("background-image","url("+this.path+"icon/action_lock.png)");action.addEvents({mouseover:function(){this.itemNode.setStyles(this.obj.css.actionItem_over)}.bind({obj:this,itemNode:action}),mouseout:function(){this.itemNode.setStyles(this.obj.css.actionItem)}.bind({obj:this,itemNode:action}),click:function(){this.lock()}.bind(this)})}action=new Element("div",{styles:this.css.actionItem,text:this.lp.setTop}).inject(this.actionBar);action.setStyle("background-image","url("+this.path+(this.data.isTopSubject?"icon/action_canceltop.png":"icon/action_top.png")+")");action.addEvents({mouseover:function(){this.itemNode.setStyles(this.obj.css.actionItem_over)}.bind({obj:this,itemNode:action}),mouseout:function(){this.itemNode.setStyles(this.obj.css.actionItem)}.bind({obj:this,itemNode:action}),click:function(){this.setTop()}.bind(this)})}if(MWF.AC.isHotPictureManager()){action=new Element("div",{styles:this.css.actionItem,text:this.lp.setHot}).inject(this.actionBar);action.setStyle("background-image","url("+this.path+"icon/action_popular.png"+")");action.addEvents({mouseover:function(){this.itemNode.setStyles(this.obj.css.actionItem_over)}.bind({obj:this,itemNode:action}),mouseout:function(){this.itemNode.setStyles(this.obj.css.actionItem)}.bind({obj:this,itemNode:action}),click:function(){this.setHotPicture()}.bind(this)})}if(this.permission.recommendAble){if(this.data.recommendToBBSIndex){action=new Element("div",{styles:this.css.actionItem,text:this.lp.cancelRecommend}).inject(this.actionBar);action.setStyle("background-image","url("+this.path+"icon/action_cancelrecommend.png)");action.addEvents({mouseover:function(){this.itemNode.setStyles(this.obj.css.actionItem_over)}.bind({obj:this,itemNode:action}),mouseout:function(){this.itemNode.setStyles(this.obj.css.actionItem)}.bind({obj:this,itemNode:action}),click:function(){this.cancelRecommend()}.bind(this)})}else if(this.sectionData.sectionVisible==this.lp.allPerson&&this.sectionData.indexRecommendable==true){action=new Element("div",{styles:this.css.actionItem,text:this.lp.setRecommend}).inject(this.actionBar);action.setStyle("background-image","url("+this.path+"icon/action_recommend.png)");action.addEvents({mouseover:function(){this.itemNode.setStyles(this.obj.css.actionItem_over)}.bind({obj:this,itemNode:action}),mouseout:function(){this.itemNode.setStyles(this.obj.css.actionItem)}.bind({obj:this,itemNode:action}),click:function(){this.setRecommend()}.bind(this)})}}if(this.permission.manageAble||this.data.creatorName==this.userName){action=new Element("div",{styles:this.css.actionItem,text:this.lp.delete}).inject(this.actionBar);action.setStyle("background-image","url("+this.path+"icon/action_delete.png)");action.addEvents({mouseover:function(){this.itemNode.setStyles(this.obj.css.actionItem_over)}.bind({obj:this,itemNode:action}),mouseout:function(){this.itemNode.setStyles(this.obj.css.actionItem)}.bind({obj:this,itemNode:action}),click:function(t){this["delete"](t)}.bind(this)})}if(this.data.typeCategory!=this.lp.vote){if(this.permission.manageAble||this.data.creatorName==this.userName){action=new Element("div",{styles:this.css.actionItem,text:this.lp.edit}).inject(this.actionBar);action.setStyle("background-image","url("+this.path+"icon/action_edit.png)");action.addEvents({mouseover:function(){this.itemNode.setStyles(this.obj.css.actionItem_over)}.bind({obj:this,itemNode:action}),mouseout:function(){this.itemNode.setStyles(this.obj.css.actionItem)}.bind({obj:this,itemNode:action}),click:function(){this.edit()}.bind(this)})}}if(!this.data.stopReply){if(this.isReplyPublisher){action=new Element("div",{styles:this.css.actionItem,text:this.lp.reply}).inject(this.actionBar);action.setStyle("background-image","url("+this.path+"icon/action_quote.png)");action.addEvents({mouseover:function(){this.itemNode.setStyles(this.obj.css.actionItem_over)}.bind({obj:this,itemNode:action}),mouseout:function(){this.itemNode.setStyles(this.obj.css.actionItem)}.bind({obj:this,itemNode:action}),click:function(){if(this.access.isAnonymousDynamic()){this.openLoginForm(function(){this.reload()}.bind(this))}else{this.createReply()}}.bind(this)})}}},lock:function(){this.restActions.lock(this.data.id,function(){this.notice(this.lp.lockSuccess);this.reload()}.bind(this))},unlock:function(){this.restActions.unlock(this.data.id,function(){this.notice(this.lp.unlockSuccess);this.reload()}.bind(this))},setRecommend:function(){this.restActions.setRecommend(this.data.id,function(){this.notice(this.lp.setRecommendSuccess);this.reload()}.bind(this))},cancelRecommend:function(){this.restActions.cancelRecommend(this.data.id,function(){this.notice(this.lp.cancelRecommendSuccess);this.reload()}.bind(this))},setHotPicture:function(){MWF.xDesktop.requireApp("ForumDocument","HotLinkForm",null,false);var t=new MWF.xApplication.ForumDocument.HotLinkForm(this,this.data,{documentId:this.data.id,onPostOk:function(t){}.bind(this)},{app:this,lp:this.lp,css:this.css,actions:this.restActions});t.create()},setTop:function(){var t=new MWF.xApplication.ForumDocument.TopSettingForm(this,this.data,{onPostOk:function(t){this.reload()}.bind(this)},{app:this,lp:this.lp,css:this.css,actions:this.restActions});t.create()},cancelTop:function(){this.restActions.cancelTopToSection(this.data.id,function(){this.notice(this.lp.cancelTopSuccess);this.reload()}.bind(this))},setPrime:function(){this.restActions.setCream(this.data.id,function(){this.notice(this.lp.setPrimeSuccess);this.reload()}.bind(this))},cancelPrime:function(){this.restActions.cancelCream(this.data.id,function(){this.notice(this.lp.cancelPrimeSuccess);this.reload()}.bind(this))},createSubject:function(){this.subjectView=new MWF.xApplication.ForumDocument.SubjectView(this.subjectConainer,this,this,{templateUrl:this.path+"listItemSubject.json",scrollEnable:false});this.subjectView.data=this.data;this.subjectView.load()},moveTo:function(){MWF.xDesktop.requireApp("Forum","SectionSelector",null,false);var t=new MWF.xApplication.Forum.SectionSelector(this.content,{count:1,title:"选择移动到的版块",values:[],onComplete:function(t){if(typeOf(t)=="array"){var e=t[0].data.id;this.restActions.changeSection({subjectIds:[this.data.id],sectionId:e},function(){this.notice("帖子已经移动到"+t[0].data.name);this.reload()}.bind(this))}}.bind(this)});t.load()},openLoginForm:function(t){MWF.require("MWF.xDesktop.Authentication",null,false);var e=new MWF.xDesktop.Authentication({style:"application",onPostOk:function(){if(t)t()}},this);e.openLoginForm({hasMask:true})},openSignUpForm:function(t){MWF.require("MWF.xDesktop.Authentication",null,false);var e=new MWF.xDesktop.Authentication({style:"application",onPostOk:function(){if(t)t()}},this);e.openSignUpForm({hasMask:true})},gotoReply:function(t){this.replyView.paging.gotoItem(t)},createSatisfiedReplyView:function(){this.satisfiedReplyView=new MWF.xApplication.ForumDocument.SatisfiedReplyView(this.satisfiedReplyViewConainer,this,this,{templateUrl:this.path+"listItemSatisfied.json",scrollEnable:false});this.satisfiedReplyView.data=this.data;this.satisfiedReplyView.load()},createReplyView:function(){this.replyView=new MWF.xApplication.ForumDocument.ReplyView(this.replyViewConainer,this,this,{templateUrl:this.path+"listItemReply.json",scrollEnable:false,pagingEnable:true,documentKeyWord:"orderNumber",pagingPar:{currentPage:this.options.viewPageNum||1,currentItem:this.options.replyIndex,returnText:this.lp.returnToList,countPerPage:10,onPostLoad:function(t){if(t.nextPageNode){t.nextPageNode.inject(this.pagingBarBottom,"before")}}.bind(this),onPageReturn:function(t){var e="ForumSection"+this.sectionData.id;if(this.desktop.apps[e]){this.desktop.apps[e].setCurrent()}else{this.desktop.openApplication(null,"ForumSection",{sectionId:this.sectionData.id,appId:e})}this.close()}.bind(this)},onGotoItem:function(t){var e=t-this.content.getTop();this.contentContainerNode.scrollTo(0,e)}.bind(this)});this.replyView.pagingContainerTop=this.pagingContainerTop;this.replyView.pagingContainerBottom=this.pagingContainerBottom;this.replyView.data=this.data;this.replyView.filterData={subjectId:this.data.id};this.replyView.load()},createReplyEditor_Anonymous:function(){this.replyArea=new Element("div.replyArea",{styles:this.css.replyArea}).inject(this.middleNode);new Element("div.replyLeft",{styles:this.css.replyLeft}).inject(this.replyArea);var t=new Element("div.replyPicture",{styles:this.css.replyPicture}).inject(this.replyArea);var e=new Element("div.replyNeedLogin",{styles:this.css.replyNeedLogin}).inject(t);new Element("div.replyNeedLogin",{styles:this.css.replyNeedLoginText,text:this.lp.replyNeedLoginText}).inject(e);var i=new Element("div.replyLoginAction",{styles:this.css.replyLoginAction,text:this.lp.login}).inject(e);i.addEvent("click",function(){this.openLoginForm(function(){this.reload()}.bind(this))}.bind(this));if(this.access.signUpMode!="disable"){new Element("div.replyNeedLogin",{styles:this.css.replyNeedLoginText,text:"|"}).inject(e);var s=new Element("div.replyLoginAction",{styles:this.css.replyLoginAction,text:this.lp.signUp}).inject(e);s.addEvent("click",function(){this.openSignUpForm()}.bind(this))}},createReplyEditor:function(){this.replyArea=new Element("div.replyArea",{styles:this.css.replyArea}).inject(this.middleNode);this.replyEditor=new MWF.xApplication.ForumDocument.ReplyEditor(this.replyArea,this,{style:this.options.style,isNew:true,onPostOk:function(t){this.postCreateReply(t)}.bind(this)});this.replyEditor.mainData=this.data;this.replyEditor.load()},createTurnSubjectNode:function(){if(!this.lastSubject&&!this.nextSubject)return;var t=new Element("div.turnSubjectNode",{styles:this.css.turnSubjectNode}).inject(this.middleNode);if(this.lastSubject){var e=new Element("div.lastSubjectNode",{styles:this.css.lastSubjectNode,text:this.lp.prevSubject+"："+this.lastSubject.title}).inject(t);e.addEvents({click:function(){this.gotoDocument(-1)}.bind(this),mouseover:function(){this.node.setStyles(this.obj.css.lastSubjectNode_over)}.bind({obj:this,node:e}),mouseout:function(){this.node.setStyles(this.obj.css.lastSubjectNode)}.bind({obj:this,node:e})})}else{var e=new Element("div.lastSubjectNode",{styles:this.css.lastSubjectNoneNode}).inject(t)}if(this.nextSubject){var i=new Element("div.nextSubjectNode",{styles:this.css.nextSubjectNode,text:this.lp.nextSubject+"："+this.nextSubject.title}).inject(t);i.addEvents({click:function(){this.gotoDocument(1)}.bind(this),mouseover:function(){this.node.setStyles(this.obj.css.nextSubjectNode_over)}.bind({obj:this,node:i}),mouseout:function(){this.node.setStyles(this.obj.css.nextSubjectNode)}.bind({obj:this,node:i})})}else{var i=new Element("div.nextSubjectNode",{styles:this.css.nextSubjectNoneNode}).inject(t)}},gotoDocument:function(t){if(t==1){var e=this.nextSubject}else{var e=this.lastSubject}var i="ForumDocument"+this.data.id;var s="ForumDocument"+e.id;if(this.desktop.apps[s]){this.desktop.apps[s].setCurrent()}else{this.setOptions({sectionId:null,id:e.id,appId:s,isEdited:false,isNew:false});this.reload(i,s)}},createSidebar:function(){if(this.inBrowser){var t=this.middleNode.getCoordinates();this.sideBar=new Element("div.sideBar",{styles:{position:"fixed",left:t.right+4+"px",bottom:"100px",width:"50px",height:"155px","padding-top":"10px","text-align":"center","background-color":"#fff","box-shadow":"0 0 4px rgba(0,0,0,0.20)"}}).inject(this.middleNode);window.onresize=function(){var t=this.middleNode.getCoordinates();this.sideBar.setStyles({left:t.right+4+"px"})}.bind(this)}else{var e=this.content.getCoordinates();var i=this.middleNode.getCoordinates();this.sideBar=new Element("div.sideBar",{styles:{position:"fixed",top:e.top+e.height-220+"px",left:i.right+4+"px",width:"50px",height:"155px","padding-top":"10px","text-align":"center","background-color":"#fff","box-shadow":"0 0 4px #ccc"}}).inject(this.middleNode);this.addEvent("moveDrop",function(){var t=this.content.getCoordinates();var e=this.middleNode.getCoordinates();this.sideBar.setStyles({top:t.top+t.height-220+"px",left:e.right+4+"px"})}.bind(this));this.addEvent("resize",function(){var t=this.content.getCoordinates();var e=this.middleNode.getCoordinates();this.sideBar.setStyles({top:t.top+t.height-220+"px",left:e.right+4+"px"})}.bind(this))}this._createSidebar()},_createSidebar:function(){var t=1;var e=new Element("div",{styles:this.css.sidebarTop,title:this.lp.gotoTop}).inject(this.sideBar);e.addEvents({mouseover:function(){this.node.setStyles(this.obj.css.sidebarTop_over)}.bind({obj:this,node:e}),mouseout:function(){this.node.setStyles(this.obj.css.sidebarTop)}.bind({obj:this,node:e}),click:function(){this.contentContainerNode.scrollTo(0,0)}.bind(this)});if(this.sectionPermission.subjectPublishAble){t++;var i=new Element("div",{styles:this.css.sidebarCreate,title:this.lp.createSubject}).inject(this.sideBar);i.addEvents({mouseover:function(){this.node.setStyles(this.obj.css.sidebarCreate_over)}.bind({obj:this,node:i}),mouseout:function(){this.node.setStyles(this.obj.css.sidebarCreate)}.bind({obj:this,node:i}),click:function(){if(this.access.isAnonymousDynamic()){this.openLoginForm(function(){this.createNewDocument()}.bind(this))}else{this.createNewDocument()}}.bind(this)})}if(!this.data.stopReply){if(this.isReplyPublisher){t++;var s=new Element("div",{styles:this.css.sidebarReply,title:this.lp.reply}).inject(this.sideBar);s.addEvents({mouseover:function(){this.itemNode.setStyles(this.obj.css.sidebarReply_over)}.bind({obj:this,itemNode:s}),mouseout:function(){this.itemNode.setStyles(this.obj.css.sidebarReply)}.bind({obj:this,itemNode:s}),click:function(){if(this.access.isAnonymousDynamic()){this.openLoginForm(function(){this.reload()}.bind(this))}else{this.createReply()}}.bind(this)})}}var o=new Element("div",{}).inject(this.sideBar);if(this.nextSubject){t++;this.sidebarNext=new Element("div.sidebarNext",{styles:this.css.sidebarNext,title:this.lp.nextSubject+"："+this.nextSubject.title}).inject(o);this.sidebarNext.addEvents({click:function(){this.gotoDocument(1)}.bind(this),mouseover:function(){this.sidebarNext.setStyles(this.css.sidebarNext_over)}.bind(this),mouseout:function(){this.sidebarNext.setStyles(this.css.sidebarNext)}.bind(this)})}if(this.lastSubject){t++;this.sidebarPrev=new Element("div.sidebarPrev",{styles:this.css.sidebarPrev,title:this.lp.prevSubject+"："+this.lastSubject.title}).inject(o);this.sidebarPrev.addEvents({click:function(){this.gotoDocument(-1)}.bind(this),mouseover:function(){this.sidebarPrev.setStyles(this.css.sidebarPrev_over)}.bind(this),mouseout:function(){this.sidebarPrev.setStyles(this.css.sidebarPrev)}.bind(this)})}this.sideBar.setStyle("height",t*30+5+"px")},getDateDiff:function(t){if(!t)return"";var e=Date.parse(t.replace(/-/gi,"/"));var i=1e3*60;var s=i*60;var o=s*24;var n=o*15;var a=o*30;var c=a*12;var l=(new Date).getTime();var r=l-e;if(r<0){}var d=(new Date).decrement("day",1);var h=(new Date).decrement("day",2);var p=r/c;var u=r/a;var m=r/(7*o);var f=r/o;var y=r/s;var b=r/i;if(d.getFullYear()==e.getFullYear()&&d.getMonth()==e.getMonth()&&d.getDate()==e.getDate()){result="昨天 "+e.getHours()+":"+e.getMinutes()}else if(h.getFullYear()==e.getFullYear()&&h.getMonth()==e.getMonth()&&h.getDate()==e.getDate()){result="前天 "+e.getHours()+":"+e.getMinutes()}else if(p>1){result=e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()}else if(u>=1){result=e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()}else if(m>=1){result=parseInt(m)+"周前"}else if(f>=1){result=parseInt(f)+"天前"}else if(y>=1){result=parseInt(y)+"小时前"}else if(b>=1){result=parseInt(b)+"分钟前"}else result="刚才";return result},openPerson:function(t){var e="ForumPerson"+t;if(this.desktop.apps[t]){this.desktop.apps[t].setCurrent()}else{this.desktop.openApplication(null,"ForumPerson",{personName:t,appId:e})}},createPersonNode:function(s,t){var o=t.split(",");o.each(function(t,e){var i=new Element("span",{text:t,styles:this.css.person}).inject(s);i.addEvents({mouseover:function(){this.node.setStyles(this.obj.css.person_over)}.bind({node:i,obj:this}),mouseout:function(){this.node.setStyles(this.obj.css.person)}.bind({node:i,obj:this}),click:function(){this.obj.openPerson(this.userName)}.bind({userName:t,obj:this})});if(e!=o.length-1){new Element("span",{text:","}).inject(s)}}.bind(this))},getUserData:function(i,s){if(this.userCache&&this.userCache[i]){if(s)s(this.userCache[i]);return}if(!this.userCache)this.userCache={};if(this.access.isAnonymous()){var t=MWF.Actions.get("x_organization_assemble_personal").getIcon(i);if(t){var e={data:{icon:t}};this.userCache[i]=e;if(s)s(e)}else{var e={data:{icon:"/x_component_ForumDocument/$Main/"+this.options.style+"/icon/noavatar_big.gif"}};this.userCache[i]=e;if(s)s(e)}}else{MWF.Actions.get("x_organization_assemble_control").getPerson(function(t){if(!t.data)t.data={};var e=MWF.Actions.get("x_organization_assemble_personal").getIcon(i);if(e){if(t.data){t.data.icon=e;this.userCache[i]=t;if(s)s(t)}}else{if(t.data){t.data.icon="/x_component_ForumDocument/$Main/"+this.options.style+"/icon/noavatar_big.gif";this.userCache[i]=t;if(s)s(t)}}}.bind(this),function(){var t={data:{icon:"/x_component_ForumDocument/$Main/"+this.options.style+"/icon/noavatar_big.gif"}};this.userCache[i]=t;if(s)s(t)}.bind(this),i,true)}}});MWF.xApplication.ForumDocument.SubjectView=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexView,_createDocument:function(e,t){e.index=t;var i;this.getUserData(e.creatorName,function(t){e.userIcon=t.data.icon;e.signature=t.data.signature;this.actions.getUserInfor({userName:e.creatorName},function(t){e.subject=t.data.subjectCount;e.reply=t.data.replyCount;e.todaySubject=t.data.subjectCountToday;e.todayReply=t.data.replyCountToday;e.prime=t.data.creamCount;e.accessed=t.data.popularity;i=new MWF.xApplication.ForumDocument.SubjectDocument(this.viewNode,e,this.explorer,this,null,e.index)}.bind(this))}.bind(this));return i},getUserData:function(t,e){this.app.getUserData(t,e)},_getCurrentPageData:function(t,e){var i={type:"success",count:1,size:1,data:[this.data]};if(t)t(i)},_removeDocument:function(t,e){this.actions.deleteSection(t.id,function(t){this.reload();this.app.notice(this.app.lp.deleteDocumentOK,"success")}.bind(this))},_create:function(){},_queryCreateViewNode:function(){},_postCreateViewNode:function(t){},_queryCreateViewHead:function(){},_postCreateViewHead:function(t){}});MWF.xApplication.ForumDocument.SubjectDocument=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexDocument,mouseoverSubject:function(t,e){},mouseoutSubject:function(t,e){},_queryCreateDocumentNode:function(t){},_postCreateDocumentNode:function(t,e){var i=t.getElement("[item='itemSubjectTools']");this.app.createActionBar(i);if(this.data.attachmentList&&this.data.attachmentList.length>0){var s=t.getElement("[item='attachment']");this.app.loadAttachment(s)}if(this.data.typeCategory==this.lp.vote){var o=t.getElement("[item='vote']");MWF.xDesktop.requireApp("ForumDocument","Vote",function(){this.vote=new MWF.xApplication.ForumDocument.Vote(o,this.app,{isNew:false,isEdited:false},this.data);this.vote.load()}.bind(this),true)}},sendMessage:function(t,e){var i=this;if(layout.desktop.widgets["IMIMWidget"]){var s=layout.desktop.widgets["IMIMWidget"];s.getOwner(function(){this.openChat(e,{from:i.data.creatorName})}.bind(s))}},createReply:function(t,e){if(this.app.access.isAnonymousDynamic()){this.app.openLoginForm(function(){this.app.reload()}.bind(this))}else{var i=new MWF.xApplication.ForumDocument.ReplyForm(this,{},{toMain:true,onPostOk:function(t){this.app.postCreateReply(t)}.bind(this)});i.mainData=this.data;i.create()}}});MWF.xApplication.ForumDocument.ReplyEditor=new Class({Implements:[Options,Events],options:{style:"default",isNew:true},initialize:function(t,e,i){this.setOptions(i);this.node=t;this.app=e},load:function(){this.app.restActions.getUUID(function(t){this.advanceReplyId=t;this._load()}.bind(this))},_load:function(){var t="<div styles='itemNode'>"+" <div styles='itemLeftNode'>"+"   <div styles='itemUserFace'>"+"     <div styles='itemUserIcon' item='userIcon'>"+"     </div>"+"   </div>"+"   <div styles='replyUserName' item='creatorName'>"+"   </div>"+" </div>"+" <div styles='replyRightNode'>"+"   <div styles='itemRightMidle'>"+"     <div styles='itemBodyReply' item='content'></div>"+"     <div styles='itemBodyReply' item='action'></div>"+"   </div>"+" </div>"+"</div>";this.node.set("html",t);var e=this.node.getElements("[item='action']")[0];this.saveReplyAction=new Element("div",{styles:this.app.css.actionNode,text:this.app.lp.saveReply}).inject(e);this.saveReplyAction.addEvent("click",function(){this.saveReply()}.bind(this));MWF.xDesktop.requireApp("Template","MForm",function(){this.form=new MForm(this.node,this.data||{},{style:"forum",isEdited:true,itemTemplate:{userIcon:{className:"itemUserIcon2",type:"img",value:function(){if(this.app.userData.icon){return"data:image/png;base64,"+this.app.userData.icon}else{return"/x_component_ForumDocument/$Main/"+this.options.style+"/icon/noavatar_big.gif"}}.bind(this)},creatorName:{type:"innerText",value:(this.app.userName||"").split("@")[0]},content:{type:"rtf",RTFConfig:{skin:"bootstrapck",resize_enabled:false,isSetImageMaxWidth:true,reference:this.advanceReplyId,referenceType:"forumReply",toolbar:[{name:"document",items:["Preview"]},{name:"basicstyles",items:["Bold","Italic","Underline","Strike","-","RemoveFormat"]},{name:"styles",items:["Styles","Format","Font","FontSize"]},{name:"colors",items:["TextColor","BGColor"]},{name:"links",items:["Link","Unlink"]},{name:"insert",items:["Image"]},{name:"tools",items:["Maximize","-","About"]}]}}}},this,this.app.css);this.form.load()}.bind(this),true)},saveReply:function(){var t=this.form.getResult(true,",",true,false,true);if(t){t.subjectId=this.mainData.id;t.id=this.advanceReplyId;this.app.restActions.saveReply(t,function(t){if(t.type=="error"){this.app.notice(t.message,"error")}else{this.app.restActions.getUUID(function(t){this.advanceReplyId=t}.bind(this));this.app.notice(this.app.lp.saveReplySuccess,"ok");this.form.getItem("content").setValue("");this.fireEvent("postOk",t.data.id)}}.bind(this))}}});MWF.xApplication.ForumDocument.ReplyForm=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"default",width:"820",height:"470",hasTop:true,hasIcon:false,hasTopIcon:true,hasTopContent:true,hasBottom:true,title:MWF.xApplication.Forum.LP.replyFormTitle,draggable:true,closeAction:true,toMain:true},_createTableContent:function(){if(this.isNew){this.app.restActions.getUUID(function(t){this.advanceReplyId=t;this._createTableContent_()}.bind(this))}else{this._createTableContent_()}},_createTableContent_:function(){var t="<table width='100%' bordr='0' cellpadding='5' cellspacing='0' styles='formTable'>"+"<tr>"+"   <td styles='formTableValue14' item='mainSubject'></td>"+"</tr><tr>"+"   <td styles='formTableValue' item='mainContent'></td>"+"</tr><tr>"+"   <td styles='formTableValue' item='content'></td>"+"</tr>"+"</table>";this.formTableArea.set("html",t);if(!this.options.toMain&&this.parentData){var e=this.formTableArea.getElements("[item='mainContent']")[0];var i=new Element("div",{styles:this.css.quoteTop}).inject(e);new Element("div",{styles:this.css.quoteLeft}).inject(i);new Element("div",{styles:this.css.quoteInfor,text:this.parentData.creatorName.split("@")[0]+this.lp.publishAt+this.parentData.createTime}).inject(i);var s=new Element("div",{styles:this.css.quoteBottom}).inject(e);var o=this.parentData.contentText;new Element("div",{styles:this.css.quoteText,text:o.length>50?o.substr(0,50)+"...":o}).inject(s);new Element("div",{styles:this.css.quoteRight}).inject(s)}MWF.xDesktop.requireApp("Template","MForm",function(){this.form=new MForm(this.formTableArea,this.data,{style:"forum",isEdited:true,itemTemplate:{mainSubject:{type:"innertext",defaultValue:"RE:"+this.mainData.title},content:{type:"rtf",RTFConfig:{skin:"bootstrapck",resize_enabled:false,isSetImageMaxWidth:true,reference:this.advanceReplyId||this.data.id,referenceType:"forumReply",toolbar:[{name:"document",items:["Preview"]},{name:"basicstyles",items:["Bold","Italic","Underline","Strike","-","RemoveFormat"]},{name:"styles",items:["Styles","Format","Font","FontSize"]},{name:"colors",items:["TextColor","BGColor"]},{name:"links",items:["Link","Unlink"]},{name:"insert",items:["Image"]},{name:"tools",items:["Maximize","-","About"]}]}}}},this.app,this.css);this.form.load()}.bind(this),true)},_createBottomContent:function(){if(this.isNew||this.isEdited){this.okActionNode=new Element("div.formOkActionNode",{styles:this.css.formOkActionNode,text:this.app.lp.saveReply}).inject(this.formBottomNode);this.okActionNode.addEvent("click",function(t){this.ok(t)}.bind(this))}this.cancelActionNode=new Element("div.formCancelActionNode",{styles:this.css.formCancelActionNode,text:this.app.lp.close}).inject(this.formBottomNode);this.cancelActionNode.addEvent("click",function(t){this.cancel(t)}.bind(this))},ok:function(t){this.fireEvent("queryOk");var e=this.form.getResult(true,",",true,false,true);if(e){this._ok(e,function(t){if(t.type=="error"){this.app.notice(t.message,"error")}else{if(this.formMaskNode)this.formMaskNode.destroy();this.formAreaNode.destroy();this.app.notice(this.isNew?this.app.lp.createReplySuccess:this.app.lp.updateSuccess,"success");this.fireEvent("postOk",t.data.id)}}.bind(this))}},_ok:function(t,e){t.subjectId=this.mainData.id;if(this.advanceReplyId)t.id=this.advanceReplyId;if(!this.options.toMain){t.parentId=this.parentData.id}this.app.restActions.saveReply(t,function(t){if(e)e(t)}.bind(this))}});MWF.xApplication.ForumDocument.ReplyView=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexView,_createDocument:function(t,e){t.index=e;return new MWF.xApplication.ForumDocument.ReplyDocument(this.viewNode,t,this.explorer,this,null,t.index)},_getCurrentPageData:function(e,t,i){this.clearBody();if(!t)t=10;if(!i)i=1;if(i==1){this.app.subjectConainer.setStyle("display","block");if(this.app.satisfiedReplyViewConainer)this.app.satisfiedReplyViewConainer.setStyle("display","block")}else{this.app.subjectConainer.setStyle("display","none");if(this.app.satisfiedReplyViewConainer)this.app.satisfiedReplyViewConainer.setStyle("display","none")}var s=this.filterData||{};this.actions.listReplyFilterPage(i,t,s,function(t){if(!t.data)t.data=[];if(!t.count)t.count=0;if(e)e(t)}.bind(this))},_removeDocument:function(t,e){this.actions.deleteReply(t.id,function(){this.reload();this.app.notice(this.lp.deleteReplySuccess,"ok")}.bind(this))},_create:function(){},_queryCreateViewNode:function(){},_postCreateViewNode:function(t){},_queryCreateViewHead:function(){},_postCreateViewHead:function(t){}});MWF.xApplication.ForumDocument.ReplyDocument=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexDocument,mouseoverSubject:function(t,e){},mouseoutSubject:function(t,e){},getUserData:function(t,e){this.app.getUserData(t,e)},_queryCreateDocumentNode:function(t){},_postCreateDocumentNode:function(i,t){var s=i.getElements("[item='userIcon']")[0];var o=i.getElements("[item='signatureContainer']")[0];this.getUserData(t.creatorName,function(t){s.src=t.data.icon;if(t.data.signature&&t.data.signature!=""){var e=o.getElements("[item='signature']")[0];e.set("text",t.data.signature)}else{o.destroy()}}.bind(this));this.actions.getUserInfor({userName:t.creatorName},function(t){var e=t.data;i.getElements("[item='subject']")[0].set("text",e.subjectCount);i.getElements("[item='reply']")[0].set("text",e.replyCount);i.getElements("[item='prime']")[0].set("text",e.creamCount);i.getElements("[item='todaySubject']")[0].set("text",e.subjectCountToday);i.getElements("[item='todayReply']")[0].set("text",e.replyCountToday)}.bind(this));if(t.parentId&&t.parentId!=""){var a=i.getElements("[item='quoteContent']")[0];this.actions.getReply(t.parentId,function(t){var e=this.parentData=t.data;var i=new Element("div",{styles:this.css.itemQuote}).inject(a);var s=i.set("html",e.content).get("text");i.empty();e.contentText=s;new Element("div",{styles:this.css.quoteLeftBig}).inject(i);var o=new Element("div",{styles:this.css.quoteAreaBig}).inject(i);var n=new Element("div",{styles:this.css.quoteInforBig,text:e.orderNumber+this.lp.floor+"："+e.creatorName.split("@")[0]+this.lp.publishAt+e.createTime}).inject(o);n.addEvent("click",function(){this.obj.app.gotoReply(this.index)}.bind({obj:this,index:e.orderNumber||e.index+2}));new Element("div",{styles:this.css.quoteTextBig,text:s.length>100?s.substr(0,100)+"...":s}).inject(o);new Element("div",{styles:this.css.quoteRightBig}).inject(i)}.bind(this),function(t){new Element("div",{styles:this.css.replyBeinngDelete,text:this.lp.quoteReplyBeingDeleted}).inject(a)}.bind(this))}},sendMessage:function(t,e){var i=this;if(layout.desktop.widgets["IMIMWidget"]){var s=layout.desktop.widgets["IMIMWidget"];s.getOwner(function(){this.openChat(e,{from:i.data.creatorName})}.bind(s))}},createReply:function(t,e){if(this.app.access.isAnonymousDynamic()){this.app.openLoginForm(function(){this.app.reload()}.bind(this))}else{var i=new MWF.xApplication.ForumDocument.ReplyForm(this,{},{toMain:false,onPostOk:function(t){this.app.postCreateReply(t)}.bind(this)});this.data.contentText=this.node.getElements("[item='content']")[0].get("text");i.mainData=this.app.data;i.parentData=this.data;i.create()}},editReply:function(t,e){var i=new MWF.xApplication.ForumDocument.ReplyForm(this,this.data,{toMain:this.data.parentId&&this.data.parentId!=""?false:true,onPostOk:function(t){this.actions.getReply(t,function(t){var e=this.node.getElements("[item='content']")[0];e.set("html",t.data.content)}.bind(this))}.bind(this)});i.mainData=this.app.data;i.parentData=this.parentData;i.edit()},deleteReply:function(t,e){var i=this;this.app.confirm("warn",e,this.lp.deleteReplyTitle,this.lp.deleteReplyText,350,120,function(){i.actions.deleteReply(i.data.id,function(){i.destroy();i.app.adjustReplyCount(-1);i.app.notice(i.lp.deleteReplySuccess,"ok")}.bind(this));this.close()},function(){this.close()})},satisfiedAction:function(){this.actions.acceptReply({id:this.data.id},function(){this.app.notice(this.lp.acceptReplySuccess,"ok");this.app.reload()}.bind(this))}});MWF.xApplication.ForumDocument.SatisfiedReplyView=new Class({Extends:MWF.xApplication.ForumDocument.ReplyView,_createDocument:function(t,e){t.index=e;return new MWF.xApplication.ForumDocument.SatisfiedReplyDocument(this.viewNode,t,this.explorer,this,null,t.index)},_getCurrentPageData:function(e,t,i){this.clearBody();if(!t)t=1;if(!i)i=1;var s=this.filterData||{};this.actions.getAcceptedReply(this.data.acceptReplyId,function(t){if(!t.data){t.data=[]}else if(typeOf(t.data)=="object"){t.data=[t.data];t.count=1}if(!t.count)t.count=0;if(e)e(t)}.bind(this))}});MWF.xApplication.ForumDocument.SatisfiedReplyDocument=new Class({Extends:MWF.xApplication.ForumDocument.ReplyDocument});MWF.xApplication.ForumDocument.TopSettingForm=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"default",width:"420",height:"250",hasTop:true,hasIcon:false,hasTopIcon:true,hasTopContent:true,hasBottom:true,title:MWF.xApplication.Forum.LP.topFormTitle,draggable:true,closeAction:true},createTopNode:function(){if(!this.formTopNode){this.formTopNode=new Element("div.formTopNode",{styles:this.css.formTopNode}).inject(this.formNode);if(this.options.hasTopIcon){this.formTopIconNode=new Element("div",{styles:this.css.formTopIconNodeDocument}).inject(this.formTopNode)}this.formTopTextNode=new Element("div",{styles:this.css.formTopTextNodeTopSetting,text:this.options.title}).inject(this.formTopNode);if(this.options.closeAction){this.formTopCloseActionNode=new Element("div",{styles:this.css.formTopCloseActionNode}).inject(this.formTopNode);this.formTopCloseActionNode.addEvent("click",function(){this.close()}.bind(this))}}},_createTableContent:function(){var t="<table width='100%' bordr='0' cellpadding='5' cellspacing='0' styles='formTable'>"+"<tr>"+"   <td styles='formTableValue' style='font-size:14px;' lable='topType'></td>"+"</tr><tr>"+"   <td styles='formTableValue' item='topToForum'></td>"+"</tr><tr>"+"   <td styles='formTableValue' item='topToSection'></td>"+"</tr>"+"</table>";this.formTableArea.set("html",t);this.topToBBS=this.data.topToBBS;this.topToForum=this.data.topToForum;this.topToSection=this.data.topToSection;MWF.xDesktop.requireApp("Template","MForm",function(){this.form=new MForm(this.formTableArea,this.data,{style:"forum",isEdited:this.isEdited||this.isNew,itemTemplate:{topType:{text:this.lp.topType},topToForum:{type:"checkbox",selectValue:["true"],selectText:[this.lp.topToForum]},topToSection:{type:"checkbox",selectValue:["true"],selectText:[this.lp.topToSection]}}},this.app,this.css);this.form.load()}.bind(this),true)},_createBottomContent:function(){if(this.isNew||this.isEdited){this.okActionNode=new Element("div.formOkActionNode",{styles:this.css.formOkActionNode,text:this.app.lp.ok}).inject(this.formBottomNode);this.okActionNode.addEvent("click",function(t){this.ok(t)}.bind(this))}this.cancelActionNode=new Element("div.formCancelActionNode",{styles:this.css.formCancelActionNode,text:this.app.lp.close}).inject(this.formBottomNode);this.cancelActionNode.addEvent("click",function(t){this.cancel(t)}.bind(this))},ok:function(t){this.fireEvent("queryOk");var e=this.form.getResult(true,",",true,false,true);if(e){var i=true;if(e.topToForum===true||e.topToForum==="true"){this.actions.topToForum(this.app.data.id,function(t){if(t.type=="error"){this.app.notice(t.message,"error");i=false}},function(){i=false},false)}else if(this.topToForum===true||this.topToForum==="true"){this.actions.cancelTopToForum(this.app.data.id,function(t){if(t.type=="error"){this.app.notice(t.message,"error");i=false}},function(){i=false},false)}if(e.topToSection===true||e.topToSection==="true"){this.actions.topToSection(this.app.data.id,function(t){if(t.type=="error"){this.app.notice(t.message,"error");i=false}},function(){i=false},false)}else if(this.topToSection===true||this.topToSection==="true"){this.actions.cancelTopToSection(this.app.data.id,function(t){if(t.type=="error"){this.app.notice(t.message,"error");i=false}},function(){i=false},false)}if(i){if(this.formMaskNode)this.formMaskNode.destroy();this.formAreaNode.destroy();this.app.notice(this.app.lp.setTopSuccess);this.fireEvent("postOk")}else{this.app.notice(this.app.lp.setToFail,"error")}}}});