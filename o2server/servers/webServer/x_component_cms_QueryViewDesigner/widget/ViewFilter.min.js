MWF.xApplication.cms.QueryViewDesigner=MWF.xApplication.cms.QueryViewDesigner||{};MWF.xApplication.cms.QueryViewDesigner.widget=MWF.xApplication.cms.QueryViewDesigner.widget||{};MWF.xApplication.cms.QueryViewDesigner.widget.ViewFilter=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default",type:"identity",names:[]},initialize:function(t,e,i,s){this.setOptions(s);this.node=$(t);this.app=e;this.filtrData=i;this.path="/x_component_cms_QueryViewDesigner/widget/$ViewFilter/";this.cssPath="/x_component_cms_QueryViewDesigner/widget/$ViewFilter/"+this.options.style+"/css.wcss";this._loadCss();this.items=[];this.load()},load:function(t){this.getInputNodes();this.createActionNode();this.loadData()},loadData:function(){this.filtrData.each(function(t){this.items.push(new MWF.xApplication.cms.QueryViewDesigner.widget.ViewFilter.Item(this,t))}.bind(this))},getInputNodes:function(){this.inputAreaNode=this.node.getFirst("div");this.actionAreaNode=this.inputAreaNode.getNext().setStyles(this.css.actionAreaNode);this.listAreaNode=this.actionAreaNode.getNext();var t=this.inputAreaNode.getElements("select");var e=this.inputAreaNode.getElements("input");this.logicInput=t[0];this.pathInput=e[0];this.comparisonInput=t[1];this.datatypeInput=t[2];this.valueTextInput=e[1];this.valueNumberInput=e[2];this.valueDatetimeInput=e[3];this.valueBooleanInput=t[3];MWF.require("MWF.widget.Calendar",function(){this.calendar=new MWF.widget.Calendar(this.valueDatetimeInput,{style:"xform",isTime:true,target:this.app.content,format:"db"})}.bind(this));this.datatypeInput.addEvent("change",function(){this.changeValueInput()}.bind(this));this.valueTextInput.addEvent("keydown",function(t){if(t.code==13)this.modifyOrAddFilterItem()}.bind(this));this.valueNumberInput.addEvent("keydown",function(t){if(t.code==13)this.modifyOrAddFilterItem()}.bind(this))},changeValueInput:function(){var t=this.datatypeInput.options[this.datatypeInput.selectedIndex].value;switch(t){case"textValue":this.valueTextInput.setStyle("display","block");this.valueNumberInput.setStyle("display","none");this.valueDatetimeInput.setStyle("display","none");this.valueBooleanInput.setStyle("display","none");break;case"numberValue":this.valueTextInput.setStyle("display","none");this.valueNumberInput.setStyle("display","block");this.valueDatetimeInput.setStyle("display","none");this.valueBooleanInput.setStyle("display","none");break;case"datetimeValue":this.valueTextInput.setStyle("display","none");this.valueNumberInput.setStyle("display","none");this.valueDatetimeInput.setStyle("display","block");this.valueBooleanInput.setStyle("display","none");break;case"booleanValue":this.valueTextInput.setStyle("display","none");this.valueNumberInput.setStyle("display","none");this.valueDatetimeInput.setStyle("display","none");this.valueBooleanInput.setStyle("display","block");break}},createActionNode:function(){this.actionNode=new Element("div",{styles:this.css.actionNode}).inject(this.actionAreaNode);this.actionNode.addEvent("click",function(){this.modifyOrAddFilterItem()}.bind(this))},modifyOrAddFilterItem:function(){if(this.currentFilterItem){this.modifyFilterItem()}else{this.addFilterItem()}},modifyFilterItem:function(){var t=this.getInputData();if(this.verificationData(t)){this.currentFilterItem.reload(t);this.currentFilterItem.unSelected();this.fireEvent("change")}},addFilterItem:function(){var t=this.getInputData();if(this.verificationData(t)){this.items.push(new MWF.xApplication.cms.QueryViewDesigner.widget.ViewFilter.Item(this,t));this.fireEvent("change")}},verificationData:function(t){if(!t.path){this.verificationNode=new Element("div",{styles:this.css.verificationNode}).inject(this.inputAreaNode);new Element("div",{styles:this.css.verificationTextNode,text:this.app.lp.mastInputPath}).inject(this.verificationNode);this.pathInput.focus();this.pathInput.setStyle("background-color","#fbe8e8");this.pathInput.addEvents({keydown:function(){if(this.verificationNode){this.verificationNode.destroy();this.verificationNode=null;this.pathInput.setStyle("background-color","#FFF")}}.bind(this),click:function(){if(this.verificationNode){this.verificationNode.destroy();this.verificationNode=null}}.bind(this)});return false}return true},getInputData:function(){var t=this.logicInput.options[this.logicInput.selectedIndex].value;var e=this.pathInput.get("value");var i=this.comparisonInput.options[this.comparisonInput.selectedIndex].value;var s=this.datatypeInput.options[this.datatypeInput.selectedIndex].value;var n="";switch(s){case"textValue":n=this.valueTextInput.get("value");break;case"numberValue":n=this.valueNumberInput.get("value").toFloat();break;case"datetimeValue":n=this.valueDatetimeInput.get("value");break;case"booleanValue":n=this.valueBooleanInput.options[this.valueBooleanInput.selectedIndex].value;if(n=="true"){n=true}else{n=false}break}return{logic:t,path:e,comparison:i,formatType:s,value:n}},setData:function(t){for(var e=0;e<this.logicInput.options.length;e++){if(this.logicInput.options[e].value==t.logic){this.logicInput.options[e].set("selected",true);break}}this.pathInput.set("value",t.path);for(var e=0;e<this.comparisonInput.options.length;e++){if(this.comparisonInput.options[e].value==t.comparison){this.comparisonInput.options[e].set("selected",true);break}}for(var e=0;e<this.datatypeInput.options.length;e++){if(this.datatypeInput.options[e].value==t.formatType){this.datatypeInput.options[e].set("selected",true);break}}switch(t.formatType){case"textValue":this.valueTextInput.set("value",t.value);break;case"numberValue":this.valueNumberInput.set("value",t.value);break;case"datetimeValue":this.valueDatetimeInput.set("value",t.value);break;case"booleanValue":for(var e=0;e<this.valueBooleanInput.options.length;e++){var i=this.valueBooleanInput.options[e].value;if(i=="true"){i=true}else{i=false}if(i===t.value){this.valueBooleanInput.options[e].set("selected",true);break}}break}},deleteItem:function(t){if(this.currentFilterItem==t)t.unSelected();this.items.erase(t);t.node.destroy();MWF.release(t);this.fireEvent("change")},getData:function(){var e=[];this.items.each(function(t){e.push(t.data)}.bind(this));return e}});MWF.xApplication.cms.QueryViewDesigner.widget.ViewFilter.Item=Class({Implements:[Events],initialize:function(t,e){this.filter=t;this.data=e;this.container=this.filter.listAreaNode;this.css=this.filter.css;this.app=this.filter.app;this.load()},load:function(){this.node=new Element("div",{styles:this.css.itemNode}).inject(this.container);this.deleteNode=new Element("div",{styles:this.css.itemDeleteNode}).inject(this.node);this.contentNode=new Element("div",{styles:this.css.itemContentNode}).inject(this.node);this.contentNode.set("text",this.getText());this.contentNode.addEvent("click",function(){this.selected()}.bind(this));this.deleteNode.addEvent("click",function(t){this.deleteItem(t)}.bind(this))},getText:function(){var t=this.app.lp.filter;return t[this.data.logic]+" "+this.data.path+" "+t[this.data.comparison]+' "'+this.data.value+'"'},reload:function(t){this.data=t;this.contentNode.set("text",this.getText())},selected:function(){if(this.filter.currentFilterItem)this.filter.currentFilterItem.unSelected();this.node.setStyles(this.css.itemNode_current);this.filter.currentFilterItem=this;this.filter.setData(this.data)},unSelected:function(){this.node.setStyles(this.css.itemNode);this.filter.currentItem=this},deleteItem:function(t){var e=this;this.filter.app.confirm("warn",t,this.app.lp.delete_filterItem_title,this.app.lp.delete_filterItem,300,120,function(){e.destroy();this.close()},function(){this.close()})},destroy:function(){this.filter.deleteItem(this)}});