MWF.xApplication.ExeManager=MWF.xApplication.ExeManager||{};MWF.xDesktop.requireApp("Template","Explorer",null,false);MWF.xDesktop.requireApp("Template","MPopupForm",null,false);MWF.xDesktop.requireApp("Template","MForm",null,false);MWF.xDesktop.requireApp("Execution","Attachment",null,false);MWF.require("MWF.widget.Identity",null,false);MWF.xApplication.ExeManager.CenterWorkList=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default"},initialize:function(t,e,i,o){this.setOptions(o);this.app=e;this.lp=e.lp;this.path="/x_component_ExeManager/$CenterWorkList/";this.loadCss();this.actions=i;this.node=$(t)},loadCss:function(){this.cssPath="/x_component_ExeManager/$CenterWorkList/"+this.options.style+"/css.wcss";this._loadCss()},load:function(){this.middleContent=this.app.middleContent;this.middleContent.setStyles({"margin-top":"0px",border:"0px solid #f00","background-color":"#ffffff"});this.createToolBarContent();this.createContentDiv();this.resizeWindow();this.app.addEvent("resize",function(){this.resizeWindow()}.bind(this))},reload:function(){this.createToolBarContent();this.createContentDiv()},resizeWindow:function(){var t=this.app.middleContent.getSize();this.contentDiv.setStyles({height:t.y-110+"px"})},createToolBarContent:function(){if(this.toolBarDiv)this.toolBarDiv.destroy();this.toolBarDiv=new Element("div.toolBarDiv",{styles:this.css.toolBarDiv}).inject(this.middleContent);this.toolBarActionDiv=new Element("div.toolBarActionDiv",{styles:this.css.toolBarActionDiv}).inject(this.toolBarDiv);this.toolBarActionBRemoveBtn=new Element("div.toolBarActionBRemoveBtn",{styles:this.css.toolBarActionBtn,text:this.lp.centerWorkList.remove}).inject(this.toolBarActionDiv);this.toolBarActionBRemoveBtn.addEvents({click:function(t){this.checkedDoc=this.view.getCheckedItems();this.removeDocument(t)}.bind(this)});this.toolBarSearchDiv=new Element("div.toolBarSearchDiv",{styles:this.css.toolBarSearchDiv}).inject(this.toolBarDiv);this.toolBarSearchInput=new Element("input.toolBarSearchInput",{styles:this.css.toolBarSearchInput}).inject(this.toolBarSearchDiv);this.toolBarSearchInput.addEvents({keyup:function(t){if(t.code==13){this.searchView(this.toolBarSearchInput.get("value"))}}.bind(this)});this.toolBarSearchActionBtn=new Element("div.toolBarSearchBtn",{styles:this.css.toolBarSearchBtn,text:this.lp.centerWorkList.searchAction}).inject(this.toolBarSearchDiv);this.toolBarSearchActionBtn.addEvents({click:function(t){this.searchView(this.toolBarSearchInput.get("value"))}.bind(this)});this.toolBarStatusDiv=new Element("div.toolBarStatusDiv",{styles:this.css.toolBarStatusDiv}).inject(this.toolBarDiv);this.toolBarStatusDiv.setStyle("display","none");this.toolBarStatusAllDiv=new Element("div.toolBarStatusAllDiv",{styles:this.css.toolBarStatusAllDiv}).inject(this.toolBarStatusDiv);this.toolBarStatusPercentDiv=new Element("div.toolBarStatusPercentDiv",{styles:this.css.toolBarStatusPercentDiv}).inject(this.toolBarStatusDiv)},removeDocument:function(t){var e=this;var i=true;this.app.confirm("warn",t,this.lp.centerWorkList.warnTitle,this.lp.centerWorkList.warnContent,300,120,function(){e.toolBarStatusDiv.setStyle("display","");__self=this;var t=e.checkedDoc;var o=t.length;var s=0;var n=window.setInterval(function(){if(t.length==0||!i){clearInterval(n);__self.close();e.reload();e.resizeWindow()}else{s++;var r=s/o;r=r*e.toolBarStatusAllDiv.getSize().x;e.toolBarStatusPercentDiv.set("text",s+"/"+o);e.toolBarStatusPercentDiv.setStyles({width:r+"px"});if(i&&t[0].data&&t[0].data.id){e.actions.deleteCenterWork(t[0].data.id,function(t){}.bind(e),function(o,s,n){e.app.notice(e.lp.centerWorkList.removeResult.failure+":"+t[0].data.title,"error");i=false}.bind(e),false)}t=t.slice(1,t.length)}}.bind(e),10)},function(){this.close()})},createContentDiv:function(t){if(this.contentDiv)this.contentDiv.destroy();this.contentDiv=new Element("div.contentDiv",{styles:this.css.contentDiv}).inject(this.middleContent);if(this.scrollBar&&this.scrollBar.scrollVAreaNode){this.scrollBar.scrollVAreaNode.destroy()}MWF.require("MWF.widget.ScrollBar",function(){this.scrollBar=new MWF.widget.ScrollBar(this.contentDiv,{indent:false,style:"xApp_TaskList",where:"before",distance:30,friction:4,axis:{x:false,y:true},onScroll:function(t){var e=this.contentDiv.getScrollSize();var i=this.contentDiv.getSize();var o=e.y-i.y;var s=this.view;if(t+200>o&&s&&s.loadElementList){if(!s.isItemsLoaded)s.loadElementList()}}.bind(this)})}.bind(this),false);templateUrl=this.path+"listItem.json";var e={filterLikeContent:t};if(this.view)delete this.view;this.view=new MWF.xApplication.ExeManager.CenterWorkList.View(this.contentDiv,this.app,{explorer:this,lp:this.lp.centerWorkList,css:this.css,actions:this.actions},{templateUrl:templateUrl,category:"",filterData:e});this.view.load()},searchView:function(t){this.createContentDiv(t);this.resizeWindow()},showErrorMsg:function(t,e,i){var o=i;if(t)errorMessage=t.responseText;try{var s=JSON.parse(errorMessage);if(s&&s.message){this.app.notice(s.message,"error")}else{this.app.notice(o,"error")}}catch(t){this.app.notice("failure","error")}}});MWF.xApplication.ExeManager.CenterWorkList.View=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexView,_createDocument:function(t){return new MWF.xApplication.ExeManager.CenterWorkList.Document(this.viewNode,t,this.explorer,this)},_getCurrentPageData:function(t,e){if(!e)e=20;var i=this.items.length?this.items[this.items.length-1].data.id:"(0)";var o=this.options.filterData||{};if(i=="(0)")this.app.createShade();this.actions.getCenterWorkListNext(i,e,o,function(e){if(t)t(e);this.app.destroyShade()}.bind(this),function(t,e,i){}.bind(this))},_create:function(){},_openDocument:function(t){this.workForm=new MWF.xApplication.ExeManager.CenterWorkList.WorkForm(this.explorer.explorer,this.actions,t,{isNew:false,isEdited:false,onPostSave:function(){this.view.explorer.contentChanged=true}.bind(this)});this.workForm.load()},_queryCreateViewNode:function(){},_postCreateViewNode:function(t){},_queryCreateViewHead:function(){},_postCreateViewHead:function(t){}});MWF.xApplication.ExeManager.CenterWorkList.Document=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexDocument,action_remove:function(t){var e=this;this.app.confirm("warn",t,this.lp.warnTitle,this.lp.warnContent,300,120,function(){e.actions.deleteCenterWork(e.data.id,function(t){e.view.explorer.explorer.reload();e.view.explorer.explorer.resizeWindow()}.bind(e),function(t,i,o){e.view.explorer.showErrorMsg(t,i,o)}.bind(e),false);e.app.notice(e.lp.removeResult.success,"success");this.close()},function(){this.close()})}});MWF.xApplication.ExeManager.CenterWorkList.WorkForm=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"default",width:"800",height:"100%",top:0,left:0,hasTop:true,hasIcon:false,hasBottom:true,title:"",draggable:false,closeAction:true,isNew:false,isEdited:false},initialize:function(t,e,i,o){this.setOptions(o);this.explorer=t;this.app=t.app;this.lp=this.app.lp.centerWorkForm;this.actions=this.app.restActions;this.path="/x_component_ExeManager/$CenterWorkList/";this.cssPath=this.path+this.options.style+"/centerWorkForm.wcss";this._loadCss();this.options.title=this.lp.title;this.data=i||{};this.actions=e},load:function(){if(this.options.isNew){this.create()}else if(this.options.isEdited){this.edit()}else{this.open()}},_open:function(){this.formMarkNode=new Element("div.formMarkNode",{styles:this.css.formMarkNode,events:{mouseover:function(t){t.stopPropagation()},mouseout:function(t){t.stopPropagation()},click:function(t){t.stopPropagation()}}}).inject(this.app.content);this.formAreaNode=new Element("div.formAreaNode",{styles:this.css.formAreaNode});this.createFormNode();this.formAreaNode.inject(this.formMarkNode,"after");this.formAreaNode.fade("in");this.setFormNodeSize();this.setFormNodeSizeFun=this.setFormNodeSize.bind(this);this.app.addEvent("resize",this.setFormNodeSizeFun);if(this.options.draggable&&this.formTopNode){var t=this.app.content.getSize();var e=this.formAreaNode.getSize();this.formAreaNode.makeDraggable({handle:this.formTopNode,limit:{x:[0,t.x-e.x],y:[0,t.y-e.y]}})}},createTopNode:function(){if(!this.formTopNode){this.formTopNode=new Element("div.formTopNode",{styles:this.css.formTopNode}).inject(this.formNode);this.formTopIconNode=new Element("div",{styles:this.css.formTopIconNode}).inject(this.formTopNode);this.formTopTextNode=new Element("div",{styles:this.css.formTopTextNode,text:this.options.title+(this.data.title?"-"+this.data.title:"")}).inject(this.formTopNode);if(this.options.closeAction){this.formTopCloseActionNode=new Element("div",{styles:this.css.formTopCloseActionNode}).inject(this.formTopNode);this.formTopCloseActionNode.addEvent("click",function(){this.close()}.bind(this))}this.formTopContentNode=new Element("div",{styles:this.css.formTopContentNode}).inject(this.formTopNode);this._createTopContent()}},_createTopContent:function(){},_createTableContent:function(){var t="<table width='100%' bordr='0' cellpadding='5' cellspacing='0' styles='formTable'>"+"<tr>"+"   <td styles='formTableTitle' lable='centerWorkTitle'></td>"+"   <td colspan='3' styles='formTableValue' item='centerWorkTitle'></td>"+"</tr><tr>"+"   <td styles='formTableTitle' lable='checkLeader'></td>"+"   <td colspan='3' styles='formTableValue' item='checkLeader'></td>"+"</tr><tr>"+"   <td styles='formTableTitle' lable='workType'></td>"+"   <td styles='formTableValue' item='workType'></td>"+"   <td styles='formTableTitle' lable='defaultCompleteDateLimitStr'></td>"+"   <td styles='formTableValue' item='defaultCompleteDateLimitStr'></td>"+"</tr><tr>"+"   <td styles='formTableTitle' lable='workDescription'></td>"+"   <td styles='formTableValue' item='workDescription' colspan='3'></td>"+"</tr>"+"</table>";this.formTableArea.set("html",t);this.loadForm()},loadForm:function(){this.form=new MForm(this.formTableArea,this.data,{style:"execution",isEdited:this.isEdited||this.isNew,itemTemplate:this.getItemTemplate(this.lp)},this.app);this.form.load()},getItemTemplate:function(t){_self=this;return{centerWorkTitle:{text:t.centerWorkTitle+":",name:"title"},checkLeader:{text:t.checkLeader+":",name:"reportAuditLeaderIdentity"},workType:{text:t.workType+":",name:"defaultWorkType"},defaultCompleteDateLimitStr:{text:t.defaultCompleteDateLimitStr+":",name:"defaultCompleteDateLimitStr"},workDescription:{text:t.workDescription+":",name:"description"}}},loadAttachment:function(t){this.attachment=new MWF.xApplication.Execution.Attachment(t,this.app,this.actions,this.app.lp,{documentId:this.data.id,isNew:this.options.isNew,isEdited:this.options.isEdited,onQueryUploadAttachment:function(){this.attachment.isQueryUploadSuccess=true;if(!this.data.id||this.data.id==""){var t=this.form.getResult(true,",",true,false,true);if(!t){this.attachment.isQueryUploadSuccess=false;return}if(this.options.isNew){t.title=t.workDetail;t.deployerName=this.app.user;t.creatorName=this.app.user;t.centerId=this.data.centerWorkId||this.data.centerId}this.app.restActions.saveTask(t,function(t){if(t.type&&t.type=="success"){if(t.data&&t.data.id){this.attachment.options.documentId=t.data.id;this.data.id=t.data.id}}}.bind(this),null,false)}}.bind(this)});this.attachment.load()},_createBottomContent:function(){this.cancelActionNode=new Element("div.formCancelActionNode",{styles:this.css.formCancelActionNode,text:this.lp.close}).inject(this.formBottomNode);this.cancelActionNode.addEvent("click",function(t){this.cancel(t)}.bind(this))}});