MWF.xApplication.CRM=MWF.xApplication.CRM||{};MWF.xDesktop.requireApp("Template","MForm",null,false);MWF.xDesktop.requireApp("CRM","Template",null,false);MWF.xDesktop.requireApp("Template","Explorer",null,false);MWF.require("MWF.widget.Identity",null,false);MWF.xDesktop.requireApp("Forum","Actions.RestActions",null,false);MWF.xApplication.CRM.Customer=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default"},initialize:function(t,e,i,s){this.setOptions(s);this.app=e;this.lp=e.lp.customer;this.path="/x_component_CRM/$Customer/";this.loadCss();this.actions=i;this.node=$(t)},loadCss:function(){this.cssPath="/x_component_CRM/$Customer/"+this.options.style+"/css.wcss";this._loadCss()},load:function(){this.testActions=new MWF.xApplication.Forum.Actions.RestActions;if(this.formContentArr)this.formContentArr.empty();this.formContentArr=[];if(this.formMarkArr)this.formMarkArr.empty();this.formMarkArr=[];this.rightContentDiv=this.app.rightContentDiv;this.createHeadContent();this.createToolBarContent();this.createCustomerContent();this.resizeWindow();this.app.addEvent("resize",function(){this.resizeWindow()}.bind(this))},reload:function(){this.createCustomerContent();this.resizeWindow()},createHeadContent:function(){if(this.headContentDiv)this.headContentDiv.destroy();this.headContentDiv=new Element("div.headContentDiv",{styles:this.css.headContentDiv}).inject(this.rightContentDiv);this.headTitleDiv=new Element("div.headTitleDiv",{styles:this.css.headTitleDiv,text:this.lp.head.headTitle}).inject(this.headContentDiv);this.headSearchDiv=new Element("div.headSearchDiv",{styles:this.css.headSearchDiv}).inject(this.headContentDiv);this.headSearchTextDiv=new Element("div.headSearchTextDiv",{styles:this.css.headSearchTextDiv}).inject(this.headSearchDiv);this.headSearchImg=new Element("img.headSearchImg",{styles:this.css.headSearchImg,src:this.path+"default/icons/search.png"}).inject(this.headSearchTextDiv);this.headSearchInput=new Element("input.headSearchInput",{styles:this.css.headSearchInput,placeholder:this.lp.head.searchText}).inject(this.headSearchTextDiv);this.headSearchInput.addEvents({keyup:function(){if(this.headSearchInput.get("value")!=""){this.headSearchRemoveImg.setStyles({display:"inline-block"})}}.bind(this)});this.headSearchRemoveImg=new Element("img.headSearchRemoveImg",{styles:this.css.headSearchRemoveImg,src:this.path+"default/icons/remove.png"}).inject(this.headSearchTextDiv);this.headSearchRemoveImg.addEvents({click:function(){this.headSearchInput.set("value","")}.bind(this)});this.headSearchBottonDiv=new Element("div.headSearchBottonDiv",{styles:this.css.headSearchBottonDiv,text:this.lp.head.search}).inject(this.headSearchDiv);this.headBottonDiv=new Element("div.headBottonDiv",{styles:this.css.headBottonDiv}).inject(this.headContentDiv);this.headNewBottonDiv=new Element("div.headNewBottonDiv",{styles:this.css.headNewBottonDiv,text:this.lp.head.create}).inject(this.headBottonDiv);this.headNewBottonDiv.addEvents({click:function(){MWF.xDesktop.requireApp("CRM","CustomerEdit",function(){this.explorer=new MWF.xApplication.CRM.CustomerEdit(this,this.actions,{},{isEdited:true,isNew:true,onReloadView:function(){this.reload()}.bind(this)});this.explorer.load()}.bind(this))}.bind(this)});this.headMoreBottonDiv=new Element("div.headMoreBottonDiv",{styles:this.css.headMoreBottonDiv,text:this.lp.head.moreAction}).inject(this.headBottonDiv);this.headMoreBottonDiv.addEvents({click:function(){}.bind(this)});this.headMoreImg=new Element("img.headMoreImg",{styles:this.css.headMoreImg,src:this.path+"default/icons/arrow.png"}).inject(this.headMoreBottonDiv)},createToolBarContent:function(){},createCustomerContent:function(){if(this.contentListDiv)this.contentListDiv.destroy();this.contentListDiv=new Element("div.contentListDiv",{styles:this.css.contentListDiv}).inject(this.rightContentDiv);if(this.contentListInDiv)this.contentListInDiv.destroy();this.contentListInDiv=new Element("div.contentListInDiv",{styles:this.css.contentListInDiv}).inject(this.contentListDiv);this.bottomPageBar=new Element("div.bottomPageBar",{styles:this.css.bottomPageBar}).inject(this.contentListDiv);this.loadView();this.view.node.addEvents({scroll:function(t){this.view.nodeHead.setStyle("margin-left",0-this.view.node.scrollLeft+"px")}.bind(this)})},loadView:function(){this.view=new MWF.xApplication.CRM.Customer.View(this.contentListInDiv,this.app,this,{templateUrl:this.path+"customerView.json",pagingEnable:true,pagingPar:{position:["bottom"],hasNextPage:false,hasReturn:false,currentPage:this.options.viewPageNum||1,countPerPage:30,onPostLoad:function(t){}.bind(this),onPageReturn:function(t){}.bind(this)}},{lp:this.app.lp.customerView,css:this.css});this.view.pagingContainerBottom=this.bottomPageBar;this.view.load()},resizeWindow:function(){var t=this.rightContentDiv.getSize();var e=this.headTitleDiv.getSize();var i=this.headBottonDiv.getSize();if(this.headSearchDiv){var s=this.headSearchDiv.getSize().x;this.headSearchDiv.setStyles({"margin-left":(t.x-e.x-i.x)/2-s/2+"px"})}if(this.contentListDiv)this.contentListDiv.setStyles({height:t.y-this.headContentDiv.getHeight()-2+"px",width:this.rightContentDiv.getWidth()+"px"});if(this.contentListInDiv)this.contentListInDiv.setStyles({height:this.contentListDiv.getHeight()-this.bottomPageBar.getHeight()+"px",width:this.rightContentDiv.getWidth()+"px"});if(this.view&&this.view.node){this.view.node.setStyles({height:this.contentListInDiv.getHeight()-40+"px",width:this.rightContentDiv.getWidth()+"px"})}}});MWF.xApplication.CRM.Customer.View=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexView,load:function(){this.thWidthArr=[];this.initData();this.ayalyseTemplate();var t=this.nodeHead=new Element("div.viewHeadListNode",{styles:this.css.viewHeadListNode}).inject(this.container);this.node=new Element("div.viewBodyNode",{styles:this.css.viewBodyNode}).inject(this.container);if(this.options.scrollEnable){this.setScroll()}this.getContentTemplateNode();this.createHeadNode();this.createViewNode();this.createViewBody()},createHeadNode:function(){var t=0;this._width=0;this.template.items.each(function(e,i){var s=this.formatElement(this.nodeHead,e.head);if(e.head.width){s.setStyle("width",parseInt(e.head.width)+"px");t=t+parseInt(e.head.width);if(i==this.template.items.length-1){if(t<this.explorer.contentListInDiv.getWidth()){this.lastTdWidth=this.explorer.contentListInDiv.getWidth()-t+parseInt(e.head.width);s.setStyle("width",parseInt(this.explorer.contentListInDiv.getWidth()-t+parseInt(e.head.width))+"px");s.set("width",this.lastTdWidth);this._width=this._width+this.lastTdWidth}else{this.lastTdWidth=parseInt(e.head.width);this._width=this._width+parseInt(e.head.width)}}else{this._width=this._width+parseInt(e.head.width)}}}.bind(this))},_createDocument:function(t,e){return new MWF.xApplication.CRM.Customer.Document(this.viewNode,t,this.explorer,this,null,e)},_getCurrentPageData:function(t,e,i){this.clearBody();if(!e)e=30;if(!i)i=1;var s=this.filterData||{};this.explorer.actions.getCustomerListPage(i,e,s,function(e){if(!e.data)e.data=[];if(!e.count)e.count=0;this.app.destroyShade();if(t)t(e)}.bind(this))},_removeDocument:function(t,e){},_create:function(){},_openDocument:function(t,e){t={id:"5514a10e-0789-4289-a4b5-c54022075553"};MWF.xDesktop.requireApp("CRM","CustomerRead",function(){this.customerRead=new MWF.xApplication.CRM.CustomerRead(this.explorer.contentListDiv,this.app,this.explorer,this.actions,{width:1e3,onReloadView:function(){this.gotoPage(this.currentPage)}.bind(this)});this.customerRead.load(t);this.explorer.formContentArr.push(this.customerRead);this.explorer.formMarkArr.push(this.customerRead.formMaskNode)}.bind(this))},_queryCreateViewNode:function(){},_postCreateViewNode:function(t){this.viewNode.set("width",this._width+"px")},_queryCreateViewHead:function(){},_postCreateViewHead:function(t){}});MWF.xApplication.CRM.Customer.Document=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexDocument,_queryCreateDocumentNode:function(t){},_postCreateDocumentNode:function(t,e){this.view.template.items.each(function(e,i){if(e.head.width){t.getElements("td")[i].set("width",e.head.width)}if(i==t.getElements("td").length-1){t.getElements("td")[i].set("width",this.view.lastTdWidth)}}.bind(this))},open:function(t){this.view._openDocument(this.data,this.index)},edit:function(){var t="ForumDocument"+this.data.id;if(this.app.desktop.apps[t]){this.app.desktop.apps[t].setCurrent()}else{this.app.desktop.openApplication(null,"ForumDocument",{sectionId:this.data.sectionId,id:this.data.id,appId:t,isEdited:true,isNew:false,index:this.index})}}});