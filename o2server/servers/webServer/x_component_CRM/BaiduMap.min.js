MWF.xApplication.CRM=MWF.xApplication.CRM||{};MWF.xDesktop.requireApp("Template","MForm",null,false);MWF.xDesktop.requireApp("CRM","Template",null,false);MWF.require("MWF.widget.Identity",null,false);MWF.xApplication.CRM.BaiduMap=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default"},initialize:function(t,e,i,a,o){this.setOptions(o);this.app=e;this.explorer=i;this.lp=e.lp.BaiduMap;this.path="/x_component_CRM/$BaiduMap/";this.loadCss();this.actions=a;this.node=$(t)},loadCss:function(){this.cssPath="/x_component_CRM/$BaiduMap/"+this.options.style+"/css.wcss";this._loadCss()},load:function(t){this.markerData=t;this.mapNode=new Element("div.mapNode",{styles:{width:"100%",height:"99%",id:"mapMaxNode"}}).inject(this.node);setTimeout(function(){this.loadResource(function(){if(this.options.from="newCustomer"){var t=this;this.mapLocation=this.explorer.formTableArea.getElement("#mapLocation");this.mapLocation.set("disabled",false);this.mapLocation.setStyles({"background-color":"#ffffff"});this.mapLocation.addEvents({keyup:function(){if(t.explorer.adDiv)t.explorer.adDiv.destroy();t.explorer.adDiv=new Element("div.adDiv",{styles:t.explorer.css.adDiv}).inject(this.getParent());t.explorer.adDiv.setStyles({width:this.getWidth()+"px"});var e=this.get("value");if(e!=""){var i=new Request.JSONP({url:"http://map.baidu.com/su?wd="+e,data:{cid:"131",type:"0",from:"jsapi"},onRequest:function(t){},onComplete:function(e){t.resolve(e)}}).send()}else{t.explorer.adDiv.destroy();t.explorer.data.lat="";t.explorer.data.lng=""}},blur:function(){}})}}.bind(this))}.bind(this),100)},loadMax:function(t){this.markerData=t;this.maxMapDiv=new Element("div.maxMapDiv",{styles:this.css.maxMapDiv}).inject(this.app.content);this.maxMapDiv.addEvents({click:function(){this.maxMapDiv.destroy()}.bind(this)});this.mapHeadDiv=new Element("div.mapHeadDiv",{styles:this.css.mapHeadDiv}).inject(this.maxMapDiv);this.maxCloseDiv=new Element("div.maxCloseDiv",{styles:this.css.maxCloseDiv}).inject(this.mapHeadDiv);this.maxCloseDiv.addEvents({mouseenter:function(){this.setStyles({opacity:"1",filter:"alpha(opacity=100)"})},mouseleave:function(){this.maxCloseDiv.setStyles(this.css.maxCloseDiv)}.bind(this),click:function(){this.maxMapDiv.destroy()}.bind(this)});this.maxMapDiv.addEvents({click:function(){this.maxMapDiv.destroy()}.bind(this)});this.mapContentDiv=new Element("div.mapContentDiv",{styles:this.css.mapContentDiv}).inject(this.maxMapDiv);this.mapContentDiv.setStyles({height:this.app.content.getHeight()-this.mapHeadDiv.getHeight()-100+"px",width:this.app.content.getWidth()-100+"px"});this.mapContentDiv.addEvents({click:function(t){t.stopPropagation()}});this.mapNode=new Element("div.mapNode",{styles:{width:"100%",height:"99%",id:"mapMaxNode"}}).inject(this.mapContentDiv);setTimeout(function(){this.loadResource()}.bind(this),5)},loadResource:function(t){window.BMap_loadScriptTime=(new Date).getTime();var e="http://api.map.baidu.com/getscript?v=2.0&ak=Qac4WmBvHXiC87z3HjtRrbotCE3sC9Zg&services=&t=20161219171637";if(!window.BDMapApiLoaded){COMMON.AjaxModule.loadDom(e,function(){window.BDMapApiLoaded=true;if(!window.BDMarkerToolLoaded){COMMON.AjaxModule.load("/x_component_CRM/BDMarkerTool.js",function(){window.BDMarkerToolLoaded=true;this._loadMap();if(t)t()}.bind(this))}else{this._loadMap();if(t)t()}}.bind(this))}else{this._loadMap();if(t)t()}},_loadMap:function(){if(this.markerData){this.loadMap()}else{if(navigator.geolocation){try{navigator.geolocation.getCurrentPosition(this.loadMap.bind(this),this.loadMap.bind(this),{timeout:500})}catch(t){this.loadMap()}}else{this.loadMap()}}},loadMap:function(t){this.createMap(t)},createMap:function(t){var e=null;if(this.markerData.longitude&&this.markerData.latitude){e=new BMap.Point(this.markerData.longitude,this.markerData.latitude)}else{if(t&&t.coords){e=new BMap.Point(t.coords.longitude,t.coords.latitude)}if(!e){e=new BMap.Point(116.404,39.915)}}this.map=new BMap.Map(this.mapNode);var i=new BMap.Marker(e);this.map.addOverlay(i);this.map.centerAndZoom(e,14);this.map.panTo(e);this.map.enableScrollWheelZoom(true)},resolve:function(t){var e=this;if(t&&t.s){t.s.each(function(t,i){var a=t.split("$");var o=a[0];var s=a[1]||o;var n=a[3]||o;if(o!=""){var p=new Element("li.adLi",{styles:this.explorer.css.adLi,text:o+"-"+s+"-"+n,city:o}).inject(this.explorer.adDiv);p.addEvents({click:function(t){var i=this.get("city");e.map.clearOverlays();var a=new BMap.LocalSearch(i,{onSearchComplete:function(){var o=a.getResults().getPoi(0).point;var p=a.getResults().province;var l=o.lat;var d=o.lng;var r=p==i?i+s+n:p+i+s+n;e.mapLocation.set("value",r);e.explorer.data.lat=l;e.explorer.data.lng=d;e.map.centerAndZoom(o,18);e.map.addOverlay(new BMap.Marker(o));e.app.confirm("warn",t,e.app.lp.confirm.customForm.replaceLocation.title,e.app.lp.confirm.customForm.replaceLocation.content,300,120,function(){e.explorer.formTableArea.getElement("#TProvinceValue").set("text",p);e.explorer.formTableArea.getElement("#TCityValue").set("text",i);e.explorer.formTableArea.getElement("#TAreaValue").set("text",s);e.explorer.form.getItem("TStreet").set("value",n);e.explorer.adDiv.destroy();this.close()},function(){this.close();e.explorer.adDiv.destroy()})}});a.search(n)},mouseover:function(){this.setStyles({background:"#999999",color:"#ffffff"})},mouseout:function(){this.setStyles({background:"#ffffff",color:""})}})}}.bind(this))}},setPlace:function(t){this.map.clearOverlays();var e=new BMap.LocalSearch(this.map,{onSearchComplete:function(){var t=e.getResults().getPoi(0).point;this.map.centerAndZoom(t,18);this.map.addOverlay(new BMap.Marker(t))}.bind(this)});e.search(t)}});MWF.xApplication.CRM.BaiduMap.MaxMap=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",width:"100%",height:"100%"},initialize:function(t,e,i,a){this.setOptions(a);this.app=e;this.explorer=t;this.lp=e.lp.BaiduMap;this.path="/x_component_CRM/$BaiduMap/";this.loadCss();this.actions=i},loadCss:function(){this.cssPath="/x_component_CRM/$BaiduMap/"+this.options.style+"/css.wcss";this._loadCss()},load:function(t,e){this.maxMapDiv=new Element("div.maxMapDiv",{styles:this.css.maxMapDiv}).inject(this.app.content);this.mapHeadDiv=new Element("div.mapHeadDiv",{styles:this.css.mapHeadDiv}).inject(this.maxMapDiv);this.mapContentDiv=new Element("div.mapContentDiv",{styles:this.css.mapContentDiv}).inject(this.maxMapDiv);this.mapContentDiv.setStyles({height:this.app.content.getHeight()-this.mapHeadDiv.getHeight()-100+"px",width:this.app.content.getWidth()-100+"px"});setTimeout(function(){this.loadResource()}.bind(this),100)},loadResource:function(t){window.BMap_loadScriptTime=(new Date).getTime();var e="http://api.map.baidu.com/getscript?v=2.0&ak=Qac4WmBvHXiC87z3HjtRrbotCE3sC9Zg&services=&t=20161219171637";if(!window.BDMapApiLoaded){COMMON.AjaxModule.loadDom(e,function(){window.BDMapApiLoaded=true;if(!window.BDMarkerToolLoaded){COMMON.AjaxModule.load("/x_component_CRM/BDMarkerTool.js",function(){window.BDMarkerToolLoaded=true;this._loadMap();if(t)t()}.bind(this))}else{this._loadMap();if(t)t()}}.bind(this))}else{this._loadMap();if(t)t()}},_loadMap:function(){if(navigator.geolocation){try{navigator.geolocation.getCurrentPosition(this.loadMap.bind(this),this.loadMap.bind(this))}catch(t){this.loadMap()}}else{this.loadMap()}},loadMap:function(t){this.createMap(t)},createMap:function(t){var e=null;if(this.markerData){e=new BMap.Point(this.markerData.longitude,this.markerData.latitude)}else{if(t&&t.coords){e=new BMap.Point(t.coords.longitude,t.coords.latitude)}if(!e){e=new BMap.Point(116.404,39.915)}}this.map=new BMap.Map(this.mapNode);var i=new BMap.Marker(e);this.map.addOverlay(i);this.map.panTo(e);this.map.centerAndZoom(e,12);this.map.enableScrollWheelZoom(true)}});