MWF.xDesktop.requireApp("cms.ColumnManager","Explorer",null,false);MWF.xApplication.cms.ColumnManager.FormExplorer=new Class({Extends:MWF.xApplication.cms.ColumnManager.Explorer,Implements:[Options,Events],options:{create:MWF.CMSCM.LP.form.create,search:MWF.CMSCM.LP.form.search,searchText:MWF.CMSCM.LP.form.searchText,noElement:MWF.CMSCM.LP.form.noFormNoticeText},_createElement:function(e){this.formTemplateList=null;this.defalutFormTemplateList=null;var n=this;var r=function(t,s){layout.desktop.getFormDesignerStyle(function(){var e={style:layout.desktop.formDesignerStyle,template:s,onQueryLoad:function(){this.actions=n.app.restActions;this.application=n.app.options.application}};layout.desktop.openApplication(t,"cms.FormDesigner",e)}.bind(this))};var a=function(t,s){layout.desktop.getFormDesignerStyle(function(){var e={style:layout.desktop.formDesignerStyle,templateId:s,onQueryLoad:function(){this.actions=n.app.restActions;this.application=n.app.options.application}};layout.desktop.openApplication(t,"cms.FormDesigner",e)}.bind(this))};var l=new Element("div",{styles:this.css.createTemplateMaskNode}).inject(this.app.content);var m=new Element("div",{styles:this.css.createFormTemplateAreaNode}).inject(this.app.content);m.fade("in");var t=new Element("div",{styles:this.css.createTemplateFormTitleNode,text:this.app.lp.createSelectTemplate}).inject(m);var i=new Element("div",{styles:this.css.createTemplateFormCategoryNode}).inject(m);var s=new Element("div",{styles:this.css.createTemplateFormCategoryTitleNode,text:this.app.lp.templateCategory}).inject(i);var c=new Element("div",{styles:this.css.createTemplateFormContentNode}).inject(m);var o=new Element("div",{styles:this.css.createTemplateFormCategoryItemNode,text:this.app.lp.all}).inject(i);o.addEvent("click",function(){v()});this.app.restActions.listFormTemplateCategory(function(e){e.data.each(function(e){var t=new Element("div",{styles:this.css.createTemplateFormCategoryItemNode,text:e.name+"("+e.count+")",value:e.name}).inject(i);t.addEvent("click",function(){c.empty();i.getElements("div").each(function(e,t){if(t>0)e.setStyles(n.css.createTemplateFormCategoryItemNode)});this.setStyles(n.css.createTemplateFormCategoryItemNode_current);u(this.get("value"))})}.bind(this))}.bind(this));var p=function(){var e=this.app.content.getSize();var t=e.y*.1/2;var s=e.x*.1/2;if(t<0)t=0;if(s<0)s=0;m.setStyles({top:""+t+"px",left:""+s+"px"});t=e.y*.9-i.getSize().y-70;c.setStyle("height",""+t+"px")}.bind(this);p();this.app.addEvent("resize",p);var d=function(t){if(this.defalutFormTemplateList){if(t)t()}else{var e="/x_component_cms_FormDesigner/Module/Form/template/templates.json";MWF.getJSON(e,function(e){this.defalutFormTemplateList=e;if(t)t()}.bind(this))}}.bind(this);var h=function(){d(function(){this.defalutFormTemplateList.each(function(e){var t=new Element("div",{styles:this.css.formTemplateNode}).inject(c);var s=new Element("div",{styles:this.css.formTemplateIconNode}).inject(t);var i=new Element("div",{styles:this.css.formTemplateTitleNode,text:e.title}).inject(t);t.store("template",e.name);var o=new Element("img",{styles:this.css.formTemplateIconImgNode}).inject(s);o.set("src","/x_component_cms_FormDesigner/Module/Form/template/"+e.icon);t.addEvents({mouseover:function(){this.setStyles(n.css.formTemplateNode_over)},mouseout:function(){this.setStyles(n.css.formTemplateNode)},mousedown:function(){this.setStyles(n.css.formTemplateNode_down)},mouseup:function(){this.setStyles(n.css.formTemplateNode_over)},click:function(e){r(e,this.retrieve("template"));n.app.removeEvent("resize",p);m.destroy();l.destroy()}})}.bind(this))}.bind(this))}.bind(this);var f=function(t){if(this.formTemplateList){if(t)t()}else{this.app.restActions.listFormTemplate(function(e){this.formTemplateList=e.data;if(t)t()}.bind(this))}}.bind(this);var u=function(i){f(function(){Object.each(this.formTemplateList,function(e,t){var s=i?t==i:true;if(s){e.each(function(e){var t=new Element("div",{styles:this.css.formTemplateNode}).inject(c);var s=new Element("div",{styles:this.css.formTemplatePreviewNode}).inject(t);var i=new Element("div",{styles:this.css.formTemplateTitleNode,text:e.name}).inject(t);t.store("template",e.id);s.set("html",e.outline);var o=new Element("img",{styles:this.css.formTemplateActionNode}).inject(s);o.addEvent("click",function(t){var e=this.getParent().getParent();var s=e.retrieve("template");n.app.confirm("wram",t,n.app.lp.form.deleteFormTemplateTitle,n.app.lp.form.deleteFormTemplate,300,120,function(){n.app.restActions.deleteFormTemplate(s,function(e){n.app.removeEvent("resize",p);m.destroy();l.destroy();n._createElement(t)}.bind(this));this.close()},function(){this.close()});t.stopPropagation()});t.addEvents({mouseover:function(){this.setStyles(n.css.formTemplateNode_over);if(o)o.setStyle("display","block")},mouseout:function(){this.setStyles(n.css.formTemplateNode);if(o)o.setStyle("display","none")},mousedown:function(){this.setStyles(n.css.formTemplateNode_down)},mouseup:function(){this.setStyles(n.css.formTemplateNode_over)},click:function(e){a(e,this.retrieve("template"));n.app.removeEvent("resize",p);m.destroy();l.destroy()}})}.bind(this))}}.bind(this))}.bind(this))}.bind(this);var v=function(){c.empty();i.getElements("div").each(function(e,t){if(t>0)e.setStyles(n.css.createTemplateFormCategoryItemNode)});o.setStyles(n.css.createTemplateFormCategoryItemNode_current);h();u()};v();l.addEvent("click",function(){this.app.removeEvent("resize",p);m.destroy();l.destroy()}.bind(this))},showDeleteAction:function(){if(!this.deleteItemsAction){this.deleteItemsAction=new Element("div",{styles:this.css.deleteItemsAction,text:this.app.lp.deleteItems}).inject(this.node);this.deleteItemsAction.fade("in");this.deleteItemsAction.position({relativeTo:this.elementContentListNode});this.deleteItemsAction.addEvent("click",function(){var e=this;this.app.confirm("warn",this.deleteItemsAction,MWF.CMSCM.LP.form.deleteFormTitle,MWF.CMSCM.LP.form.deleteForm,300,120,function(){e.deleteItems();this.close()},function(){this.close()})}.bind(this))}},_loadItemDataList:function(e){this.app.restActions.listForm(this.app.options.column.id,e)},_getItemObject:function(e,t){return new MWF.xApplication.cms.ColumnManager.FormExplorer.Form(this,e,{index:t})},setTooltip:function(){this.options.tooltip={create:MWF.CMSCM.LP.form.create,search:MWF.CMSCM.LP.form.search,searchText:MWF.CMSCM.LP.form.searchText,noElement:MWF.CMSCM.LP.form.noFormNoticeText}},deleteItems:function(){while(this.deleteMarkItems.length){var e=this.deleteMarkItems.shift();if(this.deleteMarkItems.length){e.deleteForm()}else{e.deleteForm(function(){this.hideDeleteAction();this.reload()}.bind(this))}}}});MWF.xApplication.cms.ColumnManager.FormExplorer.Form=new Class({Extends:MWF.xApplication.cms.ColumnManager.Explorer.Item,_open:function(s){layout.desktop.getFormDesignerStyle(function(){var e=this;var t={style:layout.desktop.formDesignerStyle,onQueryLoad:function(){this.actions=e.explorer.actions;this.category=e;this.options.id=e.data.id;this.column=e.explorer.app.options.column;this.application=e.explorer.app.options.column}};this.explorer.app.desktop.openApplication(s,"cms.FormDesigner",t)}.bind(this))},_getIcon:function(){var e=(Math.random()*33).toInt();return"process_icon_"+e+".png"},_getLnkPar:function(){return{icon:this.explorer.path+this.explorer.options.style+"/formIcon/lnk.png",title:this.data.name,par:'cms.FormDesigner#{"id": "'+this.data.id+'"}'}},deleteForm:function(e){this.explorer.app.restActions.removeForm(this.data.id,function(){this.node.destroy();if(e)e()}.bind(this))}});