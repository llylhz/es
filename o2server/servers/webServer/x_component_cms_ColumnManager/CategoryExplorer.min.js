MWF.xDesktop.requireApp("cms.ColumnManager","Explorer",null,false);MWF.xDesktop.requireApp("cms.ColumnManager","FormExplorer",null,false);MWF.xDesktop.requireApp("cms.ColumnManager","ViewExplorer",null,false);MWF.xApplication.cms.ColumnManager.CategoryExplorer=new Class({Extends:MWF.xApplication.cms.ColumnManager.Explorer,Implements:[Options,Events],options:{style:"default",title:"",currentCategoryId:"",tooltip:{create:MWF.CMSCM.LP.category.create,search:MWF.CMSCM.LP.category.search,searchText:MWF.CMSCM.LP.category.searchText,noElement:MWF.CMSCM.LP.category.noCategoryNoticeText}},initialize:function(t,e,i,s){this.setOptions(s);this.setTooltip();this.path="/x_component_cms_ColumnManager/$CategoryExplorer/";this.cssPath="/x_component_cms_ColumnManager/$CategoryExplorer/"+this.options.style+"/css.wcss";this._loadCss();this.actions=i;this.node=$(t);this.naviNode=e;this.initData()},load:function(){this.loadContentNode()},reload:function(){if(!this.node)return;this.initData();this.node.empty();this.naviNode.empty();this.load()},refresh:function(){this.setContentSize();this.viewExplorer.reload();this.formExplorer.reload();this.categoryProperty.reload()},loadContentNode:function(){this.elementContentNode=new Element("div.elementContentNode",{styles:this.css.elementContentNode}).inject(this.node);this.elementContentListNode=new Element("div.elementContentListNode",{styles:this.css.elementContentListNode}).inject(this.elementContentNode);this.naviContainerNode=this.naviNode;this.loadContentNodes();this.setContentSize();this.app.addEvent("resize",function(){this.setContentSize()}.bind(this));this.loadForm();this.loadView();this.loadProperty();this.loadCategoryList()},loadContentNodes:function(){this.rightContent=new Element("div.rightContent",{styles:this.css.rightContent}).inject(this.elementContentListNode);this.rightTopContent=new Element("div.rightTopContent",{styles:this.css.rightTopContent}).inject(this.rightContent);this.rightHorizontalResizeNode=new Element("div.rightHorizontalResizeNode",{styles:this.css.rightHorizontalResizeNode}).inject(this.rightContent);this.rightBottomContent=new Element("div.rightBottomContent",{styles:this.css.rightBottomContent}).inject(this.rightContent);this.createFormNode();this.createViewNode();this.formPercent=.5;this.topPercent=.5;this.loadRightHorizontalResize()},setNodeScroll:function(){MWF.require("MWF.widget.DragScroll",function(){new MWF.widget.DragScroll(this.naviArea)}.bind(this));MWF.require("MWF.widget.ScrollBar",function(){new MWF.widget.ScrollBar(this.naviArea,{indent:false})}.bind(this))},loadCategoryList:function(t){this.categoryList=new MWF.xApplication.cms.ColumnManager.CategoryExplorer.CategoryList(this,this.naviNode,{currentCategoryId:this.options.currentCategoryId,columnId:this.app.options.column.id,onPostLoad:function(){this.fireEvent("postLoadCategoryList",this.categoryList)}.bind(this)})},_createElement:function(){this.categoryList.newCategory()},loadProperty:function(){this.categoryProperty=new MWF.xApplication.cms.ColumnManager.CategoryExplorer.CategoryProperty(this.app,this.rightBottomContent);this.categoryProperty.load()},createFormNode:function(){this.formAreaNode=new Element("div.formAreaNode",{styles:this.css.formAreaNode}).inject(this.rightTopContent);this.formTitleNode=new Element("div.formTitleNode",{styles:this.css.formTitleNode}).inject(this.formAreaNode);this.formCreateNode=new Element("div.formCreateNode",{styles:this.css.formCreateNode,title:"新建表单"}).inject(this.formTitleNode);this.formCreateNode.addEvent("click",function(t){this.formExplorer._createElement(t)}.bind(this));this.formCreateNode.addEvent("mouseover",function(t){this.formCreateNode.setStyles(this.css.formCreateNode_over)}.bind(this));this.formCreateNode.addEvent("mouseout",function(t){this.formCreateNode.setStyles(this.css.formCreateNode)}.bind(this));this.formCreateNode.setStyle("display","none");this.formTitleTextNode=new Element("div.formTitleTextNode",{styles:this.css.formTitleTextNode,text:"选择分类表单"}).inject(this.formTitleNode);this.formNode=new Element("div.formNode",{styles:this.css.formNode}).inject(this.formAreaNode)},loadForm:function(){this.formExplorer=new MWF.xApplication.cms.ColumnManager.CategoryExplorer.FormExplorer(this.formNode,this.app.restActions,{style:"full"});this.formExplorer.app=this.app;this.formExplorer.explorer=this;this.formExplorer.load()},createViewNode:function(){this.viewAreaNode=new Element("div.viewAreaNode",{styles:this.css.viewAreaNode}).inject(this.rightTopContent);this.viewTitleNode=new Element("div.viewTitleNode",{styles:this.css.viewTitleNode}).inject(this.viewAreaNode);this.viewAddNode=new Element("div.viewAddNode",{styles:this.css.viewAddNode,text:"选择数据视图",title:"从已有数据视图中选择"}).inject(this.viewTitleNode);this.viewAddNode.addEvent("click",function(t){this.viewExplorer._selectView(t)}.bind(this));this.viewAddNode.addEvent("mouseover",function(t){this.viewAddNode.setStyles(this.css.viewAddNode_over)}.bind(this));this.viewAddNode.addEvent("mouseout",function(t){this.viewAddNode.setStyles(this.css.viewAddNode)}.bind(this));this.viewAddNode.setStyle("display","none");this.listAddNode=new Element("div.listAddNode",{styles:this.css.viewAddNode,text:"选择列表",title:"从已有列表中选择"}).inject(this.viewTitleNode);this.listAddNode.addEvent("click",function(t){this.viewExplorer._selectList(t)}.bind(this));this.listAddNode.addEvent("mouseover",function(t){this.listAddNode.setStyles(this.css.viewAddNode_over)}.bind(this));this.listAddNode.addEvent("mouseout",function(t){this.listAddNode.setStyles(this.css.viewAddNode)}.bind(this));this.listAddNode.setStyle("display","none");this.viewTitleTextNode=new Element("div.viewTitleTextNode",{styles:this.css.viewTitleTextNode,text:"分类展现"}).inject(this.viewTitleNode);this.viewNode=new Element("div.viewNode",{styles:this.css.viewNode}).inject(this.viewAreaNode)},loadView:function(){this.viewExplorer=new MWF.xApplication.cms.ColumnManager.CategoryExplorer.ViewExplorer(this.viewNode,this.app.restActions,{style:"full"});this.viewExplorer.app=this.app;this.viewExplorer.explorer=this;this.viewExplorer.load()},loadRightVerticalResize:function(){this.rightVerticalResize=new Drag(this.rightVerticalResizeNode,{snap:1,onStart:function(t,e){var i=Browser.name=="firefox"?e.event.clientX:e.event.x;var s=Browser.name=="firefox"?e.event.clientY:e.event.y;t.store("position",{x:i,y:s});var o=this.formNode.getSize();t.store("initialHeight",o.y)}.bind(this),onDrag:function(t,e){var i=this.rightContent.getSize();var s=Browser.name=="firefox"?e.event.clientY:e.event.y;var o=t.retrieve("position");var n=s.toFloat()-o.y.toFloat();var r=t.retrieve("initialHeight").toFloat();var a=r+n;if(a<40)a=40;if(a>i.y-40)a=i.y-40;this.topPercent=a/i.y;this.setRightVerticalResize()}.bind(this)})},setRightVerticalResize:function(){var t=this.node.getSize();var e=t.x;this.elementContentListNode.setStyles({width:""+e+"px"});this.rightContent.setStyle("width",""+e+"px");var i=this.rightVerticalResizeNode?this.rightVerticalResizeNode.getSize():{x:0,y:0};var s=e-i.x-2;var o=s*this.formPercent;var n=s-s*this.formPercent;this.formAreaNode.setStyle("width",""+o+"px");this.formNode.setStyle("width",""+o+"px");this.viewAreaNode.setStyle("width",""+n+"px");this.viewNode.setStyle("width",""+n+"px")},loadRightHorizontalResize:function(){this.rightHorizontalResize=new Drag(this.rightHorizontalResizeNode,{snap:1,onStart:function(t,e){var i=Browser.name=="firefox"?e.event.clientX:e.event.x;var s=Browser.name=="firefox"?e.event.clientY:e.event.y;t.store("position",{x:i,y:s});var o=this.rightTopContent.getSize();t.store("initialHeight",o.y)}.bind(this),onDrag:function(t,e){var i=this.rightContent.getSize();var s=Browser.name=="firefox"?e.event.clientY:e.event.y;var o=t.retrieve("position");var n=s.toFloat()-o.y.toFloat();var r=t.retrieve("initialHeight").toFloat();var a=r+n;if(a<120)a=120;if(a>i.y-120)a=i.y-120;this.topPercent=a/i.y;this.setRightHorizontalResize();if(this.formExplorer)this.formExplorer.setContentSize();if(this.viewExplorer)this.viewExplorer.setContentSize();if(this.categoryProperty)this.categoryProperty.setContentHeight()}.bind(this)})},setRightHorizontalResize:function(){var t=this.node.getSize();var e=this.elementContentNode.getStyle("padding-top").toFloat();var i=this.elementContentNode.getStyle("padding-bottom").toFloat();var s=this.naviContainerNode.getSize();var o=t.y;this.elementContentListNode.setStyle("height",""+o+"px");this.rightContent.setStyle("height",""+o+"px");var n=this.rightHorizontalResizeNode?this.rightHorizontalResizeNode.getSize():{x:0,y:0};var r=o-n.y;var a=this.topPercent*r;var l=r-a;this.rightTopContent.setStyle("height",""+a+"px");this.rightBottomContent.setStyle("height",""+l+"px");this.formNode.setStyle("height",""+(a-50)+"px");this.viewNode.setStyle("height",""+(a-50)+"px")},setContentSize:function(){this.setRightHorizontalResize();this.setRightVerticalResize()},afterClickCategory:function(t){this.fireEvent("postClickSub",[t])}});MWF.xApplication.cms.ColumnManager.CategoryExplorer.CategoryList=new Class({Implements:[Options,Events],options:{currentCategoryId:"",columnId:""},initialize:function(t,e,i){this.setOptions(i);this.explorer=t;this.app=t.app;this.node=$(e);this.css=t.css;this.categoryArr=[];this.categoryObj={};this.currentCategory=null;this.currentView=null;this.load()},load:function(){var t=this;this.app.restActions.listCategory(this.options.columnId,function(t){t.data.each(function(t){this.loadCategoryByData(t)}.bind(this));this.fireEvent("postLoad")}.bind(this),function(){this.fireEvent("postLoad")}.bind(this),true)},getCurrentNode:function(){return this.currentNode},getCategoryNodes:function(){var e=[];this.categoryArr.each(function(t){e.push(t.node)}.bind(this));return e},cancelCurrentNode:function(){if(this.currentNode){if(this.currentNodeType=="category"){this.currentNode.setStyles(this.css.categoryNaviNode);this.currentCategory._hideActions()}else{this.currentNode.setStyles(this.css.viewNaviNode)}this.currentNode=null}},setCurrentCategoryById:function(t){if(t&&this.categoryObj[t]){this.setCurrentCategory(this.categoryObj[t])}},setCurrentCategory:function(t){this.cancelCurrentNode();this.currentCategory=t;this.currentNodeType="category";this.currentNode=t.node;t.node.setStyles(this.css.categoryNaviNode_selected);this.currentTimeout=setTimeout(function(){t._showActions();this.currentTimeout=null;this.explorer.afterClickCategory(t)}.bind(this),100);if(t.options.isNew){this.explorer.formCreateNode.setStyle("display","none")}else{this.explorer.formCreateNode.setStyle("display","")}this.explorer.formExplorer.refreshByCategory(t);if(t.options.isNew){this.explorer.viewAddNode.setStyle("display","none");this.explorer.listAddNode.setStyle("display","none")}else{this.explorer.viewAddNode.setStyle("display","");this.explorer.listAddNode.setStyle("display","")}this.explorer.viewExplorer.refreshByCategory(t);this.explorer.categoryProperty.reload(t)},setCurrentView:function(t){this.cancelCurrentNode();this.currentView=t;this.currentNodeType="view";this.currentNode=t.node;t.node.setStyles(this.css.viewNaviNode_selected)},destroyCategory:function(t){if(t.options.isNew){}else{var e=t.data.id;delete this.categoryObj[e];var i=this.categoryArr.indexOf(t);if(i>-1){this.categoryArr.splice(i,1)}}t.destroy()},loadCategoryByData:function(t,e,i,s){var o=new MWF.xApplication.cms.ColumnManager.CategoryExplorer.Category(this,this.node,t,{relativeNode:e,relativePosition:i});this.categoryObj[t.id]=o;this.categoryArr.push(o);if(s)s(o);if(this.options.currentCategoryId&&this.options.currentCategoryId==t.id){this.setCurrentCategory(o);this.options.currentCategoryId=""}},loadCategoryById:function(t,s,o,n){this.app.restActions.getCategory(t,function(t){var e=t.data;var i=new MWF.xApplication.cms.ColumnManager.CategoryExplorer.Category(this,this.node,e,{relativeNode:s,relativePosition:o});this.categoryObj[e.id]=i;this.categoryArr.push(i);if(n)n(i);if(this.options.currentCategoryId&&this.options.currentCategoryId==e.id){this.setCurrentCategory(i);this.options.currentCategoryId=""}}.bind(this))},adjustSeq:function(n){var r=this.node.getElements(".categoryNaviNode");var a=this.app.restActions;r.each(function(t,e){var i=t.retrieve("category");if(!i.options.isNew){var s=i.data;var o="000"+(r.length-e);s.categorySeq=o.substr(o.length-3,3);a.saveCategory(s,null,null,n===false?false:true)}})},newCategory:function(t,e){var i=new MWF.xApplication.cms.ColumnManager.CategoryExplorer.Category(this,this.node,{},{isNew:true,relativeNode:t,relativePosition:e});this.setCurrentCategory(i)}});MWF.xApplication.cms.ColumnManager.CategoryExplorer.Category=new Class({Implements:[Options,Events],options:{style:"default",isNew:false,relativeNode:null,relativePosition:"bottom",actions_edit:[{name:"saveCategory",icon:"save.png",icon_over:"save_over.png",unselectedIcon:"save_over.png",unselectedIcon_over:"save_unselected_over.png",event:"click",action:"saveCategory",title:MWF.xApplication.cms.ColumnManager.LP.category.saveCategory},{name:"cancel",icon:"cancel.png",icon_over:"cancel_over.png",unselectedIcon:"cancel_over.png",unselectedIcon_over:"cancel_unselected_over.png",event:"click",action:"cancel",title:MWF.xApplication.cms.ColumnManager.LP.category.cancelEdit}],actions_read:[{name:"editCategory",icon:"edit.png",icon_over:"edit_over.png",event:"click",action:"editCategory",title:MWF.xApplication.cms.ColumnManager.LP.category.editCategory},{name:"insertCateogryBefore",icon:"insertBefore.png",icon_over:"insertBefore_gray.png",event:"click",action:"insertCateogryBefore",title:MWF.xApplication.cms.ColumnManager.LP.category.insertCateogryBefore},{name:"insertCateogryAfter",icon:"insertAfter.png",icon_over:"insertAfter_over.png",event:"click",action:"insertCateogryAfter",title:MWF.xApplication.cms.ColumnManager.LP.category.insertCateogryAfter},{name:"deleteCategory",icon:"trash.png",icon_over:"trash_gray.png",event:"click",action:"deleteCategory",title:MWF.xApplication.cms.ColumnManager.LP.category.deleteCategory},{name:"moveCategory",icon:"turn.png",icon_over:"turn_gray.png",event:"click",action:"moveCategory",title:MWF.xApplication.cms.ColumnManager.LP.category.moveCategory}]},initialize:function(t,e,i,s){this.setOptions(s);this.list=t;this.explorer=t.explorer;this.app=t.app;this.css=t.css;this.container=$(e);this.data=i;this.lp=this.app.lp.category;this.categoryViewArr=[];this.categoryViewObj={};this.load()},load:function(){var t=this;this.node=new Element("div.categoryNaviNode",{styles:this.css.categoryNaviNode}).inject(this.options.relativeNode||this.container,this.options.relativePosition||"bottom");this.node.store("category",this);this.textNode=new Element("div.categoryNaviTextNode",{styles:this.css.categoryNaviTextNode,text:this.data.name}).inject(this.node);this.node.addEvents({mouseover:function(){if(t.list.getCurrentNode()!=this&&!t.list.isOnDragging)this.setStyles(t.css.categoryNaviNode_over)},mouseout:function(){if(t.list.getCurrentNode()!=this)this.setStyles(t.css.categoryNaviNode)},click:function(){if(!t.list.isOnDragging){t.setCurrentNode(this)}}});this.loadViewNode();this.createIconAction();if(this.options.isNew){this.editCategory()}},loadViewNode:function(){var t=this.viewNaviListNode=new Element("div.viewNaviListNode",{styles:this.css.viewNaviListNode}).inject(this.node,"after")},destroy:function(){this.node.destroy();this.viewNaviListNode.destroy();delete this},setCategoryView:function(e,t){var i={categoryId:this.data.id,viewId:e};this.app.restActions.addCategoryView(i,function(t){this.app.restActions.getView(e,function(t){this.app.notice("设置分类列表成功")}.bind(this))}.bind(this),null,false)},setDefaultCategoryView:function(t,e){var i=this.data;i.defaultViewName=t;this.app.restActions.saveCategory(i,function(t){if(!e)this.app.notice("设置默认视图成功")}.bind(this))},cancelCategoryView:function(i,t){this.app.restActions.listCategoryViewByCategory(this.data.id,function(t){t.data.each(function(t){if(t.viewId==i){this.app.restActions.deleteCategoryView(t.id,function(t){var e=this.categoryViewObj[i];delete this.categoryViewObj[i];this.categoryViewArr.erase(e);e.destroy();this.app.notice("取消分类列表成功")}.bind(this),null,false)}}.bind(this))}.bind(this),null,false)},setImportView:function(t,e){var i=this.data;i.importViewId=t;i.importViewAppId=e;var s={viewId:t,viewAppId:e};this.app.restActions.saveCategoryImportView(i.id,s,function(t){this.app.notice("设置分类导入导出视图成功")}.bind(this))},setDocumentType:function(t){var e=this.data;e.documentType=t;this.app.restActions.saveCategory(e,function(t){this.app.notice("设置文档类型成功")}.bind(this))},setEditForm:function(t,e){var i=this.data;i.formId=t;i.formName=e;this.app.restActions.saveCategory(i,function(t){this.app.notice("设置编辑表单成功")}.bind(this))},setReadForm:function(t,e){var i=this.data;i.readFormId=t;i.readFormName=e;this.app.restActions.saveCategory(i,function(t){this.app.notice("设置阅读表单成功")}.bind(this))},saveCategory:function(){var t=this.data||{};if(this.options.isNew){t.isNew=this.options.isNew;t.appId=this.app.options.column.id}if(this.editMode&&this.input){var e=this.input.get("value");if(e==""||e=="请输入分类名称"){this.app.notice("请输入分类名称","error");return}else{t.categoryName=e;t.name=e}}this.app.restActions.saveCategory(t,function(t){this.list.loadCategoryById(t.data.id,this.node,"before",function(t){this.list.setCurrentCategory(t);this.list.adjustSeq(false);this.list.destroyCategory(this)}.bind(this))}.bind(this))},cancel:function(){if(this.options.isNew){this.destroy()}else{this.editMode=false;this.input.destroy();this.textNode.setStyle("display","");this._showActions()}},editCategory:function(){this.textNode.setStyle("display","none");this.editMode=true;this.input=new Element("input",{type:"text",value:this.options.isNew?"请输入分类名称":this.data.name,styles:this.css.categoryInput}).inject(this.node,"top");this.input.addEvents({click:function(t){this._showActions(true);if(this.list.currentCategory!=this){this.setCurrentNode()}t.stopPropagation()}.bind(this),focus:function(t){if(t.target.value=="请输入分类名称"){t.target.value=""}}.bind(this),blur:function(t){if(t.target.value==""){t.target.value="请输入分类名称"}}.bind(this)});this._showActions(true)},setCurrentNode:function(){this.list.setCurrentCategory(this)},createViewsNode:function(t,e){var i=new MWF.xApplication.cms.ColumnManager.CategoryExplorer.CategoryView(this,t,e);var s=e.isDefault?"default":e.id;this.categoryViewObj[s]=i;this.categoryViewArr.push(i)},_showActions:function(){if(this.editMode){if(this.actionArea_edit){this.actionArea_edit.setStyle("display","")}if(this.actionArea_read){this.actionArea_read.setStyle("display","none")}}else{if(this.actionArea_edit){this.actionArea_edit.setStyle("display","none")}if(this.actionArea_read){this.actionArea_read.setStyle("display","")}}},_hideActions:function(){if(this.actionArea_read)this.actionArea_read.setStyle("display","none");if(this.actionArea_edit){this.actionArea_edit.setStyle("display","none")}},createIconAction:function(){this.actionNodes=this.actionNodes||{};if(!this.actionArea_read&&!this.options.isNew){this.actionArea_read=new Element("div",{styles:this.css.actionArea}).inject(this.node);this.options.actions_read.each(function(e){var t=this.actionNodes[e.name]=new Element("div",{styles:this.css.actionNodeStyles,title:e.title}).inject(this.actionArea_read);t.setStyle("background","url("+this.explorer.path+this.options.style+"/icon/"+e.icon+") no-repeat left center");t.addEvent(e.event,function(t){this[e.action](t);t.stopPropagation()}.bind(this));t.addEvents({mouseover:function(t){if(this.obj.list.currentCategory==this.obj||!this.action.unselectedIcon_over){t.target.setStyle("background","url("+this.obj.explorer.path+this.obj.options.style+"/icon/"+this.action.icon_over+") no-repeat left center")}else{t.target.setStyle("background","url("+this.obj.explorer.path+this.obj.options.style+"/icon/"+this.action.unselectedIcon_over+") no-repeat left center")}}.bind({obj:this,action:e}),mouseout:function(t){if(this.obj.list.currentCategory==this.obj||!this.action.unselectedIcon){t.target.setStyle("background","url("+this.obj.explorer.path+this.obj.options.style+"/icon/"+this.action.icon+") no-repeat left center")}else{t.target.setStyle("background","url("+this.obj.explorer.path+this.obj.options.style+"/icon/"+this.action.unselectedIcon+") no-repeat left center")}}.bind({obj:this,action:e})})}.bind(this))}if(!this.actionArea_edit){this.actionArea_edit=new Element("div",{styles:this.css.actionArea}).inject(this.node);this.options.actions_edit.each(function(e){var t=this.actionNodes[e.name]=new Element("div",{styles:this.css.actionNodeStyles,title:e.title}).inject(this.actionArea_edit);t.setStyle("background","url("+this.explorer.path+this.options.style+"/icon/"+e.icon+") no-repeat left center");t.addEvent(e.event,function(t){this[e.action](t);t.stopPropagation()}.bind(this));t.addEvents({mouseover:function(t){if(this.obj.list.currentCategory==this.obj||!this.action.unselectedIcon_over){t.target.setStyle("background","url("+this.obj.explorer.path+this.obj.options.style+"/icon/"+this.action.icon_over+") no-repeat left center")}else{t.target.setStyle("background","url("+this.obj.explorer.path+this.obj.options.style+"/icon/"+this.action.unselectedIcon_over+") no-repeat left center")}}.bind({obj:this,action:e}),mouseout:function(t){if(this.obj.list.currentCategory==this.obj||!this.action.unselectedIcon){t.target.setStyle("background","url("+this.obj.explorer.path+this.obj.options.style+"/icon/"+this.action.icon+") no-repeat left center")}else{t.target.setStyle("background","url("+this.obj.explorer.path+this.obj.options.style+"/icon/"+this.action.unselectedIcon+") no-repeat left center")}}.bind({obj:this,action:e})})}.bind(this))}},insertCateogryBefore:function(t){this.list.newCategory(this.node,"before")},insertCateogryAfter:function(t){this.list.newCategory(this.viewNaviListNode,"after")},deleteCategory:function(t){var e=this;this.app.confirm("warn",this.actionNodes.deleteCategory,this.lp.deleteCategoryTitle,this.lp.deleteCategoryConfirm,300,120,function(){e._deleteCategory();this.close()},function(){this.close()})},_deleteCategory:function(t){this.app.restActions.removeCategory(this.data.id,function(){this.node.destroy();this.viewNaviListNode.destroy();if(t)t()}.bind(this),function(t,e,i){var s=i;if(t)s=t.responseText;if(s.indexOf("referenced")>-1){var o=this.explorer.app.lp.category;var e=o.deleteFailAsHasDocument.replace(/{title}/g,this.data.name);this.app.notice(e,"error")}}.bind(this))},moveCategory:function(t){this._createMoveNode();this._setNodeMove(t)},_createMoveNode:function(){this.moveNode=new Element("div",{styles:this.css.moduleNodeMove,text:this.node.get("text"),events:{selectstart:function(){return false}}}).inject(this.container)},_setNodeMove:function(t){this._setMoveNodePosition(t);var e=this.list.getCategoryNodes();var i=new Drag.Move(this.moveNode,{droppables:e,onEnter:function(t,e){var i=e.retrieve("category");if(i)i._dragIn(this)}.bind(this),onLeave:function(t,e){var i=e.retrieve("category");if(i)i._dragOut(this)}.bind(this),onDrag:function(t){this.list.isOnDragging=true}.bind(this),onDrop:function(t,e,i){if(e){var s=e.retrieve("category");if(s){this._dragComplete(s);s._dragDrop(this)}else{this._dragCancel(t)}}else{this._dragCancel(t)}if(this.dragInterval){clearInterval(this.dragInterval);this.dragInterval=null}setTimeout(function(){this.list.isOnDragging=false}.bind(this),100);i.stopPropagation()}.bind(this),onCancel:function(t){if(this.dragInterval){clearInterval(this.dragInterval);this.dragInterval=null}setTimeout(function(){this.list.isOnDragging=false}.bind(this),100)}.bind(this)});i.start(t)},_dragIn:function(){this.viewNaviListNode.setStyles(this.css.viewNaviListNode_dragIn)},_dragOut:function(){this.viewNaviListNode.setStyles(this.css.viewNaviListNode)},_dragDrop:function(){this.viewNaviListNode.setStyles(this.css.viewNaviListNode)},_dragComplete:function(t){this.node.inject(t.viewNaviListNode,"after");this.viewNaviListNode.inject(this.node,"after");this.setCurrentNode();if(this.moveNode)this.moveNode.destroy();this.moveNode=null;this.list.adjustSeq()},_dragCancel:function(){if(this.moveNode)this.moveNode.destroy();this.moveNode=null},_setScroll:function(){var t=this.explorer.categoryScrollWrapNode||this.explorer.naviArea;var e=t.getCoordinates();var i=e.top;var s=i+e.height;var o=this.explorer.categoryScrollContentNode||this.explorer.naviNode;var n=this.moveNode.getCoordinates();if(n.top<i&&n.bottom>i){if(!this.dragInterval){this.dragInterval=setInterval(function(){if(t.getScroll().y-15>0){t.scrollTo(0,t.getScroll().y-15)}else{t.scrollTo(0,0)}}.bind(this),100)}}else if(n.top<s&&n.bottom>s){if(!this.dragInterval){this.dragInterval=setInterval(function(){if(t.getScroll().y+15<o.getSize().y){t.scrollTo(0,t.getScroll().y+15)}else{t.scrollTo(0,o.getSize().y)}}.bind(this),100)}}else{if(this.dragInterval){clearInterval(this.dragInterval);this.dragInterval=null}}},_setMoveNodePosition:function(t){var e=t.page.x+2;var i=t.page.y+2;this.moveNode.positionTo(e,i)}});MWF.xApplication.cms.ColumnManager.CategoryExplorer.CategoryView=new Class({Implements:[Options,Events],initialize:function(t,e,i,s){this.setOptions(s);this.category=t;this.list=t.list;this.explorer=t.explorer;this.app=t.app;this.css=t.css;this.container=$(e);this.data=i;this.load()},destroy:function(){this.node.destroy();delete this},load:function(){var e=this;this.node=new Element("div.viewNaviNode",{styles:this.css.viewNaviNode,text:this.data.isDefault?this.app.lp.defaultView:this.data.name}).inject(this.container);this.node.addEvents({mouseover:function(){if(e.list.getCurrentNode()!=this)this.setStyles(e.css.viewNaviNode_over)},mouseout:function(){if(e.list.getCurrentNode()!=this)this.setStyles(e.css.viewNaviNode)},click:function(t){e.setCurrentNode(this)}})},setCurrentNode:function(){this.list.setCurrentView(this)}});MWF.xApplication.cms.ColumnManager.CategoryExplorer.FormExplorer=new Class({Extends:MWF.xApplication.cms.ColumnManager.FormExplorer,Implements:[Options,Events],load:function(){this.loadContentNode();this.setNodeScroll();this.refresh()},reload:function(){if(!this.node)return;this.initData();this.node.empty();this.loadContentNode();this.setNodeScroll();if(this.currentCategory){this.refreshByCategory(this.currentCategory)}else{this.refresh()}},refreshByCategory:function(t){this.currentCategory=t;var i,e,s;if(t.data){i=t.data.formId;e=t.data.formName;s=t.data.readFormId}if(this.currentEditForm){this.currentEditForm.isEditForm=false;this.currentEditForm.setStyle();this.currentEditForm=null}if(this.currentReadForm){this.currentReadForm.isReadForm=false;this.currentReadForm.setStyle();this.currentReadForm=null}this.refresh(t,function(){this.itemArray.each(function(t){var e=t.data;if(e.id==i){this.currentEditForm=t;t.isEditForm=true}if(e.id==s){this.currentReadForm=t;t.isReadForm=true}t.setStyle()}.bind(this))}.bind(this))},refresh:function(t,e){if(this.noElementNode)this.noElementNode.destroy();if(!t){this.itemArray.each(function(t){t.node.setStyle("display","none")});this.noElementNode=new Element("div",{styles:this.css.noElementNode,text:"请先新建或选择分类"}).inject(this.elementContentListNode)}else if(t.options.isNew){this.itemArray.each(function(t){t.node.setStyle("display","none")});this.noElementNode=new Element("div",{styles:this.css.noElementNode,text:"请先保存分类"}).inject(this.elementContentListNode)}else{if(this.itemArray&&this.itemArray.length){this.itemArray.each(function(t){t.node.setStyle("display","")});if(e)e()}else{this.loadElementList(e)}}},loadContentNode:function(){this.elementContentNode=new Element("div",{styles:this.css.elementContentNode}).inject(this.node);this.elementContentListNode=new Element("div",{styles:this.css.elementContentListNode}).inject(this.elementContentNode);this.setContentSize();this.app.addEvent("resize",function(){this.setContentSize()}.bind(this))},setContentSize:function(){var t=this.toolbarNode?this.toolbarNode.getSize():{x:0,y:0};var e=this.node.getSize();var i=this.elementContentNode.getStyle("padding-top").toFloat();var s=this.elementContentNode.getStyle("padding-bottom").toFloat();var o=e.y-t.y-i-s;var n=e.x;this.elementContentNode.setStyle("height",""+o+"px");this.elementContentListNode.setStyles({width:""+n+"px"})},loadElementList:function(i){this._loadItemDataList(function(t){if(t.data.length){t.data.each(function(t){var e=this._getItemObject(t,this.itemArray.length+1);e.load();this.itemObject[t.id]=e;this.itemArray.push(e)}.bind(this));if(i)i()}else{var e=this.noElementNode=new Element("div",{styles:this.css.noElementNode,text:this.options.tooltip.noElement}).inject(this.elementContentListNode);e.addEvent("click",function(t){this._createElement(t)}.bind(this))}}.bind(this))},_getItemObject:function(t,e){return new MWF.xApplication.cms.ColumnManager.CategoryExplorer.Form(this,t,{index:e})},_loadItemDataList:function(t){this.app.restActions.listForm(this.app.options.column.id,t,null,false)}});MWF.xApplication.cms.ColumnManager.CategoryExplorer.Form=new Class({Extends:MWF.xApplication.cms.ColumnManager.FormExplorer.Form,options:{where:"bottom",index:1},initialize:function(t,e,i){this.setOptions(i);this.explorer=t;this.app=t.app;this.css=this.explorer.css;this.lp=this.app.lp.form;this.data=e;this.container=this.explorer.elementContentListNode;this.icon=this._getIcon()},load:function(){this.node=new Element("div",{styles:this.css.itemNode,events:{mouseover:function(){if(!this.isEditForm)this.node.setStyle("background-color","#f0f0f0")}.bind(this),mouseout:function(){var t=this.options.index%2==0?"#f7f7f7":"#fff";if(!this.isEditForm)this.node.setStyle("background-color",t)}.bind(this)}}).inject(this.container);this.itemStatusNode=new Element("div",{styles:this.css.itemStatusNode}).inject(this.node);this.itemStatusTopNode=new Element("div",{styles:this.css.itemStatusTopNode}).inject(this.itemStatusNode);this.itemStatusBottomNode=new Element("div",{styles:this.css.itemStatusBottomNode}).inject(this.itemStatusNode);if(this.data.name.icon)this.icon=this.data.name.icon;var t=this.explorer.path+""+this.explorer.options.style+"/processIcon/"+this.icon;var e=new Element("div",{styles:this.css.itemIconNode,title:"可以拖动到桌面"}).inject(this.node);e.setStyle("background","url("+t+") center center no-repeat");e.makeLnk({par:this._getLnkPar()});this.actionsArea=new Element("div.actionsArea",{styles:this.css.actionsArea}).inject(this.node);this.setEditAction=new Element("div.setEditAction",{styles:this.css.setEditAction,title:"设为编辑表单"}).inject(this.actionsArea);this.setEditAction.addEvents({click:function(t){this.setEditForm()}.bind(this),mouseover:function(t){if(!this.isEditForm)this.setEditAction.setStyles(this.css.setEditAction_selected)}.bind(this),mouseout:function(t){if(!this.isEditForm)this.setEditAction.setStyles(this.css.setEditAction)}.bind(this)});this.setReadAction=new Element("div.setReadAction",{styles:this.css.setReadAction,title:"设为阅读表单"}).inject(this.actionsArea);this.setReadAction.addEvents({click:function(t){this.setReadForm()}.bind(this),mouseover:function(t){if(!this.isReadForm)this.setReadAction.setStyles(this.css.setReadAction_selected)}.bind(this),mouseout:function(t){if(!this.isReadForm)this.setReadAction.setStyles(this.css.setReadAction)}.bind(this)});if(!this.explorer.options.noDelete){this.deleteActionNode=new Element("div.deleteAction",{styles:this.css.deleteAction,title:"删除"}).inject(this.actionsArea);this.deleteActionNode.addEvent("click",function(t){this.deleteItem(t)}.bind(this));this.deleteActionNode.addEvents({mouseover:function(t){this.deleteActionNode.setStyles(this.css.deleteAction_over)}.bind(this),mouseout:function(t){this.deleteActionNode.setStyles(this.css.deleteAction)}.bind(this)})}var i=new Element("div.itemInforNode",{styles:this.css.itemInforNode}).inject(this.node);var s=new Element("div.itemInforBaseNode",{styles:this.css.itemInforBaseNode}).inject(i);this.itemTextTitleNode=new Element("div.itemTextTitleNode",{styles:this.css.itemTextTitleNode,text:this.data.name,title:this.data.name,events:{click:function(t){this._open(t);t.stopPropagation()}.bind(this)}}).inject(s);new Element("div.itemTextDateNode",{styles:this.css.itemTextDateNode,text:this.data.updateTime||""}).inject(s)},setEditForm:function(){if(this.explorer.currentEditForm){this.explorer.currentEditForm.isEditForm=false;this.explorer.currentEditForm.setStyle()}this.explorer.currentEditForm=this;this.isEditForm=true;this.setStyle();this.explorer.currentCategory.setEditForm(this.data.id,this.data.name)},setReadForm:function(){if(this.explorer.currentReadForm){this.explorer.currentReadForm.isReadForm=false;this.explorer.currentReadForm.setStyle()}this.isReadForm=true;this.setStyle();this.explorer.currentCategory.setReadForm(this.data.id,this.data.name);this.explorer.currentReadForm=this},setStyle:function(){if(this.isEditForm&&this.isReadForm){this.itemStatusTopNode.setStyles({"background-color":"#3c76b7"});this.itemStatusBottomNode.setStyles({"background-color":"#50e3c2"});this.node.setStyles({"background-color":"#f2f8ff"});this.itemTextTitleNode.setStyles({color:"#447bbb"});this.setEditAction.setStyles(this.css.setEditAction_selected);this.setReadAction.setStyles(this.css.setReadAction_selected)}else if(this.isEditForm){this.itemStatusTopNode.setStyles({"background-color":"#3c76b7"});this.itemStatusBottomNode.setStyles({"background-color":"#3c76b7"});this.node.setStyles({"background-color":"#f2f8ff"});this.itemTextTitleNode.setStyles({color:"#447bbb"});this.setEditAction.setStyles(this.css.setEditAction_selected);this.setReadAction.setStyles(this.css.setReadAction)}else if(this.isReadForm){this.itemStatusTopNode.setStyles({"background-color":"#50e3c2"});this.itemStatusBottomNode.setStyles({"background-color":"#50e3c2"});var t=this.options.index%2==0?"#f7f7f7":"#fff";this.node.setStyles({"background-color":t});this.itemTextTitleNode.setStyles({color:"#888"});this.setEditAction.setStyles(this.css.setEditAction);this.setReadAction.setStyles(this.css.setReadAction_selected)}else{var t=this.options.index%2==0?"#f7f7f7":"#fff";this.itemStatusTopNode.setStyles({"background-color":t});this.itemStatusBottomNode.setStyles({"background-color":t});this.node.setStyles({"background-color":t});this.itemTextTitleNode.setStyles({color:"#888"});this.setEditAction.setStyles(this.css.setEditAction);this.setReadAction.setStyles(this.css.setReadAction)}},_open:function(i){layout.desktop.getFormDesignerStyle(function(){var t=this;var e={style:layout.desktop.formDesignerStyle,onQueryLoad:function(){this.actions=t.explorer.actions;this.category=t;this.options.id=t.data.id;this.column=t.explorer.app.options.column;this.application=t.explorer.app.options.column}};this.explorer.app.desktop.openApplication(i,"cms.FormDesigner",e)}.bind(this))},_deleteItem:function(t){this.explorer.app.restActions.removeForm(this.data.id,function(){this.node.destroy();if(t)t()}.bind(this))}});MWF.xApplication.cms.ColumnManager.CategoryExplorer.ViewExplorer=new Class({Extends:MWF.xApplication.cms.ColumnManager.ViewExplorer,Implements:[Options,Events],initialize:function(t,e,i){this.setOptions(i);this.setTooltip();this.path="/x_component_cms_ColumnManager/$Explorer/";this.cssPath="/x_component_cms_ColumnManager/$Explorer/"+this.options.style+"/css.wcss";this._loadCss();this.actions=e;this.node=$(t);this.initData()},initData:function(){this.revealData=[];this.revealIds=[];this.itemArray=[];this.itemObject={};this.deleteMarkItems=[]},reload:function(){if(!this.node)return;this.initData();this.node.empty();this.load()},load:function(){this.loadContentNode();this.setNodeScroll();this.loadElementList()},refreshByCategory:function(t){this.category=t;this.options.categoryId=t.data.id;this.options.defaultViewId=t.data.defaultViewName||"defaultList";this.options.formId=t.data.formId;this.options.formName=t.data.formName;this.reload()},loadElementList:function(){if(!this.category){this.elementContentListNode.empty();var t=new Element("div",{styles:this.css.noElementNode,text:"请先新建或选择分类"}).inject(this.elementContentListNode)}else if(this.category.options.isNew){this.elementContentListNode.empty();var t=new Element("div",{styles:this.css.noElementNode,text:"请先保存分类"}).inject(this.elementContentListNode)}else{this._loadItemDataList(function(t){if(t&&t.length){t.each(function(t){var e=this._getItemObject(t,this.itemArray.length+1);e.load();this.itemObject[t.id]=e;this.itemArray.push(e);this.setViewsBackground()}.bind(this))}else{this.elementContentListNode.empty();var e=new Element("div",{styles:this.css.noElementNode,text:"未添加列表或者数据视图"}).inject(this.elementContentListNode);if(!this.options.noCreate){e.addEvent("click",function(t){this._createView(t)}.bind(this))}}}.bind(this))}},_loadItemDataList:function(i){var s=this.options.categoryId;var t=this.options.formId;if(s){this.actions.getCategory(s,function(t){var e=t.data.extContent;if(e){this.extContent=JSON.parse(e)}else{this.extContent={reveal:[]};this.actions.listViewByCategory(s,function(t){(t.data||[]).each(function(t){var e={type:"list",name:t.name,showName:t.name,id:t.id,alias:t.alias,appId:t.appId,formId:t.formId,formName:t.formName};this.extContent.reveal.push(e)}.bind(this))}.bind(this),null,false)}if(!this.extContent||!this.extContent.reveal||this.extContent.reveal.length==0){this.extContent={reveal:[{id:"defaultList",showName:"系统列表",name:"系统列表"}]}}this.revealData=this.extContent.reveal;this.revealData.each(function(t){this.revealIds.push(t.id)}.bind(this));if(i)i(this.revealData)}.bind(this),null,false)}else{this.elementContentListNode.empty();var e=new Element("div",{styles:this.css.noElementNode,text:"请先选择分类！"}).inject(this.elementContentListNode)}},_selectList:function(){MWF.xDesktop.requireApp("cms.ColumnManager","widget.CMSListSelector",null,false);var t={count:0,title:"选择列表",values:[],appId:this.app.options.column.id,onComplete:function(t){this.selectedList(t)}.bind(this)};var e=new MWF.xApplication.Selector.ListSelector(this.app.content,t);e.load()},selectedList:function(t){var e=[];var i=[];t.each(function(t){if(this.revealIds.contains(t.data.id)){e.push(t.data.name)}else{i.push(t.data)}}.bind(this));i.each(function(t){this.revealIds.push(t.id);var e={type:"list",name:t.name,showName:t.name,id:t.id,alias:t.alias,appId:t.appId,formId:t.formId,formName:t.formName};this.revealData.push(e);var i=this._getItemObject(e);i.load();this.itemObject[e.id]=i;this.itemArray.push(i);if(t.id!="defaultList"){this.category.setCategoryView(t.id,t.name)}}.bind(this));if(i.length>0){this.setViewsBackground();this.saveExtContent()}if(e.length>0){this.app.notice("列表"+e.join("、")+"已经存在了，不再重复添加！","error")}},_selectView:function(){MWF.xDesktop.requireApp("Selector","package",null,false);var t={type:"QueryView",title:"选择视图",count:0,values:[],onComplete:function(t){this.selectedView(t)}.bind(this)};var e=new MWF.O2Selector(this.app.content,t)},selectedView:function(t){var e=[];var i=[];t.each(function(t){if(this.revealIds.contains(t.data.id)){e.push(t.data.name)}else{i.push(t.data)}}.bind(this));debugger;i.each(function(t){this.revealIds.push(t.id);var e={type:"queryview",name:t.name,showName:t.name,id:t.id,viewType:t.type,alias:t.alias,appName:t.appName||t.applicationName};var i=this._getItemObject(e);i.load();this.itemObject[e.id]=i;this.itemArray.push(i);this.revealData.push(e)}.bind(this));if(i.length>0){this.setViewsBackground();this.saveExtContent()}if(e.length>0){this.app.notice("视图"+e.join("、")+"已经存在了，不再重复添加！","error")}},_getItemObject:function(t,e){var i=this.options.defaultViewId==t.id;var s=new MWF.xApplication.cms.ColumnManager.CategoryExplorer.View(this,t,{isCategoryDefaultView:i,index:e||1});if(i)this.defaultView=s;return s},loadContentNode:function(){if(this.elementContentNode)this.elementContentNode.destroy();this.elementContentNode=new Element("div.elementContentNode",{styles:this.css.elementContentNode}).inject(this.node);this.elementContentListNode=new Element("div.elementContentListNode",{styles:this.css.elementContentListNode}).inject(this.elementContentNode);var t=this.elementTable=new Element("table",{width:"99%",border:"0",cellpadding:"5",cellspacing:"0",styles:this.css.listTable}).inject(this.elementContentListNode);this.setContentSize();this.app.addEvent("resize",function(){this.setContentSize()}.bind(this))},saveExtContent:function(){this.extContent={reveal:this.revealData};var t=JSON.stringify(this.extContent);this.category.data.extContent=t;this.app.restActions.saveCategoryExtContent({id:this.options.categoryId,content:t});if(!this.revealIds.contains(this.options.defaultViewId)){this.category.setDefaultCategoryView("",true)}},saveByDom:function(){var t=this.elementTable.getElements("tr");this.revealData=[];this.revealIds=[];for(var e=0;e<t.length;e++){var i=t[e];var s=i.retrieve("view").data;this.revealData.push(s);this.revealIds.push(s.id);var o=e%2==1?"#f7f7f7":"#fff";i.setStyle("background-color",o)}this.saveExtContent()},setViewsBackground:function(){this.elementTable.getElements("tr").each(function(t,e){t.setStyle("background-color",e%2==1?"#f7f7f7":"#fff")}.bind(this))},setContentSize:function(){var t=this.toolbarNode?this.toolbarNode.getSize():{x:0,y:0};var e=this.node.getSize();var i=this.elementContentNode.getStyle("padding-top").toFloat();var s=this.elementContentNode.getStyle("padding-bottom").toFloat();var o=e.y-t.y-i-s;var n=e.x;this.elementContentNode.setStyle("height",""+o+"px");this.elementContentListNode.setStyles({width:""+n+"px"})}});MWF.xApplication.cms.ColumnManager.CategoryExplorer.View=new Class({Extends:MWF.xApplication.cms.ColumnManager.ViewExplorer.View,Implements:[Options],options:{isCategoryDefaultView:false,index:1},initialize:function(t,e,i){this.setOptions(i);this.explorer=t;this.css=this.explorer.css;this.data=e;if(!this.explorer.elementTable){this.explorer.loadContentNode();this.container=this.explorer.elementTable}else{this.container=this.explorer.elementTable}},load:function(){this.node=new Element("tr",{styles:this.css.listTableTr,events:{mouseover:function(){this.nodeBackgroundColor=this.node.getStyle("background-color");this.node.setStyle("background-color","#f0f0f0")}.bind(this),mouseout:function(){this.node.setStyle("background-color",this.nodeBackgroundColor)}.bind(this)}}).inject(this.container,this.options.isCategoryDefaultView?"top":"bottom");this.node.store("view",this);this.showNameNode=new Element("td",{styles:this.css.listTableContent,text:this.data.showName,events:{click:function(t){this._open(t);t.stopPropagation()}.bind(this)}}).inject(this.node);if(this.options.isCategoryDefaultView){this.showNameNode.setStyles({background:"url(/x_component_cms_Module/$Main/default/icon/category_folder.png) no-repeat 10px 12px","font-size":"15px","padding-left":"35px"})}else{this.showNameNode.setStyle("padding-left","35px")}this.typeNode=new Element("td",{styles:this.css.listTableContent,width:"30",text:this.data.type=="list"?"列表":"视图"}).inject(this.node);this.typeNode.setStyle("font-size","12px");this.actionsArea=new Element("td.actionsArea",{styles:this.css.listTableContent,width:"80"}).inject(this.node);this.createAction_read();this.createAction_edit();this.setStyle();this.loadTooltip()},loadTooltip:function(){var t=new MWF.xApplication.cms.ColumnManager.CategoryExplorer.ViewTooltip(this.explorer.app.content,this.node,this.explorer.app,this.data,{axis:"x",hiddenDelay:100,displayDelay:100,nodeStyles:{"z-index":"101"}});this.node.store("tooltip",t)},createAction_read:function(){this.readActionsArea=new Element("div").inject(this.actionsArea);this.editAction=new Element("div.editViewAction",{styles:this.css.editViewAction,title:"编辑"}).inject(this.readActionsArea);this.editAction.addEvents({click:function(t){this.editView()}.bind(this),mouseover:function(t){this.editAction.setStyles(this.css.editViewAction_over)}.bind(this),mouseout:function(t){this.editAction.setStyles(this.css.editViewAction)}.bind(this)});this.setDefaultCategoryViewAction=new Element("div.setDefaultCategoryViewAction",{styles:this.css.setDefaultCategoryViewAction,title:"设为分类默认列表"}).inject(this.readActionsArea);this.setDefaultCategoryViewAction.addEvents({click:function(t){this.setDefaultCategoryView()}.bind(this),mouseover:function(t){if(!this.options.isCategoryDefaultView)this.setDefaultCategoryViewAction.setStyles(this.css.setDefaultCategoryViewAction_selected)}.bind(this),mouseout:function(t){if(!this.options.isCategoryDefaultView)this.setDefaultCategoryViewAction.setStyles(this.css.setDefaultCategoryViewAction)}.bind(this)});this.cancelViewAction=new Element("div.cancelViewAction",{styles:this.css.cancelViewAction,title:"取消"}).inject(this.readActionsArea);this.cancelViewAction.addEvent("click",function(t){this.cancelView(t)}.bind(this));this.cancelViewAction.addEvents({mouseover:function(t){this.cancelViewAction.setStyles(this.css.cancelViewAction_over)}.bind(this),mouseout:function(t){this.cancelViewAction.setStyles(this.css.cancelViewAction)}.bind(this)});this.trunViewAction=new Element("div.trunViewAction",{styles:this.css.trunViewAction,title:"调整顺序"}).inject(this.readActionsArea);this.trunViewAction.addEvents({click:function(t){this.turnViewOrder(t)}.bind(this),mouseover:function(t){this.trunViewAction.setStyles(this.css.turnViewAction_over)}.bind(this),mouseout:function(t){this.trunViewAction.setStyles(this.css.trunViewAction)}.bind(this)})},createAction_edit:function(){this.editActionsArea=new Element("div").inject(this.actionsArea);this.editActionsArea.setStyle("display","none");this.saveViewAction=new Element("div.saveViewAction",{styles:this.css.saveViewAction,title:"保存"}).inject(this.editActionsArea);this.saveViewAction.addEvents({click:function(t){this.saveView()}.bind(this),mouseover:function(t){this.saveViewAction.setStyles(this.css.saveViewAction_over)}.bind(this),mouseout:function(t){this.saveViewAction.setStyles(this.css.saveViewAction)}.bind(this)});this.cancelEditViewAction=new Element("div.cancelEditViewAction",{styles:this.css.cancelEditViewAction,title:"取消编辑"}).inject(this.editActionsArea);this.cancelEditViewAction.addEvents({click:function(t){this.cancelEditView()}.bind(this),mouseover:function(t){this.cancelEditViewAction.setStyles(this.css.cancelEditViewAction_over)}.bind(this),mouseout:function(t){this.cancelEditViewAction.setStyles(this.css.cancelEditViewAction)}.bind(this)})},_open:function(i){var s=this;if(this.explorer.isOnDragging)return;if(this.editMode)return;if(this.data.id=="defaultList"){}else if(this.data.type=="list"){var t={onQueryLoad:function(){this.actions=s.explorer.actions;this.category=s;this.options.id=s.data.id;this.column=s.explorer.app.options.column;this.application=s.explorer.app.options.column;this.options.noModifyName=s.explorer.options.noModifyName;this.options.readMode=s.explorer.options.readMode;this.options.formId=s.data.formId}};this.explorer.app.desktop.openApplication(i,"cms.ViewDesigner",t)}else if(this.data.viewType){MWF.Actions.get("x_query_assemble_designer").getApplication(this.data.appName,function(t){var e={onQueryLoad:function(){this.options.id=s.data.id;this.options.application=t.data;this.application=t.data}};this.explorer.app.desktop.openApplication(i,"query.ViewDesigner",e)}.bind(this))}else{var t={onQueryLoad:function(){this.actions=s.explorer.actions;this.category=s;this.options.id=s.data.id;this.application=s.explorer.app.options.column;this.explorer=s.explorer}};this.explorer.app.desktop.openApplication(i,"cms.QueryViewDesigner",t)}},cancelView:function(){var t=this.node.retrieve("tooltip");if(t)t.destroy();this.node.destroy();this.explorer.category.cancelCategoryView(this.data.id,this.data.name);this.explorer.saveByDom();delete this},deleteView:function(t){this.explorer.app.restActions.deleteView(this.data.id,function(){this.node.destroy();if(t)t()}.bind(this))},setDefaultCategoryView:function(){if(this.explorer.defaultView){this.explorer.defaultView.cancelDefaultView()}this.options.isCategoryDefaultView=true;this.explorer.defaultView=this;this.explorer.options.defaultViewId=this.data.id;this.node.inject(this.container,"top");this.showNameNode.setStyles({background:"url(/x_component_cms_Module/$Main/default/icon/category_folder.png) no-repeat 10px 12px","font-size":"15px","padding-left":"35px"});this.setStyle();this.explorer.saveByDom();this.explorer.category.setDefaultCategoryView(this.data.id)},cancelDefaultView:function(){this.options.isCategoryDefaultView=false;this.showNameNode.setStyles({background:"","font-size":"14px","padding-left":"35px"});this.setStyle()},saveView:function(){this.data.showName=this.input.get("value");this.explorer.saveByDom();this.showNameNode.empty();this.editMode=false;this.explorer.editMode=false;this.editActionsArea.setStyle("display","none");this.readActionsArea.setStyle("display","");this.showNameNode.set("text",this.data.showName)},editView:function(){this.showNameNode.empty();this.editMode=true;this.explorer.editMode=true;this.editActionsArea.setStyle("display","");this.readActionsArea.setStyle("display","none");this.input=new Element("input",{type:"text",value:this.data.showName,styles:this.css.viewInput}).inject(this.showNameNode)},cancelEditView:function(){this.showNameNode.empty();this.editMode=false;this.explorer.editMode=false;this.editActionsArea.setStyle("display","none");this.readActionsArea.setStyle("display","");this.showNameNode.set("text",this.data.showName)},turnViewOrder:function(t){this._createMoveNode();this._setNodeMove(t)},_createMoveNode:function(){this.moveNode=new Element("div",{styles:this.css.moduleNodeMove,text:this.data.showName,events:{selectstart:function(){return false}}}).inject(this.container)},_setNodeMove:function(t){this._setMoveNodePosition(t);var e=new Drag.Move(this.moveNode,{droppables:this.container.getElements("tr"),onEnter:function(t,e){e.setStyle("border-bottom","1px solid #ffa200")}.bind(this),onLeave:function(t,e){e.setStyle("border-bottom","0px")}.bind(this),onDrag:function(t){this.explorer.isOnDragging=true}.bind(this),onDrop:function(t,e,i){if(e){var s=e.retrieve("view");if(s){this._dragComplete(s);e.setStyle("border-bottom","0px")}else{this._dragCancel(t)}}else{this._dragCancel(t)}setTimeout(function(){this.explorer.isOnDragging=false}.bind(this),100);i.stopPropagation()}.bind(this),onCancel:function(t){setTimeout(function(){this.explorer.isOnDragging=false}.bind(this),100)}.bind(this)});e.start(t)},_dragComplete:function(t){this.node.inject(t.node,"after");if(this.moveNode)this.moveNode.destroy();this.moveNode=null;this.explorer.saveByDom()},_dragCancel:function(){if(this.moveNode)this.moveNode.destroy();this.moveNode=null},_setMoveNodePosition:function(t){var e=t.page.x+2;var i=t.page.y+2;this.moveNode.positionTo(e,i)},setStyle:function(){if(this.options.isCategoryDefaultView&&this.options.isCategoryView){this.setDefaultCategoryViewAction.setStyles(this.css.setDefaultCategoryViewAction_selected)}else if(this.options.isCategoryView){this.setDefaultCategoryViewAction.setStyles(this.css.setDefaultCategoryViewAction);this.setCategoryViewAction.setStyles(this.css.setCategoryViewAction_selected)}else if(this.options.isCategoryDefaultView){this.setDefaultCategoryViewAction.setStyles(this.css.setDefaultCategoryViewAction_selected)}else{this.setDefaultCategoryViewAction.setStyles(this.css.setDefaultCategoryViewAction)}}});MWF.xApplication.cms.ColumnManager.CategoryExplorer.CategoryProperty=new Class({initialize:function(t,e,i){this.app=t;this.node=$(e);this.category=i;this.lp=this.app.lp.category},load:function(){this.propertyTitleBar=new Element("div",{styles:this.app.css.propertyTitleBar,text:this.lp.categoryProperty}).inject(this.node);this.contentNode=new Element("div",{styles:this.app.css.propertyContentNode}).inject(this.node);this.contentAreaNode=new Element("div",{styles:this.app.css.propertyContentAreaNode}).inject(this.contentNode);this.setContentHeight();this.setContentHeightFun=this.setContentHeight.bind(this);this.app.addEvent("resize",this.setContentHeightFun);MWF.require("MWF.widget.ScrollBar",function(){new MWF.widget.ScrollBar(this.contentNode,{indent:false})}.bind(this))},reload:function(t){if(t)this.category=t;this.contentAreaNode.empty();if(this.category&&!this.category.options.isNew)this.loadContent()},loadContent:function(){this.baseActionAreaNode=new Element("div.baseActionAreaNode",{styles:this.app.css.availableTitleNode}).inject(this.contentAreaNode);this.baseActionNode=new Element("div.propertyInforActionNode",{styles:this.app.css.propertyInforActionNode}).inject(this.baseActionAreaNode);this.baseTextNode=new Element("div.baseTextNode",{styles:this.app.css.baseTextNode,text:this.app.lp.category.baseProperty}).inject(this.baseActionAreaNode);this.createPropertyContentNode();this.processContainer=new Element("div").inject(this.contentAreaNode);this.createProcessNode();this.viewerContainer=new Element("div").inject(this.contentAreaNode);MWF.xDesktop.requireApp("cms.ColumnManager","widget.CategoryViewerSetting",null,false);this.viewerSetting=new MWF.xApplication.cms.ColumnManager.CategoryViewerSetting(this.app,this.app.lp.application.viewerSetting,this.viewerContainer,{objectId:this.category.data.id});this.viewerSetting.category=this.category;this.viewerSetting.load();this.publisherContainer=new Element("div").inject(this.contentAreaNode);MWF.xDesktop.requireApp("cms.ColumnManager","widget.CategoryPublisherSetting",null,false);this.publisherSetting=new MWF.xApplication.cms.ColumnManager.CategoryPublisherSetting(this.app,this.app.lp.application.publisherSetting,this.publisherContainer,{objectId:this.category.data.id});this.publisherSetting.category=this.category;this.publisherSetting.load();this.managerContainer=new Element("div").inject(this.contentAreaNode);MWF.xDesktop.requireApp("cms.ColumnManager","widget.CategoryManagerSetting",null,false);this.viewerSetting=new MWF.xApplication.cms.ColumnManager.CategoryManagerSetting(this.app,this.app.lp.application.managerSetting,this.managerContainer,{objectId:this.category.data.id});this.viewerSetting.category=this.category;this.viewerSetting.load()},saveProcessApp:function(t,e){var i=this.category.data;i.workflowAppId=t;i.workflowAppName=e;this.app.restActions.saveCategory(i,function(t){this.app.notice(this.lp.setProcessAppSucess)}.bind(this))},saveProcess:function(t,e){var i=this.category.data;i.workflowFlag=t;i.workflowName=e;i.workflowType=t?"固定审批流":"禁用审批流";this.app.restActions.saveCategory(i,function(t){this.app.notice(this.lp.setProcessSucess)}.bind(this))},createProcessNode:function(){this.processTitleNode=new Element("div.availableTitleNode",{styles:this.app.css.availableTitleNode,text:this.lp.useProcess}).inject(this.processContainer);this.processContentNode=new Element("div",{styles:{overflow:"hidden"}}).inject(this.processContainer);this.processAreaNode=new Element("div.processAreaNode",{styles:this.app.css.processAreaNode}).inject(this.processContentNode);this.createProcessAppSelect(this.category.data.workflowAppId||"");this.createProcessSelect(this.category.data.workflowAppId||"",this.category.data.workflowFlag||"")},createProcessAppSelect:function(i){this.processAppSelect=new Element("select",{styles:this.app.css.processSelect}).inject(this.processAreaNode);new Element("option",{value:"",text:this.lp.selectProcessApp}).inject(this.processAppSelect);new Element("option",{value:"",text:this.lp.none}).inject(this.processAppSelect);MWF.Actions.get("x_processplatform_assemble_designer").listApplication(null,function(t){t.data.each(function(t){var e=new Element("option",{value:t.id,text:t.name}).inject(this.processAppSelect);if(t.id==i)e.selected=true}.bind(this))}.bind(this));this.processAppSelect.addEvent("change",function(t){var e=this.getSelectProcessApp();this.createProcessSelect(e.id);this.saveProcessApp(e.id,e.name)}.bind(this))},getSelectProcessApp:function(){var e;this.processAppSelect.getElements("option").each(function(t){if(t.selected){e={id:t.value,name:t.text}}}.bind(this));return e},setProcessApp:function(e){var i=true;this.processAppSelect.getElements("option").each(function(t){if(i){if(t.value==e){t.selected=true;i=false}}}.bind(this))},createProcessSelect:function(t,i){if(this.processSelect)this.processSelect.destroy();if(!t)return;this.processSelect=new Element("select",{styles:this.app.css.processSelect}).inject(this.processAreaNode);new Element("option",{value:"",text:this.lp.selectProcess}).inject(this.processSelect);new Element("option",{value:"",text:this.lp.none}).inject(this.processSelect);MWF.Actions.get("x_processplatform_assemble_designer").listProcess(t,function(t){t.data.each(function(t){var e=new Element("option",{value:t.id,text:t.name}).inject(this.processSelect);if(t.id==i)e.selected=true}.bind(this))}.bind(this));this.processSelect.addEvent("change",function(t){var e=this.getSelectProcess();this.saveProcess(e.id,e.name)}.bind(this))},getSelectProcess:function(){var e;if(this.processSelect){this.processSelect.getElements("option").each(function(t){if(t.selected){e={id:t.value,name:t.text}}}.bind(this))}return e},setProcess:function(e){var i=true;if(this.processSelect){this.processSelect.getElements("option").each(function(t){if(i){if(t.value==e){t.selected=true;i=false}}}.bind(this))}},setContentHeight:function(){var t=this.node.getSize();var e=this.propertyTitleBar.getSize();var i=t.y-e.y;this.contentNode.setStyle("height",""+i+"px")},createPropertyContentNode:function(){this.propertyContentNode=new Element("div",{styles:{overflow:"hidden"}}).inject(this.contentAreaNode);var t="<table cellspacing='0' cellpadding='0' border='0' width='95%' align='center'>";t+="<tr><td class='formTitle'>"+this.app.lp.category.idLabel+"</td><td id='formCategoryId' class='formValue'>"+this.category.data.id+"</td></tr>";t+="<tr><td class='formTitle'>"+this.app.lp.category.aliasLabel+"</td><td id='formCategoryId' class='formValue'>"+this.category.data.categoryAlias+"</td></tr>";t+="<tr><td class='formTitle'>"+this.app.lp.category.documentType+"</td><td id='formCategoryType' class='formValue'>"+"</td></tr>";t+="<tr><td class='formTitle'>"+this.app.lp.category.excelImportView+"</td><td class='formValue'><div id='formImportViewId' style='float:left;overflow:hidden;border:1px solid #ccc;border-radius: 3px;'></div></td></td></tr>";t+="</table>";this.propertyContentNode.set("html",t);this.propertyContentNode.getElements("td.formTitle").setStyles(this.app.css.propertyBaseContentTdTitle);this.propertyContentNode.getElements("td.formValue").setStyles(this.app.css.propertyBaseContentTdValue);this.typeSelect=new MDomItem(this.propertyContentNode.getElement("#formCategoryType"),{type:"select",value:this.category.data.documentType||"信息",selectValue:["信息","数据"],event:{change:function(t){this.category.setDocumentType(t.getValue())}.bind(this)}});this.typeSelect.load();this.importViewIdSelect=new MDomItem(this.propertyContentNode.getElement("#formImportViewId"),{type:"org",orgType:"QueryView",orgWidgetOptions:{canRemove:false},value:this.category.data.importViewName||this.category.data.importViewId||"不使用",event:{change:function(t){if(t.orgObject&&t.orgObject.length>0){this.category.setImportView(t.orgObject[0].data.id,t.orgObject[0].data.applicationName)}else{this.category.setImportView("","")}}.bind(this)}},null,this.app);this.importViewIdSelect.load()}});MWF.xDesktop.requireApp("Template","MTooltips",null,false);MWF.xApplication.cms.ColumnManager.CategoryExplorer.ViewTooltip=new Class({Extends:MTooltips,_loadCustom:function(t){if(t)t()},_getHtml:function(){var t=this.data;var e="font-size:12px;color:#333";var i="font-size:12px;color:#666;padding-right:20px";if(t.type=="list"){var s="<table width='100%' bordr='0' cellpadding='7' cellspacing='0' style='margin:13px 13px 13px 13px;'>"+"<tr><td style='"+e+";' width='70'>"+"类型"+":</td>"+"    <td style='"+i+";'>"+"列表"+"</td></tr>"+"<tr><td style='"+e+";' width='70'>"+"列表名称"+":</td>"+"    <td style='"+i+";'>"+t.name+"</td></tr>"+"<tr><td style='"+e+"'>"+"关联表单"+":</td>"+"    <td style='"+i+"'>"+(t.formName||"")+"</td></tr>"+"<tr><td style='"+e+"'>"+"别名"+":</td>"+"    <td style='"+i+"'>"+(t.alias||"")+"</td></tr>"+"</table>"}else{var s="<table width='100%' bordr='0' cellpadding='7' cellspacing='0' style='margin:13px 13px 13px 13px;'>"+"<tr><td style='"+e+";' width='70'>"+"类型"+":</td>"+"    <td style='"+i+";'>"+"数据视图"+"</td></tr>"+"<tr><td style='"+e+";' width='70'>"+"视图名称"+":</td>"+"    <td style='"+i+";'>"+t.name+"</td></tr>"+"<tr><td style='"+e+"'>"+"栏目"+":</td>"+"    <td style='"+i+"'>"+(t.appName||"")+"</td></tr>"+"<tr><td style='"+e+"'>"+"别名"+":</td>"+"    <td style='"+i+"'>"+(t.alias||"")+"</td></tr>"+"</table>"}return s}});