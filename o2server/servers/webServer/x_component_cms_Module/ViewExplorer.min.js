MWF.xApplication.cms=MWF.xApplication.cms||{};MWF.xApplication.cms.Module=MWF.xApplication.cms.Module||{};MWF.require("MWF.xAction.org.express.RestActions",null,false);MWF.xDesktop.requireApp("cms.Module","lp."+MWF.language,null,false);MWF.xDesktop.requireApp("cms.Module","package",null,false);MWF.xDesktop.requireApp("process.Application","Viewer",null,false);MWF.xDesktop.requireApp("query.Query","Viewer",null,false);MWF.xApplication.cms.Module.ViewExplorer=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default",isAdmin:false,searchKey:""},initialize:function(e,t,i,s,n,o,l){this.setOptions(o);this.node=e;this.app=t;this.columnData=i;this.categoryData=s;this.revealData=n;this.searchNode=l;this.path="/x_component_cms_Module/$ViewExplorer/";this.cssPath="/x_component_cms_Module/$ViewExplorer/"+this.options.style+"/css.wcss";this._loadCss()},load:function(){this.loadContentNode();if(this.revealData.viewType){this.loadQuryView()}else{this.loadView()}},loadContentNode:function(){this.elementContentNode=new Element("div",{styles:this.css.elementContentNode}).inject(this.node);this.searchContainer=new Element("div",{styles:this.css.searchContainer}).inject(this.searchNode);this.app.addEvent("resize",function(){this.setContentSize()}.bind(this))},loadQuryView:function(){var e={application:this.revealData.appName,viewName:this.revealData.name,isTitle:"yes",select:"none",titleStyles:this.css.normalThNode,itemStyles:{},isExpand:"no",filter:[]};this.view=new MWF.xApplication.cms.Module.QueryViewer(this.elementContentNode,e,{hasAction:this.options.isAdmin,resizeNode:true,onSelect:function(){this.fireEvent("select")}.bind(this)},this.app,this.searchContainer);this.setContentSize()},loadView:function(){var e={application:this.columnData.id,viewName:this.revealData.name,isTitle:"yes",select:"none",titleStyles:this.css.normalThNode,isExpand:"no",itemStyles:{}};this.view=new MWF.xApplication.cms.Module.Viewer(this.elementContentNode,e,{type:"cms",hasAction:this.options.isAdmin,actions:{lookup:{uri:"/jaxrs/queryview/flag/{view}/application/flag/{application}/execute",method:"PUT"},getView:{uri:"/jaxrs/queryview/flag/{view}/application/flag/{application}"},deleteDocument:{uri:"/jaxrs/document/{id}",method:"DELETE"}},actionRoot:"x_cms_assemble_control",resizeNode:true,onSelect:function(){this.fireEvent("select")}.bind(this)},this.app,this.searchContainer);this.setContentSize()},setContentSize:function(){var e=this.toolbarNode?this.toolbarNode.getSize():{x:0,y:0};var t={x:0,y:0};var i=this.app.node.getSize();var s=0;var n=0;var o=this.filterConditionNode?this.filterConditionNode.getSize():{x:0,y:0};var l=i.y-e.y-s-n-o.y-t.y;this.elementContentNode.setStyle("height",""+l+"px");if(this.view)this.view.setContentHeight()}});MWF.xApplication.cms.Module.Viewer=new Class({Implements:[Options,Events],Extends:MWF.xApplication.process.Application.Viewer,options:{style:"default",hasAction:false,resizeNode:true,actions:{lookup:{uri:"/jaxrs/queryview/flag/{view}/application/flag/{application}/execute",method:"PUT"},getView:{uri:"/jaxrs/queryview/flag/{view}/application/flag/{application}"},listWorkByJob:{uri:"/jaxrs/job/{job}/find/work/workcompleted"},listTaskByWork:{uri:"/jaxrs/work/{id}/assignment/manage"}},actionRoot:"x_processplatform_assemble_surface"},initialize:function(e,t,i,s,n){this.setOptions(i);this.app=s;this.searchContainer=n;this.path="/x_component_cms_Module/$ViewExplorer/";this.cssPath="/x_component_cms_Module/$ViewExplorer/"+this.options.style+"/viewer.wcss";this._loadCss();this.lp=MWF.xApplication.process.Application.LP;this.container=$(e);this.json=t;this.viewJson=null;this.filterItems=[];this.searchStatus="none";this.items=[];this.selectedItems=[];this.hideColumns=[];this.openColumns=[];this.gridJson=null;this.init(function(){this.load()}.bind(this))},createViewNode:function(e){this.viewAreaNode.empty();this.contentAreaNode=new Element("div",{styles:this.css.contentAreaNode}).inject(this.viewAreaNode);this.viewTable=new Element("table",{styles:this.css.viewTitleTableNode,border:"0px",cellPadding:"0",cellSpacing:"0"}).inject(this.contentAreaNode);this.createLoadding();if(this.json.isTitle!=="no"){this.viewTitleLine=new Element("tr",{styles:this.css.viewTitleLineNode}).inject(this.viewTable);this.selectTitleCell=new Element("td",{styles:this.css.viewTitleCellNode}).inject(this.viewTitleLine);this.selectTitleCell.setStyle("width","10px");if(this.json.titleStyles)this.selectTitleCell.setStyles(this.json.titleStyles);this.entries={};this.viewJson.selectEntryList.each(function(e){this.entries[e.column]=e;if(!e.hideColumn){var t=new Element("td",{styles:this.css.viewTitleCellNode,text:e.displayName}).inject(this.viewTitleLine);if(this.json.titleStyles)t.setStyles(this.json.titleStyles)}else{this.hideColumns.push(e.column)}if(e.allowOpen)this.openColumns.push(e.column)}.bind(this));if(this.options.hasAction){var t=new Element("td",{styles:this.css.viewTitleCellNode,text:"操作"}).inject(this.viewTitleLine);t.setStyle("width","40px");if(this.json.titleStyles)t.setStyles(this.json.titleStyles)}this.lookup(e)}else{this.viewJson.selectEntryList.each(function(e){if(e.hideColumn)this.hideColumns.push(e.column);if(!e.allowOpen)this.openColumns.push(e.column)}.bind(this));this.lookup(e)}},loadLayout:function(){this.node=new Element("div",{styles:this.css.node}).inject(this.container);this.searchAreaNode=new Element("div",{styles:this.css.searchAreaNode}).inject(this.searchContainer||this.node);this.viewAreaNode=new Element("div",{styles:this.css.viewAreaNode}).inject(this.node)},loadData:function(){if(this.gridJson.length){this.gridJson.each(function(e,t){this.items.push(new MWF.xApplication.cms.Module.Viewer.Item(this,e,null,t))}.bind(this))}},loadGroupData:function(){if(this.selectTitleCell){this.selectTitleCell.set("html","<span style='font-family: Webdings'>"+"<img src='/x_component_process_Application/$Viewer/"+this.options.style+"/icon/expand.png'/>"+"</span>");this.selectTitleCell.setStyle("cursor","pointer");this.selectTitleCell.addEvent("click",this.expandOrCollapseAll.bind(this))}if(this.gridJson.length){this.gridJson.each(function(e){this.items.push(new MWF.xApplication.cms.Module.Viewer.ItemCategory(this,e))}.bind(this));if(this.json.isExpand=="yes")this.expandOrCollapseAll()}},setContentHeight:function(){if(this.node&&this.searchAreaNode&&this.viewAreaNode){var e=this.node.getSize();var t=this.searchAreaNode.getSize();var i=e.y-t.y;this.viewAreaNode.setStyle("height",""+i+"px")}}});MWF.xApplication.cms.Module.Viewer.Item=new Class({Extends:MWF.xApplication.process.Application.Viewer.Item,load:function(){var e=this;this.node=new Element("tr",{styles:this.css.viewContentTrNode});if(this.prev){this.node.inject(this.prev.node,"after")}else{this.node.inject(this.view.viewTable)}this.node.addEvents({mouseover:function(){this.setStyles(e.css.viewContentTrNode_over)},mouseout:function(){this.setStyles(e.css.viewContentTrNode)}});this.selectTd=new Element("td",{styles:this.css.viewContentTdNode}).inject(this.node);this.selectTd.setStyles({cursor:"pointer"});if(this.view.json.itemStyles)this.selectTd.setStyles(this.view.json.itemStyles);Object.each(this.data.data,function(e,t){if(this.view.hideColumns.indexOf(t)===-1){var i=new Element("td",{styles:this.css.viewContentTdNode}).inject(this.node);if(t!==this.view.viewJson.groupEntry.column){var s=this.view.entries[t].code?MWF.Macro.exec(this.view.entries[t].code,{value:e,gridData:this.view.gridJson,data:this.view.viewData,entry:this.data}):e;i.set("text",s)}if(this.view.openColumns.indexOf(t)!==-1){this.setOpenWork(i)}if(this.view.json.itemStyles)i.setStyles(this.view.json.itemStyles)}}.bind(this));if(this.view.options.hasAction){var t=new Element("td",{styles:this.css.viewContentTdNode}).inject(this.node);this.loadActions(t);if(this.view.json.itemStyles)t.setStyles(this.view.json.itemStyles)}this.setEvent()},loadActions:function(e){this.deleteNode=new Element("div",{styles:this.css.actionDeleteNode,title:"删除"}).inject(e);this.deleteNode.addEvents({mouseover:function(){this.deleteNode.setStyles(this.css.actionDeleteNode_over)}.bind(this),mouseout:function(){this.deleteNode.setStyles(this.css.actionDeleteNode)}.bind(this),mousedown:function(){this.deleteNode.setStyles(this.css.actionDeleteNode_down)}.bind(this),mouseup:function(){this.deleteNode.setStyles(this.css.actionDeleteNode_over)}.bind(this),click:function(e){this.remove(e);e.stopPropagation()}.bind(this)});this.editNode=new Element("div",{styles:this.css.actionEditNode,title:"编辑"}).inject(e);this.editNode.addEvents({mouseover:function(){this.editNode.setStyles(this.css.actionEditNode_over)}.bind(this),mouseout:function(){this.editNode.setStyles(this.css.actionEditNode)}.bind(this),mousedown:function(){this.editNode.setStyles(this.css.actionEditNode_down)}.bind(this),mouseup:function(){this.editNode.setStyles(this.css.actionEditNode_over)}.bind(this),click:function(e){this.editCMSDocument();e.stopPropagation()}.bind(this)})},setOpenWork:function(e){e.setStyle("cursor","pointer");e.addEvent("click",function(){this.openCMSDocument()}.bind(this))},openCMSDocument:function(e){var t="cms.Document"+this.data.job;if(layout.desktop.apps[t]){layout.desktop.apps[t].setCurrent()}else{var i={documentId:this.data.job,readonly:!e};layout.desktop.openApplication(null,"cms.Document",i)}},editCMSDocument:function(){this.openCMSDocument(true)},remove:function(e){var t="删除后不能恢复，你确定要删除该文档？";var i=this;this.node.setStyles(this.css.viewContentTrNode_delete);this.readyRemove=true;this.view.app.confirm("warn",e,"删除确认",t,350,120,function(){i.removeCMSDocument(i,false);this.close()},function(){i.node.setStyles(i.css.viewContentTrNode);i.readyRemove=false;this.close()})},removeCMSDocument:function(){var e=this.data.job;MWF.Actions.get("x_cms_assemble_control").removeDocument(e,function(e){this.readyRemove=false;this.node.destroy();this.view.app.notice("删除成功","success");MWF.release(this)}.bind(this))}});MWF.xApplication.cms.Module.Viewer.ItemCategory=new Class({Extends:MWF.xApplication.process.Application.Viewer.ItemCategory,load:function(){this.node=new Element("tr",{styles:this.css.viewContentTrNode}).inject(this.view.viewTable);this.selectTd=new Element("td",{styles:this.css.viewContentCategoryTdNode}).inject(this.node);if(this.view.json.itemStyles)this.selectTd.setStyles(this.view.json.itemStyles);var e=this.view.viewJson.selectEntryList.length;if(this.view.options.hasAction){e++}this.categoryTd=new Element("td",{styles:this.css.viewContentCategoryTdNode,colspan:e}).inject(this.node);this.groupColumn=null;for(var t=0;t<this.view.viewJson.selectEntryList.length;t++){if(this.view.viewJson.selectEntryList[t].column===this.view.viewJson.groupEntry.column){this.groupColumn=this.view.viewJson.selectEntryList[t];break}}if(this.groupColumn){var i=this.groupColumn.code?MWF.Macro.exec(this.groupColumn.code,{value:this.data.group,gridData:this.view.gridJson,data:this.view.viewData,entry:this.data}):this.data.group}else{var i=this.data.group}this.categoryTd.set("html","<span style='font-family: Webdings'><img src='/x_component_process_Application/$Viewer/"+this.view.options.style+"/icon/expand.png'/></span> "+i);if(this.view.json.itemStyles)this.categoryTd.setStyles(this.view.json.itemStyles);this.setEvent()},expand:function(){this.items.each(function(e){e.node.setStyle("display","table-row")}.bind(this));this.node.getElement("span").set("html","<img src='/x_component_process_Application/$Viewer/"+this.view.options.style+"/icon/down.png'/>");if(!this.loadChild){this.data.list.each(function(e){this.items.push(new MWF.xApplication.cms.Module.Viewer.Item(this.view,e,this))}.bind(this));this.loadChild=true}}});MWF.xApplication.cms.Module.QueryViewer=new Class({Implements:[Options,Events],Extends:MWF.QViewer,options:{style:"default",hasAction:false,resizeNode:true,paging:"scroll",perPageCount:50},initialize:function(e,t,i,s,n){this.setOptions(i);this.app=s;this.searchContainer=n;this.path="/x_component_cms_Module/$ViewExplorer/";this.cssPath="/x_component_cms_Module/$ViewExplorer/"+this.options.style+"/viewer.wcss";this._loadCss();this.lp=MWF.xApplication.query.Query.LP;this.container=$(e);this.json=t;this.viewJson=null;this.filterItems=[];this.searchStatus="none";this.items=[];this.selectedItems=[];this.hideColumns=[];this.openColumns=[];this.gridJson=null;this.init(function(){this.load()}.bind(this))},createViewNode:function(e){this.viewAreaNode.empty();this.contentAreaNode=new Element("div.contentAreaNode",{styles:this.css.contentAreaNode}).inject(this.viewAreaNode);this.viewTable=new Element("table.viewTable",{styles:this.css.viewTitleTableNode,border:"0px",cellPadding:"0",cellSpacing:"0"}).inject(this.contentAreaNode);this.createLoadding();if(this.json.isTitle!=="no"){this.viewTitleLine=new Element("tr",{styles:this.css.viewTitleLineNode}).inject(this.viewTable);this.selectTitleCell=new Element("td",{styles:this.css.viewTitleCellNode}).inject(this.viewTitleLine);this.selectTitleCell.setStyle("width","10px");if(this.json.titleStyles)this.selectTitleCell.setStyles(this.json.titleStyles);this.entries={};this.viewJson.selectList.each(function(e){this.entries[e.column]=e;if(!e.hideColumn){var t=new Element("td",{styles:this.css.viewTitleCellNode,text:e.displayName}).inject(this.viewTitleLine);var i=MWF.getTextSize(e.displayName,this.css.viewTitleCellNode);t.setStyle("min-width",""+i.x+"px");if(this.json.titleStyles)t.setStyles(this.json.titleStyles)}else{this.hideColumns.push(e.column)}if(e.allowOpen)this.openColumns.push(e.column)}.bind(this));if(this.options.hasAction){var t=new Element("td",{styles:this.css.viewTitleCellNode,text:"操作"}).inject(this.viewTitleLine);t.setStyle("width","40px");if(this.json.titleStyles)t.setStyles(this.json.titleStyles)}this.lookup(e)}else{this.viewJson.selectList.each(function(e){if(e.hideColumn)this.hideColumns.push(e.column);if(!e.allowOpen)this.openColumns.push(e.column)}.bind(this));this.lookup(e)}},loadLayout:function(){this.node=new Element("div",{styles:this.css.node}).inject(this.container);this.searchAreaNode=new Element("div",{styles:this.css.searchAreaNode}).inject(this.searchContainer||this.node);this.viewAreaNode=new Element("div.viewAreaNode",{styles:this.css.viewAreaNode}).inject(this.node)},loadData:function(){if(this.gridJson.length){if(!this.options.paging){this.gridJson.each(function(e,t){this.items.push(new MWF.xApplication.cms.Module.QueryViewer.Item(this,e,null,t))}.bind(this))}else{this.loadPaging()}}},loadPaging:function(){this.isItemsLoading=false;this.pageNumber=0;this.isItemsLoaded=false;this.isSetedScroll=false;this.setScroll();this.loadDataByPaging()},setScroll:function(){if(this.options.paging&&!this.isSetedScroll){this.contentAreaNode.setStyle("overflow","auto");this.scrollContainerFun=function(){var e=this.contentAreaNode.getScrollSize();var t=this.contentAreaNode.getSize();var i=e.y-t.y;if(this.contentAreaNode.scrollTop+150>i){if(!this.isItemsLoaded)this.loadDataByPaging()}}.bind(this);this.isSetedScroll=true;this.contentAreaNode.addEvent("scroll",this.scrollContainerFun)}},loadDataByPaging:function(){if(this.isItemsLoading)return;if(!this.isItemsLoaded){var e=Math.min(this.pageNumber*this.options.perPageCount,this.gridJson.length);var t=Math.min((this.pageNumber+1)*this.options.perPageCount+1,this.gridJson.length);this.isItemsLoading=true;for(var i=e;i<t;i++){this.items.push(new MWF.xApplication.cms.Module.QueryViewer.Item(this,this.gridJson[i],null,i))}this.isItemsLoading=false;this.pageNumber++;if(t==this.gridJson.length)this.isItemsLoaded=true}},loadGroupData:function(){if(this.selectTitleCell){this.selectTitleCell.set("html","<span style='font-family: Webdings'>"+"<img src='/x_component_process_Application/$Viewer/"+this.options.style+"/icon/expand.png'/>"+"</span>");this.selectTitleCell.setStyle("cursor","pointer");this.selectTitleCell.addEvent("click",this.expandOrCollapseAll.bind(this))}if(this.gridJson.length){this.gridJson.each(function(e){this.items.push(new MWF.xApplication.cms.Module.QueryViewer.ItemCategory(this,e))}.bind(this));if(this.json.isExpand=="yes")this.expandOrCollapseAll()}},setContentHeight:function(){if(this.node&&this.searchAreaNode&&this.viewAreaNode){var e=this.node.getSize();var t=this.searchAreaNode.getSize();var i=e.y-t.y;this.viewAreaNode.setStyle("height",""+i+"px")}}});MWF.xApplication.cms.Module.QueryViewer.Item=new Class({Extends:MWF.xApplication.query.Query.Viewer.Item,load:function(){var e=this;this.node=new Element("tr",{styles:this.css.viewContentTrNode});if(this.prev){this.node.inject(this.prev.node,"after")}else{this.node.inject(this.view.viewTable)}this.node.addEvents({mouseover:function(){this.setStyles(e.css.viewContentTrNode_over)},mouseout:function(){this.setStyles(e.css.viewContentTrNode)}});this.selectTd=new Element("td",{styles:this.css.viewContentTdNode}).inject(this.node);this.selectTd.setStyles({cursor:"pointer"});if(this.view.json.itemStyles)this.selectTd.setStyles(this.view.json.itemStyles);Object.each(this.data.data,function(e,t){if(this.view.hideColumns.indexOf(t)===-1){var i=new Element("td",{styles:this.css.viewContentTdNode}).inject(this.node);if(t!==this.view.viewJson.group.column){var s=this.view.entries[t].code?MWF.Macro.exec(this.view.entries[t].code,{value:e,gridData:this.view.gridJson,data:this.view.viewData,entry:this.data}):e;i.set("text",s)}if(this.view.openColumns.indexOf(t)!==-1){this.setOpenWork(i)}if(this.view.json.itemStyles)i.setStyles(this.view.json.itemStyles)}}.bind(this));if(this.view.options.hasAction){var t=new Element("td",{styles:this.css.viewContentTdNode}).inject(this.node);this.loadActions(t);if(this.view.json.itemStyles)t.setStyles(this.view.json.itemStyles)}this.setEvent()},loadActions:function(e){this.deleteNode=new Element("div",{styles:this.css.actionDeleteNode,title:"删除"}).inject(e);this.deleteNode.addEvents({mouseover:function(){this.deleteNode.setStyles(this.css.actionDeleteNode_over)}.bind(this),mouseout:function(){this.deleteNode.setStyles(this.css.actionDeleteNode)}.bind(this),mousedown:function(){this.deleteNode.setStyles(this.css.actionDeleteNode_down)}.bind(this),mouseup:function(){this.deleteNode.setStyles(this.css.actionDeleteNode_over)}.bind(this),click:function(e){this.remove(e);e.stopPropagation()}.bind(this)});this.editNode=new Element("div",{styles:this.css.actionEditNode,title:"编辑"}).inject(e);this.editNode.addEvents({mouseover:function(){this.editNode.setStyles(this.css.actionEditNode_over)}.bind(this),mouseout:function(){this.editNode.setStyles(this.css.actionEditNode)}.bind(this),mousedown:function(){this.editNode.setStyles(this.css.actionEditNode_down)}.bind(this),mouseup:function(){this.editNode.setStyles(this.css.actionEditNode_over)}.bind(this),click:function(e){this.editCMSDocument();e.stopPropagation()}.bind(this)})},setOpenWork:function(e){e.setStyle("cursor","pointer");e.addEvent("click",function(){this.openCMSDocument()}.bind(this))},openCMSDocument:function(e){var t="cms.Document"+this.data.bundle;if(layout.desktop.apps[t]){layout.desktop.apps[t].setCurrent()}else{var i={documentId:this.data.bundle,readonly:!e};layout.desktop.openApplication(null,"cms.Document",i)}},editCMSDocument:function(){this.openCMSDocument(true)},remove:function(e){var t="删除后不能恢复，你确定要删除该文档？";var i=this;this.node.setStyles(this.css.viewContentTrNode_delete);this.readyRemove=true;this.view.app.confirm("warn",e,"删除确认",t,350,120,function(){i.removeCMSDocument(i,false);this.close()},function(){i.node.setStyles(i.css.viewContentTrNode);i.readyRemove=false;this.close()})},removeCMSDocument:function(){var e=this.data.bundle;MWF.Actions.get("x_cms_assemble_control").removeDocument(e,function(e){this.readyRemove=false;this.node.destroy();this.view.app.notice("删除成功","success");MWF.release(this)}.bind(this))}});MWF.xApplication.cms.Module.QueryViewer.ItemCategory=new Class({Extends:MWF.xApplication.query.Query.Viewer.ItemCategory,load:function(){this.node=new Element("tr",{styles:this.css.viewContentTrNode}).inject(this.view.viewTable);this.selectTd=new Element("td",{styles:this.css.viewContentCategoryTdNode}).inject(this.node);if(this.view.json.itemStyles)this.selectTd.setStyles(this.view.json.itemStyles);var e=this.view.viewJson.selectList.length;if(this.view.options.hasAction){e++}this.categoryTd=new Element("td",{styles:this.css.viewContentCategoryTdNode,colspan:e}).inject(this.node);this.groupColumn=null;for(var t=0;t<this.view.viewJson.selectList.length;t++){if(this.view.viewJson.selectList[t].column===this.view.viewJson.group.column){this.groupColumn=this.view.viewJson.selectList[t];break}}if(this.groupColumn){var i=this.groupColumn.code?MWF.Macro.exec(this.groupColumn.code,{value:this.data.group,gridData:this.view.gridJson,data:this.view.viewData,entry:this.data}):this.data.group}else{var i=this.data.group}this.categoryTd.set("html","<span style='font-family: Webdings'><img src='/x_component_query_Query/$Viewer/"+this.view.options.style+"/icon/expand.png'/></span> "+i);if(this.view.json.itemStyles)this.categoryTd.setStyles(this.view.json.itemStyles);this.setEvent()},expand:function(){this.items.each(function(e){e.node.setStyle("display","table-row")}.bind(this));this.node.getElement("span").set("html","<img src='/x_component_process_Application/$Viewer/"+this.view.options.style+"/icon/down.png'/>");if(!this.loadChild){this.data.list.each(function(e){this.items.push(new MWF.xApplication.cms.Module.QueryViewer.Item(this.view,e,this))}.bind(this));this.loadChild=true}}});