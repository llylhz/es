MWF.xDesktop.Actions=MWF.xDesktop.Actions||{};MWF.xDesktop.Actions.RestActions=new Class({initialize:function(e,t){this.actionPath=e;this.serviceName=t;this.getAddress()},listApplicationAddress:function(e,t){var s=this.actions.listAddress;s=this.actions.slotHost+s;var i=new MWF.xApplication.Common.Actions.RestActions.Callback(e,t);MWF.getJSON(s,i)},getAddress:function(e,t){if(e)e.apply()},getActions:function(e){if(!this.actions){MWF.getJSON(MWF.defaultPath+this.actionPath,function(t){this.actions=t;if(e)e()}.bind(this),true,true,false)}else{if(e)e()}},invoke:function(e){this.getActions(function(){var t=this.actions[e.name];var s=t.method||"GET";var i=t.uri;if(e.parameter){Object.each(e.parameter,function(e,t){var s=new RegExp("{"+t+"}","g");i=i.replace(s,encodeURIComponent(e))})}i=this.address+i;var a=e.async===false?false:true;var n=new MWF.xDesktop.Actions.RestActions.Callback(e.success,e.failure);if(t.enctype&&t.enctype.toLowerCase()=="formdata"){this.invokeFormData(s,i,e.data,e.file,n,a)}else{var o=e.data?JSON.encode(e.data):"";var r=true;if(e.withCredentials===false){r=false}MWF.restful(s,i,o,n,a,r)}}.bind(this))},formDataUpdateProgress:function(){},invokeFormData:function(e,t,s,i,a,n){var o=new COMMON.Browser.Request;o.open(e,t,true);o.withCredentials=true;var r=null;var d=null;var c=i.size;var l=new Date;var u="";var f=function(e){}.bind(this);var v=false;var p=function(e){if(e.lengthComputable){if(!v){var t=o.responseText;if(o.responseText.indexOf("$")!=-1){t=t.substr(0,t.lastIndexOf("$"));t=t.substr(t.lastIndexOf("#")+1,t.length);v=true}else{t=t.substr(t.lastIndexOf("#")+1,t.length)}if(!t)return false;t=t*32*1024;var s=100*(t/c);if(r.contentNode){var i=r.contentNode.getFirst("div").getFirst("div");var a=i.getFirst("div");var n=r.contentNode.getFirst("div").getLast("div");a.setStyle("width",""+s+"%")}var d=new Date;var u=d.getTime()-l.getTime();var f=t/u;var p="K/S";if(f>1024){p="M/S";f=f/1024}if(f>1024){p="G/S";f=f/1024}f=f.round(2);n.set("text",MWF.LP.desktop.action.sendStart+": "+f+p)}}}.bind(this);var h=function(e){}.bind(this);var g=function(e){}.bind(this);var F=function(e){if(r.contentNode){var t=r.contentNode.getFirst("div").getFirst("div");var s=t.getFirst("div");var a=r.contentNode.getFirst("div").getLast("div")}var n=new Date;var o=n.getTime()-l.getTime();var d=c/o;var u="K/S";if(d>1024){u="M/S";d=d/1024}if(d>1024){u="G/S";d=d/1024}d=d.round(2);var f="";if(o>36e5){var v=o/36e5;var p=o%36e5;var h=p/6e4;var g=p%6e4;var F=g/1e3;f=""+v.toInt()+MWF.LP.desktop.action.hour+h.toInt()+MWF.LP.desktop.action.minute+F.toInt()+MWF.LP.desktop.action.second}else if(o>6e4){var h=o/6e4;var g=o%6e4;var F=g/1e3;f=""+h.toInt()+MWF.LP.desktop.action.minute+F.toInt()+MWF.LP.desktop.action.second}else{var F=o/1e3;f=""+F.toInt()+MWF.LP.desktop.action.second}if(r.contentNode){s.setStyle("width","100%");a.set("text",MWF.LP.desktop.action.uploadComplete+"  "+MWF.LP.desktop.action.speed+": "+d+u+"  "+MWF.LP.desktop.action.time+": "+f)}var k={subject:MWF.LP.desktop.action.uploadTitle,content:MWF.LP.desktop.action.uploadComplete+" : "+i.name};layout.desktop.message.addTooltip(k)}.bind(this);var k=function(e){if(o.readyState==2){var t=r.contentNode.getFirst("div").getFirst("div");var s=t.getFirst("div");var i=r.contentNode.getFirst("div").getLast("div");i.set("text",MWF.LP.desktop.action.sendStart)}if(o.readyState!=4)return;var n=o.responseText;n=n.substr(n.lastIndexOf("$")+1,n.length);n=n.substr(n.lastIndexOf("#")+1,n.length);var d=n.indexOf("*");if(d!=-1){n=n.substr(0,d)}u=n;var c=o.status;alert(c+"--"+o.readyState);c=c==1223?204:c;if(c>=200&&c<300){MWF.runCallback(a,"onSuccess",[{type:"success",id:u},o.responseText])}else{MWF.runCallback(a,"onFailure",[o])}};if(o.upload){o.addEventListener("progress",p,false);o.addEventListener("load",F,false);o.addEventListener("loadstart",f,false);o.addEventListener("error",h,false);o.addEventListener("abort",g,false)}else{}o.addEventListener("readystatechange",k,false);var m=this.addFormDataMessage(i);r=m.messageItem;d=m.tooltipItem;o.send(s)},addFormDataMessage:function(e){var t='<div style="overflow: hidden"><div style="height: 10px; border:1px solid #666;">'+'<div style="height: 10px; background-color: #acdab9; width: 0px;"></div></div>'+'<div style="height: 20px; line-height: 20px">'+MWF.LP.desktop.action.sendReady+"</div></div>";var s={subject:MWF.LP.desktop.action.uploadTitle,content:MWF.LP.desktop.action.uploadTitle+" : "+e.name+"<br/>"+t};var i=layout.desktop.message.addMessage(s);s={subject:MWF.LP.desktop.action.uploadTitle,content:MWF.LP.desktop.action.uploadTitle+" : "+e.name};var a=layout.desktop.message.addTooltip(s);return{tooltipItem:a,messageItem:i}},getAuthentication:function(e,t){this.invoke({name:"authentication",async:true,success:function(s,i){if(s.data){if(e)e(s)}else{if(t)t(null,i,s.message)}},failure:t})},login:function(e,t,s){this.invoke({name:"login",async:true,data:e,success:function(e,i){if(e.data.authentication){if(t)t(e)}else{if(s)s(null,i,e.message)}},failure:s})},logout:function(e,t){this.invoke({name:"logout",async:false,success:e,failure:t})}});MWF.xDesktop.Actions.RestActions.Callback=new Class({initialize:function(e,t,s,i){this.success=e;this.failure=t;this.appendSuccess=s;this.appendFailure=i},onSuccess:function(e,t){if(e){switch(e.type){case"success":if(this.appendSuccess)this.appendSuccess(e);if(this.success)this.success(e);break;case"warn":MWF.xDesktop.notice("info",{x:"right",y:"top"},e.errorMessage.join("\n"));if(this.appendSuccess)this.appendSuccess(e);if(this.success)this.success(e);break;case"error":this.doError(null,t,e.message);break}}else{this.doError(null,t,"")}},onRequestFailure:function(e){this.doError(e,"","")},onFailure:function(e){this.doError(e,"","")},onError:function(e,t){this.doError(null,e,t)},doError:function(e,t,s){if(this.appendFailure)this.appendFailure(e,t,s);if(this.failure)this.failure(e,t,s);if(!this.failure&&!this.appendFailure){var i=s;if(e)i=e.responseText;MWF.xDesktop.notice("error",{x:"right",y:"top"},"request json error: "+i)}}});