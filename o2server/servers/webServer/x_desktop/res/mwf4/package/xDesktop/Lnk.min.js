Element.implement({makeLnk:function(e){return new MWF.xDesktop.LnkMaker(this,e)}});MWF.xDesktop.LnkMaker=new Class({Implements:[Options,Events],initialize:function(e,t){this.setOptions(t);this.node=e;this.desktop=layout.desktop;this.tmpApps=[];this.isReadyDrag=false;this.readyDragPosition=null;this.setEvent()},setEvent:function(){this.node.addEvents({mousedown:function(e){if(!e.rightClick){this.isReadyDrag=true;this.readyDragPosition={x:e.page.x,y:e.page.y};document.body.addEvent("mousemove",function(e){if(this.isReadyDrag){if(Math.abs(e.page.x-this.readyDragPosition.y)>6||Math.abs(e.page.y-this.readyDragPosition.y)>6){this.isReadyDrag=false;this.readyDragPosition=null;this.node.removeEvents("mousemove");this.beginMoveToDesktop(e)}}}.bind(this))}}.bind(this),mouseup:function(e){this.isReadyDrag=false;this.readyDragPosition=null;this.node.removeEvents("mousemove")}.bind(this)})},createMoveNode:function(){var e=new Element("div",{styles:this.desktop.css.lnkMoveNode}).inject(this.desktop.desktopNode);this.node.clone().inject(e);e.position({relativeTo:this.node});return e},beginMoveToDesktop:function(e){var t=this.createMoveNode();var i=this.desktop;var s=new Drag.Move(t,{snap:10,stopPropagation:true,droppables:i.lnkAreas,onStart:function(){this.fireEvent("start");this.start();this.fireEvent("afterStart")}.bind(this),onDrag:function(e,t){this.fireEvent("drag",e);this.drag(e,t);this.fireEvent("afterDrag",e)}.bind(this),onEnter:function(e,t){this.fireEvent("enter",e,t);this.enter(e,t);this.fireEvent("afterEnter",e,t)}.bind(this),onLeave:function(e,t){this.fireEvent("leave",e,t);this.leave(e);this.fireEvent("afterLeave",e,t)}.bind(this),onDrop:function(t,i){this.fireEvent("drop",t,i);this.drop(t,e);this.fireEvent("afterDrop",t,i)}.bind(this),onCancel:function(e){this.fireEvent("cancel",e);this.cancel(e);this.fireEvent("afterCancel",e)}.bind(this),onComplete:function(e,t){this.fireEvent("complete",e,t);this.fireEvent("afterComplete",e,t)}.bind(this)});s.start(e)},start:function(){this.tmpApps=[];Object.each(this.desktop.apps,function(e,t){if(!e.window.isHide){this.tmpApps.push(e);e.window._fadeOut()}}.bind(this))},enter:function(e,t){this.addLnkMark(e,t)},drag:function(e,t){this.moveLnkMark(e,t)},leave:function(e){this.removeLnkMark(e)},drop:function(e){this.addLnk(e);this.endMoveToDesktop(e)},cancel:function(e){this.endMoveToDesktop(e)},addLnkMark:function(e,t){if(!this.lnkMarkNode){this.lnkMarkNode=new Element("div",{styles:this.desktop.css.dsektoplnkMarkNode}).inject(t)}},moveLnkMark:function(e,t){if(this.lnkMarkNode){var i=e.getPosition();var s=e.getSize();var n=this.lnkMarkNode.getParent();var o=n.getChildren();var d=false;for(var a=0;a<o.length;a++){if(o[a]!=this.lnkMarkNode&&o[a]!=e){var h=o[a].getPosition();var r=o[a].getSize();if(h.y+r.y>i.y+s.y/2&&h.x+r.x>i.x+s.x/2){}else if(h.y+r.y>i.y+s.y){this.lnkMarkNode.inject(o[a],"before");this.lnkMarkNode.setStyle("top",h.y-10);d=true;break}else{}}}if(!d){this.lnkMarkNode.inject(n);this.lnkMarkNode.setStyle("top","auto");if(this.desktop.lnks.length)this.lnkMarkNode.setStyle("top",this.lnkMarkNode.getPosition().y-10)}}},removeLnkMark:function(e){if(this.lnkMarkNode){this.lnkMarkNode.destroy();this.lnkMarkNode=null}},addLnk:function(e){if(this.lnkMarkNode){var t=this.options.par;var i=new MWF.xDesktop.Lnk(t.icon,t.title,t.par);var s=this.lnkMarkNode.getNext();if(s){var n=s.retrieve("lnk");var o=this.desktop.lnks.indexOf(n);this.desktop.lnks.splice(o,0,i)}else{this.desktop.lnks.push(i)}i.inject(this.lnkMarkNode,"after");this.removeLnkMark();this.desktop.resizeLnk()}},endMoveToDesktop:function(e){this.tmpApps.each(function(e){e.window._fadeIn()});this.tmpApps=[];if(e)e.destroy()}});MWF.xDesktop.LnkMove=new Class({Extends:MWF.xDesktop.LnkMaker,setEvent:function(){this.isReadySwing=false;this.readySwingTime="";this.node.addEvents({mousedown:function(e){if(!e.rightClick){this.isReadyDrag=true;this.isReadySwing=true;this.readyDragPosition={x:e.page.x,y:e.page.y};this.readySwingTime=(new Date).getTime();this.swingTimer=window.setTimeout(function(){this.beginNodeSwing(e)}.bind(this),1e3);this.node.addEvent("mousemove",function(t){if(this.isReadyDrag){if(Math.abs(t.page.x-this.readyDragPosition.x)>10||Math.abs(t.page.y-this.readyDragPosition.y)>10){this.clearEvent();this.beginMoveToDesktop(e)}}}.bind(this))}}.bind(this),mouseup:function(e){this.clearEvent()}.bind(this)})},clearEvent:function(){this.isReadyDrag=false;this.readyDragPosition=null;this.isReadySwing=false;this.readySwingTime="";this.node.removeEvents("mousemove");window.clearTimeout(this.swingTimer)},beginNodeSwing:function(e){if(this.isReadySwing){this.clearEvent();this.morph=new Fx.Morph(this.node,{duration:100});var t=this.node.retrieve("lnk");t.isSwing=true;this.nodeSwing(22)}},nodeSwing:function(e){var t=e==22?18:22;this.morph.start({"margin-left":t}).chain(function(){this.nodeSwing(t)}.bind(this))},stopSwing:function(){this.morph.cancel();var e=this.node.retrieve("lnk");this.morph.start({"margin-left":20}).chain(function(){e.isSwing=false}.bind(this))},createMoveNode:function(){var e=this.node.clone().inject(this.desktop.desktopNode);e.position({relativeTo:this.node});e.setStyles(this.desktop.css.desktopLnkNode);return e},start:function(){this.node.setStyle("opacity",.5);this.node.setStyles(this.desktop.css.desktopLnkNode_current)},addLnk:function(e){if(this.lnkMarkNode){var t=this.lnkMarkNode.getNext();var i=this.lnkMarkNode.getPrevious();var s=t?t.retrieve("lnk"):null;var n=i?i.retrieve("lnk"):null;var o=this.node.retrieve("lnk");if(!s){this.desktop.lnks.erase(o);this.desktop.lnks.push(o)}else if(s==o||n==o){}else{this.desktop.lnks.erase(o);var d=this.desktop.lnks.indexOf(s);if(d!=-1){this.desktop.lnks.splice(d,0,o)}else{this.desktop.lnks.push(o)}}this.removeLnkMark();this.desktop.resizeLnk()}this.node.fade("in")},endMoveToDesktop:function(e){this.node.setStyles(this.desktop.css.desktopLnkNode);if(e)e.destroy()}});MWF.xDesktop.Lnk=new Class({initialize:function(e,t,i){this.desktop=layout.desktop;this.icon=e;this.title=t;this.par=i;this.node=new Element("div",{styles:this.desktop.css.desktopLnkNode,title:this.title});this.node.store("lnk",this);this.iconNode=new Element("div",{styles:this.desktop.css.desktopLnkIconNode}).inject(this.node);if(this.icon.substr(0,3).toLowerCase()=="url"){this.iconNode.setStyle("background-image",this.icon)}else{this.iconNode.setStyle("background-image","url("+this.icon+")")}this.titleNode=new Element("div",{styles:this.desktop.css.desktopLnkTitleNode,text:this.title}).inject(this.node);this.node.addEvents({mouseover:function(e){this.node.setStyles(this.desktop.css.desktopLnkNode_current)}.bind(this),mouseout:function(e){this.node.setStyles(this.desktop.css.desktopLnkNode)}.bind(this),click:function(e){this.open(e)}.bind(this)});this.lnkMove=new MWF.xDesktop.LnkMove(this.node);this.loadMenu()},loadMenu:function(){this.menu=new MWF.widget.Menu(this.node,{style:"lnk",container:this.desktop.node});this.menu.load();this.menu.addMenuItem("删除快捷方式","click",function(){this.deleteLnk()}.bind(this))},deleteLnk:function(){this.desktop.lnks.erase(this);this.node.destroy();MWF.release(this);delete this},inject:function(e,t){this.node.inject(e,t)},open:function(e){if(!this.isSwing){var t=this.par.split("#");var i=t[0];var s=t[1]||"";var n=JSON.decode(s,false);var o={};if(n){if(n.appId){o={appId:n.appId,onQueryLoad:function(){this.status=n}}}else{o={onQueryLoad:function(){this.status=n}}}}this.desktop.openApplication(e,i,o)}else{this.stopSwingFun=function(){this.lnkMove.stopSwing();this.node.removeEvent("click",this.stopSwingFun)}.bind(this);this.node.addEvent("click",this.stopSwingFun)}}});