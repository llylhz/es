MWF.xDesktop=MWF.xDesktop||{};MWF.xDesktop.requireApp("Selector","Actions.RestActions",null,false);MWF.xDesktop.UserPanel=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default"},initialize:function(e,s){this.setOptions(s);this.container=e;this.path=MWF.defaultPath+"/xDesktop/$UserPanel/";this.cssPath=MWF.defaultPath+"/xDesktop/$UserPanel/"+this.options.style+"/css.wcss";this.users={};this.isShow=false;this._loadCss()},changStyle:function(e){this.setOptions({style:e});this.cssPath=MWF.defaultPath+"/xDesktop/$UserPanel/"+this.options.style+"/css.wcss";this._loadCss();this.node.setStyles(this.css.panelNode);this.titleNode.setStyles(this.css.titleNode);this.userInforNode.setStyles(this.css.userInforNode);this.userSearchNode.setStyles(this.css.userSearchNode);this.userListNode.setStyles(this.css.userListNode);this.userMenuNode.setStyles(this.css.userMenuNode);this.show()},load:function(){this.node=new Element("div#userpanel",{styles:this.css.panelNode});this.titleNode=new Element("div",{styles:this.css.titleNode}).inject(this.node);this.userInforNode=new Element("div",{styles:this.css.userInforNode}).inject(this.node);this.userSearchNode=new Element("div",{styles:this.css.userSearchNode}).inject(this.node);this.userListNode=new Element("div",{styles:this.css.userListNode}).inject(this.node);this.userMenuNode=new Element("div",{styles:this.css.userMenuNode}).inject(this.node);this.createTitle();this.createUserInfor();this.createSearch();this.createUserList();this.createBottomMenu();window.setInterval(function(){if(this.isShow)this.checkOnline()}.bind(this),12e4)},checkOnline:function(){Object.each(this.users,function(e){if(!this.onlineAction)this.onlineAction=new MWF.xDesktop.Actions.RestActions("/xDesktop/Actions/action.json","x_collaboration_assemble_websocket");this.onlineAction.invoke({name:"personOnline",parameter:{person:e.name},success:function(s){if(e.data.status!=s.data.status){var t=e.data.icon?"data:image/png;base64,"+e.data.icon:"";if(!t){if(e.data.genderType=="f"){t=MWF.defaultPath+"/xDesktop/$UserPanel/default/icon/female.png"}else{t=MWF.defaultPath+"/xDesktop/$UserPanel/default/icon/man.png"}}if(s.data.status!="offline"){e.userIconNode.set("src",t);e.node.inject(e.onlineContainer)}else{e.userIconNode.set("src",MWF.grayscale(t));e.node.inject(e.offlineContainer)}e.data.status=s.data.status}}.bind(this)})}.bind(this))},createBottomMenu:function(){},createTitle:function(){this.closeAction=new Element("div",{styles:this.css.closeActionNode}).inject(this.titleNode);this.closeAction.addEvent("click",function(e){this.hide();e.stopPropagation()}.bind(this))},createUserInfor:function(){this.userIconAreaNode=new Element("div",{styles:this.css.userIconAreaNode}).inject(this.userInforNode);this.userIconNode=new Element("img",{styles:this.css.userIconNode}).inject(this.userIconAreaNode);this.userTextInforNode=new Element("div",{styles:this.css.userTextInforNode}).inject(this.userInforNode);this.userNameInforNode=new Element("div",{styles:this.css.userNameInforNode}).inject(this.userTextInforNode);this.userNameTextInforNode=new Element("div",{styles:this.css.userNameTextInforNode}).inject(this.userNameInforNode);this.userDutyTextInforNode=new Element("div",{styles:this.css.userDutyTextInforNode}).inject(this.userNameInforNode);this.userSignInforNode=new Element("div",{styles:this.css.userSignInforNode}).inject(this.userTextInforNode);if(!this.userAction)this.userAction=new MWF.xApplication.Selector.Actions.RestActions;this.userAction.getPersonComplex(function(e){if(!e.data)e.data={display:layout.desktop.session.user.name,name:layout.desktop.session.user.name,identityList:[]};this.owner=e.data;if(e.data.icon){this.userIconNode.set("src","data:image/png;base64,"+e.data.icon+"")}else{if(e.data.genderType=="f"){this.userIconNode.set("src",""+MWF.defaultPath+"/xDesktop/$UserPanel/default/icon/female.png")}else{this.userIconNode.set("src",""+MWF.defaultPath+"/xDesktop/$UserPanel/default/icon/man.png")}}this.userNameTextInforNode.set("text",e.data.display);var s=[];e.data.identityList.each(function(e){s.push(e.department)}.bind(this));var t=[];var i=t.length?s.join(", ")+"["+t.join(", ")+"]":s.join(", ");this.userDutyTextInforNode.set("text",i);this.userSignInforNode.set("text",e.data.signature||MWF.LP.desktop.nosign)}.bind(this),null,layout.desktop.session.user.name)},createSearch:function(){this.searchInput=new Element("input",{styles:this.css.searchInput,type:"text",value:MWF.LP.desktop.searchUser}).inject(this.userSearchNode);this.searchInput.addEvents({focus:function(){if(this.searchInput.get("value")==MWF.LP.desktop.searchUser)this.searchInput.set("value","")}.bind(this),blur:function(){if(!this.searchInput.get("value"))this.searchInput.set("value",MWF.LP.desktop.searchUser)}.bind(this),keydown:function(e){if(e.code==13)this.doSearch()}.bind(this)})},doSearch:function(){var e=this.searchInput.get("value");if(e){this.userListSearchTab.click();if(!this.userAction)this.userAction=new MWF.xApplication.Selector.Actions.RestActions;this.userAction.listPersonByKey(function(e){this.userListSearchAreaNode.getFirst().empty();this.userListSearchAreaNode.getLast().empty();e.data.each(function(e){if(layout.desktop.session.user.name!=e)new MWF.xDesktop.UserPanel.User(this.userListSearchAreaNode,this,e.name)}.bind(this))}.bind(this),null,e)}},createUserList:function(){this.userListTitleNode=new Element("div",{styles:this.css.userListTitleNode}).inject(this.userListNode);this.userListChatTab=new Element("div",{styles:this.css.userListChatTab}).inject(this.userListTitleNode);this.userListOnlineTab=new Element("div",{styles:this.css.userListOnlineTab}).inject(this.userListTitleNode);this.userListSearchTab=new Element("div",{styles:this.css.userListSearchTab}).inject(this.userListTitleNode);this.userListChatTab.addEvents({mouseover:function(){if(this.currentList!=this.userListChatTab)this.userListChatTab.setStyles(this.css.userListChatTab_over)}.bind(this),mouseout:function(){if(this.currentList!=this.userListChatTab)this.userListChatTab.setStyles(this.css.userListChatTab)}.bind(this),click:function(){this.loadChatList()}.bind(this)});this.userListOnlineTab.addEvents({mouseover:function(){if(this.currentList!=this.userListOnlineTab)this.userListOnlineTab.setStyles(this.css.userListOnlineTab_over)}.bind(this),mouseout:function(){if(this.currentList!=this.userListOnlineTab)this.userListOnlineTab.setStyles(this.css.userListOnlineTab)}.bind(this),click:function(){this.loadOnlineList()}.bind(this)});this.userListSearchTab.addEvents({mouseover:function(){if(this.currentList!=this.userListSearchTab)this.userListSearchTab.setStyles(this.css.userListSearchTab_over)}.bind(this),mouseout:function(){if(this.currentList!=this.userListSearchTab)this.userListSearchTab.setStyles(this.css.userListSearchTab)}.bind(this),click:function(){this.loadSearchList()}.bind(this)});this.currentList=this.userListOnlineTab;this.userListScrollNode=new Element("div",{styles:this.css.userListScrollNode}).inject(this.userListNode);this.userListChatAreaNode=new Element("div",{styles:this.css.userListAreaNode}).inject(this.userListScrollNode);this.userListChatAreaOnlineNode=new Element("div",{styles:this.css.userListAreaNode}).inject(this.userListChatAreaNode);this.userListChatAreaOfflineNode=new Element("div",{styles:this.css.userListAreaNode}).inject(this.userListChatAreaNode);this.userListOnlineAreaNode=new Element("div",{styles:this.css.userListAreaNode}).inject(this.userListScrollNode);this.userListOnlineAreaOnlineNode=new Element("div",{styles:this.css.userListAreaNode}).inject(this.userListOnlineAreaNode);this.userListOnlineAreaOfflineNode=new Element("div",{styles:this.css.userListAreaNode}).inject(this.userListOnlineAreaNode);this.userListSearchAreaNode=new Element("div",{styles:this.css.userListAreaNode}).inject(this.userListScrollNode);this.userListSearchAreaOnlineNode=new Element("div",{styles:this.css.userListAreaNode}).inject(this.userListSearchAreaNode);this.userListSearchAreaOfflineNode=new Element("div",{styles:this.css.userListAreaNode}).inject(this.userListSearchAreaNode);this.loadChatOnlineList();MWF.require("MWF.widget.ScrollBar",function(){new MWF.widget.ScrollBar(this.userListScrollNode,{style:"xDesktop_Message",where:"before",indent:false,distance:50,friction:6,axis:{x:false,y:true}})}.bind(this))},loadChatOnlineList:function(){MWF.UD.getData("chat",function(e){if(e.data){this.chatData=JSON.decode(e.data);chatList=this.chatData.chatList;onlineList=this.chatData.onlineList;if(chatList){if(chatList.length){chatList.each(function(e){if(layout.desktop.session.user.name!=e)this.users["chat"+e]=new MWF.xDesktop.UserPanel.User(this.userListChatAreaNode,this,e)}.bind(this))}else{}}else{}if(onlineList){if(onlineList.length){onlineList.each(function(e){if(layout.desktop.session.user.name!=e)this.users["online"+e]=new MWF.xDesktop.UserPanel.User(this.userListOnlineAreaNode,this,e)}.bind(this))}else{}}else{}}if(!layout.desktop.socket)layout.desktop.openWebSocket()}.bind(this))},loadChatList:function(){this.userListChatAreaNode.setStyle("display","block");this.userListOnlineAreaNode.setStyle("display","none");this.userListSearchAreaNode.setStyle("display","none");this.userListChatTab.setStyles(this.css.userListChatTab_current);this.userListOnlineTab.setStyles(this.css.userListOnlineTab);this.userListSearchTab.setStyles(this.css.userListSearchTab);this.currentList=this.userListChatTab},loadOnlineList:function(){this.userListOnlineAreaNode.setStyle("display","block");this.userListChatAreaNode.setStyle("display","none");this.userListSearchAreaNode.setStyle("display","none");this.userListOnlineTab.setStyles(this.css.userListOnlineTab_current);this.userListChatTab.setStyles(this.css.userListChatTab);this.userListSearchTab.setStyles(this.css.userListSearchTab);this.currentList=this.userListOnlineTab},loadSearchList:function(){this.userListOnlineAreaNode.setStyle("display","none");this.userListChatAreaNode.setStyle("display","none");this.userListSearchAreaNode.setStyle("display","block");this.userListOnlineTab.setStyles(this.css.userListOnlineTab);this.userListChatTab.setStyles(this.css.userListChatTab);this.userListSearchTab.setStyles(this.css.userListSearchTab_current);this.currentList=this.userListSearchTab},listOnlineUser:function(){},hide:function(){this.node.setStyle("display","none");this.isShow=false},show:function(){this.node.inject($(document.body));var e=MWF.xDesktop.zIndexPool.applyZindex();this.node.setStyles({display:"block","z-index":e});this.setPosition();this.currentList.click();this.isShow=true;if(layout.desktop.currentApp)layout.desktop.currentApp.setUncurrent()},setPosition:function(){var e=this.container.getSize();var s=this.container.getPosition(this.container.getOffsetParent());var t=e.y-24;var i=s.y+10;this.node.setStyle("height",""+t+"px");this.node.setStyle("top",""+i+"px");var n=this.titleNode.getSize();var o=this.userInforNode.getSize();var a=this.userSearchNode.getSize();var r=this.userMenuNode.getSize();var h=t-(n.y+o.y+a.y+r.y);this.userListNode.setStyle("height",""+h+"px");var d=this.userListTitleNode.getSize();h=h-d.y;this.userListScrollNode.setStyle("height",""+h+"px")},receiveChatMessage:function(e){var s=this.desktop.apps["Chat"];if(s){var t=e.fromPerson+layout.desktop.session.user.name;var i=s.dialogues[t];if(i){i.showMessage(e,e.fromPerson);if(s.current!=i){layout.desktop.playMessageAudio();i.addUnreadMessage(e)}if(layout.desktop.currentApp!=s){var n=this.users["online"+e.fromPerson];this.sendTooltipMessage(e,n);layout.desktop.playMessageAudio()}}else{this.receiveMessageRecodePanel(e)}}else{this.receiveMessageRecodePanel(e)}},receiveMessageRecodePanel:function(e){var s=this.users["online"+e.fromPerson];if(s){s.addUnreadMessage(e)}else{this.users["online"+e.fromPerson]=new MWF.xDesktop.UserPanel.User(this.userListOnlineAreaNode,this,e.fromPerson);s=this.users["online"+e.fromPerson];s.addUnreadMessage(e)}this.sendTooltipMessage(e,s);layout.desktop.playMessageAudio()},sendTooltipMessage:function(e,s){var t='<div style="height: 20px; line-height: 20px">'+e.text+"</div></div>";msg={subject:e.fromPerson+" "+MWF.LP.desktop.say+": ",content:t};var i=layout.desktop.message.addTooltip(msg);i.contentNode.addEvent("click",function(){s.openChat()})}});MWF.xDesktop.UserPanel.User=new Class({initialize:function(e,s,t){this.panel=s;this.name=t;this.data=null;this.container=e;this.onlineContainer=e.getFirst();this.offlineContainer=e.getLast();this.css=this.panel.css;this.checkOnlineTime=new Date;this.unreadDatas=[];this.load()},createNode:function(){this.node=new Element("div",{styles:this.css.chatUserNode}).inject(this.onlineContainer);this.userIconAreaNode=new Element("div",{styles:this.css.userListIconAreaNode}).inject(this.node);this.userIconNode=new Element("img",{styles:this.css.userListIconNode}).inject(this.userIconAreaNode);this.userTextInforNode=new Element("div",{styles:this.css.userListTextInforNode}).inject(this.node);this.userNameInforNode=new Element("div",{styles:this.css.userListNameInforNode}).inject(this.userTextInforNode);this.userNameTextInforNode=new Element("div",{styles:this.css.userListNameTextInforNode}).inject(this.userNameInforNode);this.userListGenderFlagNode=new Element("div",{styles:this.css.userListGenderFlagNode}).inject(this.userNameInforNode);this.userDutyTextInforNode=new Element("div",{styles:this.css.userListDutyTextInforNode}).inject(this.userNameInforNode);this.userSignInforNode=new Element("div",{styles:this.css.userListSignInforNode}).inject(this.userTextInforNode)},checkOnline:function(){if(this.data.status=="offline"){this.userIconNode.set("src",MWF.grayscale(this.userIconNode.get("src")));this.node.inject(this.offlineContainer)}},loadPerson:function(){this.panel.userAction.getPersonComplex(function(e){this.data=e.data;if(e.data.icon){this.userIconNode.set("src","data:image/png;base64,"+e.data.icon+"")}else{if(e.data.genderType=="f"){this.userIconNode.set("src",""+MWF.defaultPath+"/xDesktop/$UserPanel/default/icon/female.png")}else{this.userIconNode.set("src",""+MWF.defaultPath+"/xDesktop/$UserPanel/default/icon/man.png")}}if(e.data.status=="offline"){this.userIconNode.set("src",MWF.grayscale(this.userIconNode.get("src")))}this.userNameTextInforNode.set("text",e.data.display);if(e.data.genderType=="f"){this.userListGenderFlagNode.setStyle("background-image","url("+MWF.defaultPath+"/xDesktop/$UserPanel/default/icon/female_flag.png)")}else{this.userListGenderFlagNode.setStyle("background-image","url("+MWF.defaultPath+"/xDesktop/$UserPanel/default/icon/male_flag.png)")}var s=[];e.data.identityList.each(function(e){s.push(e.department)}.bind(this));var t=[];var i=t.length?s.join(", ")+"["+t.join(", ")+"]":s.join(", ");this.userDutyTextInforNode.set("text",i);this.userSignInforNode.set("text",e.data.signature||MWF.LP.desktop.nosign);this.checkOnline();this.createPersonInforNode()}.bind(this),null,this.name)},createPersonInforNode:function(){var e=[];this.data.companyDutyList.each(function(s){e.push(s.name)}.bind(this));this.data.departmentDutyList.each(function(s){e.push(s.name)}.bind(this));this.personInforNode=new Element("div",{styles:this.css.personInforNode});var s='<table width="100%" cellpadding="3px" border="0">';s+="<tr><td>"+MWF.LP.desktop.person.personEmployee+"</td><td>"+this.data.employee+"</td></tr>";s+="<tr><td>"+MWF.LP.desktop.person.personMobile+"</td><td>"+this.data.mobile+"</td></tr>";s+="<tr><td>"+MWF.LP.desktop.person.personMail+"</td><td>"+this.data.mail+"</td></tr>";s+="<tr><td>"+MWF.LP.desktop.person.personQQ+"</td><td>"+this.data.qq+"</td></tr>";s+="<tr><td>"+MWF.LP.desktop.person.personWeixin+"</td><td>"+this.data.weixin+"</td></tr>";if(e.length)s+="<tr><td>"+MWF.LP.desktop.person.duty+"</td><td>"+e.join(", ")+"</td></tr>";s+="</table>";this.personInforNode.set("html",s)},load:function(){this.createNode();this.loadPerson();this.setEvent()},setEvent:function(){this.node.addEvents({mouseover:function(){this.node.setStyles(this.css.chatUserNode_over)}.bind(this),mouseout:function(){this.node.setStyles(this.css.chatUserNode)}.bind(this),dblclick:function(e){this.openChat(e)}.bind(this),click:function(e){this.openChat(e)}.bind(this)});this.userIconAreaNode.addEvents({mouseover:function(){this.showPersonInfor()}.bind(this),mouseout:function(){this.hidePersonInfor()}.bind(this)})},showPersonInfor:function(){this.personInforNode.inject(this.container);this.personInforNode.setStyle("display","block");var e=this.personInforNode.getSize();var s=this.node.getPosition(this.node.getOffsetParent());var t=this.panel.node.getSize();var i=s.y;var n=t.x+5;this.personInforNode.setStyles({top:""+i+"px",right:""+n+"px"})},hidePersonInfor:function(){this.personInforNode.setStyle("display","none")},destroy:function(){this.node.destroy();delete this.panel.users["online"+this.name];MWF.release(this);delete this},openChat:function(e){var s=layout.desktop.apps["Chat"];if(s){var t=this.name+layout.desktop.session.user.name;var i=s.dialogues[t];if(!i)i=s.addDialogue(this.panel.owner,[this.data]);this.unreadDatas.each(function(e){i.showMessage(e,e.fromPerson)});i.setCurrent();this.clearUnread()}var n=this;layout.desktop.openApplication(e,"Chat",{onPostLoad:function(){i=this.addDialogue(n.panel.owner,[n.data]);n.unreadDatas.each(function(e){i.showMessage(e,e.fromPerson)});n.clearUnread()}})},addUnreadMessage:function(e){if(!this.unreadNode)this.createUnreadnode();this.unreadDatas.push(e);if(this.unreadDatas.length>100)this.unreadDatas.shift();this.unreadNode.set("text",this.unreadDatas.length);this.node.inject(this.container,"top")},createUnreadnode:function(){this.unreadNode=new Element("div",{styles:this.css.userListUnreadNode}).inject(this.node,"bottom")},clearUnread:function(){if(this.unreadNode){this.unreadDatas=null;this.unreadDatas=[];this.unreadNode.destroy();this.unreadNode=null}}});