MWF.xDesktop=MWF.xDesktop||{};MWF.xApplication=MWF.xApplication||{};MWF.require("MWF.xAction.Authentication.RestActions",null,false);MWF.xDesktop.requireApp("Template","MPopupForm",null,false);MWF.xDesktop.Authentication=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],options:{style:"default"},initialize:function(t,e,i){this.setOptions(t);this.node=i;this.action=new MWF.xApplication.Authentication.Actions.RestActions;this.actions=this.action;this.path=MWF.defaultPath+"/xDesktop/$Authentication/";var s=null;MWF.UD.getPublicData("loginStyleList",function(t){if(t&&t.enabledId){MWF.UD.getPublicData(t.enabledId,function(t){if(t&&t.data){s=t.data}}.bind(this),false)}}.bind(this),false);if(!s){this.cssPath=MWF.defaultPath+"/xDesktop/$Authentication/"+this.options.style+"/css.wcss";this._loadCss()}else{this.css=s}this.lp=MWF.LP.authentication;this.app=e||{}},isAuthenticated:function(t,e){this.action.getAuthentication(t,e)},loadLogin:function(t){this.popupOptions={draggable:false,closeAction:false,hasMask:false,relativeToApp:false};this.popupPara={container:t};this.postLogin=function(t){layout.desktop.session.user=t.data;layout.session.user=t.data;var e=layout.desktop.session.user;if(e.roleList){var i=[];e.roleList.each(function(t){i.push(t.substring(0,t.indexOf("@")))});e.roleList=e.roleList.concat(i)}window.location.reload()}.bind(this);this.openLoginForm(this.popupOptions)},logout:function(){this.action.logout(function(){if(this.socket){this.socket.close();this.socket=null}Cookie.dispose("x-token",{domain:".ctc.com",path:"/"});window.location.reload()}.bind(this))},openLoginForm:function(t,e){var i=Object.merge(this.popupOptions||{},t||{},{onPostOk:function(t){if(e)e(t);if(this.postLogin)this.postLogin(t);this.fireEvent("postOk",t)}.bind(this)});var s=new MWF.xDesktop.Authentication.LoginForm(this,{},i,this.popupPara);s.create()},openSignUpForm:function(t,e){var i=Object.merge(this.popupOptions||{},t||{},{onPostOk:function(t){if(e)e(t);this.fireEvent("postOk",t)}.bind(this)});var s=new MWF.xDesktop.Authentication.SignUpForm(this,{},i,this.popupPara);s.create()},openResetPasswordForm:function(t,e){var i=Object.merge(this.popupOptions||{},t||{},{onPostOk:function(t){if(e)e(t);this.fireEvent("postOk",t)}.bind(this)});var s=new MWF.xDesktop.Authentication.ResetPasswordForm(this,{},i,this.popupPara);s.create()}});MWF.xDesktop.Authentication.LoginForm=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"default",popupStyle:"o2platform",width:"650",height:"490",hasTop:true,hasIcon:false,hasTopIcon:true,hasTopContent:true,hasBottom:false,hasMark:false,title:layout.config&&(layout.config.systemTitle||layout.config.title)?layout.config.title||layout.config.systemTitle:MWF.LP.authentication.LoginFormTitle,draggable:true,closeAction:true},_createTopContent:function(){this.faceLogin=false;this.actions.getLoginMode(function(t){this.faceLogin=t.data.faceLogin}.bind(this),null,false);if(this.faceLogin){if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){COMMON.AjaxModule.loadDom(COMMON.contentPath+"/res/framework/adapter/adapter.js",function(){if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){this.cameraLoginIcon=new Element("div",{styles:this.explorer.css.cameraLoginIcon}).inject(this.formTopContentNode);this.cameraLoginIcon.addEvent("click",function(){if(!this.isCameraLogin){this.cameraLogin();this.isCameraLogin=true}else{this.closeCamera();this.isCameraLogin=false}}.bind(this))}}.bind(this))}}},closeCamera:function(){if(this.cameraLoginVideoNode){if(this.video)this.video.destroy();if(this.canvas)this.canvas.destroy();if(this.cameraLoginVideoNode)this.cameraLoginVideoNode.destroy();this.video=null;this.canvas=null;this.cameraLoginVideoNode=null}this.cameraLoginIcon.setStyles(this.explorer.css.cameraLoginIcon)},cameraLoginInit:function(){this.cameraLoginConfig={maxStep:1,step:0,count:0,max:2,errorCount:0,errorMax:3,user:"",tokens:[]}},cameraLoginReset:function(t){this.cameraLoginConfig.count=0;this.cameraLoginConfig.user="";if(t)this.cameraLoginConfig.errorCount=0},cameraLogin:function(){this.cameraLoginInit();this.cameraLoginIcon.setStyles(this.explorer.css.closeCameraLoginIcon);this.createCameraLoginNode();this.startCameraLogin()},createCameraLoginNode:function(){this.cameraLoginVideoNode=new Element("div",{styles:this.explorer.css.cameraLoginVideoNode}).inject(this.container);var t=this.formNode.getSize();var e=this.formTopNode.getSize();var i=t.y-e.y;this.cameraLoginVideoNode.setStyles({width:""+t.x+"px",height:""+i+"px"});this.cameraLoginVideoNode.position({relativeTo:this.formContentNode,position:"upperLeft",edge:"upperLeft"})},startCameraLogin:function(){this.cameraLoginVideoAreaNode=new Element("div").inject(this.cameraLoginVideoNode);this.cameraLoginVideoInfoNode=new Element("div",{styles:this.explorer.css.cameraLoginVideoInfoNode}).inject(this.cameraLoginVideoNode);this.cameraLoginVideoInfoNode.set("text",MWF.LP.desktop.login.camera_logining);var t=this.cameraLoginVideoNode.getSize();var e=this.cameraLoginVideoInfoNode.getSize();var i=t.y-e.y;this.cameraLoginVideoAreaNode.setStyle("height",""+i+"px");this.cameraLoginVideoAreaNode.set("html","<video autoplay></video>");this.video=this.cameraLoginVideoAreaNode.getFirst().setStyles({"background-color":"#000000",width:""+t.x+"px",height:""+i+"px"});this.videoStart()},videoStart:function(){this.video.addEventListener("canplay",function(){window.setTimeout(function(){this.startCameraAuthentication()}.bind(this),500)}.bind(this));navigator.mediaDevices.getUserMedia({audio:false,video:true}).then(function(t){this.video.srcObject=t}.bind(this))["catch"](function(t){console.log("navigator.getUserMedia error: ",t);this.closeCamera()}.bind(this))},getFormData:function(){if(!this.canvas){this.canvas=new Element("canvas",{styles:{display:"none"}}).inject(this.cameraLoginVideoNode);this.canvas.width=this.video.videoWidth;this.canvas.height=this.video.videoHeight}this.canvas.getContext("2d").drawImage(this.video,0,0,this.canvas.width,this.canvas.height);var t=this.toBlob(this.canvas.toDataURL());var e=new FormData;e.append("file",t);this.canvas.destroy();return{data:e,size:t.size}},checkUserFace:function(t){var e=window.location.host;e=e.replace(/\./g,"_");this.faceAction.search(e,t.data,{name:"pic",size:t.size},function(t){if(t.data.results&&t.data.results.length){var e=t.data.thresholds["1e-5"];if(t.data.results[0].confidence>e){var i=t.data.faces[0].face_token;var s=t.data.results[0].user_id;if(!this.cameraLoginConfig.user||this.cameraLoginConfig.user===s){this.cameraLoginConfig.count++;this.cameraLoginConfig.user=s;this.cameraLoginConfig.tokens.push(i);this.cameraLoginConfig.step++;this.cameraLoginConfig.errorCount=0;this.cameraLoginVideoInfoNode.set("text",MWF.LP.desktop.login["camera_logining_"+this.cameraLoginConfig.step])}else{this.cameraLoginReset();this.cameraLoginConfig.errorCount++}}else{this.cameraLoginReset();this.cameraLoginConfig.errorCount++}}else{this.cameraLoginReset();this.cameraLoginConfig.errorCount++}this.checkCameraLogin()}.bind(this),function(){window.setTimeout(function(){this.startCameraAuthentication()}.bind(this),500)}.bind(this))},checkUserAlive:function(t,e,i){this.faceAction.detectattr(e,t.data,{name:"pic",size:t.size},function(t){if(t.data.faces&&t.data.faces.length){if(this[i](t.data.faces[0].attributes)){this.cameraLoginConfig.step++;this.cameraLoginConfig.errorCount=0;this.cameraLoginVideoInfoNode.set("text",MWF.LP.desktop.login["camera_logining_"+this.cameraLoginConfig.step])}else{this.cameraLoginConfig.errorCount++}}else{this.cameraLoginConfig.errorCount++}this.checkCameraLogin()}.bind(this),function(){this.cameraLoginConfig.errorCount++;this.checkCameraLogin()}.bind(this))},checkUserSmile:function(t){return t.smile.value>t.smile.threshold},checkUserPitch:function(t){return t.headpose.pitch_angle<-10},startCameraAuthentication:function(){if(this.video){var t=this.getFormData();if(!this.faceAction)this.faceAction=MWF.Actions.get("x_faceset_control");if(this.cameraLoginConfig.step===0){this.checkUserFace(t)}if(this.cameraLoginConfig.step===1){this.checkUserAlive(t,"smiling","checkUserSmile")}if(this.cameraLoginConfig.step===2){this.checkUserAlive(t,"headpose","checkUserPitch")}}},toBlob:function(t){var e;if(t.substr(0,10)==="data:image"){e=window.atob(t.split(",")[1])}else{e=window.atob(t)}var i=new ArrayBuffer(e.length);var s=new Uint8Array(i);for(var n=0;n<e.length;n++){s[n]=e.charCodeAt(n)}return new Blob([i],{type:"image/png"})},getDIF:function(t){var e=Math.max.apply(this,t);var i=Math.min.apply(this,t);return e-i},checkCameraLogin:function(){if(this.cameraLoginConfig.errorCount>this.cameraLoginConfig.errorMax){this.cameraLoginVideoInfoNode.set("text",MWF.LP.desktop.login.camera_loginError)}else{if(this.cameraLoginConfig.step>=this.cameraLoginConfig.maxStep){var t=MWF.LP.desktop.login.camera_loginSuccess.replace("{name}",this.cameraLoginConfig.user);this.cameraLoginVideoInfoNode.set("text",t);this.cameraLoginSuccess()}else{window.setTimeout(function(){this.startCameraAuthentication()}.bind(this),100)}}},cameraLoginSuccess:function(){COMMON.AjaxModule.loadDom(COMMON.contentPath+"/res/framework/CryptoJS/tripledes.js",function(){COMMON.AjaxModule.loadDom(COMMON.contentPath+"/res/framework/CryptoJS/mode-ecb.js",function(){var t=layout.desktop.serviceAddressList["x_organization_assemble_authentication"];var e=layout.config.app_protocol+"//"+t.host+(t.port===80?"":":"+t.port)+t.context;var i=this.crypDES();var s={client:"oa",token:i};var n=new Request.JSON({method:"POST",url:e+"/jaxrs/sso",data:JSON.stringify(s),secure:false,emulation:false,noCache:true,withCredentials:true,headers:{"Content-Type":"application/json; charset=utf-8"},onSuccess:function(t){this._close();this.closeCamera();if(this.formMaskNode)this.formMaskNode.destroy();this.formAreaNode.destroy();if(this.explorer&&this.explorer.view)this.explorer.view.reload();if(this.app)this.app.notice(this.lp.loginSuccess,"success");this.fireEvent("postOk",t)}.bind(this),onError:function(){this.cameraLoginVideoInfoNode.set("text",MWF.LP.desktop.login.camera_loginError2)}.bind(this)});n.send()}.bind(this))}.bind(this))},crypDES:function(){var t="xplatform";var e=this.cameraLoginConfig.user;var i=(new Date).getTime();var s=CryptoJS.enc.Utf8.parse(t);var n=CryptoJS.DES.encrypt(e+"#"+i,s,{mode:CryptoJS.mode.ECB,padding:CryptoJS.pad.Pkcs7});return n.ciphertext.toString(CryptoJS.enc.Base64)},_createTableContent:function(){this.loginType="captcha";this.codeLogin=false;this.bindLogin=false;this.actions.getLoginMode(function(t){this.codeLogin=t.data.codeLogin;this.bindLogin=t.data.bindLogin}.bind(this),null,false);this.actions.getRegisterMode(function(t){this.signUpMode=t.data.value}.bind(this),null,false);if(this.bindLogin){this.bindLoginTipPic=new Element("div.bindLoginTipPic",{styles:this.css.bindLoginTipPic}).inject(this.formContentNode,"top");this.bindLoginAction=new Element("div.bindLoginAction",{styles:this.css.bindLoginAction}).inject(this.formContentNode,"top");this.bindLoginAction.addEvent("click",function(){this.showBindCodeLogin()}.bind(this));this.backtoPasswordLoginTipPic=new Element("div.backtoPasswordLoginTipPic",{styles:this.css.backtoPasswordLoginTipPic}).inject(this.formContentNode,"top");this.backtoPasswordLoginAction=new Element("div.backtoPasswordLoginAction",{styles:this.css.backtoPasswordLoginAction}).inject(this.formContentNode,"top");this.backtoPasswordLoginAction.addEvent("click",function(){this.backtoPasswordLogin()}.bind(this))}var t="<table width='100%' bordr='0' cellpadding='0' cellspacing='0' styles='formTable'>"+"<tr><div><div item='passwordAction'>";if(this.codeLogin){t+="</div><div styles='titleSep'></div><div item='codeAction'></div></tr>"}t+="</table>";t+="<table width='100%' bordr='0' cellpadding='0' cellspacing='0' styles='formTable'>"+"<tr item='credentialTr'><td styles='formTableValueTop20' item='credential'></td></tr>"+"<tr item='passwordTr'><td styles='formTableValueTop20' item='password'></td></tr>"+"<tr item='captchaTr'><td styles='formTableValueTop20'>"+"<div item='captchaAnswer' style='float:left;'></div><div item='captchaPic' style='float:left;'></div><div item='changeCaptchaAction' style='float:left;'></div>"+"</td></tr>";if(this.codeLogin){t+="<tr item='codeTr' style='display: none'><td styles='formTableValueTop20'>"+"   <div item='codeAnswer' style='float:left;'></div>"+"   <div item='verificationAction' style='float:left;'></div>"+"   <div item='resendVerificationAction' style='float:left;display:none;'></div>"+"</td></tr>"}t+="<tr><td styles='formTableValueTop20' item='loginAction'></td></tr>"+"</table>"+"<table width='100%' bordr='0' cellpadding='0' cellspacing='0' styles='formTable'>";if(this.signUpMode&&this.signUpMode!=="disable"){t+="<tr><td><div item='signUpAction'></div><div item='forgetPassword'></div></td></tr>"}else{t+="<tr><td><div styles='signUpAction'></div><div item='forgetPassword'></div></td></tr>"}t+="<tr><td  styles='formTableValue' item='errorArea'></td></tr>"+"</table>";this.formTableArea.set("html",t);new Element("div",{styles:{"text-align":"center",height:"40px","line-height":"40px"},text:layout.config.footer||layout.config.systemName}).inject(this.formTableArea,"after");this.setCaptchaPic();this.errorArea=this.formTableArea.getElements("[item=errorArea]")[0];MWF.xDesktop.requireApp("Template","MForm",function(){this.form=new MForm(this.formTableArea,this.data,{style:this.options.popupStyle,verifyType:"single",isEdited:this.isEdited||this.isNew,itemTemplate:{credential:{text:this.lp.userName,defaultValue:this.lp.userName,className:"inputUser",notEmpty:true,defaultValueAsEmpty:true,emptyTip:this.lp.inputYourUserName,event:{focus:function(t){if(this.lp.userName===t.getValue())t.setValue("");if(!t.warningStatus)t.getElements()[0].setStyles(this.css.inputActive)}.bind(this),blur:function(t){if(""===t.getValue())t.setValue(this.lp.userName);if(!t.warningStatus)t.getElements()[0].setStyles(this.css.inputUser)}.bind(this),keyup:function(t,e){if(e.event.keyCode===13)this.ok()}.bind(this)},onEmpty:function(t){t.getElements()[0].setStyles(this.css.inputEmpty)}.bind(this),onUnempty:function(t){t.getElements()[0].setStyles(this.css.inputUser)}.bind(this)},password:{text:this.lp.password,type:"password",defaultValue:"password",className:"inputPassword",notEmpty:true,defaultValueAsEmpty:true,emptyTip:this.lp.inputYourPassword,event:{focus:function(t){if("password"===t.getValue())t.setValue("");if(!t.warningStatus)t.getElements()[0].setStyles(this.css.inputActive)}.bind(this),blur:function(t){if(!t.warningStatus)t.getElements()[0].setStyles(this.css.inputPassword)}.bind(this),keyup:function(t,e){if(e.event.keyCode===13)this.ok()}.bind(this)},onEmpty:function(t){t.getElements()[0].setStyles(this.css.inputEmpty)}.bind(this),onUnempty:function(t){t.getElements()[0].setStyles(this.css.inputPassword)}.bind(this)},captchaAnswer:{tType:"number",text:this.lp.verificationCode,defaultValue:this.lp.verificationCode,className:"inputVerificationCode",notEmpty:true,defaultValueAsEmpty:true,emptyTip:this.lp.inputPicVerificationCode,event:{focus:function(t){if(this.lp.verificationCode===t.getValue())t.setValue("");if(!t.warningStatus)t.getElements()[0].setStyles(this.css.inputActive)}.bind(this),blur:function(t){if(""===t.getValue())t.setValue(this.lp.verificationCode);if(!t.warningStatus)t.getElements()[0].setStyles(this.css.inputVerificationCode)}.bind(this),keyup:function(t,e){if(e.event.keyCode===13)this.ok()}.bind(this)},onEmpty:function(t){t.getElements()[0].setStyles(this.css.inputEmpty)}.bind(this),onUnempty:function(t){t.getElements()[0].setStyles(this.css.inputVerificationCode)}.bind(this)},changeCaptchaAction:{value:this.lp.changeVerification,type:"innerText",className:"verificationChange",event:{click:function(){this.setCaptchaPic()}.bind(this)}},codeAnswer:{text:this.lp.verificationCode,defaultValue:this.lp.inputVerificationCode,className:"inputVerificationCode2",notEmpty:true,defaultValueAsEmpty:true,emptyTip:this.lp.inputVerificationCode,event:{focus:function(t){if(this.lp.inputVerificationCode===t.getValue())t.setValue("");if(!t.warningStatus)t.getElements()[0].setStyles(this.css.inputActive)}.bind(this),blur:function(t){if(""===t.getValue())t.setValue(this.lp.inputVerificationCode);if(!t.warningStatus)t.getElements()[0].setStyles(this.css.inputVerificationCode2)}.bind(this),keyup:function(t,e){if(e.event.keyCode===13)this.ok()}.bind(this)},onEmpty:function(t){t.getElements()[0].setStyles(this.css.inputEmpty)}.bind(this),onUnempty:function(t){t.getElements()[0].setStyles(this.css.inputVerificationCode2)}.bind(this)},verificationAction:{value:this.lp.sendVerification,type:"button",className:"inputSendVerification",event:{click:function(){this.sendVerificationAction()}.bind(this)}},resendVerificationAction:{value:this.lp.resendVerification,type:"button",className:"inputResendVerification"},loginAction:{value:this.lp.loginAction,type:"button",className:"inputLogin",event:{click:function(){this.ok()}.bind(this)}},passwordAction:{value:this.lp.passwordLogin,type:"innerText",className:"titleNode_active",event:{click:function(){if(this.codeLogin)this.showPasswordLogin()}.bind(this)}},codeAction:{value:this.lp.codeLogin,type:"innerText",className:"titleNode_normal",event:{click:function(){this.showCodeLogin()}.bind(this)}},signUpAction:{value:this.lp.signUp,type:"innerText",className:"signUpAction",event:{click:function(){this.gotoSignup()}.bind(this)}},forgetPassword:{value:this.lp.forgetPassword,type:"innerText",className:"forgetPassword",event:{click:function(){this.gotoResetPassword()}.bind(this)}}}},this.app,this.css);this.form.load()}.bind(this),true);if(this.bindLogin){this.bindLoginContainer=new Element("div",{styles:this.css.bindLoginContainer}).inject(this.formContentNode);var e="<div item='bindLoginTitle' styles='bindTitleNode'></div>"+"<div styles='bindBodyArea'>"+"<div item='bindPicArea' styles='bindPicArea'></div>"+"<div styles='bindSepArea'></div>"+"<div styles='bindExampleArea'></div>"+"</div>"+"<div styles='bindTipArea'>"+"   <div styles='bindTipIconArea'></div>"+"   <div styles='bindTipTextArea'>"+"       <div>打开<div styles='bindTipLinkArea'>O2APP</div>扫一扫</div>"+"       <div>登录网页版</div>"+"</div>";this.bindLoginContainer.set("html",e);this.isShowEnable=true;this.bindBodyArea=this.bindLoginContainer.getElements("[styles='bindBodyArea']")[0];this.bindLoginContainer.addEvent("mousemove",function(t){if(this.bindBodyArea.isOutside(t)){this.hideExampleArea(t)}else{this.showExampleArea(t)}}.bind(this));this.bindPicArea=this.bindLoginContainer.getElements("[item='bindPicArea']")[0];this.setBindPic();this.bindExampleArea=this.bindLoginContainer.getElements("[styles='bindExampleArea']")[0];this.bindSepArea=this.bindLoginContainer.getElements("[styles='bindSepArea']")[0];var i=this.bindLoginContainer.getElements("[styles='bindTipLinkArea']")[0];i.addEvent("click",function(){window.open(this.lp.o2downloadLink,"_blank")}.bind(this));MWF.xDesktop.requireApp("Template","MForm",function(){this.bindform=new MForm(this.bindLoginContainer,{},{style:"o2platform",verifyType:"single",isEdited:this.isEdited||this.isNew,itemTemplate:{bindLoginTitle:{value:this.lp.bingLoginTitle,type:"innerText"}}},this.app,this.css);this.bindform.load()}.bind(this),true)}},showExampleArea:function(){if(this.isHiddingExample||this.isShowingExample)return;if(!this.isShowEnable)return;this.isShowingExample=true;var t=this.bindBodyArea.getPosition(this.bindBodyArea.getParent()).x;this.intervalId=setInterval(function(){if(t>136){this.bindBodyArea.setStyle("margin-left",t-5+"px");t=t-5}else{clearInterval(this.intervalId);this.bindBodyArea.setStyle("width","400px");this.bindSepArea.setStyle("display","");this.bindExampleArea.setStyle("display","");this.isHidEnable=true;this.isShowEnable=false;this.isShowingExample=false}}.bind(this),10)},hideExampleArea:function(){if(this.isShowingExample||this.isHiddingExample)return;if(!this.isHidEnable)return;this.isHiddingExample=true;var t=this.bindBodyArea.getPosition(this.bindBodyArea.getParent()).x;this.bindSepArea.setStyle("display","none");this.bindExampleArea.setStyle("display","none");this.intervalId2=setInterval(function(){if(t<220){this.bindBodyArea.setStyle("margin-left",t+5+"px");t=t+5}else{clearInterval(this.intervalId2);this.bindBodyArea.setStyle("width","204px");this.isHidEnable=false;this.isShowEnable=true;this.isHiddingExample=false}}.bind(this),10)},showPasswordLogin:function(){this.errorArea.empty();this.loginType="captcha";this.form.getItem("passwordAction").setStyles(this.css.titleNode_active);this.form.getItem("codeAction").setStyles(this.css.titleNode_normal);this.formTableArea.getElements("[item='passwordTr']")[0].setStyle("display","");this.formTableArea.getElements("[item='captchaTr']")[0].setStyle("display","");this.formTableArea.getElements("[item='codeTr']")[0].setStyle("display","none")},showCodeLogin:function(){this.errorArea.empty();this.loginType="code";this.form.getItem("passwordAction").setStyles(this.css.titleNode_normal);this.form.getItem("codeAction").setStyles(this.css.titleNode_active);this.formTableArea.getElements("[item='passwordTr']")[0].setStyle("display","none");this.formTableArea.getElements("[item='captchaTr']")[0].setStyle("display","none");this.formTableArea.getElements("[item='codeTr']")[0].setStyle("display","")},showBindCodeLogin:function(){this.errorArea.empty();this.formTableContainer.setStyle("display","none");this.bindLoginContainer.setStyle("display","");this.bindLoginTipPic.setStyle("display","none");this.bindLoginAction.setStyle("display","none");this.backtoPasswordLoginTipPic.setStyle("display","");this.backtoPasswordLoginAction.setStyle("display","");this.checkBindStatus()},backtoPasswordLogin:function(){this.errorArea.empty();if(this.bindStatusInterval)clearInterval(this.bindStatusInterval);this.formTableContainer.setStyle("display","");this.bindLoginContainer.setStyle("display","none");this.bindLoginTipPic.setStyle("display","");this.bindLoginAction.setStyle("display","");this.backtoPasswordLoginTipPic.setStyle("display","none");this.backtoPasswordLoginAction.setStyle("display","none")},setBindPic:function(){this.bindPicArea.empty();this.actions.getLoginBind(function(t){this.bindMeta=t.data.meta;new Element("img",{src:"data:image/png;base64,"+t.data.image}).inject(this.bindPicArea)}.bind(this))},setCaptchaPic:function(){var t=this.formTableArea.getElements("[item='captchaPic']")[0];t.empty();this.actions.getLoginCaptcha(120,50,function(e){this.captcha=e.data.id;new Element("img",{src:"data:image/png;base64,"+e.data.image,styles:this.css.verificationImage}).inject(t)}.bind(this))},sendVerificationAction:function(){var t=true;var e=this.form.getItem("credential");var i=e.getValue();if(!i||i.trim()===""){e.setWarning(this.lp.inputYourUserName,"empty");return}else{this.actions.checkCredential(i,function(i){if(!i.data.value){t=false;e.setWarning(this.lp.userNotExist,"invalid")}}.bind(this),function(i){t=false;var s=JSON.parse(i.responseText);e.setWarning(s.message,"invalid")}.bind(this),false)}if(!t){return}else{e.clearWarning("invalid")}this.actions.createCredentialCode(i,function(t){},function(e){var i=JSON.parse(e.responseText);this.setWarning(i.message);t=false}.bind(this));if(!t){return}else{this.errorArea.empty()}this.form.getItem("verificationAction").container.setStyle("display","none");this.setResendVerification()},setResendVerification:function(){var t=this.form.getItem("resendVerificationAction");t.container.setStyle("display","");this.resendElement=t.getElements()[0];this.resendElement.set("text",this.lp.resendVerification+"(60)");var e=60;this.timer=setInterval(function(){if(e>0){this.resendElement.set("text",this.lp.resendVerification+"("+--e+")")}else{this.form.getItem("verificationAction").container.setStyle("display","");t.container.setStyle("display","none");clearInterval(this.timer)}}.bind(this),1e3)},gotoSignup:function(){this.explorer.openSignUpForm();this.close()},gotoResetPassword:function(){this.explorer.openResetPasswordForm();this.close()},checkBindStatus:function(){this.bindStatusInterval=setInterval(function(){this.actions.checkBindStatus(this.bindMeta,function(t){if(t.data){if(t.data.name&&t.data.name!=="anonymous"){this.fireEvent("queryOk");this._close();if(this.formMaskNode)this.formMaskNode.destroy();this.formAreaNode.destroy();if(this.explorer&&this.explorer.view)this.explorer.view.reload();if(this.app)this.app.notice(this.lp.loginSuccess,"success");this.fireEvent("postOk",t)}}}.bind(this),function(t){}.bind(this))}.bind(this),3e3)},_close:function(){if(this.bindStatusInterval)clearInterval(this.bindStatusInterval);if(this.timer)clearInterval(this.timer)},ok:function(){this.fireEvent("queryOk");this.errorArea.empty();var t=null;var e=null;if(this.loginType==="captcha"){this.form.getItem("password").options.notEmpty=true;t=this.form.getItem("captchaAnswer");if(t)t.options.notEmpty=true;e=this.form.getItem("codeAnswer");if(e)e.options.notEmpty=false}else if(this.loginType==="code"){this.form.getItem("password").options.notEmpty=false;t=this.form.getItem("captchaAnswer");if(t)t.options.notEmpty=false;e=this.form.getItem("codeAnswer");if(e)e.options.notEmpty=true}var i=this.form.getResult(true,",",true,false,true);if(i){this._ok(i,function(t){if(t.type==="error"){if(this.app)this.app.notice(t.message,"error")}else{this._close();if(this.formMaskNode)this.formMaskNode.destroy();this.formAreaNode.destroy();if(this.explorer&&this.explorer.view)this.explorer.view.reload();if(this.app)this.app.notice(this.lp.loginSuccess,"success");this.fireEvent("postOk",t)}}.bind(this))}},setWarning:function(t){this.errorArea.empty();new Element("div",{text:t,styles:this.css.warningMessageNode}).inject(this.errorArea)},_ok:function(t,e){var i=null;if(this.loginType==="captcha"){i={credential:t.credential,password:t.password,captchaAnswer:t.captchaAnswer,captcha:this.captcha};this.actions.loginByCaptcha(i,function(t){if(e)e(t)}.bind(this),function(t){var e=JSON.parse(t.responseText);this.setWarning(e.message);this.setCaptchaPic();this.form.getItem("captchaAnswer").setValue("")}.bind(this))}else if(this.loginType==="code"){i={credential:t.credential,codeAnswer:t.codeAnswer};this.actions.loginByCode(i,function(t){if(e)e(t)}.bind(this),function(t){var e=JSON.parse(t.responseText);this.setWarning(e.message)}.bind(this))}}});MWF.xDesktop.Authentication.SignUpForm=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"default",popupStyle:"o2platformSignup",width:"900",height:"620",hasTop:true,hasIcon:false,hasTopIcon:true,hasTopContent:true,hasBottom:false,title:MWF.LP.authentication.SignUpFormTitle,draggable:true,closeAction:true},_createTableContent:function(){var t="code";this.actions.getRegisterMode(function(e){t=e.data.value}.bind(this),null,false);this.formTableContainer.setStyles({width:"900px","margin-top":"50px"});var e="<table width='100%' bordr='0' cellpadding='5' cellspacing='0' styles='formTable'>"+"<tr><td styles='formTableTitle' lable='name' width='200'></td>"+"   <td styles='formTableValue' item='name' width='350'></td>"+"   <td styles='formTableValue' item='nameTip'></td></tr>"+"<tr><td styles='formTableTitle' lable='password'></td>"+"   <td styles='formTableValue' item='password'></td>"+"   <td styles='formTableValue'><div item='passwordStrengthArea'></div></div><div item='passwordTip'></div></td></tr>"+"<tr><td styles='formTableTitle' lable='confirmPassword'></td>"+"   <td styles='formTableValue' item='confirmPassword'></td>"+"   <td styles='formTableValue' item='confirmPasswordTip'></td></tr>"+"<tr><td styles='formTableTitle' lable='genderType'></td>"+"   <td styles='formTableValue' item='genderType'></td>"+"   <td styles='formTableValue' item='genderTypeTip'></td></tr>"+"<tr><td styles='formTableTitle' lable='mobile'></td>"+"   <td styles='formTableValue' item='mobile'></td>"+"   <td styles='formTableValue' item='mobileTip'></td></tr>";if(t==="code"){e+="<tr><td styles='formTableTitle' lable='codeAnswer'></td>"+"   <td styles='formTableValue'><div item='codeAnswer' style='float:left;'></div><div item='verificationAction' style='float:left;'></div><div item='resendVerificationAction' style='float:left;display:none;'></div></td>"+"   <td styles='formTableValue' item='verificationCodeTip'></td></tr>"}else{e+="<tr><td styles='formTableTitle' lable='captchaAnswer'></td>"+"   <td styles='formTableValue'><div item='captchaAnswer' style='float:left;'></div><div item='captchaPic' style='float:left;'></div><div item='changeCaptchaAction' style='float:left;'></div></td>"+"   <td styles='formTableValue' item='captchaAnswerTip'></td></tr>"}e+="<tr><td styles='formTableTitle'></td>"+"   <td styles='formTableValue' item='signUpAction'></td>"+"   <td styles='formTableValue' item='signUpTip'></td></tr>"+"<tr><td></td>"+"   <td><div item='hasAccountArea'></div><div item='gotoLoginAction'></div></td>"+"   <td></td></tr>"+"</table>";this.formTableArea.set("html",e);if(t==="captcha"){this.setCaptchaPic()}this.createPasswordStrengthNode();MWF.xDesktop.requireApp("Template","MForm",function(){this.form=new MForm(this.formTableArea,this.data,{style:this.options.popupStyle,verifyType:"batchSingle",isEdited:this.isEdited||this.isNew,onPostLoad:function(){var t=this.form;var e=this.formTableArea;t.getItem("name").tipNode=e.getElements("[item='nameTip']")[0];t.getItem("password").tipNode=e.getElements("[item='passwordTip']")[0];t.getItem("confirmPassword").tipNode=e.getElements("[item='confirmPasswordTip']")[0];t.getItem("genderType").tipNode=e.getElements("[item='genderTypeTip']")[0];t.getItem("mobile").tipNode=e.getElements("[item='mobileTip']")[0];this.tipNode=e.getElements("[item='signUpTip']")[0];var i=t.getItem("captchaAnswer");if(i){t.getItem("captchaAnswer").tipNode=e.getElements("[item='captchaAnswerTip']")[0]}var s=t.getItem("codeAnswer");if(s){t.getItem("codeAnswer").tipNode=e.getElements("[item='verificationCodeTip']")[0]}}.bind(this),itemTemplate:{name:{text:this.lp.userName,defaultValue:this.lp.userName,className:"inputUser",notEmpty:true,defaultValueAsEmpty:true,emptyTip:this.lp.inputYourUserName,validRule:{isInvalid:function(t,e){return this.checkUserName(t,e)}.bind(this)},validMessage:{isInvalid:this.lp.userExist},event:{focus:function(t){if(this.lp.userName===t.getValue())t.setValue("");if(!t.warningStatus)t.getElements()[0].setStyles(this.css.inputActive)}.bind(this),keyup:function(t,e){if(e.event.keyCode===13){this.ok()}}.bind(this),blur:function(t){if(t.verify(true)){if(!t.warningStatus)t.getElements()[0].setStyles(this.css.inputUser)}}.bind(this)},onEmpty:function(t){t.getElements()[0].setStyles(this.css.inputEmpty)}.bind(this),onUnempty:function(t){t.getElements()[0].setStyles(this.css.inputUser)}.bind(this)},password:{text:this.lp.password,type:"password",className:"inputPassword",notEmpty:true,defaultValueAsEmpty:true,emptyTip:this.lp.inputYourPassword,validRule:{passwordIsWeak:function(t,e){if(this.getPasswordLevel(e.getValue())>3)return true}.bind(this)},validMessage:{passwordIsWeak:this.lp.passwordIsSimple},event:{focus:function(t){if("password"===t.getValue())t.setValue("");if(!t.warningStatus)t.getElements()[0].setStyles(this.css.inputActive)}.bind(this),keyup:function(t){this.pwStrength(t.getValue())}.bind(this),blur:function(t){t.verify(true)}.bind(this)},onEmpty:function(t){t.getElements()[0].setStyles(this.css.inputEmpty)}.bind(this),onUnempty:function(t){t.getElements()[0].setStyles(this.css.inputPassword)}.bind(this)},confirmPassword:{text:this.lp.confirmPassword,type:"password",className:"inputComfirmPassword",notEmpty:true,defaultValueAsEmpty:true,emptyTip:this.lp.inputComfirmPassword,validRule:{passwordNotEqual:function(t,e){if(e.getValue()===this.form.getItem("password").getValue())return true}.bind(this)},validMessage:{passwordNotEqual:this.lp.passwordNotEqual},event:{focus:function(t){if("password"===t.getValue())t.setValue("");if(!t.warningStatus)t.getElements()[0].setStyles(this.css.inputActive);
}.bind(this),keyup:function(t,e){if(e.event.keyCode===13){this.ok()}}.bind(this),blur:function(t){if(t.verify(true)){if(!t.warningStatus)t.getElements()[0].setStyles(this.css.inputComfirmPassword)}}.bind(this)},onEmpty:function(t){t.getElements()[0].setStyles(this.css.inputEmpty)}.bind(this),onUnempty:function(t){t.getElements()[0].setStyles(this.css.inputComfirmPassword)}.bind(this)},mail:{text:this.lp.mail,defaultValue:this.lp.inputYourMail,className:"inputMail",notEmpty:true,defaultValueAsEmpty:true,emptyTip:this.lp.inputYourMail,validRule:{email:true},event:{focus:function(t){if(this.lp.inputYourMail===t.getValue())t.setValue("");if(!t.warningStatus)t.getElements()[0].setStyles(this.css.inputActive)}.bind(this),blur:function(t){t.verify(true);if(!t.warningStatus)t.getElements()[0].setStyles(this.css.inputMail)}.bind(this),keyup:function(t,e){if(e.event.keyCode===13){this.ok()}}.bind(this)},onEmpty:function(t){t.getElements()[0].setStyles(this.css.inputEmpty)}.bind(this),onUnempty:function(t){t.getElements()[0].setStyles(this.css.inputMail)}.bind(this)},genderType:{text:this.lp.genderType,className:"inputGenderType",type:"select",selectValue:this.lp.genderTypeValue.split(","),selectText:this.lp.genderTypeText.split(","),notEmpty:true,emptyTip:this.lp.selectGenderType,event:{focus:function(t){if(!t.warningStatus)t.getElements()[0].setStyles(this.css.inputActive)}.bind(this),blur:function(t){t.verify(true);if(!t.warningStatus)t.getElements()[0].setStyles(this.css.inputGenderType)}.bind(this),keyup:function(t,e){if(e.event.keyCode===13){this.ok()}}.bind(this)},onEmpty:function(t){t.getElements()[0].setStyles(this.css.inputEmpty)}.bind(this),onUnempty:function(t){t.getElements()[0].setStyles(this.css.inputGenderType)}.bind(this)},mobile:{text:this.lp.mobile,defaultValue:this.lp.inputYourMobile,className:"inputMobile",tType:"number",notEmpty:true,defaultValueAsEmpty:true,emptyTip:this.lp.inputYourMobile,validRule:{isInvalid:function(t,e){return this.checkMobile(t,e)}.bind(this)},validMessage:{isInvalid:this.lp.mobileIsRegisted},event:{focus:function(t){if(this.lp.inputYourMobile===t.getValue())t.setValue("");if(!t.warningStatus)t.getElements()[0].setStyles(this.css.inputActive)}.bind(this),keyup:function(t,e){if(e.event.keyCode===13){this.ok()}}.bind(this),blur:function(t){if(t.verify(true)){if(!t.warningStatus)t.getElements()[0].setStyles(this.css.inputMobile)}}.bind(this)},onEmpty:function(t){t.getElements()[0].setStyles(this.css.inputEmpty)}.bind(this),onUnempty:function(t){t.getElements()[0].setStyles(this.css.inputMobile)}.bind(this)},captchaAnswer:{tType:"number",text:this.lp.verificationCode,defaultValue:this.lp.verificationCode,className:"inputVerificationCode",notEmpty:true,defaultValueAsEmpty:true,emptyTip:this.lp.inputPicVerificationCode,event:{focus:function(t){if(this.lp.verificationCode===t.getValue())t.setValue("");if(!t.warningStatus)t.getElements()[0].setStyles(this.css.inputActive)}.bind(this),blur:function(t){t.verify(true);if(!t.warningStatus)t.getElements()[0].setStyles(this.css.inputVerificationCode)}.bind(this),keyup:function(t,e){if(e.event.keyCode===13){this.ok()}}.bind(this)},onEmpty:function(t){t.getElements()[0].setStyles(this.css.inputEmpty)}.bind(this),onUnempty:function(t){t.getElements()[0].setStyles(this.css.inputVerificationCode)}.bind(this)},changeCaptchaAction:{value:this.lp.changeVerification,type:"innerText",className:"verificationChange",event:{click:function(){this.setCaptchaPic()}.bind(this)}},codeAnswer:{text:this.lp.verificationCode,defaultValue:this.lp.inputVerificationCode,className:"inputVerificationCode2",notEmpty:true,defaultValueAsEmpty:true,emptyTip:this.lp.inputVerificationCode,event:{focus:function(t){if(this.lp.inputVerificationCode===t.getValue())t.setValue("");if(!t.warningStatus)t.getElements()[0].setStyles(this.css.inputActive)}.bind(this),blur:function(t){t.verify(true);if(!t.warningStatus)t.getElements()[0].setStyles(this.css.inputVerificationCode2)}.bind(this),keyup:function(t,e){if(e.event.keyCode===13){this.ok()}}.bind(this)},onEmpty:function(t){t.getElements()[0].setStyles(this.css.inputEmpty)}.bind(this),onUnempty:function(t){t.getElements()[0].setStyles(this.css.inputVerificationCode2)}.bind(this)},verificationAction:{value:this.lp.sendVerification,type:"button",className:"inputSendVerification",event:{click:function(){this.sendVerificationAction()}.bind(this)}},resendVerificationAction:{value:this.lp.resendVerification,type:"button",className:"inputResendVerification"},signUpAction:{value:this.lp.signUp,type:"button",className:"inputSignUp",event:{click:function(){this.ok()}.bind(this)}},hasAccountArea:{value:this.lp.hasAccount,type:"innerText",className:"hasCountArea"},gotoLoginAction:{value:this.lp.gotoLogin,type:"innerText",className:"gotoLoginAction",event:{click:function(){this.gotoLogin()}.bind(this)}}}},this.app,this.css);this.form.load()}.bind(this),true)},checkMobile:function(t,e){var i=true;this.actions.checkRegisterMobile(t,function(){i=true}.bind(this),function(t){if(t.status===404){e.options.validMessage.isInvalid=this.lp.pageNotFound;i=false}else{var s=JSON.parse(t.responseText);e.options.validMessage.isInvalid=s.message;i=false}}.bind(this),false);return i},checkUserName:function(t,e){var i=true;this.actions.checkRegisterName(t,function(){i=true}.bind(this),function(t){if(t.status===404){e.options.validMessage.isInvalid=this.lp.pageNotFound;i=false}else{var s=JSON.parse(t.responseText);e.options.validMessage.isInvalid=s.message;i=false}}.bind(this),false);return i},setCaptchaPic:function(){var t=this.formTableArea.getElements("[item='captchaPic']")[0];t.empty();this.actions.getRegisterCaptcha(120,50,function(e){this.captcha=e.data.id;new Element("img",{src:"data:image/png;base64,"+e.data.image,styles:this.css.verificationImage}).inject(t)}.bind(this))},sendVerificationAction:function(){var t=true;var e=this.form.getItem("mobile");if(e.verify(true)){e.clearWarning();e.getElements()[0].setStyles(this.css.inputMobile)}else{return}this.actions.createRegisterCode(e.getValue(),function(t){},function(e){var i=this.form.getItem("codeAnswer");var s=JSON.parse(e.responseText);if(e.status===404){i.setWarning(s.message,this.lp.pageNotFound);t=false}else{i.setWarning(s.message,"invalid");t=false}}.bind(this),false);if(!t)return false;this.form.getItem("verificationAction").container.setStyle("display","none");this.setResendVerification()},setResendVerification:function(){var t=this.form.getItem("resendVerificationAction");t.container.setStyle("display","");this.resendElement=t.getElements()[0];this.resendElement.set("text",this.lp.resendVerification+"(60)");var e=60;this.timer=setInterval(function(){if(e>0){this.resendElement.set("text",this.lp.resendVerification+"("+--e+")")}else{this.form.getItem("verificationAction").container.setStyle("display","");t.container.setStyle("display","none");clearInterval(this.timer)}}.bind(this),1e3)},createPasswordStrengthNode:function(){var t=this.formTableArea.getElements("[item='passwordStrengthArea']")[0];var e=new Element("div",{styles:this.css.passwordStrengthNode}).inject(t);this.lowColorNode=new Element("div",{styles:this.css.passwordStrengthColor}).inject(e);this.lowTextNode=new Element("div",{styles:this.css.passwordStrengthText,text:this.lp.weak}).inject(e);var i=new Element("div",{styles:this.css.passwordStrengthNode}).inject(t);this.middleColorNode=new Element("div",{styles:this.css.passwordStrengthColor}).inject(i);this.middleTextNode=new Element("div",{styles:this.css.passwordStrengthText,text:this.lp.middle}).inject(i);var s=new Element("div",{styles:this.css.passwordStrengthNode}).inject(t);this.highColorNode=new Element("div",{styles:this.css.passwordStrengthColor}).inject(s);this.highTextNode=new Element("div",{styles:this.css.passwordStrengthText,text:this.lp.high}).inject(s)},getPasswordLevel:function(t){var e=0;this.actions.checkRegisterPassword(t,function(t){e=t.data.value}.bind(this),null,false);return e},pwStrength:function(t){this.lowColorNode.setStyles(this.css.passwordStrengthColor);this.lowTextNode.setStyles(this.css.passwordStrengthText);this.middleColorNode.setStyles(this.css.passwordStrengthColor);this.middleTextNode.setStyles(this.css.passwordStrengthText);this.highColorNode.setStyles(this.css.passwordStrengthColor);this.highTextNode.setStyles(this.css.passwordStrengthText);if(!t){}else{var e=this.getPasswordLevel(t);switch(e){case 0:case 1:case 2:case 3:this.lowColorNode.setStyles(this.css.passwordStrengthColor_low);this.lowTextNode.setStyles(this.css.passwordStrengthText_current);break;case 4:case 5:case 6:this.middleColorNode.setStyles(this.css.passwordStrengthColor_middle);this.middleTextNode.setStyles(this.css.passwordStrengthText_current);break;default:this.highColorNode.setStyles(this.css.passwordStrengthColor_high);this.highTextNode.setStyles(this.css.passwordStrengthText_current)}}},gotoLogin:function(){this.explorer.openLoginForm({},function(){window.location.reload()});this.close()},setWarning:function(t){this.tipNode.empty();new Element("div",{text:t,styles:this.css.warningMessageNode}).inject(this.tipNode)},setNotice:function(t){this.tipNode.empty();new Element("div",{text:t,styles:this.css.noticeMessageNode}).inject(this.tipNode)},ok:function(){this.tipNode.empty();this.fireEvent("queryOk");var t=this.form.getResult(true,",",true,false,true);if(t){this._ok(t,function(t){if(t.type==="error"){if(this.app)this.app.notice(t.message,"error")}else{if(this.formMaskNode)this.formMaskNode.destroy();this.formAreaNode.destroy();this.setNotice(this.lp.registeSuccess);if(this.app)this.app.notice(this.lp.registeSuccess,"success");this.fireEvent("postOk",t);this.gotoLogin()}}.bind(this))}},_ok:function(t,e){t.captcha=this.captcha;this.actions.register(t,function(t){if(e)e(t)}.bind(this),function(t){if(t.status===404){this.setWarning(this.lp.pageNotFound)}else{var e=JSON.parse(t.responseText);this.setWarning(e.message)}}.bind(this))}});MWF.xDesktop.Authentication.ResetPasswordForm=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"default",popupStyle:"o2platformSignup",width:"700",height:"450",hasTop:true,hasIcon:false,hasTopIcon:true,hasTopContent:true,hasBottom:false,title:MWF.LP.authentication.ResetPasswordFormTitle,draggable:true,closeAction:true},_createTopContent:function(){this.actions.getRegisterMode(function(t){this.signUpMode=t.data.value}.bind(this),null,false);if(this.signUpMode&&this.signUpMode!=="disable"){this.gotoSignupNode=new Element("div",{styles:this.css.formTopContentCustomNode,text:this.lp.signUp}).inject(this.formTopContentNode);this.gotoSignupNode.addEvent("click",function(){this.gotoSignup()}.bind(this));new Element("div",{styles:this.css.formTopContentSepNode}).inject(this.formTopContentNode)}this.gotoLoginNode=new Element("div",{styles:this.css.formTopContentCustomNode,text:this.lp.loginAction}).inject(this.formTopContentNode);this.gotoLoginNode.addEvent("click",function(){this.gotoLogin()}.bind(this))},_createTableContent:function(){this.formTableContainer.setStyles(this.css.formTableContainer2);this.loadSteps();this.loadStepForm_1();this.loadStepForm_2();this.loadStepForm_3()},reset:function(){this.formTableArea.empty();this._createTableContent()},loadSteps:function(){var t=new Element("div",{styles:this.css.stepsContainer}).inject(this.formTableArea);this.step_1=new Element("div",{styles:this.css.step_1_active,text:this.lp.shotMessageCheck}).inject(t);this.stepLink_1=new Element("div",{styles:this.css.stepLink_1}).inject(this.step_1);this.step_2=new Element("div",{styles:this.css.step_2,text:this.lp.setMewPassword}).inject(t);this.stepLink_2=new Element("div",{styles:this.css.stepLink_2}).inject(this.step_2);this.step_3=new Element("div",{styles:this.css.step_3,text:this.lp.completed}).inject(t)},loadStepForm_1:function(){var t="<table width='100%' bordr='0' cellpadding='5' cellspacing='0' styles='formTable'>"+"<tr><td styles='formTableTitle' lable='name' width='80'></td>"+"   <td styles='formTableValue' item='name' width='350'></td></tr>"+"<tr><td styles='formTableTitle' lable='codeAnswer'></td>"+"   <td styles='formTableValue'>"+"       <div item='codeAnswer' style='float:left;'></div>"+"       <div item='verificationAction' style='float:left;'></div>"+"       <div item='resendVerificationAction' style='float:left;display:none;'></div></td>"+"   </tr>"+"<tr><td styles='formTableTitle'></td>"+"   <td styles='formTableValue' item='nextStep'></td></tr>"+"</table>";this.stepNode_1=new Element("div",{html:t,styles:{display:""}}).inject(this.formTableArea);MWF.xDesktop.requireApp("Template","MForm",function(){this.stepForm_1=new MForm(this.stepNode_1,{},{style:this.options.popupStyle,verifyType:"single",isEdited:this.isEdited||this.isNew,itemTemplate:{name:{text:this.lp.userName,defaultValue:this.lp.userName,className:"inputUser",notEmpty:true,defaultValueAsEmpty:true,emptyTip:this.lp.inputYourUserName,validRule:{isInvalid:function(t,e){return this.checkUserName(t,e)}.bind(this)},validMessage:{isInvalid:this.lp.userNotExist},event:{focus:function(t){if(this.lp.userName===t.getValue())t.setValue("");if(!t.warningStatus)t.getElements()[0].setStyles(this.css.inputActive)}.bind(this),blur:function(t){if(t.getValue()==="")t.setValue(this.lp.userName);if(!t.warningStatus)t.getElements()[0].setStyles(this.css.inputUser)}.bind(this),keyup:function(t,e){if(e.event.keyCode===13){this.gotoStep(2)}}.bind(this)},onEmpty:function(t){t.getElements()[0].setStyles(this.css.inputEmpty)}.bind(this),onUnempty:function(t){t.getElements()[0].setStyles(this.css.inputUser)}.bind(this)},codeAnswer:{text:this.lp.verificationCode,defaultValue:this.lp.inputVerificationCode,className:"inputVerificationCode2",notEmpty:true,defaultValueAsEmpty:true,emptyTip:this.lp.inputVerificationCode,event:{focus:function(t){if(this.lp.inputVerificationCode===t.getValue())t.setValue("");if(!t.warningStatus)t.getElements()[0].setStyles(this.css.inputActive)}.bind(this),blur:function(t){if(t.getValue()==="")t.setValue(this.lp.inputVerificationCode);if(!t.warningStatus)t.getElements()[0].setStyles(this.css.inputVerificationCode2)}.bind(this),keyup:function(t,e){if(e.event.keyCode===13){this.gotoStep(2)}}.bind(this)},onEmpty:function(t){t.getElements()[0].setStyles(this.css.inputEmpty)}.bind(this),onUnempty:function(t){t.getElements()[0].setStyles(this.css.inputVerificationCode2)}.bind(this)},verificationAction:{value:this.lp.sendVerification,type:"button",className:"inputSendVerification",event:{click:function(){this.sendVerificationAction()}.bind(this)}},resendVerificationAction:{value:this.lp.resendVerification,type:"button",className:"inputResendVerification"},nextStep:{value:this.lp.nextStep,type:"button",className:"inputSignUp",event:{click:function(){this.gotoStep(2)}.bind(this)}}}},this.app,this.css);this.stepForm_1.load()}.bind(this),true)},loadStepForm_2:function(){html="<table width='100%' bordr='0' cellpadding='5' cellspacing='0' styles='formTable'>"+"<tr><td styles='formTableTitle' lable='password' width='80'></td>"+"   <td styles='formTableValue' item='password' width='350'></td>"+"   <td styles='formTableValue'><div item='passwordStrengthArea'></div></td></tr>"+"<tr><td styles='formTableTitle' lable='confirmPassword'></td>"+"   <td styles='formTableValue' item='confirmPassword'></td>"+"   <td styles='formTableValue'></td></tr>"+"<tr><td styles='formTableTitle'></td>"+"   <td styles='formTableValue' item='nextStep'></td>"+"   <td styles='formTableValue'></td></tr>"+"</table>";this.stepNode_2=new Element("div",{html:html,styles:{display:"none"}}).inject(this.formTableArea);MWF.xDesktop.requireApp("Template","MForm",function(){this.stepForm_2=new MForm(this.stepNode_2,{},{style:"o2platformSignup",verifyType:"single",isEdited:this.isEdited||this.isNew,itemTemplate:{password:{text:this.lp.setNewPassword,type:"password",className:"inputPassword",notEmpty:true,defaultValueAsEmpty:true,emptyTip:this.lp.inputYourPassword,validRule:{passwordIsWeak:function(t,e){if(this.getPasswordLevel(e.getValue())>3)return true}.bind(this)},validMessage:{passwordIsWeak:this.lp.passwordIsWeak},event:{focus:function(t){if("password"===t.getValue())t.setValue("");if(!t.warningStatus)t.getElements()[0].setStyles(this.css.inputActive)}.bind(this),blur:function(t){if(!t.warningStatus)t.getElements()[0].setStyles(this.css.inputPassword)}.bind(this),keyup:function(t){this.pwStrength(t.getValue())}.bind(this)},onEmpty:function(t){t.getElements()[0].setStyles(this.css.inputEmpty)}.bind(this),onUnempty:function(t){t.getElements()[0].setStyles(this.css.inputPassword)}.bind(this)},confirmPassword:{text:this.lp.confirmNewPassword,type:"password",className:"inputComfirmPassword",notEmpty:true,defaultValueAsEmpty:true,emptyTip:this.lp.inputComfirmPassword,validRule:{passwordNotEqual:function(t,e){if(e.getValue()===this.stepForm_2.getItem("password").getValue())return true}.bind(this)},validMessage:{passwordNotEqual:this.lp.passwordNotEqual},event:{focus:function(t){if("password"===t.getValue())t.setValue("");if(!t.warningStatus)t.getElements()[0].setStyles(this.css.inputActive)}.bind(this),blur:function(t){if(!t.warningStatus)t.getElements()[0].setStyles(this.css.inputComfirmPassword)}.bind(this),keyup:function(t,e){if(e.event.keyCode===13){this.gotoStep(3)}}.bind(this)},onEmpty:function(t){t.getElements()[0].setStyles(this.css.inputEmpty)}.bind(this),onUnempty:function(t){t.getElements()[0].setStyles(this.css.inputComfirmPassword)}.bind(this)},nextStep:{value:this.lp.nextStep,type:"button",className:"inputSignUp",event:{click:function(){this.gotoStep(3)}.bind(this)}}}},this.app,this.css);this.stepForm_2.load()}.bind(this),true);this.createPasswordStrengthNode()},loadStepForm_3:function(){this.stepNode_3=new Element("div",{styles:this.css.stepFormResult}).inject(this.formTableArea)},createSetForm_3:function(t,e){var i=null;var s=null;if(t){this.stepNode_3.setStyles(this.css.stepFormResult);this.stepNode_3.setStyle("display","");new Element("div",{styles:this.css.resetPasswordSuccess,text:this.lp.resetPasswordSuccess}).inject(this.stepNode_3);i=new Element("div",{styles:this.css.resetPasswordResultArea}).inject(this.stepNode_3);new Element("div",{styles:this.css.resetPasswordResultWord,text:this.lp.resetPasswordSuccessWord}).inject(i);s=new Element("div",{styles:this.css.resetPasswordResultAction,text:this.lp.gotoLogin}).inject(i);s.addEvent("click",function(){this.gotoLogin()}.bind(this))}else{this.stepNode_3.setStyles(this.css.stepFormResult_fail);this.stepNode_3.setStyle("display","");new Element("div",{styles:this.css.resetPasswordFail,text:e+this.lp.resetPasswordFail}).inject(this.stepNode_3);i=new Element("div",{styles:this.css.resetPasswordResultArea}).inject(this.stepNode_3);new Element("div",{styles:this.css.resetPasswordResultWord,text:this.lp.resetPasswordFailWord}).inject(i);s=new Element("div",{styles:this.css.resetPasswordResultAction,text:this.lp.backtoModify}).inject(i);s.addEvent("click",function(){this.reset()}.bind(this))}},gotoStep:function(t){var e=this["stepForm_"+(t-1)];e.clearWarning();var i=e.getResult(true,",",true,false,true);if(!i){return}var s;for(s=1;s<=t;s++){this["step_"+s].setStyles(this.css["step_"+s+"_active"]);if(s!==t&&this["stepLink_"+s]){this["stepLink_"+s].setStyles(this.css["stepLink_"+s+"_active"])}}for(s=t+1;s<=3;s++){this["step_"+s].setStyles(this.css["step_"+s]);if(s!==3){this["stepLink_"+s].setStyles(this.css["stepLink_"+s])}}for(s=1;s<=3;s++){if(s===t){this["stepNode_"+s].setStyle("display","")}else{this["stepNode_"+s].setStyle("display","none")}}if(t===3){var n={credential:this.stepForm_1.getItem("name").getValue(),codeAnswer:this.stepForm_1.getItem("codeAnswer").getValue(),password:this.stepForm_2.getItem("password").getValue()};this.actions.resetPassword(n,function(){this.createSetForm_3(true)}.bind(this),function(t){var e=JSON.parse(t.responseText);this.createSetForm_3(false,e.message)}.bind(this),false)}},checkMobile:function(t){var e=true;this.actions.checkRegisterMobile(t,function(){e=true}.bind(this),function(){e=false}.bind(this),false);return e},checkUserName:function(t,e){var i=false;this.actions.checkCredentialOnResetPassword(t,function(t){if(t.data){i=t.data.value}}.bind(this),function(t){if(t.status===404){e.options.validMessage.isInvalid=this.lp.pageNotFound;i=false}else{var s=JSON.parse(t.responseText);e.options.validMessage.isInvalid=s.message;i=false}}.bind(this),false);return i},sendVerificationAction:function(){var t=true;var e=this.stepForm_1.getItem("name");this.stepForm_1.clearWarning();if(e.verify(true)){}else{return}this.actions.createCodeOnResetPassword(e.getValue(),function(t){},function(i){var s=JSON.parse(i.responseText);e.setWarning(s.message,"invalid");t=false}.bind(this),false);if(!t)return false;this.stepForm_1.getItem("verificationAction").container.setStyle("display","none");this.setResendVerification()},setResendVerification:function(){var t=this.stepForm_1.getItem("resendVerificationAction");t.container.setStyle("display","");this.resendElement=t.getElements()[0];this.resendElement.set("text",this.lp.resendVerification+"(60)");var e=60;this.timer=setInterval(function(){if(e>0){this.resendElement.set("text",this.lp.resendVerification+"("+--e+")")}else{this.stepForm_1.getItem("verificationAction").container.setStyle("display","");t.container.setStyle("display","none");clearInterval(this.timer)}}.bind(this),1e3)},createPasswordStrengthNode:function(){var t=this.formTableArea.getElements("[item='passwordStrengthArea']")[0];var e=new Element("div",{styles:this.css.passwordStrengthNode}).inject(t);this.lowColorNode=new Element("div",{styles:this.css.passwordStrengthColor}).inject(e);this.lowTextNode=new Element("div",{styles:this.css.passwordStrengthText,text:this.lp.weak}).inject(e);var i=new Element("div",{styles:this.css.passwordStrengthNode}).inject(t);this.middleColorNode=new Element("div",{styles:this.css.passwordStrengthColor}).inject(i);this.middleTextNode=new Element("div",{styles:this.css.passwordStrengthText,text:this.lp.middle}).inject(i);var s=new Element("div",{styles:this.css.passwordStrengthNode}).inject(t);this.highColorNode=new Element("div",{styles:this.css.passwordStrengthColor}).inject(s);this.highTextNode=new Element("div",{styles:this.css.passwordStrengthText,text:this.lp.high}).inject(s)},getPasswordLevel:function(t){var e=0;this.actions.checkRegisterPassword(t,function(t){e=t.data.value}.bind(this),null,false);return e},pwStrength:function(t){this.lowColorNode.setStyles(this.css.passwordStrengthColor);this.lowTextNode.setStyles(this.css.passwordStrengthText);this.middleColorNode.setStyles(this.css.passwordStrengthColor);this.middleTextNode.setStyles(this.css.passwordStrengthText);this.highColorNode.setStyles(this.css.passwordStrengthColor);this.highTextNode.setStyles(this.css.passwordStrengthText);if(!t){}else{var e=this.getPasswordLevel(t);switch(e){case 0:case 1:case 2:case 3:this.lowColorNode.setStyles(this.css.passwordStrengthColor_low);this.lowTextNode.setStyles(this.css.passwordStrengthText_current);break;case 4:case 5:case 6:this.middleColorNode.setStyles(this.css.passwordStrengthColor_middle);this.middleTextNode.setStyles(this.css.passwordStrengthText_current);break;default:this.highColorNode.setStyles(this.css.passwordStrengthColor_high);this.highTextNode.setStyles(this.css.passwordStrengthText_current)}}},gotoLogin:function(){this.explorer.openLoginForm({},function(){window.location.reload()});this.close()},gotoSignup:function(){this.explorer.openSignUpForm();this.close()}});