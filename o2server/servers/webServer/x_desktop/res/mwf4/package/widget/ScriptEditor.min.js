MWF.widget=MWF.widget||{};MWF.require("MWF.widget.Common",null,false);MWF.widget.ScriptEditor=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default",keySeparat:/[\.\,\;\s\{\}\(\)\n\r\t\:\/\*\"\'=\[\]\+\-\/]+/gi,keyCodes:[220,46,13,222,219,221,57,48,191,190,186,188,32,55,187,189,8,9]},initialize:function(e,t){this.setOptions(t);this.node=$(e);this.path=MWF.defaultPath+"/widget/$ScriptEditor/";this.cssPath=MWF.defaultPath+"/widget/$ScriptEditor/"+this.options.style+"/css.wcss";this._loadCss();this.checkTextNodes=[];this.checkAll=false},load:function(e,t){if(this.fireEvent("queryLoad")){this.createContent(e,t);this.fireEvent("postLoad")}},toCode:function(){return this.editDocument.body.innerText},toHTML:function(){return this.editDocument.body.innerHTML},focus:function(){this.editDocument.body.focus()},createContent:function(e,t){this.editArea=new Element("iframe",{styles:this.css.contentEditArea,border:"0",frameBorder:"0",marginHeight:"0",marginWidth:"0",scrolling:"auto"}).inject(this.node);this.loadContent(e,t)},loadContent:function(e,t){this.editDocument=this.editArea.contentWindow.document;this.editWindow=this.editArea.contentWindow;if(t){this.editDocument.write('<style type="text/css">p {margin:0px;}</style><body style="overflow:visible; word-break:keep-all; word-wrap:normal; font-size:12px; font-family:Verdana, Geneva, sans-serif; line-height:20px;">'+t+"</body>")}else{this.editDocument.write('<style type="text/css">p {margin:0px;}</style><body style="overflow:visible; word-break:keep-all; word-wrap:normal; font-size:12px; font-family:Verdana, Geneva, sans-serif; line-height:20px;">'+e+"</body>")}this.editDocument.designMode="On";this.clearFontElements(this.editDocument.body);this.checkScriptFormatComment(this.editDocument.body);this.checkScriptFormatString(this.editDocument.body);this.checkScriptFormatNumber(this.editDocument.body);this.checkScriptFormatKeyword(this.editDocument.body);this.setBodyEvent()},addElementEvent:function(e,t,i){if(e.addEventListener){e.addEventListener(t,i)}else{e.attachEvent("on"+t,function(){return i()})}},setBodyEvent:function(){this.editDocument.body.style.whiteSpace="nowrap";this.addElementEvent(this.editDocument.body,"blur",function(e){this.fireEvent("change")}.bind(this));this.addElementEvent(this.editDocument.body,"keydown",function(e){if(e.keyCode==9){var t=this.editWindow.getSelection();var i=t.getRangeAt(0);i.insertNode(this.editDocument.createTextNode("\t"));try{e.preventDefault()}catch(e){}return false}}.bind(this));this.addElementEvent(this.editDocument.body,"paste",function(e){this.checkAll=true}.bind(this));this.addElementEvent(this.editDocument.body,"focus",function(e){if(this.checkAll){this.clearFontElements(this.editDocument.body);this.checkScriptFormatComment(this.editDocument.body);this.checkScriptFormatString(this.editDocument.body);this.checkScriptFormatNumber(this.editDocument.body);this.checkScriptFormatKeyword(this.editDocument.body);this.checkAll=false}}.bind(this));this.addElementEvent(this.editDocument.body,"blur",function(e){if(this.checkAll){this.clearFontElements(this.editDocument.body);this.checkScriptFormatComment(this.editDocument.body);this.checkScriptFormatString(this.editDocument.body);this.checkScriptFormatNumber(this.editDocument.body);this.checkScriptFormatKeyword(this.editDocument.body);this.checkAll=false}}.bind(this));this.addElementEvent(this.editDocument.body,"keyup",function(e){if(this.options.keyCodes.indexOf(e.keyCode)!=-1){this.checkScriptFormat(e.keyCode)}}.bind(this))},clearFontElements:function(e){var t=e.getElementsByTagName("font");var i=t.length;while(t.length){var n=t.item(0);if(n.previousSibling&&n.previousSibling.nodeType==3){n.previousSibling.nodeValue=n.previousSibling.nodeValue+n.firstChild.nodeValue;var o=n.previousSibling;n.parentElement.removeChild(n);while(o.nextSibling&&o.nextSibling.nodeType==3){o.nodeValue=o.nodeValue+o.nextSibling.nodeValue;o.nextSibling.parentNode.removeChild(o.nextSibling)}}else if(n.nextSibling&&n.nextSibling.nodeType==3){n.nextSibling.nodeValue=n.firstChild.nodeValue+n.nextSibling.nodeValue;var o=n.nextSibling;n.parentElement.removeChild(n);while(o.previousSibling&&o.previousSibling.nodeType==3){o.nodeValue=o.nodeValue+o.previousSibling.nodeValue;o.previousSibling.parentNode.removeChild(o.previousSibling)}}else{if(n.firstChild){n.parentNode.replaceChild(this.editDocument.createTextNode(n.firstChild.nodeValue),n)}else{n.parentNode.removeChild(n)}}}},getCheckScriptElements:function(e){if(e){if(e.nodeType==3){this.checkTextNodes.push(e)}else{if(e.nodeType==1&&e.tagName.toString().toLowerCase()=="font"){}else{var t=e.childNodes;for(var i=0;i<t.length;i++){this.getCheckScriptElements(t[i])}}}}},checkScriptFormat:function(e){var t=this.editWindow.getSelection();var i=t.focusNode;if(e!=8&&e!=13&&e!=9){try{var n=t.focusOffset;var o=this.getCurrentOffset(i)+n}catch(e){}}var r=null;if(i.nodeType==3){r=i.parentNode;while(r&&r.nodeType==1&&(r.tagName.toString().toLowerCase()!="p"&&r.tagName.toString().toLowerCase()!="body")){r=r.parentElement}}else{r=i.previousSibling;while(r&&r.nodeType==1&&(r.tagName.toString().toLowerCase()!="p"&&r.tagName.toString().toLowerCase()!="body")){r=r.parentElement}}if(r){var s=this.checkAll?this.editDocument.body:r;this.clearFontElements(s);this.checkScriptFormatComment(s);this.checkScriptFormatString(s);this.checkScriptFormatNumber(s);this.checkScriptFormatKeyword(s);this.checkAll=false;if(e!=8&&e!=13&&e!=9){try{var c=this.getBackOffset(o,r);t.collapse(c.node,c.offset)}catch(e){}}}},getCurrentOffset:function(e){var t=0;var i=e.previousSibling;if(i){if(i.nodeType==3){t=i.nodeValue.length}else{t=i.innerText.length}t+=this.getCurrentOffset(i)}else{i=e.parentNode;if(i&&i.nodeType==1&&(i.tagName.toString().toLowerCase()!="p"&&i.tagName.toString().toLowerCase()!="body")){t+=this.getCurrentOffset(i)}}return t},getBackOffset:function(e,t){if(t.nodeType==3){var i=t.nodeValue.length;if(i>=e){return{node:t,offset:e}}else{e=e-i;tmpNode=t.nextSibling;while(!tmpNode){t=t.parentNode;tmpNode=t.nextSibling}return this.getBackOffset(e,t.nextSibling)}}else{return this.getBackOffset(e,t.firstChild)}},checkScriptFormatNumber:function(e){this.checkTextNodes=[];this.getCheckScriptElements(e);this.checkTextNodes.each(function(e){this.checkScriptTextFormatNumber(e)}.bind(this))},checkScriptTextFormatNumber:function(e){var t=this.css.number.color;var i=this.editDocument.createRange();var n=/\b(-?\d+(\.\d+)?)/g;var o=e.nodeValue.match(n);if(o){var r=o[0];var s=e.nodeValue.indexOf(r);var c=s;var a=c+r.length;i.setStart(e,c);i.setEnd(e,a);var d=this.createFormatFont(i,t,"number");var h=d.nextSibling;if(h&&h.nodeType==3){this.checkScriptTextFormatNumber(h)}}},checkScriptFormatString:function(e){this.checkTextNodes=[];this.getCheckScriptElements(e);this.isScriptTextString=false;this.checkTextNodes.each(function(e){this.checkScriptTextFormatString(e)}.bind(this))},checkScriptTextFormatString:function(e){var t=this.css.string.color;var i=this.editDocument.createRange();var n=e.nodeValue;var o=n.indexOf('"');var r=n.indexOf("'");var s=-1;var c=-1;var a='"';if(o!=-1&&r==-1){s=o}else if(o==-1&&r!=-1){s=r;a="'"}else if(o!=-1&&r!=-1){if(o<r){s=o}else{s=r;a="'"}}if(s!=-1){var d=n.indexOf('"',s+1);while(d!=-1){var h=n.substr(d-1,1);if(h!="\\"){c=d+1;break}var d=n.indexOf('"',d+1)}if(c!=-1){i.setStart(e,s);i.setEnd(e,c);var l=this.createFormatFont(i,t,"string");var m=l.nextSibling;if(m&&m.nodeType==3){this.checkScriptTextFormatString(m)}}}},checkScriptFormatKeyword:function(e){this.checkTextNodes=[];this.getCheckScriptElements(e);this.checkTextNodes.each(function(e){this.checkScriptTextFormatKeyword(e)}.bind(this))},checkScriptTextFormatKeyword:function(e){var t=this.css.keywords.color;var i=this.editDocument.createRange();var n=/\b((function)|(if)|(else)|(case)|(switch)|(for)|(in)|(do)|(while)|(with)|(var)|(this)|(break)|(continue)|(return)|(true)|(false)|(throw)|(try)|(finally)|(catch)|(finally)|(debugger)|(new)|(delete))/gi;var o=e.nodeValue.match(n);if(o){var r=o[0];var s=e.nodeValue.indexOf(r);var c=s;var a=c+r.length;i.setStart(e,c);i.setEnd(e,a);var d=this.createFormatFont(i,t,"keyword");var h=d.nextSibling;if(h&&h.nodeType==3){this.checkScriptTextFormatKeyword(h)}}},checkScriptFormatComment:function(e){this.checkTextNodes=[];this.getCheckScriptElements(e);this.isScriptTextComment=false;this.checkTextNodes.each(function(e){this.checkScriptTextFormatComment(e)}.bind(this))},checkScriptTextFormatComment:function(e){var t=this.css.comment.color;var i=this.editDocument.createRange();if(!this.isScriptTextComment){var n=e.nodeValue.indexOf("//");var o=e.nodeValue.indexOf("/*");if(n!=-1&&o==-1){i.setStart(e,n);i.setEnd(e,e.nodeValue.length);this.createFormatFont(i,t,"comment")}else if(n==-1&&o!=-1){i.setStart(e,o);i.setEnd(e,e.nodeValue.length);this.isScriptTextComment=true;this.createFormatFont(i,t,"comment")}else if(n!=-1&&o!=-1){if(n<o){i.setStart(e,n);i.setEnd(e,e.nodeValue.length);this.createFormatFont(i,t,"comment")}else{i.setStart(e,o);i.setEnd(e,e.nodeValue.length);this.isScriptTextComment=true;this.createFormatFont(i,t,"comment")}}}else{var r=e.nodeValue.indexOf("*/");if(r!=-1){i.setStart(e,0);i.setEnd(e,r+2);this.isScriptTextComment=false;this.createFormatFont(i,t,"comment")}else{i.setStart(e,0);i.setEnd(e,e.nodeValue.length);this.createFormatFont(i,t,"comment")}}},createFormatFont:function(e,t,i){var n=this.editDocument.createElement("font");n.appendChild(this.editDocument.createTextNode(e.toString()));n.MWFScriptType=i;n.setAttribute("color",t);e.deleteContents();e.insertNode(n);return n},checkScriptFormat1:function(){var e=this.editWindow.getSelection();var t=e.focusNode;if(t.nodeType!=3){t=null}else{var i=t.parentElement;if(i.tagName.toString().toLowerCase()=="font"){switch(i.MWFScriptType){case"comment_line":var n=i.firstChild.nodeValue;var o=n.injdexOf("//");if(o!=-1){var r=n.substr(0,o);if(r){var s=i.previousSibling;if(s&&s.nodeType==3){s.nodeValue=s.nodeValue+r;t=s}else{i.parentElement.insertBefore(document.createTextNode(r),i)}t.nodeValue=n.substr(o,n.length)}}else{var s=i.previousSibling;if(s&&s.nodeType==3){s.nodeValue=s.nodeValue+n}else{i.parentElement.insertBefore(document.createTextNode(n),i)}i.parentElement.removeChild(i)}case"comment_multi":case"string":case"number":case"keyword":}}else{}}}});