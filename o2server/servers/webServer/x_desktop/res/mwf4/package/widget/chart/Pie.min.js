MWF.widget=MWF.widget||{};MWF.widget.chart=MWF.widget.chart||{};MWF.require("MWF.widget.Common",null,false);MWF.require("MWF.widget.chart.d3",null,false);MWF.widget.chart.Pie=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default",margin:10,showText:false,dataFormat:""},initialize:function(t,e,s){this.setOptions(s);this.node=$(t);this.data=e;this.path=MWF.defaultPath+"/widget/chart/$Pie/";this.cssPath=MWF.defaultPath+"/widget/chart/$Pie/"+this.options.style+"/css.wcss";this._loadCss()},load:function(){this.svgNode=new Element("div",{styles:this.css.svgNode}).inject(this.node);if(this.fireEvent("queryLoad")){this.size=this.node.getSize();MWF.widget.chart.d3.load(function(){this.svg=d3.select(this.svgNode).append("svg");this.setSvgSize();this.loadPieData();this.loadPieArc()}.bind(this));this.fireEvent("postLoad")}},setSvgSize:function(){this.svg.attr("width",this.size.x).attr("height",this.size.y)},loadPieData:function(){this.pie=d3.pie().value(function(t,e){return t.value}).sort(function(t,e){return false});this.pieData=this.pie(this.data)},loadPieArc:function(){var t=this.size.x>this.size.y?this.size.y:this.size.x;t=t/2-this.options.margin;this.arc=d3.arc().innerRadius(0).outerRadius(t);this.arcOver=d3.arc().innerRadius(0).outerRadius(t+5);this.colors=this.css.colors||d3.schemeCategory10;var e=this.svg.selectAll("g").data(this.pieData).enter().append("g").attr("transform","translate("+this.size.x/2+", "+this.size.y/2+")");var s=e.append("path").attr("d",function(t,e){var s={startAngle:t.startAngle,endAngle:t.startAngle};return this.arc(s)}.bind(this)).attr("fill",function(t,e){return this.colors[0+e]}.bind(this));Object.each(this.css.arcs,function(t,e){s.attr(e,function(e){return typeOf(t)=="function"?t.apply(i,[e,this]):t})}.bind(this));this.setDefs("arcs_defs",s);this.transition();var i=this;e.on("mouseover",function(t,e,n){i.highlight(this,t,e);i.fireEvent("mouseover",[s,t,e])}).on("mousemove",function(t,e,n){if(!i.options.showText)i.moveHint(this,t,e);i.fireEvent("mousemove",[s,t,e])}).on("mouseout",function(t,e,n){i.normal(this,t,e);i.fireEvent("mouseout",[s,t,e])}).on("click",function(t,e,n){i.fireEvent("click",[s,t,e])})},highlight:function(t,e,s){var i=d3.select(t).select("path");var n=d3.select(t).select("text");i.attr("d",this.arcOver(e));Object.each(this.css.arcs_over,function(t,e){i.attr(e,function(e){return typeOf(t)=="function"?t.apply(_self,[e,this]):t})}.bind(this));this.setDefs("arcs_over_defs",i);Object.each(this.css.text_over,function(t,e){n.attr(e,function(e){return typeOf(t)=="function"?t.apply(_self,[e,this]):t})}.bind(this));this.setDefs("text_over_defs",n);if(!this.options.showText)this.showHint(t,e,s)},normal:function(t,e,s){var i=d3.select(t).select("path");var n=d3.select(t).select("text");i.attr("d",this.arc(e));Object.each(this.css.arcs,function(t,e){i.attr(e,function(e){return typeOf(t)=="function"?t.apply(_self,[e,this]):t})}.bind(this));this.setDefs("arcs_defs",i);i.attr("fill",this.colors[0+s]);Object.each(this.css.text,function(t,e){n.attr(e,function(e){return typeOf(t)=="function"?t.apply(_self,[e,this]):t})}.bind(this));this.setDefs("text_defs",n);if(!this.options.showText)this.hideHint(t,e,s)},createTextNode:function(t,e,s,i){var n=this.svg.append("g");if(!i)i=d3.mouse(this.svg.node());var a=e.data.name+" ("+d3.format(this.options.dataFormat)(e.data.value)+")";if(!e.size)e.size=MWF.getTextSize(a);var r=e.size;var h=i[0]-r.x/2;var o=i[1]-r.y-5;if(h<0)h=0;var c=n.attr("transform","translate("+h+", "+o+")").append("rect").attr("height",r.y).attr("width",r.x);var d=n.append("text").attr("transform","translate("+r.x/2+", "+(r.y/2+5)+")").text(a);Object.each(this.css.hint_rect,function(t,e){c.attr(e,function(e){return typeOf(t)=="function"?t.apply(_self,[e,this]):t})}.bind(this));this.setDefs("hint_rect_defs",c);Object.each(this.css.hint_text,function(t,e){d.attr(e,function(e){return typeOf(t)=="function"?t.apply(_self,[e,this]):t})}.bind(this));this.setDefs("hint_text_defs",d);return n},showHint:function(t,e,s){var i=t.retrieve("hint");if(!i){i=this.createTextNode(t,e,s);t.store("hint",i)}},moveHint:function(t,e,s){var i=t.retrieve("hint");if(i){var n=d3.mouse(this.svg.node());if(!e.size)e.size=MWF.getTextSize(e.data.name);var a=e.size;var r=n[0]-a.x/2;var h=n[1]-a.y-5;if(r<0)r=0;i.attr("transform","translate(0,0)").attr("transform","translate("+r+", "+h+")")}},hideHint:function(t,e,s){var i=t.retrieve("hint");if(i){i.remove();t.eliminate("hint")}},transition:function(t,e){var s=this;if(!t)t=this.svg.selectAll("path");if(!e)e=this.svg.selectAll("g");texts=this.svg.selectAll("text");texts.remove();var i=d3.sum(this.data,function(t,e){return t.value});t.attr("d",function(t,e){var s={startAngle:t.startAngle,endAngle:t.startAngle};return this.arc(s)}.bind(this));t.transition().delay(function(t,e){var s=d3.sum(this.data,function(t,s){return s<e?t.value:0});return e>0?s/i*600:0}.bind(this)).duration(function(t,e){return t.value/i*600}.bind(this)).ease(d3.easeLinear).attrTween("d",function(t,e){return function(e){var s=t.endAngle-t.startAngle;var i={startAngle:t.startAngle,endAngle:t.startAngle+s*e};return this.arc(i)}.bind(this)}.bind(this)).on("end",function(t,i){var n=this.size.x>this.size.y?this.size.y:this.size.x;n=n/2-this.options.margin;var a=d3.arc().innerRadius(0).outerRadius(n+20);var r=a.centroid(t);var h=d3.select(e.nodes()[i]).append("text").attr("transform","translate("+r[0]+", "+r[1]+")").text(d3.format(this.options.dataFormat)(t.data.value));Object.each(this.css.text,function(t,e){h.attr(e,function(e){return typeOf(t)=="function"?t.apply(s,[e,this]):t})}.bind(this));this.setDefs("text_defs",h)}.bind(this))},setDefs:function(t,e){if(this.css[t]){var s=this.svg.append("defs");this.createDefs(s,this.css[t]);s.select(function(){return this.getFirst()}).attr("id",this.classId+"_"+t);e.attr(this.css[t].urlAttr,"url(#"+this.classId+"_"+t+")")}},hide:function(){this.svgNode.setStyle("display","none")},show:function(){this.svgNode.setStyle("display","block");this.transition()},destroy:function(){this.svgNode.destroy();MWF.release(this)}});