MWF.widget=MWF.widget||{};MWF.require("MWF.widget.codemirror",null,false);MWF.require("MWF.widget.ace",null,false);MWF.require("MWF.xDesktop.UserData",null,false);MWF.widget.JavascriptEditor=new Class({Implements:[Options,Events],options:{type:"ace",title:"JavascriptEditor",style:"default",option:{value:"",mode:"javascript",lineNumbers:true}},initialize:function(e,t){this.setOptions(t);this.editorClass=MWF.widget[this.options.type];this.node=$(e)},getEditorTheme:function(e){if(!MWF.editorData){MWF.UD.getData("editor",function(t){if(t.data){MWF.editorData=JSON.decode(t.data)}else{MWF.editorData={javascriptEditor:{theme:"tomorrow"}}}if(e)e()})}else{if(e)e()}},load:function(e){this.getEditorTheme(function(t){if(MWF.editorData.javascriptEditor){this.theme=MWF.editorData.javascriptEditor.theme}else{MWF.editorData.javascriptEditor={theme:"tomorrow"}}if(!this.theme)this.theme="tomorrow";if(this.options.type.toLowerCase()=="ace"){this.loadAce(e)}if(this.options.type.toLowerCase()=="codeMirror"){this.loadCodeMirror(e)}}.bind(this))},loadAce:function(e){this.editorClass.load(function(){ace.require("ace/ext/language_tools");this.editor=ace.edit(this.node);this.editor.session.setMode("ace/mode/javascript");this.editor.setTheme("ace/theme/"+this.theme);this.editor.setOptions({enableBasicAutocompletion:true,enableSnippets:true,enableLiveAutocompletion:false});if(this.options.option.value)this.editor.setValue(this.options.option.value);this.editor.commands.addCommand({name:"save",bindKey:{win:"Ctrl-S",mac:"Command-S"},exec:function(e){this.fireEvent("save")}.bind(this),readOnly:false});this.editor.commands.addCommand({name:"help",bindKey:{win:"Ctrl-Q|Ctrl-Alt-Space|Ctrl-Space|Alt-/",mac:"Command-Q"},exec:function(e,t,i){this.fireEvent("reference",[e,t,i])}.bind(this),readOnly:false});this.node.addEvent("keydown",function(e){e.stopPropagation()});this.fireEvent("postLoad");if(e)e()}.bind(this))},loadCodeMirror:function(e){if(this.fireEvent("queryLoad")){this.editorClass.load(function(){this.editorClass.loadJavascript(function(t){this.options.option.mode="javascript";this.editor=CodeMirror(this.node,this.options.option);this.editor.setSize("100%","100%");this.fireEvent("postLoad");if(e)e()}.bind(this))}.bind(this))}},showLineNumbers:function(){if(this.options.type.toLowerCase()=="codeMirror")this.editor.setOption("lineNumbers",true)},max:function(){if(this.options.type.toLowerCase()=="codeMirror")this.editor.setSize("100%","100%")},getCursorPixelPosition:function(){var e=this.editor.getSession();var t=this.editor.getCursorPosition();var i=e.getLine(t.row);var o=this.retrievePrecedingIdentifier(i,t.column);var r=e.doc.createAnchor(t.row,t.column-o.length);r.$insertRight=true;var s=this.editor.renderer;var t=s.$cursorLayer.getPixelPosition(r,true);var n=this.editor.container.getBoundingClientRect();t.top+=n.top-s.layerConfig.offset;t.left+=n.left-this.editor.renderer.scrollLeft;t.left+=s.gutterWidth;return t},retrievePrecedingIdentifier:function(e,t,i){i=i||/[a-zA-Z_0-9\$\-\u00A2-\uFFFF]/;var o=[];for(var r=t-1;r>=0;r--){if(i.test(e[r]))o.push(e[r]);else break}return o.reverse().join("")}});