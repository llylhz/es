MWF.widget=MWF.widget||{};MWF.require("MWF.widget.Common",null,false);MWF.widget.ScriptEditor=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default",keySeparat:/[\.\,\;\s\{\}\(\)\n\r\t\:\/\*\"\'=\[\]\+\-\/]+/gi,keyCodes:[220,46,13,222,219,221,57,48,191,190,186,188,32,55,16,187,189,8,9]},initialize:function(e,t){this.setOptions(t);this.node=$(e);this.path=MWF.defaultPath+"/widget/$ScriptEditor/";this.cssPath=MWF.defaultPath+"/widget/$ScriptEditor/"+this.options.style+"/css.wcss";this._loadCss();this.checkTextNodes=[]},load:function(e){if(this.fireEvent("queryLoad")){this.createContent(e);this.fireEvent("postLoad")}},createContent:function(e){this.editArea=new Element("iframe",{styles:this.css.contentEditArea,border:"0",frameBorder:"0",marginHeight:"0",marginWidth:"0",scrolling:"auto"}).inject(this.node);this.loadContent(e)},loadContent:function(e){this.editDocument=this.editArea.contentWindow.document;this.window=this.editArea.contentWindow;this.editDocument.write('<style type="text/css">p {margin:0px;}</style><body style="overflow:visible; word-break:keep-all; word-wrap:normal; font-size:12px; font-family:Verdana, Geneva, sans-serif; line-height:20px;">'+e+"</body>");this.editDocument.designMode="On";this.setBodyEvent()},addElementEvent:function(e,t,i){if(e.addEventListener){e.addEventListener(t,i)}else{e.attachEvent("on"+t,i)}},setBodyEvent:function(){this.editDocument.body.style.whiteSpace="nowrap";this.addElementEvent(this.editDocument.body,"keydown",function(e){if(e.keyCode==9){}}.bind(this));this.addElementEvent(this.editDocument.body,"keyup",function(e){if(this.options.keyCodes.indexOf(e.keyCode)!=-1){window.setTimeout(function(){this.checkScriptFormat()}.bind(this),10)}}.bind(this))},clearFontElements:function(){var e=this.editDocument.body.getElementsByTagName("font");var t=e.length;while(e.length){var i=e.item(0);if(i.previousSibling&&i.previousSibling.nodeType==3){i.previousSibling.nodeValue=i.previousSibling.nodeValue+i.firstChild.nodeValue;var n=i.previousSibling;i.parentElement.removeChild(i);while(n.nextSibling&&n.nextSibling.nodeType==3){n.nodeValue=n.nodeValue+n.nextSibling.nodeValue;n.nextSibling.parentNode.removeChild(n.nextSibling)}}else if(i.nextSibling&&i.nextSibling.nodeType==3){i.nextSibling.nodeValue=i.firstChild.nodeValue+i.nextSibling.nodeValue;var n=i.nextSibling;i.parentElement.removeChild(i);while(n.previousSibling&&n.previousSibling.nodeType==3){n.nodeValue=n.nodeValue+n.previousSibling.nodeValue;n.previousSibling.parentNode.removeChild(n.previousSibling)}}else{if(i.firstChild){i.parentNode.replaceChild(this.editDocument.createTextNode(i.firstChild.nodeValue),i)}else{i.parentNode.removeChild(i)}}}},getCheckScriptElements:function(e){if(e){if(e.nodeType==3){this.checkTextNodes.push(e)}else{if(e.nodeType==1&&e.tagName.toString().toLowerCase()=="font"){}else{var t=e.childNodes;for(var i=0;i<t.length;i++){this.getCheckScriptElements(t[i])}}}}},checkScriptFormat:function(e){this.clearFontElements();this.checkScriptFormatComment();this.checkScriptFormatString();this.checkScriptFormatNumber();this.checkScriptFormatKeyword()},recordCurrentInsertPoint:function(){this.currentInsertPointCount=0;var e=this.window.getSelection();var t=e.focusNode;if(t.nodeType==3){}},checkScriptFormatNumber:function(){this.checkTextNodes=[];this.getCheckScriptElements(this.editDocument.body);this.checkTextNodes.each(function(e){this.checkScriptTextFormatNumber(e)}.bind(this))},checkScriptTextFormatNumber:function(e){var t=this.css.number.color;var n=this.options.keySeparat;var s=this.editDocument.createRange();var r=this.editDocument.createRange();s.setStart(e,0);s.setEnd(e,1);var o=[];var a=e.nodeValue.length;while(true){var d=s.toString();if(!d.replace(n,"")){s.setStart(e,s.endOffset)}else{var c=false;if(s.endOffset+1>a){c=true}else{r.setStart(e,s.endOffset);r.setEnd(e,s.endOffset+1);c=!r.toString().replace(n,"")}if(c){if(Number.from(d)){o.push(s.cloneRange())}s.setStart(e,s.endOffset)}}if(s.endOffset+1>a){break}else{s.setEnd(e,s.endOffset+1)}}if(o.length){for(i=o.length-1;i>=0;i--){var h=o[i];this.createFormatFont(h,t,"number")}}},checkScriptFormatString:function(){this.checkTextNodes=[];this.getCheckScriptElements(this.editDocument.body);this.isScriptTextString=false;this.checkTextNodes.each(function(e){this.checkScriptTextFormatString(e)}.bind(this))},checkScriptTextFormatString:function(e){var t=this.css.string.color;var i=this.editDocument.createRange();if(e.nodeValue.length){i.setStart(e,0);i.setEnd(e,1);var n=0;var s=0;var r=e.nodeValue.length;var o='"';while(true){var a=i.toString();if(!this.isScriptTextString){if(a=='"'){this.isScriptTextString=true;o='"';n=i.startOffset}if(a=="'"){this.isScriptTextString=true;o="'";n=i.startOffset}}else{if(a==o){var d=this.editDocument.createRange();if(i.startOffset>0){d.setEnd(e,i.startOffset);d.setStart(e,i.startOffset-1);if(d.toString()!="\\"){s=i.endOffset}}else{s=i.endOffset}if(s!=0){d.setStart(e,n);d.setEnd(e,s);var c=this.createFormatFont(d,t,"string");this.isScriptTextString=false;e=c.nextSibling;if(!e||e.nodeType!=3){break}r=e.nodeValue.length;i.setStart(e,0);i.setEnd(e,1)}}}if(i.endOffset+1>r){break}else{i.setStart(e,i.startOffset+1);i.setEnd(e,i.endOffset+1)}}}},checkScriptFormatKeyword:function(){this.checkTextNodes=[];this.getCheckScriptElements(this.editDocument.body);this.checkTextNodes.each(function(e){this.checkScriptTextFormatKeyword(e)}.bind(this))},checkScriptTextFormatKeyword:function(e){var t=this.css.keywords;var n=this.options.keySeparat;var s=this.editDocument.createRange();var r=this.editDocument.createRange();s.setStart(e,0);s.setEnd(e,1);var o=[];var a=0;var d=e.nodeValue.length;while(true){var c=s.toString();if(!c.replace(n,"")){s.setStart(e,s.endOffset)}else{var h=false;if(s.endOffset+1>d){h=true}else{r.setStart(e,s.endOffset);r.setEnd(e,s.endOffset+1);h=!r.toString().replace(n,"")}if(h){if(t.keys.indexOf(s.toString().toLowerCase())!=-1){o.push(s.cloneRange())}s.setStart(e,s.endOffset)}}if(s.endOffset+1>d){break}else{s.setEnd(e,s.endOffset+1)}}if(o.length){for(i=o.length-1;i>=0;i--){var l=o[i];this.createFormatFont(l,t.color,"keyword")}}},checkScriptFormatComment:function(){this.checkTextNodes=[];this.getCheckScriptElements(this.editDocument.body);this.isScriptTextComment=false;this.checkTextNodes.each(function(e){this.checkScriptTextFormatComment(e)}.bind(this))},checkScriptTextFormatComment:function(e){var t=this.css.comment.color;var i=this.editDocument.createRange();if(!this.isScriptTextComment){var n=e.nodeValue.indexOf("//");var s=e.nodeValue.indexOf("/*");if(n!=-1&&multiCommentIndex==-1){i.setStart(e,n);i.setEnd(e,e.nodeValue.length);this.createFormatFont(i,t,"comment")}else if(n==-1&&multiCommentIndex!=-1){i.setStart(e,multiCommentIndex);i.setEnd(e,e.nodeValue.length);this.isScriptTextComment=true;this.createFormatFont(i,t,"comment")}else if(n!=-1&&multiCommentIndex!=-1){if(n<multiCommentIndex){i.setStart(e,n);i.setEnd(e,e.nodeValue.length);this.createFormatFont(i,t,"comment")}else{i.setStart(e,multiCommentIndex);i.setEnd(e,e.nodeValue.length);this.isScriptTextComment=true;this.createFormatFont(i,t,"comment")}}}else{var r=e.nodeValue.indexOf("*/");if(r!=-1){i.setStart(e,0);i.setEnd(e,r+2);this.isScriptTextComment=false;this.createFormatFont(i,t,"comment")}else{i.setStart(e,0);i.setEnd(e,e.nodeValue.length);this.createFormatFont(i,t,"comment")}}if(!this.isScriptTextComment){if(e.nodeValue.length>=2){i.setStart(e,0);i.setEnd(e,2);var o=e.nodeValue.length;while(true){var a=i.toString();if(a=="//"){i.setEnd(e,e.nodeValue.length);this.createFormatFont(i,t,"comment");break}if(a=="/*"){i.setEnd(e,e.nodeValue.length);this.createFormatFont(i,t,"comment");this.isScriptTextComment=true;break}if(i.endOffset+1>o){break}else{i.setStart(e,i.startOffset+1);i.setEnd(e,i.endOffset+1)}}}}else{i.setStart(e,0);i.setEnd(e,e.nodeValue.length);var d=i.toString();if(d.indexOf("*/")==-1){i.setStart(e,0);i.setEnd(e,e.nodeValue.length);this.createFormatFont(i,t,"comment")}else{if(e.nodeValue.length>=2){i.setStart(e,0);i.setEnd(e,2);var o=e.nodeValue.length;while(true){var a=i.toString();if(a=="*/"){var c=i.startOffset;i.setStart(e,0);var h=this.createFormatFont(i,t,"comment");e=h.nextSibling;if(!e||e.nodeType!=3){break}o=e.nodeValue.length;i.setStart(e,0);i.setEnd(e,2);this.isScriptTextComment=false}if(a=="//"){i.setEnd(e,e.nodeValue.length);this.createFormatFont(i,t,"comment");break}if(a=="/*"){i.setEnd(e,e.nodeValue.length);this.createFormatFont(i,t,"comment");this.isScriptTextComment=true;break}if(i.endOffset+1>o){break}else{i.setStart(e,i.startOffset+1);i.setEnd(e,i.endOffset+1)}}}}}},createFormatFont:function(e,t,i){var n=this.editDocument.createElement("font");n.appendChild(this.editDocument.createTextNode(e.toString()));n.MWFScriptType=i;n.setAttribute("color",t);e.deleteContents();e.insertNode(n);return n}});