MWF.widget=MWF.widget||{};MWF.widget.AttachmentSelector=MWF.widget.ATTSER=new Class({Extends:MWF.widget.AttachmentController,Implements:[Options,Events],options:{style:"default",listStyle:"icon",selectType:"all",size:"max",resize:false,attachmentCount:0,isUpload:true,isDelete:true,isReplace:true,isDownload:true,isSizeChange:false,readonly:false,images:["bmp","gif","png","jpeg","jpg","jpe","ico"],audios:["mp3","wav","wma","wmv"],videos:["avi","mkv","mov","ogg","mp4","mpa","mpe","mpeg","mpg","rmvb"]},initialize:function(t,e,i){this.setOptions(i);this.pages=[];this.path=MWF.defaultPath+"/widget/$AttachmentSelector/";this.cssPath=MWF.defaultPath+"/widget/$AttachmentSelector/"+this.options.style+"/css.wcss";this._loadCss();MWF.getJSON("/x_component_File/$Main/icon.json",function(t){this.icons=t}.bind(this),false,false);this.module=e;this.actions=[];this.attachments=[];this.selectedAttachments=[];this.container=$(t)},load:function(){this.markNode=new Element("div",{styles:this.css.markNode,events:{mouseover:function(t){t.stopPropagation()},mouseout:function(t){t.stopPropagation()}}}).inject(this.container);this.node=new Element("div",{styles:this.css.container});this.fiterByExtension(this.attachments);if(this.options.size=="min"){this.loadMin()}else{this.loadMax()}this.node.inject(this.markNode,"after");this.node.fade("in");this.setNodeSize();var t=this.container.getSize();var e=this.node.getSize();this.node.makeDraggable({handle:this.titleNode,limit:{x:[0,t.x-e.x],y:[0,t.y-e.y]}})},close:function(){this.node.destroy();this.markNode.destroy();delete this},fiterByExtension:function(t){var e=this.options[this.options.selectType];if(e){var i=[];while(t.length){var s=t.shift();if(e.contains(s.extension)){i.push(s)}}t=i}return t},loadMax:function(){if(!this.node)this.node=new Element("div",{styles:this.css.container});if(!this.topNode){this.createTopNode();this.createContentNode();this.createBottomToolbarNode();if(this.options.resize){this.createBottomNode();this.createResizeNode()}this.node.inject(this.container);this.checkActions();this.setEvent()}else{this.contentScrollNode.setStyle("display","block");if(this.bottomNode)this.bottomNode.setStyle("display","block");if(this.titleNode)this.titleNode.setStyle("display","block");this.topNode.setStyle("display","block");this.content.empty()}var t=[];while(this.attachments.length){var e=this.attachments.shift();t.push(new MWF.widget.AttachmentSelector.Attachment(e.data,this))}this.attachments=t},loadMin:function(){if(!this.node)this.node=new Element("div",{styles:this.css.container_min});if(!this.minActionAreaNode){this.minActionAreaNode=new Element("div",{styles:this.css.minActionAreaNode}).inject(this.node);this.minContent=new Element("div",{styles:this.css.minContentNode}).inject(this.node);this.min_uploadAction=this.createAction(this.minActionAreaNode,"upload",MWF.LP.widget.upload,function(t,e){this.uploadAttachment(t,e)}.bind(this));this.min_deleteAction=this.createAction(this.minActionAreaNode,"delete",MWF.LP.widget["delete"],function(t,e){this.deleteAttachment(t,e)}.bind(this));this.min_replaceAction=this.createAction(this.minActionAreaNode,"replace",MWF.LP.widget.replace,function(t,e){this.replaceAttachment(t,e)}.bind(this));this.createSeparate(this.minActionAreaNode);this.sizeAction=this.createAction(this.minActionAreaNode,"max",MWF.LP.widget.min,function(){this.changeControllerSize()}.bind(this));this.node.inject(this.container);this.checkActions();this.setEvent()}else{this.minActionAreaNode.setStyle("display","block");this.minContent.setStyle("display","block");this.minContent.empty()}var t=[];while(this.attachments.length){var e=this.attachments.shift();t.push(new MWF.widget.AttachmentSelector.AttachmentMin(e.data,this))}this.attachments=t},createTopNode:function(){if(this.options.title){if(!this.titleNode){this.titleNode=new Element("div",{styles:this.css.titleNode,text:this.options.title}).inject(this.node);this.titleActionNode=new Element("div",{styles:this.css.titleActionNode}).inject(this.titleNode);this.titleActionNode.addEvent("click",function(){this.close()}.bind(this))}}this.topNode=new Element("div",{styles:this.css.topNode}).inject(this.node);this.createEditGroupActions();this.createReadGroupActions();this.createListGroupActions();this.createViewGroupActions()},addAttachment:function(t){var e=this.fiterByExtension([t]);if(e.length>0){if(this.options.size=="min"){this.attachments.push(new MWF.widget.AttachmentSelector.AttachmentMin(t,this))}else{this.attachments.push(new MWF.widget.AttachmentSelector.Attachment(t,this))}}},selectAttachment:function(t,e,i){if(i){if(this.module)this.module.selectAttachment(t,e,i)}this.close()},createBottomToolbarNode:function(){this.bottomToolbarNode=new Element("div",{styles:this.css.bottomToolbarNode}).inject(this.node);this.cancelButton=new Element("div",{styles:this.css.cancelButton,text:MWF.LP.widget.cancel}).inject(this.bottomToolbarNode);this.cancelButton.addEvent("click",function(){this.close()}.bind(this));this.okButton=new Element("div",{styles:this.css.okButton,text:MWF.LP.widget.ok}).inject(this.bottomToolbarNode);this.okButton.addEvent("click",function(){if(this.selectedAttachments.length){this.selectAttachment(null,null,this.selectedAttachments)}this.close()}.bind(this))},setNodeSize:function(t,e){t=t||"50%";e=e||"50%";"string"==typeof t&&(1<t.length&&"%"==t.substr(t.length-1,1))&&(t=parseInt(window.screen.width*parseInt(t,10)/100,10));"string"==typeof e&&(1<e.length&&"%"==e.substr(e.length-1,1))&&(e=parseInt(window.screen.height*parseInt(e,10)/100,10));700>t&&(t=700);420>e&&(e=420);var i=parseInt((window.screen.height-e)/2,10);var s=parseInt((window.screen.width-t)/2,10);this.node.setStyles({width:""+t+"px",height:""+e+"px",top:""+i+"px",left:""+s+"px"});var n=this.titleNode?this.titleNode.getSize().y:0;var o=this.topNode?this.topNode.getSize().y:0;var h=this.bottomToolbarNode?this.bottomToolbarNode.getSize().y:0;var c=this.bottomNode?this.bottomNode.getSize().y:0;var l=e-n-o-h-c;this.contentScrollNode.setStyles({height:""+l+"px"})}});MWF.widget.AttachmentSelector.Attachment=new Class({Extends:MWF.widget.AttachmentController.Attachment,Implements:[Options,Events],load:function(){this.node=new Element("div").inject(this.content);switch(this.controller.options.listStyle){case"list":this.loadList();break;case"icon":this.loadIcon();break;case"preview":this.loadPreview();break}this.createInforNode(function(){this.tooltip=new mBox.Tooltip({content:this.inforNode,setStyles:{content:{padding:15,lineHeight:20}},zIndex:10013,attach:this.node,transition:"flyin"})}.bind(this));this.setEvent()},setEvent:function(){this.node.addEvents({mouseover:function(){if(!this.isSelected)this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle+"_over"])}.bind(this),mouseout:function(){if(!this.isSelected)this.node.setStyles(this.css["attachmentNode_"+this.controller.options.listStyle])}.bind(this),mousedown:function(t){this.selected(t)}.bind(this),dblclick:function(t){this.selectAttachment(t)}.bind(this)})},selectAttachment:function(t){this.controller.selectAttachment(t,null,[this])}});MWF.widget.AttachmentSelector.AttachmentMin=new Class({Extends:MWF.widget.AttachmentController.AttachmentMin,setEvent:function(){this.node.addEvents({mouseover:function(){if(!this.isSelected)this.node.setStyles(this.css["minAttachmentNode_list_over"])}.bind(this),mouseout:function(){if(!this.isSelected)this.node.setStyles(this.css["minAttachmentNode_list"])}.bind(this),mousedown:function(t){this.selected(t)}.bind(this),dblclick:function(t){this.selectAttachment(t)}.bind(this)})},selectAttachment:function(t){this.controller.selectAttachment(t,null,[this])}});