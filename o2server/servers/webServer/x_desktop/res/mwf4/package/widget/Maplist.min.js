MWF.widget=MWF.widget||{};MWF.widget.Maplist=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{title:"maplist",style:"default",collapse:false,isAdd:true,isDelete:true,isModify:true},initialize:function(t,e){this.setOptions(e);this.node=$(t);this.container=new Element("div");this.path=MWF.defaultPath+"/widget/$Maplist/";this.cssPath=MWF.defaultPath+"/widget/$Maplist/"+this.options.style+"/css.wcss";this._loadCss();this.items=[]},load:function(t){if(this.fireEvent("queryLoad")){this.container.set("styles",this.css.container);this.container.inject(this.node);this.createTitleNode();this.createContent(t);this.fireEvent("postLoad");if(this.options.collapse){var e=this.contentNode.getSize().y.toInt()-2;this.contentNode.store("showHeight",e);this.contentNode.setStyles({display:"none",height:"0px"})}}},createTitleNode:function(){this.titleNode=new Element("div",{styles:this.css.titleNode}).inject(this.container);this.titleActionNode=new Element("div",{styles:this.css.titleActionNode}).inject(this.titleNode);this.titleTextNode=new Element("div",{styles:this.css.titleTextNode,text:this.options.title}).inject(this.titleNode);this.titleTextNode.addEvent("click",function(){this.expandOrCollapse()}.bind(this));this.createTitleActions()},createTitleActions:function(){this.actionNode=new Element("div",{styles:this.css.actionNode}).inject(this.titleActionNode);this.actionNode.setStyle("background-image","url("+this.path+this.options.style+"/icon/code_empty.png)");this.actionNode.addEvent("click",function(t){this.showCode();t.stopPropagation()}.bind(this))},showCode:function(){var t=this.contentNode.getStyle("display");if(t=="none")this.expand();if(!this.isShowCode){this.codeContentNode=new Element("div",{styles:this.css.contentNode}).inject(this.container);this.codeTextNode=new Element("textarea",{styles:this.css.codeTextNode,events:{blur:function(){this.showCode();this.fireEvent("change")}.bind(this)}}).inject(this.codeContentNode);var e=this.contentNode.getSize();this.codeTextNode.setStyle("height",""+e.y+"px");MWF.require("MWF.widget.JsonParse",function(){this.json=new MWF.widget.JsonParse(this.toJson(),null,this.codeTextNode);this.json.load()}.bind(this));this.contentNode.setStyle("display","none");this.titleActionNode.setStyles({border:"1px solid #999",background:"#FFF"});this.actionNode.setStyle("background-image","url("+this.path+this.options.style+"/icon/code.png)");this.isShowCode=true}else{this.contentItemsNode.empty();this.loadContent(JSON.decode(this.codeTextNode.get("value")));this.fireEvent("change");this.codeContentNode.destroy();this.codeContentNode=null;this.codeTextNode=null;this.contentNode.setStyle("display","block");this.titleActionNode.setStyles({border:"1px solid #EEE",background:"transparent"});this.actionNode.setStyle("background-image","url("+this.path+this.options.style+"/icon/code_empty.png)");this.isShowCode=false}},reload:function(t){if(!this.isShowCode){this.contentItemsNode.empty();this.loadContent(t)}else{this.contentItemsNode.empty();this.loadContent(t);this.codeContentNode.destroy();this.codeContentNode=null;this.codeTextNode=null;this.contentNode.setStyle("display","block");this.titleActionNode.setStyles({border:"1px solid #EEE",background:"transparent"});this.actionNode.setStyle("background-image","url("+this.path+this.options.style+"/icon/code_empty.png)");this.isShowCode=false}},addAction:function(t,e){var i=new Element("div",{styles:this.css.actionNode}).inject(this.titleActionNode);i.setStyle("background-image","url("+this.path+this.options.style+"/icon/"+t+")");i.addEvent("click",e)},expandOrCollapse:function(){var t=this.contentNode.getStyle("display");if(t!="none"){this.collapse()}else{this.expand()}},collapse:function(){if(!this.morph){this.morph=new Fx.Morph(this.contentNode,{duration:200})}var t=this.contentNode.getSize().y.toInt()-2;this.contentNode.store("showHeight",t);this.morph.start({height:[t,0]}).chain(function(){this.contentNode.setStyle("display","none")}.bind(this))},expand:function(){if(!this.morph){this.morph=new Fx.Morph(this.contentNode,{duration:200})}var t=this.contentNode.retrieve("showHeight");this.contentNode.setStyle("display","block");this.morph.start({height:[0,t]}).chain(function(){this.contentNode.setStyle("height","auto")}.bind(this))},createContent:function(t){this.contentNode=new Element("div",{styles:this.css.contentNode}).inject(this.container);this.contentStartNode=new Element("div",{styles:this.css.contentStartNode,text:"{"}).inject(this.contentNode);this.contentStartNode.addEvents({mouseover:function(t){t.target.setStyles(this.css.contentStartNodeOver)}.bind(this),mouseout:function(t){t.target.setStyles(this.css.contentStartNode)}.bind(this),click:function(t){this.addNewItem(null,"top")}.bind(this)});this.contentItemsNode=new Element("div",{styles:this.css.contentItemsNode}).inject(this.contentNode);this.contentEndNode=new Element("div",{styles:this.css.contentEndNode,text:"}"}).inject(this.contentNode);this.contentEndNode.addEvents({mouseover:function(t){t.target.setStyles(this.css.contentEndNodeOver)}.bind(this),mouseout:function(t){t.target.setStyles(this.css.contentEndNode)}.bind(this),click:function(t){this.addNewItem(null,"bottom")}.bind(this)});this.loadContent(t)},createItem:function(t,e){return new MWF.widget.Maplist.Item(this,t,e)},loadContent:function(t){Object.each(t,function(t,e){var i=this.createItem(t,e);i.load();i.itemNode.inject(this.contentItemsNode);this.items.push(i)},this)},addNewItem:function(t,e){if(this.notAddItem){this.notAddItem=false}else{var i=this.createItem("","");i.load();if(t){i.itemNode.inject(t.itemNode,"after")}else{i.itemNode.inject(this.contentItemsNode,e)}i.isNewItem=true;i.editKey();this.items.push(i)}},deleteItem:function(t){var e=t.key;this.notAddItem=false;this.items.erase(t);t.itemNode.destroy();delete t;this.fireEvent("delete",[e]);this.fireEvent("change")},toJson:function(){var t={};this.items.each(function(e){if(e.key){t[e.key]=e.value}});return t},getValue:function(){return this.toJson()}});MWF.widget.Maplist.Item=new Class({initialize:function(t,e,i){this.maplist=t;this.key=i;this.value=e},load:function(){this.creatItemNode();this.setItemEvents()},creatItemNode:function(){this.itemNode=new Element("div",{styles:this.maplist.css.contentItemNode});this.iconNode=new Element("div",{styles:this.maplist.css.contentItemIconNode,events:{mouseover:function(t){t.stopPropagation()},mouseout:function(t){t.stopPropagation()}}}).inject(this.itemNode);this.keyNode=new Element("span",{styles:this.maplist.css.contentItemKeyNode,text:this.key}).inject(this.itemNode);this.colonNode=new Element("span",{styles:this.maplist.css.contentItemColonNode,text:":"}).inject(this.itemNode);this.valueNode=new Element("span",{styles:this.maplist.css.contentItemValueNode,text:this.value}).inject(this.itemNode)},setItemEvents:function(){this.itemNode.addEvents({mouseover:function(t){t.target.setStyles(this.maplist.css.contentItemNodeOver)}.bind(this),mouseout:function(t){t.target.setStyles(this.maplist.css.contentItemNode)}.bind(this),click:function(t){this.maplist.addNewItem(this)}.bind(this)});this.keyNodeClick=function(t){if(this.maplist.options.isModify)this.editKey(this.keyNode);t.stopPropagation()}.bind(this);this.keyNode.addEvent("click",this.keyNodeClick);this.valueNodeClick=function(t){if(this.maplist.options.isModify)this.editValue();t.stopPropagation()}.bind(this);this.valueNode.addEvent("click",this.valueNodeClick)},editKey:function(){this.editItem(this.keyNode,function(t){if(t)this.keyNode.addEvent("click",this.keyNodeClick)}.bind(this));this.keyNode.removeEvent("click",this.keyNodeClick)},editValue:function(){this.editItem(this.valueNode,function(t){if(t)this.valueNode.addEvent("click",this.valueNodeClick)}.bind(this));this.valueNode.removeEvent("click",this.valueNodeClick)},editItem:function(t,e){var i=t.get("text");t.set("html","");var s=new Element("div",{styles:this.maplist.css.editInputDiv});var n=new Element("input",{styles:this.maplist.css.editInput,type:"text",value:i}).inject(s);var o=MWF.getTextSize(i+"a").x;n.setStyle("width",o);s.setStyle("width",o);s.inject(t);n.select();n.addEvents({keydown:function(t){var e=MWF.getTextSize(n.get("value")+"a").x;t.target.setStyle("width",e);t.target.getParent().setStyle("width",e);if(t.code==13){this.isEnterKey=true;t.target.blur()}t.stopPropagation()}.bind(this),blur:function(i){var s=this.editItemComplate(t,i.target);if(e)e(s)}.bind(this),click:function(t){t.stopPropagation()}.bind(this)})},editItemComplate:function(t,e){var i=e.get("value");if(t==this.keyNode){if(!i){this.maplist.deleteItem(this)}var s=true;this.maplist.items.each(function(t){if(t.key==i){if(t!=this)s=false}}.bind(this));if(s){this.key=i;this.editValue();this.maplist.notAddItem=true}else{this.iconNode.setStyle("background","url("+this.maplist.path+this.maplist.options.style+"/icon/error.png) center center no-repeat");this.iconNode.title=MWF.LP.process.repetitions;e.select();return false}}var n=false;if(t==this.valueNode){this.value=i;if(this.isEnterKey){if(this.isNewItem){n=true}this.editOkAddNewItem=false}this.isNewItem=false}t.set("html",i);this.iconNode.setStyle("background","transparent ");this.iconNode.title="";this.maplist.fireEvent("change");if(n){this.maplist.notAddItem=false;this.maplist.addNewItem(this)}else{this.maplist.notAddItem=true}return true}});MWF.widget.Maplist.Style=new Class({Implements:[Options,Events],Extends:MWF.widget.Maplist,createItem:function(t,e){return new MWF.widget.Maplist.Style.Item(this,t,e)}});MWF.widget.Maplist.Style.Item=new Class({Extends:MWF.widget.Maplist.Item,imgKeys:["background","background-image"],creatItemNode:function(){this.itemNode=new Element("div",{styles:this.maplist.css.contentItemNode});this.iconNode=new Element("div",{styles:this.maplist.css.contentItemIconNode,events:{mouseover:function(t){t.stopPropagation()},mouseout:function(t){t.stopPropagation()}}}).inject(this.itemNode);this.keyNode=new Element("span",{styles:this.maplist.css.contentItemKeyNode,text:this.key}).inject(this.itemNode);this.colonNode=new Element("span",{styles:this.maplist.css.contentItemColonNode,text:":"}).inject(this.itemNode);if(this.imgKeys.indexOf(this.key)==-1){this.valueNode=new Element("span",{styles:this.maplist.css.contentItemValueNode,text:this.value}).inject(this.itemNode)}else{this.valueNode=new Element("span",{styles:this.maplist.css.contentItemImgValueNode,text:"image"}).inject(this.itemNode)}},setItemEvents:function(){this.itemNode.addEvents({mouseover:function(t){t.target.setStyles(this.maplist.css.contentItemNodeOver)}.bind(this),mouseout:function(t){t.target.setStyles(this.maplist.css.contentItemNode)}.bind(this),click:function(t){this.maplist.addNewItem(this)}.bind(this)});this.keyNodeClick=function(t){if(this.maplist.options.isModify)this.editKey(this.keyNode);t.stopPropagation()}.bind(this);this.keyNode.addEvent("click",this.keyNodeClick);if(this.imgKeys.indexOf(this.key)==-1){this.valueNodeClick=function(t){if(this.maplist.options.isModify)this.editValue();t.stopPropagation()}.bind(this);this.valueNode.addEvent("click",this.valueNodeClick)}else{this.valueNode.addEvent("click",this.valueNodeEditImage.bind(this))}},valueNodeEditImage:function(t){var e=this.valueNode.getPosition(this.valueNode.getOffsetParent());var i=this.maplist.app.content.getSize();var s=500;var n=200;if(e.y+n>i.y)e.y=i.y-n-10;if(e.y<0)e.y=10;if(e.x+s>i.x)e.x=i.x-s-10;if(e.x<0)e.x=10;var o=this;MWF.require("MWF.xDesktop.Dialog",function(){var t=new MWF.xDesktop.Dialog({title:this.maplist.options.title+" - "+this.key,style:"settingStyle",top:e.y,left:e.x,fromTop:e.y,fromLeft:e.x,width:s,height:n,html:"",maskNode:this.maplist.app.content,container:this.maplist.app.content,buttonList:[{text:MWF.LP.widget.ok,action:function(){o.saveImage(this)}},{text:MWF.LP.widget.cancel,action:function(){this.close()}}]});t.show();this.createImageContent(t)}.bind(this));t.stopPropagation()},saveImage:function(t){this.textValue=this.valueInput.get("value");this.value=this.imgUrl?"url("+this.imgUrl+") ":"";this.value+=this.textValue;this.maplist.fireEvent("change");t.close()},createImageContent:function(t){var e=new Element("div",{styles:this.maplist.css.imageEditContent}).inject(t.content);var i=new Element("div",{styles:this.maplist.css.imageEditArea}).inject(e);this.imgPreviewArea=new Element("div",{styles:this.maplist.css.imageEditPreview}).inject(i);var s=new Element("div",{styles:this.maplist.css.imageEditActionArea}).inject(i);this.uploadImageAction=new Element("div",{styles:this.maplist.css.imageEditActionNode,text:MWF.LP.widget.uploadImg}).inject(s);this.clearImageAction=new Element("div",{styles:this.maplist.css.imageEditActionNode,text:MWF.LP.widget.clearImg}).inject(s);var n=new Element("div",{styles:this.maplist.css.valueEditArea}).inject(e);this.valueInput=new Element("input",{styles:this.maplist.css.valueEditInput}).inject(n);var o=/(url\().+?\)/gi;var h=this.value.match(o);this.imgUrl="";this.textValue=this.value;if(h&&h.length){this.imgUrl=h[0].substr(0,h[0].lastIndexOf(")"));this.imgUrl=this.imgUrl.substr(this.imgUrl.indexOf("(")+1,this.imgUrl.length);this.textValue=this.value.replace(/(url\().+?\)/i,"").trim()}this.valueInput.set("value",this.textValue);this.showImg();this.uploadImageAction.addEvent("click",function(t){this.uploadImage()}.bind(this));this.clearImageAction.addEvent("click",function(t){var e=this;this.maplist.app.confirm("infor",t,MWF.LP.widget.clearImg_confirmTitle,MWF.LP.widget.clearImg_confirm,300,100,function(){e.clearImage(this)},function(){this.close()})}.bind(this))},uploadImage:function(){if(!this.fileNode){this.fileNode=new Element("input.file",{styles:{display:"none"},type:"file",accept:"images/*"}).inject(this.itemNode);this.fileNode.addEvent("change",function(t){var e=this.fileNode.files[0];this.fileType=e.type;this.fileName=e.name;this.fileSize=e.size;this.loadImage(e)}.bind(this))}this.fileNode.click()},loadImage:function(t){var e=new FileReader;e.onload=function(){this.imgUrl=e.result;this.showImg()}.bind(this);e.readAsDataURL(t)},showImg:function(){this.imgPreviewArea.empty();if(this.imgUrl){this.img=new Element("img",{styles:this.maplist.css.imageEditPreviewImg,src:this.imgUrl}).inject(this.imgPreviewArea);var t=this.img.getSize();var e=Math.max(t.x,t.y);var i=80/e;var s=t.y*i;var n=t.x*i;this.img.setStyles({width:""+n+"px",height:""+s+"px"})}},clearImage:function(t){this.imgUrl="";this.showImg();t.close()},editItemComplate:function(t,e){var i=e.get("value");if(t==this.keyNode){if(!i){this.maplist.deleteItem(this)}var s=true;this.maplist.items.each(function(t){if(t.key==i){if(t!=this)s=false}}.bind(this));if(s){this.key=i;if(this.imgKeys.indexOf(this.key)==-1)this.editValue();this.maplist.notAddItem=true}else{this.iconNode.setStyle("background","url("+this.maplist.path+this.maplist.options.style+"/icon/error.png) center center no-repeat");this.iconNode.title=MWF.LP.process.repetitions;e.select();return false}}var n=false;if(t==this.valueNode){this.value=i;if(this.isEnterKey){if(this.isNewItem){n=true}this.editOkAddNewItem=false}this.isNewItem=false}t.set("html",i);this.iconNode.setStyle("background","transparent ");this.iconNode.title="";this.maplist.fireEvent("change");if(n){this.maplist.notAddItem=false;this.maplist.addNewItem(this)}else{this.maplist.notAddItem=true}return true}});