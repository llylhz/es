MWF.widget=MWF.widget||{};MWF.require("MWF.widget.Common",null,false);MWF.require("MWF.widget.Tree",null,false);MWF.widget.TreeEditor=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default",count:0,height:500,width:500,top:-1,left:-1,maxObj:document.body},initialize:function(t,e){this.setOptions(e);this.node=$(t);this.path=MWF.defaultPath+"/widget/$TreeEditor/";this.cssPath=MWF.defaultPath+"/widget/$TreeEditor/"+this.options.style+"/css.wcss";this._loadCss();this.container=new Element("div")},load:function(t){if(this.fireEvent("queryLoad")){this.container.set("styles",this.css.container);this.container.inject(this.node);this.createTitleNode();this.createContent(t);this.fireEvent("postLoad")}},createTitleNode:function(){this.titleNode=new Element("div",{styles:this.css.titleNode,events:{dblclick:this.toggleSize.bind(this)}}).inject(this.container);this.titleActionNode=new Element("div",{styles:this.css.titleActionNode,events:{click:this.addTreeNode.bind(this)}}).inject(this.titleNode);this.titleTextNode=new Element("div",{styles:this.css.titleTextNode,text:this.options.title}).inject(this.titleNode)},createContent:function(t){this.contentNode=new Element("div",{styles:this.css.contentNode}).inject(this.container);this.json=t;this.resizeContentNodeSize();this.tree=new MWF.widget.TreeEditor.Tree(this,this.contentNode,{style:"editor"});this.tree.treeJson=this.json;this.tree.load()},resizeContentNodeSize:function(){var t=this.titleNode.getSize();var e=this.container.getSize();var i=e.y-t.y-2-6;this.contentNode.setStyle("min-height",""+i+"px")},addTreeNode:function(){if(this.tree){var t=Object.clone(this.tree.nodejson);this.json.push(t);var e=this.tree.appendChild(t);e.selectNode();var i=e.textNode.getElement("div");e.editItem(i)}},toggleSize:function(t){var e=this.titleActionNode.retrieve("status","max");if(e=="max"){this.maxSize()}else{this.returnSize()}},toJson:function(){if(this.tree){return this.tree.toJson(this.tree)}else{return{}}}});MWF.widget.TreeEditor.Tree=new Class({Extends:MWF.widget.Tree,nodejson:{expand:true,title:"",text:"[none]",action:"",icon:"none"},initialize:function(t,e,i){this.parent(e,i);this.editor=t},appendChild:function(t){var e=new MWF.widget.TreeEditor.Tree.Node(this,t);if(this.children.length){e.previousSibling=this.children[this.children.length-1];e.previousSibling.nextSibling=e}else{this.firstChild=e}e.load();e.node.inject(this.node);this.children.push(e);return e},expandOrCollapseNode:function(t){if(t.options.expand){this.collapse(t);t.options.expand=false}else{this.expand(t);t.options.expand=true}t.setOperateIcon();this.editor.fireEvent("change")}});MWF.widget.TreeEditor.Tree.Node=new Class({Extends:MWF.widget.Tree.Node,srciptOption:{width:300,height:300,top:null,left:null},initialize:function(t,e){this.parent(t,e);this.itemNode.addEvents({mouseover:function(){if(!this.isEditScript)this.itemNode.setStyles(this.tree.css.treeItemNodeOver);this.showItemAction()}.bind(this),mouseout:function(){if(!this.isEditScript)this.itemNode.setStyles(this.tree.css.treeItemNode);this.hideItemAction()}.bind(this)})},appendChild:function(t){if(!this.options.sub)this.options.sub=[];this.options.sub.push(t);var e=new MWF.widget.TreeEditor.Tree.Node(this.tree,t);if(this.children.length){e.previousSibling=this.children[this.children.length-1];e.previousSibling.nextSibling=e}else{this.firstChild=e;this.setOperateIcon()}e.level=this.level+1;e.parentNode=this;e.load();e.node.inject(this.childrenNode);this.children.push(e);return e},doAction:function(t){var e=t.target;this.editItem(e)},hideItemAction:function(){if(this.actionNode)this.actionNode.setStyle("display","none")},setActionPosition:function(){if(this.actionNode){this.actionNode.position({relativeTo:this.itemNode,position:"rightCenter",edge:"rightCenter"})}},showItemAction:function(){if(!this.actionNode)this.createItemActionNode();this.setActionPosition();this.actionNode.setStyle("display","block")},createItemActionNode:function(){this.actionNode=new Element("div",{styles:this.tree.css.itemActionNode}).inject(this.itemNode);var t=new Element("div",{styles:this.tree.css.itemDeleteActionNode,title:MWF.LP.process.formAction["delete"],events:{click:function(t){this.deleteItem(t)}.bind(this)}}).inject(this.actionNode);var e=new Element("div",{styles:this.tree.css.itemScriptActionNode,title:MWF.LP.process.formAction["script"],events:{click:function(t){this.editScriptItem(t)}.bind(this)}}).inject(this.actionNode);var i=new Element("div",{styles:this.tree.css.itemAddActionNode,title:MWF.LP.process.formAction.add,events:{click:this.addChild.bind(this)}}).inject(this.actionNode)},getScriptDefaultPosition:function(t,e){var i=this.node.getPosition();var s=this.tree.node.getPosition();var n=this.node.getSize();var o=document.body.getSize();var r=s.x-t-10;if(r+t>o.x)r=o.x-t;if(r<0)r=0;var d=i.y-e/2+n.y/2;if(d+e>o.y)d=o.y-e;if(d<0)d=0;return{x:r,y:d}},createScriptNode:function(){this.scriptNode=new Element("div",{styles:this.tree.css.scriptNode});MWF.require("MWF.widget.ScriptEditor",null,false);this.scriptEditor=new MWF.widget.ScriptEditor(this.scriptNode,{style:"process"})},completeScriptItem:function(){this.itemNode.setStyles(this.tree.css.treeItemNode);this.isEditScript=false;this.tree.currentEditNode=null;if(this.scriptArea){if(!this.scriptArea.treeEditorMorph){this.scriptArea.treeEditorMorph=new Fx.Morph(this.scriptArea.container,{duration:200})}this.scriptArea.treeEditorMorph.start({height:"0",overflow:"auto"}).chain(function(){this.scriptArea.container.setStyle("display","none")}.bind(this))}},editScriptItem:function(t){if(this.tree.currentEditNode!=this){if(this.tree.currentEditNode)this.tree.currentEditNode.completeScriptItem();this.itemNode.setStyle("background","#DDD");if(!this.scriptArea){var e=new Element("div").inject(this.itemNode,"after");MWF.require("MWF.widget.ScriptArea",function(){this.scriptArea=new MWF.widget.ScriptArea(e,{title:MWF.LP.process.formAction["script"],maxObj:this.tree.editor.options.maxObj,style:"treeEditor",onChange:function(){this.options.action=this.scriptArea.toJson();this.tree.editor.fireEvent("change")}.bind(this)});if(!this.options.action)this.options.action={};this.scriptArea.load(this.options.action);this.scriptArea.container.setStyles({overflow:"hidden",height:"0px"})}.bind(this))}this.scriptArea.container.setStyle("display","block");if(!this.scriptArea.treeEditorMorph){this.scriptArea.treeEditorMorph=new Fx.Morph(this.scriptArea.container,{duration:200})}this.scriptArea.treeEditorMorph.start({height:"200px",overflow:"auto"}).chain(function(){this.scriptArea.container.scrollIntoView();this.scriptArea.focus();this.setActionPosition()}.bind(this));this.isEditScript=true;this.tree.currentEditNode=this}else{this.completeScriptItem()}},addChild:function(){var t=Object.clone(this.tree.nodejson);if(!this.options.sub)this.options.sub=[];this.options.sub.push(t);var e=this.appendChild(t);if(!this.options.expand)this.tree.expandOrCollapseNode(this);e.selectNode();var i=e.textNode.getElement("div");e.editItem(i)},deleteItem:function(t){var e=this;var i=t.target.getPosition();var s={event:{x:i.x+40,y:i.y}};layout.confirm("warn",s,MWF.LP.process.notice.deleteTreeNodeTitle,MWF.LP.process.notice.deleteTreeNode,300,120,function(){e.destroy();e.tree.editor.fireEvent("change");this.close()},function(){this.close()},null)},editItem:function(t,e){var i=t.get("text");t.set("html","");var s=new Element("div",{styles:this.tree.css.editInputDiv});var n=new Element("input",{styles:this.tree.css.editInput,type:"text",value:i}).inject(s);var o=MWF.getTextSize(i+"a").x;n.setStyle("width",o);s.setStyle("width",o);s.inject(t);n.select();n.addEvents({keydown:function(t){var e=MWF.getTextSize(n.get("value")+"a").x;t.target.setStyle("width",e);t.target.getParent().setStyle("width",e);if(t.code==13){this.isEnterKey=true;t.target.blur()}}.bind(this),blur:function(i){var s=this.editItemComplate(t,i.target);if(e)e(s)}.bind(this),click:function(t){t.stopPropagation()}.bind(this)})},editItemComplate:function(t,e){var i=e.get("value");if(!i){i="[none]"}this.options.text=i;var s=false;if(this.isEnterKey){if(this.isNewItem){s=true}this.editOkAddNewItem=false}this.isNewItem=false;t.set("html",i);this.tree.editor.fireEvent("change");return true}});