MWF.widget=MWF.widget||{};MWF.require("MWF.widget.UUID",null,false);MWF.widget.MediaRecorder=MWF.MediaRecorder=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default",path:MWF.defaultPath+"/widget/$MediaRecorder/",videoHeight:"232px",constraints:{audio:true,video:true},reference:"",referenceType:""},initialize:function(e,t){this.node=e;this.setOptions(t);this.path=this.options.path||MWF.defaultPath+"/widget/$MediaRecorder/";this.cssPath=this.path+this.options.style+"/css.wcss";this._loadCss();this.fireEvent("init")},load:function(){this.container=new Element("div.container",{styles:this.css.container}).inject(this.node);if(!this.checkBroswer())return;this.loadResource(function(){this._load()}.bind(this))},loadResource:function(e){var t="/x_desktop/res/framework/webrtc/adapter/adapter.js";COMMON.AjaxModule.load(t,function(){if(e)e()}.bind(this))},_load:function(){this.gumVideo=new Element("video",{styles:this.css.gumVideo,autoplay:true,muted:true}).inject(this.container);this.gumVideo.setStyles({height:parseInt(this.options.videoHeight)+"px",width:"calc(20em - 10px)"});this.recordedVideo=new Element("video",{styles:this.css.recordedVideo,loop:true,controls:true}).inject(this.container);this.recordedVideo.setStyles({height:parseInt(this.options.videoHeight)+"px",width:"calc(20em - 10px)"});var e=new Element("div",{styles:this.css.toolbar}).inject(this.container);this.recordButton=new Element("button",{styles:this.css.recordButton,text:"开始录制",events:{click:function(){this.toggleRecording()}.bind(this)}}).inject(e);this.playButton=new Element("button",{styles:this.css.playButton,text:"播放",disable:true,events:{click:function(){this.play()}.bind(this)}}).inject(e);this.downloadButton=new Element("button",{styles:this.css.downloadButton,text:"下载",disable:true,events:{click:function(){this.download()}.bind(this)}}).inject(e);var t=this.mediaSource=new MediaSource;t.addEventListener("sourceopen",this.handleSourceOpen.bind(this),false);navigator.mediaDevices.getUserMedia(this.options.constraints).then(this.handleSuccess.bind(this)).catch(this.handleError.bind(this));this.recordedVideo.addEventListener("error",function(e){console.error("MediaRecording.recordedMedia.error()");alert("Your browser can not play\n\n"+this.recordedVideo.src+"\n\n media clip. event: "+JSON.stringify(e))}.bind(this),true)},handleSuccess:function(e){this.recordButton.disabled=false;console.log("getUserMedia() got stream: ",e);this.stream=e;this.activeFlag=true;this.gumVideo.srcObject=e},handleError:function(e){console.log("navigator.getUserMedia error: ",e)},handleSourceOpen:function(e){console.log("MediaSource opened");this.sourceBuffer=this.mediaSource.addSourceBuffer('video/webm; codecs="vp8"');console.log("Source buffer: ",this.sourceBuffer)},handleDataAvailable:function(e){if(e.data&&e.data.size>0){this.recordedBlobs.push(e.data)}},handleStop:function(e){console.log("Recorder stopped: ",e)},toggleRecording:function(){if(this.isRecording){this.stopRecording();this.recordButton.textContent="开始录制";this.playButton.disabled=false;this.downloadButton.disabled=false;this.isRecording=false}else{this.startRecording();this.recordButton.textContent="结束录制";this.isRecording=true}},startRecording:function(){this.recordedBlobs=[];var e={mimeType:"video/webm;codecs=vp9"};if(!MediaRecorder.isTypeSupported(e.mimeType)){console.log(e.mimeType+" is not Supported");e={mimeType:"video/webm;codecs=vp8"};if(!MediaRecorder.isTypeSupported(e.mimeType)){console.log(e.mimeType+" is not Supported");e={mimeType:"video/webm"};if(!MediaRecorder.isTypeSupported(e.mimeType)){console.log(e.mimeType+" is not Supported");e={mimeType:""}}}}try{var t=this.mediaRecorder=new MediaRecorder(this.stream,e)}catch(t){console.error("Exception while creating MediaRecorder: "+t);alert("Exception while creating MediaRecorder: "+t+". mimeType: "+e.mimeType);return}console.log("Created MediaRecorder",t,"with options",e);this.recordButton.textContent="Stop Recording";this.playButton.disabled=true;this.downloadButton.disabled=true;t.onstop=this.handleStop.bind(this);t.ondataavailable=this.handleDataAvailable.bind(this);t.start(10);console.log("MediaRecorder started",t)},stopRecording:function(){this.mediaRecorder.stop();console.log("Recorded Blobs: ",this.recordedBlobs);this.recordedVideo.controls=true},play:function(){var e=new Blob(this.recordedBlobs,{type:"video/webm"});var t=this.recordedVideo;t.src=window.URL.createObjectURL(e);t.addEventListener("loadedmetadata",function(){if(t.duration===Infinity){t.currentTime=1e101;t.ontimeupdate=function(){t.currentTime=0;t.ontimeupdate=function(){delete t.ontimeupdate;t.play()}}}})},download:function(){var e=new Blob(this.recordedBlobs,{type:"video/webm"});var t=window.URL.createObjectURL(e);var i=document.createElement("a");i.style.display="none";i.href=t;i.download="test.webm";document.body.appendChild(i);i.click();setTimeout(function(){document.body.removeChild(i);window.URL.revokeObjectURL(t)},100)},getFormData:function(){var e=new FormData;e.append("file",this.resizedImage,this.fileName);return e},checkBroswer:function(){var e=location.protocol==="https:"||location.hostname==="localhost";if(!e){this.available=false;this.container.set("html","<p>视频录制功能需要用在 https 协议下才能使用</p>")}var t=MWF.MediaRecorder.getUnavailableBrowerFeatures();if(t.length>0){var i=t.map(function(e,t){return"<li>"+e+"</li>"}).join("");this.available=false;this.container.set("html","<p>视频录制功能不能使用，您的浏览器不支持以下特性:</p><ul>"+i+"</ul>");return false}return true},stopDevice:function(){if(this.sourceBuffer){this.mediaSource.removeSourceBuffer(this.sourceBuffer)}if(this.stream){var e=this.stream.getTracks();for(var t=0;t<e.length;t++){e[t].stop()}this.stream=null;this.activeFlag=false}},close:function(){this.stopDevice();if(this.gumVideo)this.gumVideo.destroy();this.container.destroy();delete this},isActive:function(){return!!this.activeFlag},reset:function(){}});MWF.MediaRecorder.getUnavailableBrowerFeatures=function(){var e=[];if(!window.navigator||!window.navigator.mediaDevices){e.push("mediaDevices")}if(!window.Blob){e.push("Blob")}if(!window.URL){e.push("URL")}if(!window.MediaRecorder){e.push("MediaRecorder")}if(!window.MediaSource){e.push("MediaSource")}return e};MWF.MediaRecorder.isAvailable=function(){var e=location.protocol==="https:"||location.hostname==="localhost";if(!e){return false}if(MWF.MediaRecorder.getUnavailableBrowerFeatures().length>0){return false}return true};