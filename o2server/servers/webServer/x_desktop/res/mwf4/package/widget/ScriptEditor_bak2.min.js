MWF.widget=MWF.widget||{};MWF.require("MWF.widget.Common",null,false);MWF.widget.ScriptEditor=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default",keySeparat:/[\.\,\;\s\{\}\(\)\n\r\t\:\/\*\"\'=\[\]\+\-\/]+/gi,keyCodes:[220,46,13,222,219,221,57,48,191,190,186,188,32,55,16,187,189,8,9]},initialize:function(e,t){this.setOptions(t);this.node=$(e);this.path=MWF.defaultPath+"/widget/$ScriptEditor/";this.cssPath=MWF.defaultPath+"/widget/$ScriptEditor/"+this.options.style+"/css.wcss";this._loadCss();this.checkTextNodes=[]},load:function(e){if(this.fireEvent("queryLoad")){this.createContent(e);this.fireEvent("postLoad")}},createContent:function(e){this.editArea=new Element("iframe",{styles:this.css.contentEditArea,border:"0",frameBorder:"0",marginHeight:"0",marginWidth:"0",scrolling:"auto"}).inject(this.node);this.loadContent(e)},loadContent:function(e){this.editDocument=this.editArea.contentWindow.document;this.window=this.editArea.contentWindow;this.editDocument.write('<style type="text/css">p {margin:0px;}</style><body style="overflow:visible; word-break:keep-all; word-wrap:normal; font-size:12px; font-family:Verdana, Geneva, sans-serif; line-height:20px;">'+e+"</body>");this.editDocument.designMode="On";this.setBodyEvent()},addElementEvent:function(e,t,i){if(e.addEventListener){e.addEventListener(t,i)}else{e.attachEvent("on"+t,i)}},setBodyEvent:function(){this.editDocument.body.style.whiteSpace="nowrap";this.addElementEvent(this.editDocument.body,"keydown",function(e){if(e.keyCode==9){}}.bind(this));this.addElementEvent(this.editDocument.body,"keyup",function(e){if(this.options.keyCodes.indexOf(e.keyCode)!=-1){window.setTimeout(function(){this.checkScriptFormat()}.bind(this),10)}}.bind(this))},clearFontElements:function(){var e=this.editDocument.body.getElementsByTagName("font");var t=e.length;while(e.length){var i=e.item(0);if(i.previousSibling&&i.previousSibling.nodeType==3){i.previousSibling.nodeValue=i.previousSibling.nodeValue+i.firstChild.nodeValue;var n=i.previousSibling;i.parentElement.removeChild(i);while(n.nextSibling&&n.nextSibling.nodeType==3){n.nodeValue=n.nodeValue+n.nextSibling.nodeValue;n.nextSibling.parentNode.removeChild(n.nextSibling)}}else if(i.nextSibling&&i.nextSibling.nodeType==3){i.nextSibling.nodeValue=i.firstChild.nodeValue+i.nextSibling.nodeValue;var n=i.nextSibling;i.parentElement.removeChild(i);while(n.previousSibling&&n.previousSibling.nodeType==3){n.nodeValue=n.nodeValue+n.previousSibling.nodeValue;n.previousSibling.parentNode.removeChild(n.previousSibling)}}else{if(i.firstChild){i.parentNode.replaceChild(this.editDocument.createTextNode(i.firstChild.nodeValue),i)}else{i.parentNode.removeChild(i)}}}},getCheckScriptElements:function(e){if(e){if(e.nodeType==3){this.checkTextNodes.push(e)}else{if(e.nodeType==1&&e.tagName.toString().toLowerCase()=="font"){}else{var t=e.childNodes;for(var i=0;i<t.length;i++){this.getCheckScriptElements(t[i])}}}}},checkScriptFormat:function(e){this.clearFontElements();this.checkScriptFormatComment();this.checkScriptFormatString();this.checkScriptFormatNumber();this.checkScriptFormatKeyword()},recordCurrentInsertPoint:function(){this.currentInsertPointCount=0;var e=this.window.getSelection();var t=e.focusNode;if(t.nodeType==3){}},checkScriptFormatNumber:function(){this.checkTextNodes=[];this.getCheckScriptElements(this.editDocument.body);this.checkTextNodes.each(function(e){this.checkScriptTextFormatNumber(e)}.bind(this))},checkScriptTextFormatNumber:function(e){var t=this.css.number.color;var i=this.editDocument.createRange();var n=/\b(-?\d+(\.\d+)?)/g;var o=e.nodeValue.match(n);if(o){var r=o[0];var s=e.nodeValue.indexOf(r);var c=s;var a=c+r.length;i.setStart(e,c);i.setEnd(e,a);var d=this.createFormatFont(i,t,"number");var h=d.nextSibling;if(h&&h.nodeType==3){this.checkScriptTextFormatNumber(h)}}},checkScriptFormatString:function(){this.checkTextNodes=[];this.getCheckScriptElements(this.editDocument.body);this.isScriptTextString=false;this.checkTextNodes.each(function(e){this.checkScriptTextFormatString(e)}.bind(this))},checkScriptTextFormatString:function(e){var t=this.css.string.color;var i=this.editDocument.createRange();var n=e.nodeValue;var o=n.indexOf('"');var r=n.indexOf("'");var s=-1;var c=-1;var a='"';if(o!=-1&&r==-1){s=o}else if(o==-1&&r!=-1){s=r;a="'"}else if(o!=-1&&r!=-1){if(o<r){s=o}else{s=r;a="'"}}if(s!=-1){var d=n.indexOf('"',s+1);while(d!=-1){var h=n.substr(d-1,1);if(h!="\\"){c=d+1;break}var d=n.indexOf('"',d+1)}if(c!=-1){i.setStart(e,s);i.setEnd(e,c);var l=this.createFormatFont(i,t,"string");var m=l.nextSibling;if(m&&m.nodeType==3){this.checkScriptTextFormatString(m)}}}},checkScriptFormatKeyword:function(){this.checkTextNodes=[];this.getCheckScriptElements(this.editDocument.body);this.checkTextNodes.each(function(e){this.checkScriptTextFormatKeyword(e)}.bind(this))},checkScriptTextFormatKeyword:function(e){var t=this.css.keywords.color;var i=this.editDocument.createRange();var n=/\b((function)|(if)|(else)|(case)|(switch)|(for)|(in)|(do)|(while)|(width)|(var)|(this)|(break)|(continue)|(return)|(true)|(false)|(throw)|(try)|(finally)|(catch)|(finally)|(debugger)|(new)|(delete))/gi;var o=e.nodeValue.match(n);if(o){var r=o[0];var s=e.nodeValue.indexOf(r);var c=s;var a=c+r.length;i.setStart(e,c);i.setEnd(e,a);var d=this.createFormatFont(i,t,"keyword");var h=d.nextSibling;if(h&&h.nodeType==3){this.checkScriptTextFormatKeyword(h)}}},checkScriptFormatComment:function(){this.checkTextNodes=[];this.getCheckScriptElements(this.editDocument.body);this.isScriptTextComment=false;this.checkTextNodes.each(function(e){this.checkScriptTextFormatComment(e)}.bind(this))},checkScriptTextFormatComment:function(e){var t=this.css.comment.color;var i=this.editDocument.createRange();if(!this.isScriptTextComment){var n=e.nodeValue.indexOf("//");var o=e.nodeValue.indexOf("/*");if(n!=-1&&o==-1){i.setStart(e,n);i.setEnd(e,e.nodeValue.length);this.createFormatFont(i,t,"comment")}else if(n==-1&&o!=-1){i.setStart(e,o);i.setEnd(e,e.nodeValue.length);this.isScriptTextComment=true;this.createFormatFont(i,t,"comment")}else if(n!=-1&&o!=-1){if(n<o){i.setStart(e,n);i.setEnd(e,e.nodeValue.length);this.createFormatFont(i,t,"comment")}else{i.setStart(e,o);i.setEnd(e,e.nodeValue.length);this.isScriptTextComment=true;this.createFormatFont(i,t,"comment")}}}else{var r=e.nodeValue.indexOf("*/");if(r!=-1){i.setStart(e,0);i.setEnd(e,r+2);this.isScriptTextComment=false;this.createFormatFont(i,t,"comment")}else{i.setStart(e,0);i.setEnd(e,e.nodeValue.length);this.createFormatFont(i,t,"comment")}}},createFormatFont:function(e,t,i){var n=this.editDocument.createElement("font");n.appendChild(this.editDocument.createTextNode(e.toString()));n.MWFScriptType=i;n.setAttribute("color",t);e.deleteContents();e.insertNode(n);return n}});