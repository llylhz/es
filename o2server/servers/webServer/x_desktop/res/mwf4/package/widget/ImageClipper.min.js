MWF.widget=MWF.widget||{};MWF.widget.ImageClipper=MWF.ImageClipper=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default",path:MWF.defaultPath+"/widget/$ImageClipper/",imageUrl:"",action:null,method:"",parameter:{},data:null,reference:"",referenceType:"",description:"",aspectRatio:1,resultMaxSize:800,editorSize:340,frameMinSize:30,previewerSize:260,showPreviewer:true,fromLocalEnable:true,fromFileEnable:true,resetEnable:false,uploadSourceEnable:true},initialize:function(e,t){this.node=e;if(isNaN(t.aspectRatio))t.aspectRatio=0;if(isNaN(t.resultMaxSize))t.resultMaxSize=800;this.setOptions(t);this.path=this.options.path||MWF.defaultPath+"/widget/$ImageClipper/";this.cssPath=this.path+this.options.style+"/css.wcss";this._loadCss();this.fireEvent("init")},load:function(e){this.container=new Element("div.container",{styles:this.css.container}).inject(this.node);this.container.addEvent("selectstart",function(e){e.preventDefault();e.stopPropagation()});if(this.checkBroswer()){this._loadWithH5(e)}else{this._loadWithSWF()}},_loadWithSWF:function(){this.clipper=new MWF.widget.FlashImageClipper(this.container,this.options,this);this.clipper.load()},_loadWithH5:function(e){this.clipper=new MWF.widget.HTML5ImageClipper(this.container,this.options,this);this.clipper.load(e)},uploadImage:function(e,t){this.clipper.uploadImage(e,t)},getFormData:function(){return this.clipper.getFormData()},getResizedImage:function(){return this.clipper.getResizedImage()},getBase64Code:function(){return this.clipper.getBase64Code()},getBase64Image:function(){return this.clipper.getBase64Image()},close:function(){this.clipper.close()},checkBroswer:function(){if(window.Uint8Array&&window.HTMLCanvasElement&&window.atob&&window.Blob){this.available=true;return true}else{this.available=false;return false}}});MWF.widget.FlashImageClipper=new Class({Implements:[Options,Events],options:{style:"default",path:MWF.defaultPath+"/widget/$ImageClipper/",imageUrl:"",action:null,method:"",parameter:{},reference:"",referenceType:"",description:"",aspectRatio:1,resultMaxSize:800},initialize:function(e,t,i){this.container=e;this.setOptions(t);this.parent=i;if(!this.options.aspectRatio){this.options.aspectRatio=1}this.Previer_MaxSize=240;this.css=this.parent.css;this.fireEvent("init")},load:function(){window.uploadevent_flash=function(e){if(typeOf(e)=="number"){e+="";switch(e){case"1":alert("上传成功！");var t=(new Date).getTime();ok();break;case"2":if(this.isUploading){return 0}else{this.isUploading=true;return 1}break;case"-1":this.isUploading=false;break;case"-2":this.isUploading=false;alert("上传失败，请重新上传!");window.location.href="#";break;default:}}else{this.isUploading=false;var i=JSON.parse(e);if(i.type=="error"){alert(i.message)}else{if(this.uploadSuccess)this.uploadSuccess(i.data)}}}.bind(this);this.getUploadUrl(function(){this.renderFlash()}.bind(this))},renderFlash:function(){this.contentNode=new Element("div.contentNode",{styles:this.css.contentNode,id:"imageclipper_swf"}).inject(this.container);var e=MWF.defaultPath+"/widget/$ImageClipper/";var t=this.options.imageUrl||e+"flash_default.png";if(this.options.aspectRatio>1){var i=this.Previer_MaxSize;var s=this.Previer_MaxSize/this.options.aspectRatio}else{var i=this.Previer_MaxSize*this.options.aspectRatio;var s=this.Previer_MaxSize}COMMON.AjaxModule.load(e+"swfobject.js",function(){swfobject.embedSWF(e+"FaustCplus.swf",this.contentNode,"650","370","9.0.0",e+"expressInstall.swf",{jsfunc:"uploadevent_flash",imgUrl:t,tip:this.options.description,aspectRatio:this.options.aspectRatio,reqContentDisposition:"",imageUploadKey:"thumb.jpg",imageSrcUploadKey:"src.jpg",showZoom:false,showSaveBtns:false,showTurn:false,showColorAdjuster:false,pid:"75642723",uploadSrc:false,showBrow:true,showCame:false,pSize:"300|300|"+i+"|"+s,uploadUrl:this.uploadUrl},{menu:"false",scale:"noScale",allowFullscreen:"true",allowScriptAccess:"always",wmode:"transparent",bgcolor:"#FFFFFF"},{id:"FaustCplus"},function(e){this.swf=e}.bind(this))}.bind(this))},getUploadUrl:function(e){if(this.options.action){this.action=typeOf(this.options.action)=="string"?MWF.Actions.get(action).action:this.options.action;this.action.getActions(function(){var i=this.action.actions[this.options.method];i=this.action.address+i.uri;if(this.options.parameter){Object.each(this.options.parameter,function(e,t){i=i.replace("{"+t+"}",e)})}this.uploadUrl=i;if(e)e(i)}.bind(this))}else{var t=layout.desktop.serviceAddressList["x_file_assemble_control"];if(t){var i=layout.config.app_protocol+"//"+t.host+(t.port==80?"":":"+t.port)+t.context}else{var s=layout.config.center.host||window.location.hostname;var o=layout.config.center.port;var i=layout.config.app_protocol+"//"+s+(o=="80"?"":":"+o)+"/x_program_center"}var n="/jaxrs/file/upload/referencetype/"+this.options.referenceType+"/reference/"+this.options.reference+"/scale/"+this.options.resultMaxSize;this.uploadUrl=i+n;if(e)e(this.uploadUrl)}},uploadImage:function(e,t){this.uploadSuccess=e;if(this.swf){this.swf.ref["jscall_updateAvatar"]()}},getFormData:function(){return true},getResizedImage:function(){return true},getBase64Code:function(){return true},getBase64Image:function(){return true},close:function(){}});MWF.widget.HTML5ImageClipper=new Class({Implements:[Options,Events],options:{style:"default",path:MWF.defaultPath+"/widget/$ImageClipper/",imageUrl:"",editorSize:340,aspectRatio:1,frameMinSize:30,previewerSize:260,resultMaxSize:800,action:null,method:"",parameter:{},data:null,reference:"",referenceType:"",uploadSourceEnable:true,showPreviewer:true,fromLocalEnable:true,fromFileEnable:true,resetEnable:false,description:""},initialize:function(e,t,i){this.container=e;this.setOptions(t);this.parent=i;this.fileName="untitled.png";this.fileType="image/png";this.fileSize=null;this.css=this.parent.css;this.fireEvent("init")},load:function(e){this.lastPoint=null;this.loadToolBar();this.contentNode=new Element("div.contentNode",{styles:this.css.contentNode}).inject(this.container);this.loadEditorNode();this.loadResultNode();if(this.options.description){this.loadDescriptionNode()}if(this.options.imageUrl){this.loadImageAsUrl(this.options.imageUrl)}if(e){this.loadImageAsFile(this.base64ToBlob(e))}},uploadImage:function(t,e){if(this.resizedImage){if(this.options.action){this.action=typeOf(this.options.action)=="string"?MWF.Actions.get(action).action:this.options.action;this.action.invoke({name:this.options.method,async:true,data:this.getFormData(),file:this.resizedImage,parameter:this.options.parameter,success:function(e){t(e)}.bind(this)})}else{var i=this.options.resultMaxSize;if(this.uploadSourceInput&&this.uploadSourceInput.get("checked")){i=0}MWF.xDesktop.uploadImageByScale(this.options.reference,this.options.referenceType,i,this.getFormData(),this.resizedImage,t,e)}}else{}},getFormData:function(){var i=new FormData;i.append("file",this.resizedImage,this.fileName);if(this.options.data){Object.each(this.options.data,function(e,t){i.append(t,e)})}return i},getResizedImage:function(){return this.resizedImage},getBase64Code:function(){return this.base64Code},getBase64Image:function(){if(!this.base64Code)return null;return"data:"+this.fileType+";base64,"+this.base64Code},checkBroswer:function(){if(window.Uint8Array&&window.HTMLCanvasElement&&window.atob&&window.Blob){this.available=true;return true}else{this.available=false;return false}},close:function(){this.docBody.removeEvent("touchmove",this.bodyMouseMoveFun);this.docBody.removeEvent("mousemove",this.bodyMouseMoveFun);this.docBody.removeEvent("touchend",this.bodyMouseEndFun);this.docBody.removeEvent("mouseup",this.bodyMouseEndFun);this.container.destroy();delete this},loadToolBar:function(){this.uploadToolbar=new Element("div.uploadToolbar",{styles:this.css.uploadToolbar}).inject(this.container);if(this.options.fromLocalEnable){this.uploadLocalImage=new Element("button.uploadActionNode",{styles:this.css.uploadActionNode,text:"选择本地图片"}).inject(this.uploadToolbar);this.uploadLocalImage.addEvents({click:function(){this.fileNode.click()}.bind(this)});this.fileNode=new Element("input.file",{type:"file",accept:"images/*",styles:{display:"none"}}).inject(this.container);this.fileNode.addEvent("change",function(e){var t=this.fileNode.files[0];this.fileType=t.type;this.fileName=t.name;this.fileSize=t.size;this.loadImageAsFile(t)}.bind(this))}this._createUploadButtom();this.uploadCloudFileArea=new Element("span").inject(this.uploadToolbar);if(this.options.fromFileEnable){var e=MWF.defaultPath+"/xDesktop/$Layout/applications.json";MWF.getJSON(e,function(e){e.each(function(e){if(e.name=="File"||e.path=="File"){this.uploadCloudFile=new Element("button.uploadActionNode",{styles:this.css.uploadActionNode,text:"选择云文件图片"}).inject(this.uploadCloudFileArea);this.uploadCloudFile.addEvents({click:function(){this.selectFileImage(function(e,t,i){this.fileName=i.name;this.fileType=["jpeg","jpg"].contains(i.extension.toLowerCase())?"image/jpeg":"image/png";this.fileSize=i.length;this.loadImageAsUrl(e)}.bind(this))}.bind(this)})}}.bind(this))}.bind(this))}if(this.options.resetEnable){this.resetAction=new Element("button.resetAction",{styles:this.css.resetActionNode,text:"重置"}).inject(this.uploadToolbar);this.resetAction.addEvents({click:function(){this.reset()}.bind(this)})}if(this.options.uploadSourceEnable){this.uploadSourceInput=new Element("input",{type:"checkbox",events:{change:function(){this.clipImage()}.bind(this)}}).inject(this.uploadToolbar);new Element("span",{text:"上传原图"}).inject(this.uploadToolbar)}},_createUploadButtom:function(){},reset:function(){this.fileName="untitled.png";this.fileType="image/png";this.fileSize=null;this.resizedImage="";this.base64Code="";this.resetImage();this.setFrameSize({width:0,height:0});this.frameOffset.top=0;this.frameOffset.left=0;this.frameNode.setStyles({top:0,left:0});this.resultNode.empty();this.editorContainer.setStyles(this.css.editorContainer);this.imageNode.setStyle("display","none");this.innerNode.setStyles({width:0,height:0})},selectFileImage:function(s){var e=this;MWF.xDesktop.requireApp("File","FileSelector",function(){e.selector_cloud=new MWF.xApplication.File.FileSelector(document.body,{style:"default",title:"选择云文件图片",copyToPublic:false,listStyle:"preview",selectType:"images",onPostSelectAttachment:function(e,t,i){if(s)s(e,t,i)}});e.selector_cloud.load()},true)},loadResultNode:function(){if(this.options.showPreviewer){this.resultContainer=new Element("div",{styles:this.css.resultContainer}).inject(this.contentNode);var e=Math.max(this.options.editorSize,this.options.previewerSize)-parseInt(this.resultContainer.getStyle("padding-left"))*2;this.resultContainer.setStyles({width:this.options.previewerSize+"px",height:e+"px"});this.resultTitleNode=new Element("div",{styles:this.css.resultTitleNode,text:"预览"}).inject(this.resultContainer);var t=this.resultTitleNode.getSize().y;var i=this.options.aspectRatio?this.options.previewerSize/this.options.aspectRatio:this.options.previewerSize;this.resultNode=new Element("div.resultNode",{styles:this.css.resultNode}).inject(this.resultContainer);this.resultNode.setStyles({"padding-top":(e-t-i)/2-10+"px"})}else{this.resultNode=new Element("div",{styles:{display:"none"}}).inject(this.contentNode)}},loadEditorNode:function(){this.docBody=window.document.body;this.editorContainer=new Element("div.editorContainer",{styles:this.css.editorContainer}).inject(this.contentNode);this.editorContainer.setStyles({width:this.options.editorSize+"px",height:this.options.editorSize+"px"});this.editorNode=new Element("div.editorNode",{styles:this.css.editorNode}).inject(this.editorContainer);this.innerNode=new Element("div.innerNode",{styles:this.css.innerNode}).inject(this.editorNode);this.imageNode=new Element("img",{styles:this.css.imageNode}).inject(this.innerNode);this.imageNode.ondragstart=function(){return false};this.frameNode=new Element("div.frameNode",{styles:this.css.frameNode}).inject(this.innerNode);this.frameOffset={top:0,left:0};this.frameNode.addEvents({touchstart:function(e){this.getOffset(e)}.bind(this),mousedown:function(e){this.getOffset(e)}.bind(this),touchmove:function(e){if(!this.lastPoint)return;var t=this.getOffset(e);if(this.resizeMode){this.resizeFrames(t)}else{this.moveFrames(t)}e.stopPropagation()}.bind(this),mousemove:function(e){if(!this.lastPoint)return;var t=this.getOffset(e);if(this.resizeMode){this.resizeFrames(t)}else{this.moveFrames(t)}e.stopPropagation()}.bind(this),touchend:function(e){this.lastPoint=null;if(this.resizeMode){this.frameNode.setStyle("cursor","move");this.docBody.setStyle("cursor","default");this.resizeMode=false}this.clipImage();e.stopPropagation()}.bind(this),mouseup:function(e){this.lastPoint=null;if(this.resizeMode){this.frameNode.setStyle("cursor","move");this.docBody.setStyle("cursor","default");this.resizeMode=false}this.clipImage();e.stopPropagation()}.bind(this)});this.reizeNode=new Element("div.reizeNode",{styles:this.css.reizeNode}).inject(this.frameNode);this.reizeNode.addEvents({touchstart:function(e){this.frameNode.setStyle("cursor","nw-resize");this.docBody.setStyle("cursor","nw-resize");this.resizeMode=true;this.getOffset(e);e.stopPropagation()}.bind(this),mousedown:function(e){this.frameNode.setStyle("cursor","nw-resize");this.docBody.setStyle("cursor","nw-resize");this.resizeMode=true;this.getOffset(e);e.stopPropagation()}.bind(this),touchmove:function(e){if(!this.lastPoint)return;var t=this.getOffset(e);this.resizeFrames(t);e.stopPropagation()}.bind(this),mousemove:function(e){if(!this.lastPoint)return;var t=this.getOffset(e);this.resizeFrames(t);e.stopPropagation()}.bind(this),touchend:function(e){this.frameNode.setStyle("cursor","move");this.docBody.setStyle("cursor","default");this.resizeMode=false;this.lastPoint=null;this.clipImage();e.stopPropagation()}.bind(this),mouseup:function(e){this.frameNode.setStyle("cursor","move");this.docBody.setStyle("cursor","default");this.resizeMode=false;this.lastPoint=null;this.clipImage();e.stopPropagation()}.bind(this)});this.bodyMouseMoveFun=this.bodyMouseMove.bind(this);this.docBody.addEvent("touchmove",this.bodyMouseMoveFun);this.docBody.addEvent("mousemove",this.bodyMouseMoveFun);this.bodyMouseEndFun=this.bodyMouseEnd.bind(this);this.docBody.addEvent("touchend",this.bodyMouseEndFun);this.docBody.addEvent("mouseup",this.bodyMouseEndFun)},loadDescriptionNode:function(){new Element("div",{styles:this.css.descriptionNode,text:this.options.description}).inject(this.container)},bodyMouseMove:function(e){if(!this.lastPoint)return;if(this.resizeMode){var t=this.getOffset(e);this.resizeFrames(t)}},bodyMouseEnd:function(e){this.lastPoint=null;if(this.resizeMode){this.frameNode.setStyle("cursor","move");this.docBody.setStyle("cursor","default");this.resizeMode=false;this.clipImage()}},clipImage:function(){this.resultNode.empty();var e=this.imageNode.naturalHeight,t=this.imageNode.naturalWidth,i=this.uploadSourceInput&&this.uploadSourceInput.get("checked")?0:this.options.resultMaxSize,s,o;o=this.options.aspectRatio?this.options.aspectRatio:this.frameOffset.size.width/this.frameOffset.size.height;if(i==0||e<=i&&t<=i){s=this.getRatioMaxSize(t,e,o)}else{var n=Math.min(i,e,t);s=this.getRatioMaxSize(n,n,o)}var a=new Element("canvas",s);var r=a.getContext("2d"),h=t/this.offset.width,l=this.frameOffset.left*h,d=this.frameOffset.top*h,f=this.frameOffset.size.width*h,c=this.frameOffset.size.height*h;r.drawImage(this.imageNode,l,d,f,c,0,0,s.width,s.height);var u=a.toDataURL(this.fileType);this.canvas=a;a.inject(this.resultNode);u=u.split(",")[1];if(!u){this.resizedImage=null;this.base64Code="";return}this.base64Code=u;u=window.atob(u);var p=new Uint8Array(u.length);for(var m=0;m<u.length;m++){p[m]=u.charCodeAt(m)}this.resizedImage=new Blob([p],{type:this.fileType});var n=Math.min(this.options.previewerSize,e,t,this.options.resultMaxSize);s=this.getRatioMaxSize(n,n,o);a.setStyles({width:s.width+"px",height:s.height+"px"})},loadImageAsFile:function(e){this.resetImage();this.editorContainer.setStyles(this.css.editorContainer_active);this.imageNode.setStyle("display","");this.setFrameSize({width:0,height:0});this.frameOffset.top=0;this.frameOffset.left=0;this.frameNode.setStyles({top:0,left:0});var t=new FileReader;t.onload=function(){this.imageNode.src=t.result;t=null;this.onImageLoad()}.bind(this);t.readAsDataURL(e)},loadImageAsUrl:function(e){this.resetImage();this.editorContainer.setStyles(this.css.editorContainer_active);this.imageNode.setStyle("display","");this.setFrameSize({width:0,height:0});this.frameOffset.top=0;this.frameOffset.left=0;this.frameNode.setStyles({top:0,left:0});this.onImageLoadFun=this.onImageLoad.bind(this);this.imageNode.addEvent("load",this.onImageLoadFun);this.imageNode.src=e},onImageLoad:function(){var e=this.imageNode.naturalHeight,t=this.imageNode.naturalWidth;if(isNaN(e)||isNaN(t)||e==0||t==0){setTimeout(function(){this.onImageLoad()}.bind(this),100)}else{this._onImageLoad()}},_onImageLoad:function(){this.setImageSize();this.setFrameSize(this.getDefaultSize());this.clipImage();if(this.onImageLoadFun){this.imageNode.removeEvent("load",this.onImageLoadFun);this.onImageLoadFun=null}},resetImage:function(){this.imageNode.src="";if(this.canvas)this.canvas.destroy()},setImageSize:function(){var e=this.imageNode.naturalHeight,t=this.imageNode.naturalWidth,i;if(t>e){i={width:this.options.editorSize,height:this.options.editorSize*(e/t)}}else{i={width:this.options.editorSize*(t/e),height:this.options.editorSize}}this.offset=i;this.imageNode.setStyles(i)},setFrameSize:function(e){this.frameOffset.size=e;return this.frameNode.setStyles({width:e.width+"px",height:e.height+"px"})},getDefaultSize:function(){this.innerNode.setStyles({width:this.offset.width,height:this.offset.height,"margin-left":(this.options.editorSize-this.offset.width)/2+"px","margin-top":(this.options.editorSize-this.offset.height)/2+"px"});if(this.options.aspectRatio){return this.getRatioMaxSize(this.offset.width,this.offset.height)}else{return{width:this.offset.width,height:this.offset.height}}},getRatioMaxSize:function(e,t,i){if(!i)i=this.options.aspectRatio;var s=e/t;if(s>i){return{width:t*i,height:t}}else{return{width:e,height:e/i}}},resizeFrames:function(e){var t=e.x;if(t==0)return;var i=e.y;if(i==0)return;var s=this.frameOffset.top,o=this.frameOffset.left,n=this.frameOffset.size,a=this.offset.width,r=this.offset.height,h=this.options.aspectRatio,l,d;if(h){if(Math.abs(t)/Math.abs(i)>h){if(t+n.width+o>a){return}else{l=t+n.width;d=l/h;if(d+s>r){return}}}else{if(i+n.height+s>r){return}else{d=i+n.height;l=d*h}if(l+o>a){return}}}else{if(t+n.width+o>a){return}else{l=t+n.width}if(i+n.height+s>r){return}else{d=i+n.height}}var f=this.options.frameMinSize;var c=h?f/h:f;l=l<f?f:l;d=d<c?c:d;this.frameNode.setStyles({width:l+"px",height:d+"px"});this.frameOffset.size={width:l,height:d}},moveFrames:function(e){var t=e.x,i=e.y,s=this.frameOffset.top,o=this.frameOffset.left,n=this.frameOffset.size,a=this.offset.width,r=this.offset.height;if(t+n.width+o>a){t=a-n.width}else{t=t+o}if(i+n.height+s>r){i=r-n.height}else{i=i+s}t=t<0?0:t;i=i<0?0:i;this.frameNode.setStyles({top:i+"px",left:t+"px"});this.frameOffset.top=i;this.frameOffset.left=t},getOffset:function(e){e=e.event;var t,i;if(e.touches){var s=e.touches[0];t=s.clientX;i=s.clientY}else{t=e.clientX;i=e.clientY}if(!this.lastPoint){this.lastPoint={x:t,y:i}}var o={x:t-this.lastPoint.x,y:i-this.lastPoint.y};this.lastPoint={x:t,y:i};return o},base64ToBlob:function(e){if(e.substr(0,10)=="data:image"){var t=window.atob(e.split(",")[1])}else{var t=window.atob(e)}var i=new ArrayBuffer(t.length);var s=new Uint8Array(i);for(var o=0;o<t.length;o++){s[o]=t.charCodeAt(o)}return new Blob([i],{type:this.fileType})}});