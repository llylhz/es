MWF.widget=MWF.widget||{};MWF.widget.chart=MWF.widget.chart||{};MWF.require("MWF.widget.Common",null,false);MWF.require("MWF.widget.chart.d3",null,false);MWF.require("MWF.widget.UUID",null,false);MWF.widget.chart.Dashboard=new Class({Implements:[Options,Events],Extends:MWF.widget.Common,options:{style:"default",margin:"10px",sort:"ASC",red:.3,green:.3,borderWidth:6,arcWidth:15,arcMargin:22,ticks:7,tickLong:6,miniTicks:31,miniTickLong:3,centerWidth:6,format:"",formatdData:"",text:"",domain:[]},initialize:function(t,i,s){this.setOptions(s);this.container=$(t);this.data=i;this.classId=new MWF.widget.UUID;this.path=MWF.defaultPath+"/widget/chart/$Dashboard/";this.cssPath=MWF.defaultPath+"/widget/chart/$Dashboard/"+this.options.style+"/css.wcss";this._loadCss()},load:function(){this.node=new Element("div",{styles:this.css.node}).inject(this.container);this.setNodeSize();MWF.widget.chart.d3.load(function(){if(this.fireEvent("queryLoad")){this.svg=d3.select(this.node).append("svg");this.setSvgSize();this.showData=this.data;var t=d3.max(this.options.domain);var i=d3.min(this.options.domain);if(this.data>t)this.showData=t;if(this.data<i)this.showData=i;this.drawCircleOutline();this.drawArc();this.drawMiniTicks();this.drawTicks();this.drawText();this.drawPointer()}}.bind(this));this.fireEvent("postLoad")},setNodeSize:function(){var t=this.options.margin.toInt();var i=this.container.getSize();var s=i.x-t*2;var a=i.y-t*2;this.size={x:s,y:a,m:t}},setSvgSize:function(){this.svg.attr("width","100%").attr("height","100%")},drawCircleOutline:function(){var t=this.size.x/2;var i=this.size.x/2+this.size.m;this.circleBig=this.svg.append("circle").attr("cx",i).attr("cy",i).attr("r",t);Object.each(this.css.circleBig,function(t,i){this.circleBig.attr(i,t)}.bind(this));t=t-this.options.borderWidth;this.circleSmall=this.svg.append("circle").attr("cx",i).attr("cy",i).attr("r",t);Object.each(this.css.circleSmall,function(t,i){this.circleSmall.attr(i,t)}.bind(this));this.circleCenter=this.svg.append("circle").attr("cx",i).attr("cy",i).attr("r",this.options.centerWidth);Object.each(this.css.circleCenter,function(t,i){this.circleCenter.attr(i,t)}.bind(this));this.setDefs("circleBig_defs",this.circleBig);this.setDefs("circleSmall_defs",this.circleSmall);this.setDefs("circleCenter_defs",this.circleCenter)},setDefs:function(t,i){if(this.css[t]){var s=this.svg.append("defs");this.createDefs(s,this.css[t]);s.select(function(){return this.getFirst()}).attr("id",this.classId+"_"+t);i.attr(this.css[t].urlAttr,"url(#"+this.classId+"_"+t+")")}},createDefs:function(t,i){var s=t.append(i.tag);Object.each(i.attrs,function(t,i){s.attr(i,t)});if(i.subs){i.subs.each(function(t){this.createDefs(s,t)}.bind(this))}},drawArc:function(){this.angleScale=d3.scaleLinear().domain(this.options.domain).range([0-.75*Math.PI,.75*Math.PI]);var t=this.angleScale(this.options.green*d3.max(this.options.domain));var i=this.angleScale((1-this.options.red)*d3.max(this.options.domain));var s={startAngle:0-.75*Math.PI,endAngle:t};var a={startAngle:t,endAngle:i};var e={startAngle:i,endAngle:.75*Math.PI};var r=this.size.x/2-this.options.arcMargin-this.options.borderWidth;var n=this.size.x/2-this.options.arcMargin-this.options.arcWidth-this.options.borderWidth;var h=this.size.x/2+this.size.m;var o=d3.arc().innerRadius(n).outerRadius(r);this.greenArc=this.svg.append("path").attr("d",o(s)).attr("transform","translate("+h+", "+h+")");this.yellowArc=this.svg.append("path").attr("d",o(a)).attr("transform","translate("+h+", "+h+")");this.redArc=this.svg.append("path").attr("d",o(e)).attr("transform","translate("+h+", "+h+")");Object.each(this.css.greenArc,function(t,i){this.greenArc.attr(i,t)}.bind(this));Object.each(this.css.yellowArc,function(t,i){this.yellowArc.attr(i,t)}.bind(this));Object.each(this.css.redArc,function(t,i){this.redArc.attr(i,t)}.bind(this));this.setDefs("greenArc_defs",this.greenArc);this.setDefs("yellowArc_defs",this.yellowArc);this.setDefs("redArc_defs",this.redArc)},drawTicks:function(){var t=d3.max(this.options.domain)/(this.options.ticks-1);var i=this.size.x/2-this.options.borderWidth;var s=this.size.x/2-this.options.tickLong-this.options.borderWidth;var a=this.size.x/2+this.size.m;var e=d3.arc().innerRadius(s).outerRadius(i);var r=d3.arc().innerRadius(s-16).outerRadius(s);for(var n=0;n<this.options.ticks;n++){var h=this.angleScale(t*n);var o={startAngle:h,endAngle:h};var d=this.svg.append("path").attr("d",e(o)).attr("transform","translate("+a+", "+a+")");Object.each(this.css.tick,function(t,i){d.attr(i,t)}.bind(this));var c=r.centroid(o);var l=Math.round(t*n);if(l>1e3){l=l/1e3;l=d3.format("0.3r")(l);l=l+"k"}this.svg.append("text").attr("transform","translate("+a+", "+a+") "+"translate("+c[0]+", "+c[1]+")").attr("text-anchor","middle").attr("dy","4").attr("font-size","10px").text(l)}},drawMiniTicks:function(){var t=d3.max(this.options.domain)/(this.options.miniTicks-1);var i=this.size.x/2-this.options.borderWidth;var s=this.size.x/2-this.options.miniTickLong-this.options.borderWidth;var a=this.size.x/2+this.size.m;var e=d3.arc().innerRadius(s).outerRadius(i);for(var r=0;r<this.options.miniTicks;r++){var n=this.angleScale(t*r);var h={startAngle:n,endAngle:n};var o=this.svg.append("path").attr("d",e(h)).attr("transform","translate("+a+", "+a+")");Object.each(this.css.miniTick,function(t,i){o.attr(i,t)}.bind(this))}},getPointerPath:function(t){var i=this.size.x/2+this.size.m;var s=this.size.x/2-this.options.tickLong-this.options.borderWidth;var a=d3.arc().innerRadius(s-24).outerRadius(s);var e=this.angleScale(t);var r={startAngle:e,endAngle:e};var n=a.centroid(r);var h=n[0]+i;var o=n[1]+i;var d=this.angleScale(d3.min(this.options.domain));var c=0-n[0];var l=0-n[1];var p=Math.sqrt(Math.pow(c,2)+Math.pow(l,2));var f=this.options.centerWidth-4;var v=Math.asin(l/p);var g=Math.asin(f/p);var u,m;if(c>=0){u=v-g+Math.PI/2;m=v+g+Math.PI/2}else{m=Math.PI*2-(v-g+Math.PI/2);u=Math.PI*2-(v+g+Math.PI/2)}if(!this.arcPointerPath)this.arcPointerPath=d3.arc().innerRadius(0).outerRadius(p+10);var r={startAngle:u,endAngle:m};var x=this.arcPointerPath(r);return{d:x,lx:h,ly:o}},drawPointer:function(){var t=this.getPointerPath(d3.min(this.options.domain));this.pointer=this.svg.append("path").attr("d",t.d).attr("transform","translate("+t.lx+", "+t.ly+")");Object.each(this.css.pointer,function(t,i){this.pointer.attr(i,t)}.bind(this));this.setDefs("pointer_defs",this.pointer);this.transition()},transition:function(){var t=this.getPointerPath(d3.min(this.options.domain));var i=t.lx;var s=t.ly;this.pointer.attr("d",t.d).attr("transform","translate("+t.lx+", "+t.ly+")");this.pointer.transition().delay(200).duration(3e3).ease(d3.easeElasticOut).attrTween("d",function(t,a,e){return function(t){var a=this.getPointerPath(this.showData*t);i=a.lx;s=a.ly;return a.d}.bind(this)}.bind(this)).attrTween("transform",function(t,a,e){return function(t){return"translate("+i+", "+s+")"}.bind(this)}.bind(this))},drawText:function(){var t=this.size.x/2-this.options.arcMargin-this.options.borderWidth;var i=this.size.x/2+this.size.m;var s=this.size.x/2+this.size.m+t;this.dataText=this.svg.append("text").attr("transform","translate("+i+", "+s+") ").attr("text-anchor","middle").attr("dy","4").attr("font-size","10px").text(this.options.formatData?d3.format(this.options.formatData)(this.options.text||this.data):this.options.text||this.data);Object.each(this.css.dataText,function(t,i){this.dataText.attr(i,t)}.bind(this));this.setDefs("dataText_defs",this.dataText)},hide:function(){this.node.setStyle("display","none")},show:function(){this.node.setStyle("display","block");this.transition()},destroy:function(){this.node.destroy();d3.interrupt(this.pointer);MWF.release(this)}});