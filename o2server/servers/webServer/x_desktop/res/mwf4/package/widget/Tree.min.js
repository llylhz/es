MWF.widget=MWF.widget||{};MWF.require("MWF.widget.Common",null,false);MWF.widget.Tree=new Class({Extends:MWF.widget.Common,Implements:[Options,Events],children:[],options:{style:"default",expand:false,text:"html"},jsonMapping:{expand:"expand",title:"title",text:"text",action:"action",icon:"icon",style:"",sub:"sub"},initialize:function(t,e){this.setOptions(e);this.path=MWF.defaultPath+"/widget/$Tree/";this.cssPath=MWF.defaultPath+"/widget/$Tree/"+this.options.style+"/css.wcss";this._loadCss();this.container=$(t);this.children=[];this.treeJson=null;this.treeXML=null},load:function(t){if(this.fireEvent("queryLoad")){if(t)this.treeJson=t;this.node=new Element("div",{styles:this.css.areaNode});this.loadTree();this.node.inject(this.container);this.fireEvent("postLoad")}},empty:function(){this.children.each(function(t){MWF.release(t)}.bind(this));this.node.empty()},reLoad:function(t){if(t)this.treeJson=t;this.children=[];this.node.empty();this.loadTree()},loadTree:function(){if(this.treeJson){this.loadJsonTree(this.treeJson,this,this)}else if(this.treeXML){this.loadXMLTree()}if(this.container)this.node.inject(this.container)},mappingJson:function(t){if(t.expand)this.jsonMapping.expand=t.expand;if(t.title)this.jsonMapping.title=t.title;if(t.text)this.jsonMapping.text=t.text;if(t.action)this.jsonMapping.action=t.action;if(t.icon)this.jsonMapping.icon=t.icon;if(t.style)this.jsonMapping.style=t.style;if(t.sub)this.jsonMapping.sub=t.sub},loadJsonTree:function(t,e,i){t.each(function(t){var e={};if(t[this.jsonMapping.expand]!=undefined)e.expand=t[this.jsonMapping.expand];if(t[this.jsonMapping.title])e.title=t[this.jsonMapping.title];if(t[this.jsonMapping.text])e.text=t[this.jsonMapping.text];if(t[this.jsonMapping.action])e.action=t[this.jsonMapping.action];if(t[this.jsonMapping.style])e.style=t[this.jsonMapping.style];if(t[this.jsonMapping.icon])e.icon=t[this.jsonMapping.icon];var s=i.appendChild(e);if(t[this.jsonMapping.sub]){this.loadJsonTree(t[this.jsonMapping.sub],this,s)}}.bind(e))},appendChild:function(t){var e=new this.$constructor.Node(this,t);if(this.children.length){e.previousSibling=this.children[this.children.length-1];e.previousSibling.nextSibling=e}else{this.firstChild=e}e.load();e.node.inject(this.node);this.children.push(e);return e},expandOrCollapseNode:function(t){if(t.options.expand){this.collapse(t);t.options.expand=false}else{this.expand(t);t.options.expand=true}t.setOperateIcon()},expand:function(t){if(this.fireEvent("queryExpand",[t])){t.childrenNode.setStyle("display","block")}this.fireEvent("postExpand",[t])},collapse:function(t){if(this.fireEvent("queryCollapse",[t])){t.childrenNode.setStyle("display","none")}this.fireEvent("postCollapse",[t])},toJson:function(t){var e=null;var i=t.firstChild;e=[];while(i){e.push(this.transObj(i.options));e[e.length-1].sub=this.toJson(i);i=i.nextSibling}return e},transObj:function(t){var e={};e[this.jsonMapping.expand]=t.expand;e[this.jsonMapping.title]=t.title;e[this.jsonMapping.text]=t.text;e[this.jsonMapping.action]=t.action;e[this.jsonMapping.style]=t.style;e[this.jsonMapping.icon]=t.icon?t.icon:"none";return e}});MWF.widget.Tree.Node=new Class({Implements:[Options,Events],options:{expand:true,title:"",text:"",action:"",style:"",icon:"folder.png"},imgs:{expand:"expand.gif",collapse:"collapse.gif",blank:"blank.gif"},tree:null,level:0,levelNode:[],initialize:function(t,e){this.setOptions(e);if(e.icon=="none")this.options.icon="";this.tree=t;this.levelNode=[];this.children=[];this.parentNode=null;this.previousSibling=null;this.nextSibling=null;this.firstChild=null;this.node=new Element("div",{styles:this.tree.css.treeNode});this.itemNode=new Element("div",{styles:this.tree.css.treeItemNode}).inject(this.node);this.childrenNode=new Element("div",{styles:this.tree.css.treeChildrenNode}).inject(this.node);if(this.options.style){if(this.tree.css[this.options.style]){this.node.setStyles(this.tree.css[this.options.style].treeNode);this.itemNode.setStyles(this.tree.css[this.options.style].treeItemNode);this.childrenNode.setStyles(this.tree.css[this.options.style].treeChildrenNode)}}if(!this.options.expand){this.childrenNode.setStyle("display","none")}},setText:function(t){var e=this.textNode.getElement("div");if(e)e.set("text",t)},setTitle:function(t){var e=this.textNode.getElement("div");if(e)e.set("title",t)},load:function(){this.nodeTable=new Element("table",{border:"0",cellpadding:"0",cellspacing:"0",styles:this.tree.css.nodeTable}).inject(this.itemNode);if(this.options.style){if(this.tree.css[this.options.style]){this.nodeTable.setStyles(this.tree.css[this.options.style].nodeTable)}}var t=new Element("tbody").inject(this.nodeTable);this.nodeArea=new Element("tr").inject(t);this.createLevelNode();this.createOperateNode();this.createIconNode();this.createTextNode()},createLevelNode:function(){for(var t=0;t<this.level;t++){var e=new Element("td",{styles:this.tree.css.blankLevelNode}).inject(this.nodeArea);if(this.options.style){if(this.tree.css[this.options.style]){e.setStyles(this.tree.css[this.options.style].blankLevelNode)}}this.levelNode.push(e)}},createOperateNode:function(){this.operateNode=new Element("td",{styles:this.tree.css.operateNode}).inject(this.nodeArea);if(this.options.style){if(this.tree.css[this.options.style]){this.operateNode.setStyles(this.tree.css[this.options.style].operateNode)}}this.operateNode.addEvent("click",function(){this.expandOrCollapse()}.bind(this));this.operateNode.setStyle("background","url("+this.tree.path+this.tree.options.style+"/"+this.imgs.blank+") center center no-repeat")},createIconNode:function(){if(this.options.icon){this.iconNode=new Element("td",{styles:this.tree.css.iconNode}).inject(this.nodeArea);if(this.options.style){if(this.tree.css[this.options.style]){this.iconNode.setStyles(this.tree.css[this.options.style].iconNode)}}this.iconNode.setStyle("background","url("+this.tree.path+this.tree.options.style+"/"+this.options.icon+") center center no-repeat")}},createTextNode:function(){this.textNode=new Element("td",{styles:this.tree.css.textNode}).inject(this.nodeArea);if(this.options.style){if(this.tree.css[this.options.style]){this.textNode.setStyles(this.tree.css[this.options.style].textNode)}}var t=new Element("div",{styles:this.tree.css.textDivNode,title:this.options.title});if(this.options.style){if(this.tree.css[this.options.style]){t.setStyles(this.tree.css[this.options.style].textDivNode)}}if(this.tree.options.text=="html"){t.set("html",this.options.text)}else{t.set("text",this.options.text)}t.addEvent("click",function(t){this.clickNode(t)}.bind(this));t.inject(this.textNode)},clickNode:function(t){this.selectNode(t);this.doAction(t)},selectNode:function(){if(this.tree.currentNode){var t=this.tree.currentNode.textNode.getElement("div");t.setStyles(this.tree.css.textDivNode);if(this.tree.currentNode.options.style){if(this.tree.css[this.tree.currentNode.options.style]){t.setStyles(this.tree.css[this.tree.currentNode.options.style].textDivNode)}}}var t=this.textNode.getElement("div");t.setStyles(this.tree.css.textDivNodeSelected);if(this.options.style){if(this.tree.css[this.options.style]){t.setStyles(this.tree.css[this.options.style].textDivNodeSelected)}}this.tree.currentNode=this},doAction:function(t){if(typeOf(this.options.action)=="string"){Browser.exec(this.options.action)}else if(typeOf(this.options.action)=="function"){this.options.action.apply(this,[this])}},setOperateIcon:function(){var t=this.options.expand?this.imgs.expand:this.imgs.collapse;t=this.tree.path+this.tree.options.style+"/"+t;if(!this.firstChild)t=this.tree.path+this.tree.options.style+"/"+this.imgs.blank;this.operateNode.setStyle("background","url("+t+") center center no-repeat")},insertChild:function(t){var e=new this.tree.$constructor.Node(this.tree,t);var i=this.previousSibling;this.previousSibling=e;e.nextSibling=this;e.previousSibling=i;if(i){i.nextSibling=e}else{this.parentNode.firstChild=e}e.parentNode=this.parentNode;e.level=this.level;e.load();e.node.inject(this.node,"before");this.parentNode.children.push(e);return e},appendChild:function(t){var e=new this.tree.$constructor.Node(this.tree,t);if(this.children.length){e.previousSibling=this.children[this.children.length-1];e.previousSibling.nextSibling=e}else{this.firstChild=e;this.setOperateIcon()}e.level=this.level+1;e.parentNode=this;e.load();e.node.inject(this.childrenNode);this.children.push(e);return e},expandOrCollapse:function(){this.tree.expandOrCollapseNode(this)},destroy:function(){if(this.previousSibling)this.previousSibling.nextSibling=this.nextSibling;if(this.nextSibling)this.nextSibling.previousSibling=this.previousSibling;if(this.parentNode){if(this.parentNode.firstChild==this){this.parentNode.firstChild=this.nextSibling}this.parentNode.children.erase(this)}this.node.destroy();delete this}});