MWF.xApplication.Report=MWF.xApplication.Report||{};MWF.require("MWF.widget.O2Identity",null,false);MWF.xDesktop.requireApp("Template","Explorer",null,false);MWF.xDesktop.requireApp("Report","Common",null,false);MWF.xDesktop.requireApp("Report","Setting",null,false);MWF.xApplication.Report.options={multitask:false,executable:true};MWF.xApplication.Report.Main=new Class({Extends:MWF.xApplication.Common.Main,Implements:[Options,Events],options:{style:"default",name:"Report",view:"all",icon:"icon.png",width:"1220",height:"700",isResize:true,isMax:true,sideBarEnable:true,title:MWF.xApplication.Report.LP.title},onQueryLoad:function(){this.lp=MWF.xApplication.Report.LP},loadApplication:function(e){MWF.UD.getDataJson("reportConfig",function(t){this.reportConfig=t||{};if(!this.options.isRefresh){this.maxSize(function(){this.loadLayout()}.bind(this))}else{this.loadLayout()}if(e)e()}.bind(this))},loadLayout:function(){this.userName=(layout.desktop.session.user||layout.user).distinguishedName;this.restActions=MWF.Actions.get("x_report_assemble_control");this.strategyActions=MWF.Actions.get("x_strategydeploy_assemble_control");this.common=new MWF.xApplication.Report.Common(this);this.path="/x_component_Report/$Main/"+this.options.style+"/";this.createNode();this.loadApplicationContent()},loadController:function(e){this.isAdmin=this.common.isAdmin();if(this.isAdmin){this.exportAllFlag=true}else{this.exportAllFlag=this.common.hasExportAllUnitPermission()}this.unitWithExport=[];if(!this.exportAllFlag){this.common.getUnitWithExportPermission(function(t){this.unitWithExport=t;if(e)e()}.bind(this))}else{if(e)e()}},isShowExport:function(){if(this.isAdmin)return true;if(this.exportAllFlag)return true;if(this.unitWithExport&&this.unitWithExport.length>0)return true;return false},createNode:function(){this.content.setStyle("overflow","hidden");this.node=new Element("div.reportNode",{styles:{width:"100%",height:"100%",overflow:"hidden","background-color":"#eee"}}).inject(this.content)},loadApplicationContent:function(){this.loadController(function(){this.loadApplicationLayout()}.bind(this))},loadApplicationLayout:function(){if(this.status&&this.status.action){this.defaultAction=this.status.action}else if(this.reportConfig.defaultView){this.defaultAction=this.reportConfig.defaultView}else if(this.options.view=="todo"){this.defaultAction="toTodo"}else{this.defaultAction="toList"}if((this.common.isAdmin()||this.isShowExport())&&this.options.view=="all"){this.topMenu=new Element("div",{styles:this.css.topMenu}).inject(this.node)}this.contentNode=new Element("div",{styles:this.css.contentNode}).inject(this.node);if(this.options.view=="todo"){this.toTodo()}else if((this.common.isAdmin()||this.isShowExport())&&this.options.view=="all"){this.loadTopMenus()}else{this.toList()}if(this.options.sideBarEnable){}},loadTopMenus_right:function(){this.topMenuRight=new Element("div",{styles:this.css.topMenuRight}).inject(this.topMenu);var t=this.createTopMenu_right(this.lp.setting,"icon_shezhi","config");t.setStyle("float","right")},createTopMenu_right:function(t,e,i){var n=new Element("div",{styles:this.css.topMenuNode_right,title:t}).inject(this.topMenuRight);var o=new Element("div",{styles:this.css.topMenuIconNode}).inject(n);o.setStyle("background","url(/x_component_Report/$Main/default/icon/"+e+".png) no-repeat center center");n.store("icon",e);n.store("iconNode",o);var s=this;n.addEvents({mouseover:function(){this.node.retrieve("iconNode").setStyle("background","url(/x_component_Report/$Main/default/icon/"+this.node.retrieve("icon")+"_click.png) no-repeat center center")}.bind({node:n}),mouseout:function(){this.node.retrieve("iconNode").setStyle("background","url(/x_component_Report/$Main/default/icon/"+this.node.retrieve("icon")+".png) no-repeat center center")}.bind({node:n}),click:function(){this.node.retrieve("iconNode").setStyle("background","url(/x_component_Report/$Main/default/icon/"+this.node.retrieve("icon")+"_click.png) no-repeat center center");if(s[i])s[i].apply(s)}.bind({node:n})});return n},loadTopMenus:function(){this.createTopMenu(this.lp.list,"icon_liebiao","toList");if(this.isShowExport()){this.createTopMenu("导出","icon_export","toStatistics",true);this.createTopMenu("部门五项重点工作统览","icon_tongji","toSummarization",true)}if(this.common.isAdmin()){this.createTopMenu(this.lp.startRecord,"icon_liebiao","toStartRecord");this.loadTopMenus_right()}},createTopMenu:function(t,e,i,n){var o=new Element("div",{styles:this.css.topMenuNode}).inject(this.topMenu);var s=new Element("div",{styles:this.css.topMenuIconNode}).inject(o);s.setStyle("background","url(/x_component_Report/$Main/default/icon/"+e+".png) no-repeat center center");var r=new Element("div",{styles:this.css.topMenuTextNode,text:t}).inject(o);o.store("icon",e);o.store("iconNode",s);o.store("action",i);var h=this;o.addEvents({mouseover:function(){if(this.node!=h.currentTopMenuNode){this.node.setStyles(h.css.topMenuNode_over);this.node.retrieve("iconNode").setStyle("background","url(/x_component_Report/$Main/default/icon/"+this.node.retrieve("icon")+"_click.png) no-repeat center center")}}.bind({node:o}),mouseout:function(){if(this.node!=h.currentTopMenuNode){this.node.setStyles(h.css.topMenuNode);this.node.retrieve("iconNode").setStyle("background","url(/x_component_Report/$Main/default/icon/"+this.node.retrieve("icon")+".png) no-repeat center center")}}.bind({node:o}),click:function(){if(!n){if(this.node!=h.currentTopMenuNode){this.node.setStyles(h.css.topMenuNode_down);this.node.retrieve("iconNode").setStyle("background","url(/x_component_Report/$Main/default/icon/"+this.node.retrieve("icon")+"_click.png) no-repeat center center")}if(h.currentTopMenuNode&&this.node!=h.currentTopMenuNode){h.currentTopMenuNode.setStyles(h.css.topMenuNode);h.currentTopMenuNode.retrieve("iconNode").setStyle("background","url(/x_component_Report/$Main/default/icon/"+h.currentTopMenuNode.retrieve("icon")+".png) no-repeat center center")}h.currentTopMenuNode=this.node}if(h[i])h[i].apply(h)}.bind({node:o})});if(this.defaultAction==i){o.click()}return o},showMenu:function(){if(this.menuMode!="show"){this.topMenu.set("tween",{duration:100,transition:"bounce:out"});this.topMenu.tween("top","-50px","0px");this.menuMode="show"}},hideCurrentView:function(){if(this.currentView){this.currentView.hide();this.currentView=null}},toMyReport:function(){this.contentNode.setStyles(this.css.contentNode);if(this.currentView){this.currentView.destroy();this.currentView=null}this.myReportView=null;this.getMyReportView(function(){this.myReportView.show();this.currentView=this.myReportView}.bind(this))},getMyReportView:function(e){if(!this.myReportView){MWF.xDesktop.requireApp("Report","ReportView",function(){var t;if(this.status&&this.status.options){t=this.status.options}this.myReportView=new MWF.xApplication.Report.ReportView(this.contentNode,this,t);if(t)this.status.options=null;if(e)e()}.bind(this))}else{if(e)e()}},toTodo:function(){if(this.currentView){this.currentView.destroy();this.currentView=null}this.todoView=null;this.getTodoView(function(){this.todoView.show();this.currentView=this.todoView}.bind(this))},getTodoView:function(e){if(!this.todoView){MWF.xDesktop.requireApp("Report","ListView",function(){var t;if(this.status&&this.status.options){t=this.status.options}t=t||{};t.isTodo=true;this.todoView=new MWF.xApplication.Report.ListView(this.contentNode,this,t);if(this.status&&this.status.options)this.status.options=null;if(e)e()}.bind(this))}else{if(e)e()}},toList:function(){if(this.currentView){this.currentView.destroy();this.currentView=null}this.listView=null;this.getListView(function(){this.listView.show();this.currentView=this.listView}.bind(this))},getListView:function(e){if(!this.listView){MWF.xDesktop.requireApp("Report","ListView",function(){var t;if(this.status&&this.status.options){t=this.status.options}this.listView=new MWF.xApplication.Report.ListView(this.contentNode,this,t);if(t)this.status.options=null;if(e)e()}.bind(this))}else{if(e)e()}},toMonth:function(){if(this.currentView){this.currentView.destroy();this.currentView=null}this.monthView=null;this.getMonthView(function(){this.monthView.show();this.currentView=this.monthView}.bind(this))},getMonthView:function(e){if(!this.monthView){MWF.xDesktop.requireApp("Report","MonthView",function(){var t;if(this.status&&this.status.options){t=this.status.options}this.monthView=new MWF.xApplication.Report.MonthView(this.contentNode,this,t);if(t)this.status.options=null;if(e)e()}.bind(this))}else{if(e)e()}},toDay:function(t){if(this.currentView){this.currentView.destroy();this.currentView=null}this.dayView=null;this.getDayView(function(){this.dayView.show();this.currentView=this.dayView}.bind(this),t)},getDayView:function(e,i){if(!this.dayView){MWF.xDesktop.requireApp("Report","DayView",function(){var t;if(this.status&&this.status.options){t=this.status.options}this.dayView=new MWF.xApplication.Report.DayView(this.contentNode,this,t||{date:i});if(this.status)this.status.options=null;if(e)e()}.bind(this))}else{this.dayView.toDay(i);if(e)e()}},toKeyWork:function(t){if(this.currentView){this.currentView.destroy();this.currentView=null}this.mindView=null;this.getKeyWorkView(function(){this.mindView.load();this.currentView=this.mindView}.bind(this),t)},getKeyWorkView:function(e,i){if(!this.mindView){MWF.xDesktop.requireApp("Report","MindView",function(){var t;if(this.status&&this.status.options){t=this.status.options}this.mindView=new MWF.xApplication.Report.MindView(this.contentNode,this,this.restActions,t||{date:i});if(this.status)this.status.options=null;if(e)e()}.bind(this))}else{this.mindView.load(i);if(e)e()}},toStatistics:function(){var t=new MWF.xApplication.Report.StatisticsForm(this,{},{},{app:this});t.create()},toSummarization:function(){var t=new MWF.xApplication.Report.SummarizationForm(this,{},{},{app:this});t.create()},toStartRecord:function(){if(this.currentView){this.currentView.destroy();this.currentView=null}this.startRecordView=null;this.getStartRecordView(function(){this.startRecordView.show();this.currentView=this.startRecordView}.bind(this))},getStartRecordView:function(e){if(!this.startRecordView){MWF.xDesktop.requireApp("Report","StartRecordView",function(){var t;if(this.status&&this.status.options){t=this.status.options}this.startRecordView=new MWF.xApplication.Report.StartRecordView(this.contentNode,this,t);if(t)this.status.options=null;if(e)e()}.bind(this))}else{if(e)e()}},config:function(){var t=new MWF.xApplication.Report.SettingForm(this,null,{height:this.common.isAdmin()?"600":"300",width:this.common.isAdmin()?"1000":"700"},{app:this});t.edit()},recordStatus:function(){return{action:this.currentTopMenuNode?this.currentTopMenuNode.retrieve("action"):"toList",options:this.currentView&&this.currentView.recordStatus?this.currentView.recordStatus():null}},reload:function(){this.refresh()},loadSideBar:function(){this.sideBar=new MWF.xApplication.Report.SideBar(this.node,this);this.sideBar.show()},addReport:function(){}});var getDateDiff=function(t){if(!t)return"";var e=Date.parse(t.replace(/-/gi,"/"));var i=1e3*60;var n=i*60;var o=n*24;var s=o*15;var r=o*30;var h=r*12;var u=(new Date).getTime();var c=u-e;if(c<0){}var a=(new Date).decrement("day",1);var l=(new Date).decrement("day",2);var p=c/h;var d=c/r;var f=c/(7*o);var w=c/o;var M=c/n;var V=c/i;if(a.getFullYear()==e.getFullYear()&&a.getMonth()==e.getMonth()&&a.getDate()==e.getDate()){result="昨天 "+e.getHours()+":"+e.getMinutes()}else if(l.getFullYear()==e.getFullYear()&&l.getMonth()==e.getMonth()&&l.getDate()==e.getDate()){result="前天 "+e.getHours()+":"+e.getMinutes()}else if(p>1){result=e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()}else if(d>=1){result=e.getFullYear()+"-"+(e.getMonth()+1)+"-"+e.getDate()}else if(f>=1){result=parseInt(f)+"周前"}else if(w>=1){result=parseInt(w)+"天前"}else if(M>=1){result=parseInt(M)+"小时前"}else if(V>=1){result=parseInt(V)+"分钟前"}else result="刚刚发表";return result};