MWF.xApplication.Report.StrategyExplorer.Summary=new Class({Implements:[Options,Events],options:{style:"default",isEdited:false,status:"summary",isToRead:false,isToReadLeader:false},initialize:function(t,e,i,s){this.setOptions(s);this.container=t;this.explorer=e;this.app=this.explorer.app;this.lp=this.app.lp;this.css=this.explorer.css;this.actions=this.app.restActions;this.data=i;this.path="/x_component_Report/$StrategyExplorer/"},load:function(){if(this.options.isToReadLeader){this.loadLeaderRead()}else if(this.options.isToRead){this.loadOpinion(true)}else if(this.data.detail.opinions){var t=JSON.parse(this.data.detail.opinions);if(typeOf(t)=="array"){this.loadOpinion(false)}}this._load()},loadOpinion:function(t){var e=new Element("table",{width:"96%",border:"0",cellpadding:"5",cellspacing:"0",styles:this.css.formTable}).inject(this.explorer.ideaContainer);var i=new Element("tr").inject(e);var s=new Element("td",{styles:this.css.formTableTitle,text:"领导意见"}).inject(i);s.setStyle("width","14%");var s=new Element("td",{styles:this.css.formTableValue}).inject(i);var a=this.data.detail.opinions;if(a){var n=JSON.parse(a);if(typeOf(n)=="array"){var l=new Element("div").inject(s);n.each(function(t){var e=new Element("table",{width:"100%",border:"0",cellpadding:"0",cellspacing:"0"}).inject(l);var i=new Element("tr").inject(e);var s=new Element("td",{text:t.identity.split("@")[0]+":"}).inject(i);s.setStyle("width","50px");s=new Element("td",{text:(t.content?this.app.common.replaceWithBr(t.content):"已阅")+"      ("+t.datetime+")"}).inject(i)}.bind(this))}}if(t){l=new Element("div",{styles:{"margin-top":"10px"}}).inject(s);var o=new Element("button",{value:"已阅",text:"已阅",styles:this.css.setRead}).inject(l);o.addEvent("click",function(t){this.setReaded(t)}.bind(this))}},loadLeaderRead:function(){var e="";if(this.data.detail.opinions){var t=JSON.parse(this.data.detail.opinions);if(typeOf(t)=="array"){t.each(function(t){if(t.name==this.explorer.userName){e=t.content}}.bind(this))}}var i=new Element("table",{width:"96%",border:"0",cellpadding:"5",cellspacing:"0",styles:this.css.formTable}).inject(this.explorer.ideaContainer);var s=new Element("tr").inject(i);var a=new Element("td",{styles:this.css.formTableTitle,text:"填写意见"}).inject(s);a.setStyle("width","14%");var a=new Element("td",{styles:this.css.formTableValue}).inject(s);var n=new Element("div").inject(a);this.textarea_idea=new Element("textarea",{styles:this.css.textarea,value:e}).inject(n);this.textarea_idea.addEvent("blur",function(){var t=[{identity:null,name:(layout.desktop.session.user||layout.user).distinguishedName,activity:"领导阅知",content:this.textarea_idea.get("value")}];this.app.restActions.saveOpinion(this.data.id,{opinions:t})}.bind(this));n=new Element("div").inject(a);var l=new Element("button",{value:"已阅",text:"已阅",styles:this.css.setRead}).inject(n);l.addEvent("click",function(t){this.setReaded(t)}.bind(this))},getWorkId:function(){var t=this.explorer.workApp;if(t.work&&t.work.id){return t.work.id}else if(t.workCompleted&&t.workCompleted.id){return t.workCompleted.id}else if(t.data&&t.data.$work){var e=t.data.$work;if(e.completed){return e.workCompletedId}else{return e.workId}}},sendRead:function(s){MWF.Actions.get("x_organization_assemble_express").getDutyValue({name:"部主管",unit:this.data.targetUnit},function(t){var e=t.data.identityList;if(e&&typeOf(e)=="array"&&e.length>0){var i=this.getWorkId();MWF.Actions.get("x_processplatform_assemble_surface").sendReaderByWorkCompleted(function(){if(s)s()}.bind(this),null,i,{identityList:e},false)}else{if(s)s()}}.bind(this))},setReaded:function(t){var i=this;var s=function(){var t=i.explorer.readData;if(i.textarea_idea){t.opinion=i.textarea_idea.get("value").trim()}MWF.Actions.get("x_processplatform_assemble_surface").setReaded(function(){i.app.notice("标记已阅成功!");i.app.close()}.bind(i),null,t.id,t)}.bind(this);var e="您确定要标记为已阅吗？";this.app.confirm("infor",t,"标记已阅确认",e,350,130,function(){if(i.options.isToReadLeader){var t=i.textarea_idea.get("value").trim();if(!t||t==""){i.textarea_idea.set("value","已阅")}var e=[{identity:null,name:(layout.desktop.session.user||layout.user).distinguishedName,activity:"领导阅知",content:i.textarea_idea.get("value")}];i.app.restActions.saveOpinion(i.data.id,{opinions:e},function(){i.app.restActions.modifyReportStatus(i.data.id,{reportStatus:"结束"},function(){i.sendRead(function(){s();this.close()}.bind(this))}.bind(this))}.bind(this))}else{s();this.close()}},function(){this.close()},null,this.app.content)},_load:function(){this.month=parseInt(this.data.month);var t=this.table=new Element("table",{width:"96%",border:"0",cellpadding:"5",cellspacing:"0",styles:this.css.formTable}).inject(this.explorer.totalContainer);var e=new Element("tr").inject(t);new Element("td",{rowspan:2,width:"30",styles:this.css.formTableTitle,text:"序号"}).inject(e);new Element("td",{colspan:3,text:this.data.year+"年"+parseInt(this.data.month)+"月工作总结",width:"140",styles:this.css.formTableTitle}).inject(e);var i=new Date(this.data.year,this.data.month,1).increment("month",1);var s=i.getFullYear()+"年"+i.getMonth()+"月工作计划";new Element("td",{colspan:2,text:s,width:"140",styles:this.css.formTableTitle}).inject(e);new Element("td",{rowspan:2,text:"服务客户",width:"140",styles:this.css.formTableTitle}).inject(e);new Element("td",{rowspan:2,text:"关爱员工",width:"140",styles:this.css.formTableTitle}).inject(e);new Element("td",{rowspan:2,text:"意见建议",width:"140",styles:this.css.formTableTitle}).inject(e);var e=new Element("tr").inject(t);new Element("td",{text:"部门重点工作",width:"140",styles:this.css.formTableTitle}).inject(e);new Element("td",{text:"计划",width:"140",styles:this.css.formTableTitle}).inject(e);new Element("td",{text:"总结",width:"140",styles:this.css.formTableTitle}).inject(e);new Element("td",{text:"部门重点工作",width:"140",styles:this.css.formTableTitle}).inject(e);new Element("td",{text:"计划",width:"140",styles:this.css.formTableTitle}).inject(e);this.listExtSummaryData(function(){this.loadContent()}.bind(this))},listExtSummaryData:function(t){this.extSummaryData=this.data.WoReport_I_Ext_Contents_sumamry||[];if(t)t()},loadContent:function(){var t=this.getTableData();t.each(function(t){var e=new Element("tr").inject(this.table);new Element("td",{text:t.sequence,align:"center",styles:this.css.formTableValue}).inject(e);var i=new Element("td",{html:this.app.common.replaceWithBr(t.thisMonth.title),width:"140",styles:this.css.formTableValue}).inject(e);if(t.thisMonth.measuresList.length){var s=new Element("input",{type:"button",styles:this.css.showMeasureNode2,value:"查看举措"}).inject(i);var a=new MWF.xApplication.Report.ShowMeasureTooltip(this.app.content,s,this.app,this.data,{style:"report",position:{x:"auto",y:"auto"},event:"click"});a.measuresList=t.thisMonth.measuresList}new Element("td",{html:this.app.common.replaceWithBr(t.thisMonth.plan),width:"140",styles:this.css.formTableValue}).inject(e);new Element("td",{html:this.app.common.replaceWithBr(t.thisMonth.prog),width:"140",styles:this.css.formTableValue}).inject(e);i=new Element("td",{html:this.app.common.replaceWithBr(t.nextMonth.title),width:"140",styles:this.css.formTableValue}).inject(e);if(t.nextMonth.measuresList.length){var s=new Element("input",{type:"button",styles:this.css.showMeasureNode2,value:"查看举措"}).inject(i);var a=new MWF.xApplication.Report.ShowMeasureTooltip(this.app.content,s,this.app,this.data,{style:"report",position:{x:"auto",y:"auto"},event:"click"});a.measuresList=t.nextMonth.measuresList}new Element("td",{html:this.app.common.replaceWithBr(t.nextMonth.plan),width:"140",styles:this.css.formTableValue}).inject(e);new Element("td",{html:this.app.common.replaceWithBr(t.extWork.fuwu),width:"140",styles:this.css.formTableValue}).inject(e);new Element("td",{html:this.app.common.replaceWithBr(t.extWork.guanai),width:"140",styles:this.css.formTableValue}).inject(e);new Element("td",{html:this.app.common.replaceWithBr(t.extWork.yijian),width:"140",styles:this.css.formTableValue}).inject(e)}.bind(this))},getTableData:function(){this.tableData=[];for(var t=0;t<5;t++){var e=this.extSummaryData[t];var i=this.data.thisMonth_workList[t];var s=this.data.nextMonth_workList[t];var a={sequence:t+1,thisMonth:{title:i?i.workTitle:"",plan:i?i.workPlanSummary:"",prog:i?i.workProgSummary:"",measuresList:i?i.measuresList:[]},nextMonth:{title:s?s.workTitle:"",plan:s?s.workPlanSummary:"",measuresList:s?s.measuresList:[]},extWork:{fuwu:e?e.fuwu:"",guanai:e?e.guanai:"",yijian:e?e.yijian:""}};this.tableData.push(a)}return this.tableData}});