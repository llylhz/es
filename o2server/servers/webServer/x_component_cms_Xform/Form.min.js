MWF.xApplication.cms=MWF.xApplication.cms||{};MWF.xApplication.cms.Xform=MWF.xApplication.cms.Xform||{};MWF.require("MWF.widget.Common",null,false);MWF.require("MWF.xAction.org.express.RestActions",null,false);MWF.xDesktop.requireApp("Selector","package",null,false);MWF.xDesktop.requireApp("process.Xform","Form",null,false);MWF.require("MWF.widget.O2Identity",null,false);MWF.xDesktop.requireApp("cms.Xform","Package",null,false);MWF.xApplication.cms.Xform.Form=MWF.CMSForm=new Class({Implements:[Options,Events],Extends:MWF.APPForm,options:{style:"default",readonly:false,cssPath:"",autoSave:false,saveOnClose:false,showAttachment:true,moduleEvents:["queryLoad","postLoad","beforeLoad","afterLoad","beforeSave","postSave","afterSave","beforeClose","beforePublish","postPublish","afterPublish","beforeModulesLoad","afterModulesLoad"]},initialize:function(t,e,s){this.setOptions(s);this.container=$(t);this.container.setStyle("-webkit-user-select","text");this.data=e;this.json=e.json;this.html=e.html;this.path="/x_component_cms_Xform/$Form/";this.cssPath=this.options.cssPath||"/x_component_cms_Xform/$Form/"+this.options.style+"/css.wcss";this._loadCss();this.modules=[];this.all={};this.forms={}},load:function(){this.Macro=new MWF.CMSMacro.CMSFormContext(this);this.container.set("html",this.html);this.node=this.container.getFirst();this._loadEvents();if(this.app){if(this.app.formNode)this.app.formNode.setStyles(this.json.styles);if(this.app.addEvent)this.app.addEvent("resize",function(){this.fireEvent("resize")}.bind(this))}if(this.fireEvent("queryLoad")){this.fireEvent("beforeLoad");MWF.xDesktop.requireApp("cms.Xform","lp."+MWF.language,null,false);this._loadBusinessData();this._loadHtml();this._loadForm();this.fireEvent("beforeModulesLoad");this._loadModules(this.node);if(!this.options.readonly){if(this.options.autoSave)this.autoSave();this.app.addEvent("queryClose",function(){if(this.options.saveOnClose&&this.businessData.document.docStatus=="draft")this.saveDocument(null,true);Object.each(this.forms,function(t,e){if(t.json.type=="Htmleditor"&&t.editor){CKEDITOR.remove(t.editor);delete t.editor}})}.bind(this))}this.fireEvent("afterModulesLoad");this.fireEvent("postLoad");this.fireEvent("afterLoad")}},autoSave:function(){},_loadBusinessData:function(){if(!this.businessData){this.businessData={data:{}}}},_loadEvents:function(){Object.each(this.json.events,function(e,t){if(e.code){if(this.options.moduleEvents.indexOf(t)!=-1){this.addEvent(t,function(t){return this.Macro.fire(e.code,this,t)}.bind(this))}else{if(t=="load"){this.addEvent("postLoad",function(){return this.Macro.fire(e.code,this)}.bind(this))}else if(t=="submit"){this.addEvent("beforePublish",function(){return this.Macro.fire(e.code,this)}.bind(this))}else{this.node.addEvent(t,function(t){return this.Macro.fire(e.code,this,t)}.bind(this))}}}}.bind(this))},_loadModules:function(t){var e=this._getModuleNodes(t);e.each(function(t){var e=this._getDomjson(t);if(!this.options.showAttachment&&e.type=="Attachment"){return}var s=this._loadModule(e,t);this.modules.push(s)}.bind(this))},_loadModule:function(t,e,s){if(!t)return;var i=new MWF["CMS"+t.type](e,t,this);if(s)s.apply(i);if(!this.all[t.id])this.all[t.id]=i;if(i.field){if(!this.forms[t.id])this.forms[t.id]=i}i.readonly=this.options.readonly;i.load();return i},trim:function(t){var e=[];t.each(function(t){if(t)e.push(t)});return e},transportPermissionData:function(t,i){var o=[];t.each(function(t){if(t.distinguishedName){var e=t.distinguishedName.substr(t.distinguishedName.length-1,1);var s;switch(e.toLowerCase()){case"i":s="身份";break;case"p":s="人员";break;case"u":s="组织";break;case"g":s="群组";break;case"r":s="角色";break;default:s=""}if(s){o.push({permission:i=="author"?"作者":"阅读",permissionObjectType:s,permissionObjectName:t.distinguishedName})}}});return o.length>0?o:null},getSpecialData:function(){var o=this.businessData.data;var a=[];var n=[];var r=[];var u=[];var c="";Object.each(this.forms,function(t,e){if(t.json.type=="Readerfield"){if(t.json.section=="yes"){a=a.concat(this.getSectionData(t,o[e]))}else{a=a.concat(t.getData())}}if(t.json.type=="Authorfield"){if(t.json.section=="yes"){n=n.concat(this.getSectionData(t,o[e]))}else{n=n.concat(t.getData())}}if(t.json.type=="ImageClipper"){var s=t.getData();if(s)r.push(s)}if(t.json.type=="Htmleditor"){var i=t.getText();c=i.substr(0,80);u=u.concat(t.getImageIds())}});if(o.processOwnerList&&typeOf(o.processOwnerList)=="array"){var e={personValue:[]};o.processOwnerList.each(function(t){e.personValue.push({name:t,type:"person"})});a=a.concat(e)}return{readers:this.transportPermissionData(a,"reader"),authors:this.transportPermissionData(n,"author"),pictures:r,summary:c,cloudPictures:u}},getDocumentData:function(t){var e=Object.clone(this.businessData.document);if(t.subject){e.title=t.subject;e.subject=t.subject;this.businessData.document.title=t.subject;this.businessData.document.subject=t.subject}e.isNewDocument=false;return e},saveDocument:function(t,e){this.fireEvent("beforeSave");if(!this.formSaveValidation()){this.app.content.unmask();return false}if(this.businessData.document.docStatus=="published"){if(!this.formValidation("publish")){if(t)t();return false}}var s=this.getData();var i=this.getSpecialData();var o=this.getDocumentData(s);o.readerList=i.readers;o.authorList=i.authors;o.pictureList=i.pictures;o.summary=i.summary;o.cloudPictures=i.cloudPictures;o.docData=s;delete o.attachmentList;this.fireEvent("postSave",[o]);this.documentAction.saveDocument(o,function(){this.notice(MWF.xApplication.cms.Xform.LP.dataSaved,"success");this.businessData.data.isNew=false;this.fireEvent("afterSave");if(t)t()}.bind(this),null,!e)},closeDocument:function(){this.fireEvent("beforeClose");if(this.app){this.app.close()}},formValidation:function(s){if(this.options.readonly)return true;var i=true;Object.each(this.forms,function(t,e){t.validationMode();debugger;if(!t.validation(s)){i=false}}.bind(this));return i},formSaveValidation:function(){if(!this.json.validationSave)return true;if(!this.json.validationSave.code)return true;var t=this.Macro.exec(this.json.validationSave.code,this);if(!t)t=MWF.xApplication.cms.Xform.LP.notValidation;if(t.toString()!="true"){return false}return true},formPublishValidation:function(){if(!this.json.validationPublish)return true;if(!this.json.validationPublish.code)return true;var t=this.Macro.exec(this.json.validationPublish.code,this);if(!t)t=MWF.xApplication.cms.Xform.LP.notValidation;if(t.toString()!="true"){return false}return true},publishDocument:function(e){this.fireEvent("beforePublish");this.app.content.mask({destroyOnHide:true,style:this.app.css.maskNode});if(!this.formPublishValidation()){this.app.content.unmask();return false}if(!this.formValidation("publish")){this.app.content.unmask();if(e)e();return false}var t=this.getData();var s=this.getSpecialData();var i=this.getDocumentData(t);i.readerList=s.readers;i.authorList=s.authors;i.pictureList=s.pictures;i.summary=s.summary;i.cloudPictures=s.cloudPictures;i.docData=t;delete i.attachmentList;this.fireEvent("postPublish",[i]);this.documentAction.publishDocumentComplex(i,function(t){this.businessData.data.isNew=false;this.fireEvent("afterPublish");if(e)e();this.app.notice(MWF.xApplication.cms.Xform.LP.documentPublished+": “"+this.businessData.document.title+"”","success");this.options.saveOnClose=false;this.app.close()}.bind(this))},deleteDocument:function(){var e=this;var t=MWF.getCenterPosition(this.app.content,380,150);var s={event:{x:t.x,y:t.y-200,clientX:t.x,clientY:t.y-200}};this.app.confirm("infor",s,MWF.xApplication.cms.Xform.LP.deleteDocumentTitle,MWF.xApplication.cms.Xform.LP.deleteDocumentText,380,120,function(){e.app.content.mask({style:{"background-color":"#999",opacity:.6}});e.documentAction.removeDocument(e.businessData.document.id,function(t){e.app.notice(MWF.xApplication.cms.Xform.LP.documentDelete+": “"+e.businessData.document.title+"”","success");e.options.autoSave=false;e.options.saveOnClose=false;e.fireEvent("postDelete");e.app.close();this.close()}.bind(this))},function(){this.close()})},editDocument:function(){var t={documentId:this.businessData.document.id,readonly:false};this.app.desktop.openApplication(null,"cms.Document",t);this.app.close()},setPopularDocument:function(){this.app.setPopularDocument()},printWork:function(t,e){var s=t||this.businessData.work.application;var e=e;if(!e){e=this.json.id;if(this.json.printForm)e=this.json.printForm}window.open("/x_desktop/printWork.html?workid="+this.businessData.work.id+"&app="+this.businessData.work.application+"&form="+e)}});