MWF.xApplication.Execution=MWF.xApplication.Execution||{};MWF.xDesktop.requireApp("Template","Explorer",null,false);MWF.xDesktop.requireApp("Template","MPopupForm",null,false);MWF.xDesktop.requireApp("Template","MForm",null,false);MWF.xDesktop.requireApp("Execution","WorkForm",null,false);MWF.xApplication.Execution.WorkDeploy=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"default",width:"90%",height:"90%",hasTop:true,hasIcon:false,hasBottom:true,title:"",draggable:false,closeAction:true,isNew:false,isEdited:true},initialize:function(t,e,i,o){this.setOptions(o);this.explorer=t;this.app=t.app;this.lp=this.app.lp.WorkDeploy;this.actions=this.app.restActions;this.path="/x_component_Execution/$WorkDeploy/";this.cssPath=this.path+this.options.style+"/css.wcss";this._loadCss();this.options.title=this.lp.title;this.data=i||{};this.actions=e},load:function(){this.getCenterWorkInfo();if(this.options.isNew){this.create()}else if(this.options.isEdited){this.edit()}else{this.open()}},getCenterWorkInfo:function(t){var e="(0)";if(arguments.length==1){e=t}else{if(this.data.id){e=this.data.id}}this.actions.getCenterWorkInfo(e,function(t){if(t.type="success"){this.centerWorkData=t.data;this.centerWorkId=this.centerWorkData.id}}.bind(this),function(t,e,i){this.showErrorMessage(t,e,i)}.bind(this),false)},createTopNode:function(){if(!this.formTopNode){this.formTopNode=new Element("div.formTopNode",{styles:this.css.formTopNode}).inject(this.formNode);this.formTopIconNode=new Element("div",{styles:this.css.formTopIconNode}).inject(this.formTopNode);this.formTopTextNode=new Element("div",{styles:this.css.formTopTextNode,text:this.options.title}).inject(this.formTopNode);if(this.options.closeAction){this.formTopCloseActionNode=new Element("div.formTopCloseActionNode",{styles:this.css.formTopCloseActionNode}).inject(this.formTopNode);this.formTopCloseActionNode.addEvent("click",function(){this.close()}.bind(this))}this.formTopContentNode=new Element("div",{styles:this.css.formTopContentNode}).inject(this.formTopNode);this._createTopContent()}},_createTopContent:function(){if(this.formTopContentNode)this.formTopContentNode.empty();var t="<span styles='formTopContentTitle' lable='drafter'></span>"+"    <span styles='formTopContentValue' item='drafter'></span>"+"<span styles='formTopContentTitle' lable='draftDepartment'></span>"+"    <span styles='formTopContentValue' item='draftDepartment'></span>"+"<span styles='formTopContentTitle' lable='draftDate'></span>"+"    <span styles='formTopContentValue' item='draftDate'></span>";this.formTopContentNode.set("html",t);var e=new MForm(this.formTopContentNode,this.centerWorkData,{isEdited:false,itemTemplate:{drafter:{text:this.lp.drafter+":",value:this.centerWorkData.creatorName.split("@")[0],type:"innertext"},draftDepartment:{text:this.lp.draftDepartment+":",value:this.centerWorkData.creatorUnitName.split("@")[0],type:"innertext"},draftDate:{text:this.lp.draftDate+":",name:"createTime",type:"innertext"}}},this.app,this.css);e.load()},reloadTableContent:function(t){if(arguments.length==0){if(this.centerWorkData){t=this.centerWorkData.id}else if(this.data.id){t=this.data.id}else if(this.options.centerWorkId){t=this.options.centerWorkId}}this.getCenterWorkInfo(t);this._createTopContent();this._createTableContent(this.centerWorkData);this._createBottomContent()},_createTableContent:function(){if(this.formTableArea)this.formTableArea.empty();this.createCenterWorkInfor(this.centerWorkData);this.createImportContent();this.createMyWorkList();this.creataMyDeployWorkList()},createCenterWorkInfor:function(t){this.centerWorkContentArea=new Element("div.centerWorkContentArea",{styles:this.css.workContentArea}).inject(this.formTableArea);var e=new Element("div.workContentTitleNode",{styles:this.css.workContentTitleNode,text:this.lp.centerWorkInfor}).inject(this.centerWorkContentArea);this.centerWorkContentNode=new Element("div.centerWorkContentNode",{styles:this.css.workContentNode}).inject(this.centerWorkContentArea);this.loadCenterWorkInfor(t)},loadCenterWorkInfor:function(t){this.centerWorkContentNode.empty();var e="<table width='100%' bordr='0' cellpadding='5' cellspacing='0' styles='centerWorkInforTable'>"+"<tr><td styles='centerWorkInforTitle' lable='centerWorkTitle'></td>"+"    <td styles='centerWorkInforValue' item='centerWorkTitle'></td></tr>"+"<tr><td colspan='2'>"+"   <div styles='centerWorkInforTitleDiv' lable='reportAuditLeader'></div>"+"    <div styles='centerWorkInforValueDiv' item='reportAuditLeader'></div>"+"   <div styles='centerWorkInforTitleDiv' lable='defaultWorkType'></div>"+"    <div styles='centerWorkInforValueDiv' item='defaultWorkType'></div>"+"   <div styles='centerWorkInforTitleDiv' lable='workCompletedLimit'></div>"+"    <div styles='centerWorkInforValueDiv' item='workCompletedLimit'></div>"+"</td></tr>"+"<tr><td styles='centerWorkInforTitle' lable='centerWorkMemo'></td>"+"    <td styles='centerWorkInforValue' item='centerWorkMemo'></td></tr>"+"</table>";this.centerWorkContentNode.set("html",e);var i=[];var o="";if(t.workTypes){t.workTypes.each(function(t,e){if(t.workTypeName)i.push(t.workTypeName)})}o=i.join(",");if(i.length>0){o=","+o}var n=this.centerForm=new MForm(this.centerWorkContentNode,t,{isEdited:this.isEdited||this.isNew,itemTemplate:{centerWorkTitle:{text:this.lp.centerWorkTitle+":",name:"title",type:"text",notEmpty:true},defaultWorkType:{text:this.lp.defaultWorkType+":",name:"defaultWorkType",type:"select",selectValue:o,selectText:o,notEmpty:true,style:{width:"100px",height:"30px","border-radius":"1px"}},defaultWorkLevel:{text:this.lp.defaultWorkLevel+":",name:"defaultWorkLevel",type:"select",selectValue:this.lp.defaultWorkTypeValue,notEmpty:true,style:{width:"200px",height:"30px",color:"#999999","border-radius":"1px","box-shadow":"0px 0px 1px #CCC"}},reportAuditLeader:{text:this.lp.reportAuditLeader+":",name:"reportAuditLeaderIdentityList",type:"org",orgType:"identity",attr:{readonly:true},notEmpty:false,count:0,value:this.reportAuditLeaderList?this.reportAuditLeaderList.join(","):"",style:{width:"400px"}},workCompletedLimit:{text:this.lp.workCompletedLimit+":",name:"defaultCompleteDateLimitStr",type:"text",tType:"date",attr:{readonly:true},notEmpty:true},centerWorkMemo:{text:this.lp.centerWorkMemo+":",name:"description",type:"textarea"}}},this.app);n.load()},createImportContent:function(){if(this.centerWorkData&&this.centerWorkData.operation){if(this.centerWorkData.operation.indexOf("IMPORTWORK")>-1){this.importDiv=new Element("div.importDiv",{styles:this.css.importDiv}).inject(this.formTableArea);this.importTemplateDiv=new Element("div.importTemplateDiv",{styles:this.css.importTemplateDiv,text:this.lp.importTemplate}).inject(this.importDiv);this.importTemplateDiv.addEvents({click:function(){window.open("/x_component_Execution/baseWork.xls")}.bind(this)});this.importTitleDiv=new Element("div.importTitleDiv",{styles:this.css.importTitleDiv,text:this.lp.importTemplateTitle}).inject(this.importDiv)}}},createMyWorkList:function(){if(this.myWorkContentArea)this.myWorkContentArea.destroy();var t=this.myWorkContentArea=new Element("div.workContentArea",{styles:this.css.workContentArea}).inject(this.formTableArea);var e=new Element("div",{styles:this.css.workContentTitleNode,text:this.lp.myWorkInfor}).inject(t);workContentNode=new Element("div",{styles:this.css.workContentNode}).inject(t);var i=this.myWorkView=new MWF.xApplication.Execution.WorkDeploy.MyWorkView(workContentNode,this.app,this,{templateUrl:this.path+"myWork.json"});i.load()},creataMyDeployWorkList:function(){var t=this.myDeployWorkArea=new Element("div.myDeployWorkArea",{styles:this.css.workContentArea}).inject(this.formTableArea);var e=new Element("div.myDeployWorkTitleNode",{styles:this.css.workContentTitleNode,text:this.lp.deployWorkInfor}).inject(t);var i=this.myDeployWorkView=new MWF.xApplication.Execution.WorkDeploy.MyDeployWorkView(t,this.app,this,{templateUrl:this.path+"myDeployWork.json"});i.load()},_createBottomContent:function(){if(this.formBottomNode)this.formBottomNode.empty();if(this.centerWorkData&&this.centerWorkData.operation){this.centerWorkData.operation.each(function(t,e){if(t=="CLOSE"){this.closeBotton=new Element("div.closeBotton",{styles:this.css.formActionNode,text:this.lp.botton.close}).inject(this.formBottomNode);this.closeBotton.addEvent("click",function(t){this.closeWork(t)}.bind(this))}else if(t=="CREATEWORK"){this.newBotton=new Element("div.newBotton",{styles:this.css.formActionNode,text:this.lp.botton.new}).inject(this.formBottomNode);this.newBotton.addEvent("click",function(t){this.createWork(t)}.bind(this))}else if(t=="IMPORTWORK"){this.importBotton=new Element("div.importBotton",{styles:this.css.formActionNode,text:this.lp.botton.import}).inject(this.formBottomNode);this.importBotton.addEvent("click",function(t){this.importWork(t)}.bind(this))}else if(t=="DELETE"){this.deleteBotton=new Element("div.deleteBotton",{styles:this.css.formActionNode,text:this.lp.botton.delete}).inject(this.formBottomNode);this.deleteBotton.addEvent("click",function(t){this.deleteWork(t)}.bind(this))}else if(t=="DEPLOY"){this.deployBotton=new Element("div.deployBotton",{styles:this.css.formActionNode,text:this.lp.botton.deploy}).inject(this.formBottomNode);this.deployBotton.addEvent("click",function(t){this.deployWork(t)}.bind(this))}else if(t=="ARCHIVE"){this.archiveBotton=new Element("div.archiveBotton",{styles:this.css.formActionNode,text:this.lp.botton.archive}).inject(this.formBottomNode);this.archiveBotton.addEvent("click",function(t){this.archiveWork(t)}.bind(this))}if(t=="CONFIRM"){this.confirmBotton=new Element("div.confirmBotton",{styles:this.css.formActionNode,text:this.lp.botton.confirm}).inject(this.formBottomNode);this.confirmBotton.addEvent("click",function(t){this.confirmWork(t)}.bind(this))}}.bind(this))}},closeWork:function(t){this.close();this.fireEvent("reloadView",{action:"reload"})},createWork:function(){var t=this.centerForm.getResult(true,",",true,false,true);if(!t){return}if(this.options.isNew||this.options.isEdited){this.saveCenterWork(t,function(t){if(t.type&&t.type=="error"){this.app.notice(t.message,"error")}else{if(t.data&&t.data.id)this.reloadTableContent(t.data.id);if(this.centerWorkData)this.openWorkForm(this.centerWorkData)}}.bind(this))}else{if(this.centerWorkData)this.openWorkForm(this.centerWorkData)}},importWork:function(){var t;var e=this.centerForm.getResult(true,",",true,false,true);if(!e){return false}if(this.options.isNew||this.options.isEdited){this.saveCenterWork(e,function(e){if(e.type&&e.type=="error"){this.app.notice(e.message,"error")}else{if(this.centerWorkData){t=this.centerWorkData.id;this.createUpload(t);this.reloadTableContent(t)}}}.bind(this))}else{if(this.centerWorkData)t=this.centerWorkData.id;this.createUpload(t)}},createUpload:function(t){if(t){if(this.uploadFileAreaNode)this.uploadFileAreaNode.destroy();this.uploadFileAreaNode=new Element("div");var e='<input name="file" type="file" />';this.uploadFileAreaNode.set("html",e);this.fileUploadNode=this.uploadFileAreaNode.getFirst();this.fileUploadNode.addEvent("change",function(){var e=i.files;if(e.length){for(var o=0;o<e.length;o++){var n=e.item(o);var s=n.name.split(".");this.uploadFileName=n.name;if(s[s.length-1].toLowerCase()!="xls"&&s[s.length-1].toLowerCase()!="xlsx"){this.app.notice("请导入excel文件！","error");return}var r=new FormData;r.append("file",n);this.app.createShade(null,"正在导入，请稍后.....");this.actions.importBaseWork(t,function(e){this.reloadTableContent(t);this.app.destroyShade()}.bind(this),function(t,e,i){this.showErrorMessage(t,e,i);this.app.destroyShade()}.bind(this),r,n)}}}.bind(this));var i=this.uploadFileAreaNode.getFirst();debugger;i.click()}},deleteWork:function(t){var e=this;e.app.confirm("warn",t,e.lp.submitWarn.warnTitle,e.lp.submitWarn.warnContent,300,120,function(){e.app.createShade();e.actions.deleteCenterWork(e.centerWorkData.id,function(t){if(t.type&&t.type=="success"){e.app.notice(this.lp.prompt.deleteCenterWork,"success");e.closeWork({action:"reload"})}e.app.destroyShade()}.bind(e),function(t,i,o){e.showErrorMessage(t,i,o);e.app.destroyShade()}.bind(e));this.close()},function(){this.close()})},deployWork:function(t){var e=this;e.app.confirm("warn",t,e.lp.submitWarn.warnTitle,e.lp.submitWarn.warnDeployContent,300,120,function(){e.app.createShade();e.actions.deployCenterWork(e.centerWorkData.id,function(t){if(t.type&&t.type=="success"){e.app.notice(this.lp.prompt.deployCenterWork,"success");e.close();e.fireEvent("reloadView",{action:"reload"});e.app.destroyShade()}}.bind(e),function(t,i,o){e.showErrorMessage(t,i,o);e.app.destroyShade()}.bind(e));this.close()},function(){this.close()})},confirmWork:function(t){var e=this;e.app.confirm("warn",t,e.lp.submitWarn.warnTitle,e.lp.submitWarn.warnConfirmContent,300,120,function(){e.actions.deployCenterWork(e.centerWorkData.id,function(t){e.app.createShade();if(t.type&&t.type=="success"){e.app.notice(this.lp.prompt.comfirmCenterWork,"success");e.close();e.fireEvent("reloadView",{action:"reload"});e.app.destroyShade()}}.bind(e),function(t,i,o){e.showErrorMessage(t,i,o);e.app.destroyShade()}.bind(e));this.close()},function(){this.close()})},archiveWork:function(t){var e=this;e.app.confirm("warn",t,e.lp.submitWarn.warnTitle,e.lp.submitWarn.warnArchiveContent,300,120,function(){e.app.createShade();e.actions.archiveMainTask(e.centerWorkData.id,function(t){if(t.type&&t.type=="success"){e.app.notice(this.lp.prompt.archiveCenterWork,"success");e.close();e.fireEvent("reloadView",{action:"reload"});e.app.destroyShade()}}.bind(e),function(t,i,o){e.showErrorMessage(t,i,o);e.app.destroyShade()}.bind(e));this.close()},function(){this.close()})},saveCenterWork:function(t,e){if(t.reportAuditLeaderIdentityList==""){t.reportAuditLeaderIdentityList=[]}else{t.reportAuditLeaderIdentityList=t.reportAuditLeaderIdentityList.split(",")}this.app.restActions.saveCenterWork(t,function(t){if(e)e(t)}.bind(this),function(t,e,i){this.showErrorMessage(t,e,i)}.bind(this),false)},openWorkForm:function(t){MWF.xDesktop.requireApp("Execution","WorkForm",function(){this.workform=new MWF.xApplication.Execution.WorkForm(this,this.app.restActions,{centerWorkId:t.id||this.options.centerWorkId,centerWorkTitle:t.title},{isNew:true,isEdited:false,actionStatus:"save",onPostSave:function(){this.reloadTableContent()}.bind(this)});this.workform.load()}.bind(this))},showErrorMessage:function(t,e,i){var o=i;if(t)errorMessage=t.responseText;if(errorMessage!=""){var n=JSON.parse(errorMessage);if(n.message){this.app.notice(n.message,"error")}else{this.app.notice(o,"error")}}else{this.app.notice(o,"error")}}});MWF.xApplication.Execution.WorkDeploy.MyDeployWorkView=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexView,_createDocument:function(t){return new MWF.xApplication.Execution.WorkDeploy.MyDeployWorkDocument(this.viewNode,t,this.explorer,this)},_getCurrentPageData:function(t,e){if(!this.explorer.centerWorkId)return;this.actions.getMyDeployWork(this.explorer.centerWorkId,function(e){if(e.data.length==0){this.explorer.myDeployWorkArea.destroy()}if(t)t(e)}.bind(this),function(t,e,i){this.explorer.showErrorMessage(t,e,i)}.bind(this),false)},_queryCreateViewNode:function(){},_postCreateViewNode:function(t){},_queryCreateViewHead:function(){},_postCreateViewHead:function(t){}});MWF.xApplication.Execution.WorkDeploy.MyDeployWorkDocument=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexDocument,_queryCreateDocumentNode:function(t){},_postCreateDocumentNode:function(t,e){var i=t.getElements("td")[0];t.empty();var o=new Element("td",{colspan:this.view.template.items.length,style:i.get("style"),html:i.get("html")}).inject(t);if(e.subWorks){e.subWorks.each(function(t,e){var i=new Element("tr.subTrNode",{styles:this.css.subTrNode}).inject(this.view.viewNode);i.addEvents({click:function(){this.action_view(t.id)}.bind(this),mouseover:function(){i.setStyles(this.css["documentNode_over"])}.bind(this),mouseout:function(){i.setStyles(this.css.subTrNode)}.bind(this)});this.view.template.items.each(function(t,e){var o=t.content.html;i.set("html",i.get("html")+o)}.bind(this));this.setLables(i,t);this.setValues(i,t);this.setStyles(i,t);this.setActions(i,t)}.bind(this))}},setLables:function(t,e){t.getElements("[lable]").each(function(t){var e=t.get("lable");if(e&&this.lp[e]){t.set("text",this.lp[e])}}.bind(this))},setValues:function(t,e){t.getElements("[item]").each(function(t){var o=t.get("item");if(e[o]){if(o=="responsibilityUnitName"||o=="deployerUnitName"||o=="responsibilityEmployeeName"||o=="deployerName"){if(e[o]!=""){if(e[o].indexOf(",")>0){var n=e[o];var s=n.split(",");var r="";for(i=0;i<s.length;i++){if(r=="")r=s[i].split("@")[0];else r=r+","+s[i].split("@")[0]}e[o]=r}else{e[o]=e[o].split("@")[0]}}}if(o=="cooperateUnitNameList"||o=="cooperateEmployeeNameList"){var r="";for(i=0;i<e[o].length;i++){if(r=="")r=e[o][i].split("@")[0];else r=r+","+e[o][i].split("@")[0]}e[o]=r}t.set("text",e[o].length>70?e[o].substr(0,70)+"...":e[o])}}.bind(this));t.getElements("[title]").each(function(t){var i=t.get("title");if(e[i]){t.set("title",e[i])}}.bind(this))},setStyles:function(t,e){var i=t.getElements("td[actionTd='yes']");if(!i)return;t.getElements("[styles]").each(function(t){var e=t.get("styles");if(e&&this.css[e]){t.setStyles(this.css[e])}}.bind(this));t.getElements("[subStyles]").each(function(t){var e=t.get("subStyles");if(e&&this.css[e]){t.setStyles(this.css[e])}}.bind(this))},setActions:function(t,e){var i=t.getElement("td[actionTd='yes']");if(!i)return;if(e.operation){e.operation.each(function(t,o){var n=new Element("span.actionSpan",{styles:this.css.documentActionNode}).inject(i);if(e.operation.length==1){if(t=="VIEW"){n.set("text",this.lp.action_view);n.addEvent("click",function(t){this.action_view(e.id);return false}.bind(this))}}if(t=="EDIT"){n.set("text",this.lp.action_edit);n.addEvent("click",function(t){this.action_edit(e.id);return false}.bind(this))}else if(t=="DELETE"){n.set("text",this.lp.action_delete);n.addEvent("click",function(t){this.action_delete(e.id,t);return false}.bind(this))}else if(t=="ARCHIVE"){n.set("text",this.lp.action_archive);n.addEvent("click",function(t){this.action_archive(e.id,t);return false}.bind(this))}}.bind(this))}},action_view:function(t){this.workform=new MWF.xApplication.Execution.WorkForm(this,this.app.restActions,{id:t},{isNew:false,isEdited:false,actionStatus:"save",onPostSave:function(){this.explorer.contentChanged=true}.bind(this)});this.workform.load()},action_edit:function(t){this.workform=new MWF.xApplication.Execution.WorkForm(this,this.app.restActions,{id:t},{isNew:false,isEdited:true,actionStatus:"save",onPostSave:function(){this.explorer.reloadTableContent()}.bind(this)});this.workform.load()},action_delete:function(t,e){var i=this;i.view.app.confirm("warn",e,i.view.app.lp.WorkDeploy.submitWarn.warnTitle,i.view.app.lp.WorkDeploy.submitWarn.warnContent,300,120,function(){i.app.createShade();i.actions.deleteBaseWork(t,function(t){if(t.type&&t.type=="success"){this.app.notice(i.view.explorer.lp.prompt.deleteBaseWork,"success");i.view.explorer.reloadTableContent();i.app.destroyShade()}}.bind(i),function(t,e,o){i.view.explorer.showErrorMessage(t,e,o);i.app.destroyShade()}.bind(i));this.close()},function(){this.close()})},action_archive:function(t,e){var i=this;i.view.app.confirm("warn",e,i.view.app.lp.WorkDeploy.submitWarn.warnTitle,i.view.app.lp.WorkDeploy.submitWarn.warnArchiveContent,300,120,function(){i.app.createShade();i.actions.archiveBaseWork(t,function(t){if(t.type&&t.type=="success"){this.app.notice(i.view.explorer.lp.prompt.archiveBaseWork,"success");i.view.explorer.reloadTableContent();i.app.destroyShade()}}.bind(i),function(t,e,o){i.view.explorer.showErrorMessage(t,e,o);i.app.destroyShade()}.bind(i));this.close()},function(){this.close()})}});MWF.xApplication.Execution.WorkDeploy.MyWorkView=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexView,_createDocument:function(t){return new MWF.xApplication.Execution.WorkDeploy.MyWorkDocument(this.viewNode,t,this.explorer,this)},_getCurrentPageData:function(t,e){if(this.explorer.centerWorkId){this.actions.getMyRelativeWork(this.explorer.centerWorkId,function(e){if(e.data.length==0){this.explorer.myWorkContentArea.destroy()}if(t)t(e)}.bind(this),null,false)}},_openDocument:function(t){this.workForm=new MWF.xApplication.Execution.WorkForm(this,this.actions,t,{isNew:false,isEdited:false});this.workForm.load()},_queryCreateViewNode:function(){},_postCreateViewNode:function(t){},_queryCreateViewHead:function(){},_postCreateViewHead:function(t){}});MWF.xApplication.Execution.WorkDeploy.MyWorkDocument=new Class({Extends:MWF.xApplication.Template.Explorer.ComplexDocument,viewActionReturn:function(t){var e=false;if(t.operation&&t.operation.length==1){e=true}return e},splitActionReturn:function(t){var e=false;if(t.operation&&t.operation.indexOf("SPLIT")>-1)e=true;return e},authorizeActionReturn:function(t){var e=false;if(t.operation&&t.operation.indexOf("AUTHORIZE")>-1)e=true;return e},tackBackActionReturn:function(t){var e=false;if(t.operation&&t.operation.indexOf("TACKBACK")>-1)e=true;return e},archiveActionReturn:function(t){var e=false;if(t.operation&&t.operation.indexOf("ARCHIVE")>-1)e=true;return e},action_view:function(){MWF.xDesktop.requireApp("Execution","WorkForm",function(){var t=new MWF.xApplication.Execution.WorkForm(this,this.app.restActions,this.data,{isNew:false,isEdited:false});t.load()}.bind(this))},action_split:function(){MWF.xDesktop.requireApp("Execution","WorkForm",function(){var t={title:this.data.title,centerId:this.data.centerId,centerWorkTitle:this.data.centerTitle,parentWorkId:this.data.id,workType:this.data.workType,workLevel:this.data.workLevel,completeDateLimitStr:this.data.completeDateLimitStr,completeDateLimit:this.data.completeDateLimit,reportCycle:this.data.reportCycle,reportDayInCycle:this.data.reportDayInCycle};if(this.data.id){this.actions.getBaseWorkDetails(this.data.id,function(e){t.workSplitAndDescription=e.data.workDetail}.bind(this),null,false)}var e=new MWF.xApplication.Execution.WorkForm(this,this.app.restActions,{centerWorkTitle:this.data.centerTitle},{isNew:true,isEdited:false,parentWorkId:this.data.id,actionStatus:"save",onPostSave:function(){this.explorer.reloadTableContent()}.bind(this)});e.load()}.bind(this))},action_authorize:function(){var t={workId:this.data.id};var e=new MWF.xApplication.Execution.WorkDeploy.Appoint(this.view.app,this.view.app.restActions,t,this.view.css,{ieEdited:true,onReloadView:function(t){this.explorer.reloadTableContent()}.bind(this)});e.load()},action_tackBack:function(t){var e=this;e.app.confirm("warn",t,e.lp.submitWarn.warnTitle,e.lp.submitWarn.warnTackBackContent,300,120,function(){e.actions.unAppointBaseWork({workId:e.data.id},function(t){if(t.type&&t.type=="success"){e.app.notice(e.explorer.lp.prompt.tackbackBaseWork,"success");e.explorer.reloadTableContent()}}.bind(e),function(t,i,o){e.explorer.showErrorMessage(t,i,o)}.bind(e));this.close()},function(){this.close()})},action_archive:function(t){var e=this;e.view.app.confirm("warn",t,e.view.app.lp.WorkDeploy.submitWarn.warnTitle,e.view.app.lp.WorkDeploy.submitWarn.warnArchiveContent,300,120,function(){e.app.createShade();e.actions.archiveBaseWork(e.data.id,function(t){if(t.type&&t.type=="success"){this.app.notice(e.view.explorer.lp.prompt.archiveBaseWork,"success");e.view.explorer.reloadTableContent();e.app.destroyShade()}}.bind(e),function(t,i,o){e.view.explorer.showErrorMessage(t,i,o);e.app.destroyShade()}.bind(e));this.close()},function(){this.close()})},_queryCreateDocumentNode:function(t){},_postCreateDocumentNode:function(t,e){if(t.getElements("div[item='workDetail']").length>0){if(e.hasSubWorks){t.getElements("div[item='workDetail']").setStyle("color","#ec6a1a")}}if(t.getElements("div[name='appointDiv']")){if(e.workProcessIdentity&&e.workProcessIdentity.indexOf("AUTHORIZE")>-1){t.getElements("div[name='appointDiv']").setStyle("display","")}}if(t.getElements("div[styles='documentSubject']")){t.getElements("div[styles='documentSubject']").set("title",e.workDetail)}}});MWF.xApplication.Execution.WorkDeploy.Appoint=new Class({Extends:MPopupForm,Implements:[Options,Events],options:{style:"default",width:"500",height:"300",hasTop:true,hasIcon:false,hasBottom:true,title:"",draggable:false,closeAction:true,closeText:"",needLogout:false,isNew:true},initialize:function(t,e,i,o,n){this.setOptions(n);this.app=t;this.actions=this.app.restActions;this.css=o;this.data=i||{};this.actions=e},load:function(){this.create()},createTopNode:function(){if(!this.formTopNode){this.formTopNode=new Element("div.formTopNode",{styles:this.css.formTopNode}).inject(this.formNode);this.formTopIconNode=new Element("div.formTopIconNode",{styles:this.css.formTopIconNode}).inject(this.formTopNode);this.formTopTextNode=new Element("div.formTopTextNode",{styles:this.css.formTopTextNode,text:this.app.lp.workTask.appoint.appointTitle}).inject(this.formTopNode);if(this.options.closeAction){this.formTopCloseActionNode=new Element("div.formTopCloseActionNode",{styles:this.css.formTopCloseActionNode}).inject(this.formTopNode);this.formTopCloseActionNode.addEvent("click",function(){this.close()}.bind(this))}this.formTopContentNode=new Element("div.formTopContentNode",{styles:this.css.formTopContentNode}).inject(this.formTopNode)}},_createTableContent:function(){var t=new Element("table",{width:"100%",border:"0",cellpadding:"5",cellspacing:"0"}).inject(this.formTableArea);t.setStyles({"margin-top":"40px"});var e=new Element("tr").inject(t);var i=new Element("td",{text:this.app.lp.workTask.appoint.appointFor,valign:"middle",width:"20%"}).inject(e);i=new Element("td",{width:"80%"}).inject(e);this.appointPerson=new MDomItem(i,{name:"appointPerson",type:"org",orgType:"identity",notEmpty:true,style:{width:"90%",height:"25px",border:"1px solid #666"}},true,this.app);this.appointPerson.load();e=new Element("tr").inject(t);i=new Element("td",{text:this.app.lp.workTask.appoint.appointOpinion,valign:"middle"}).inject(e);i=new Element("td").inject(e);this.appointOpinion=new Element("textarea").inject(i);this.appointOpinion.setStyles({width:"90%",height:"50px"})},_createBottomContent:function(){this.cancelActionNode=new Element("div.formCancelActionNode",{styles:this.css.formCancelActionNode,text:this.app.lp.workTask.appoint.appointCancel}).inject(this.formBottomNode);this.cancelActionNode.addEvent("click",function(t){this.close()}.bind(this));this.okActionNode=new Element("div.formOkActionNode",{styles:this.css.formOkActionNode,text:this.app.lp.workTask.appoint.appointOK}).inject(this.formBottomNode);this.okActionNode.addEvent("click",function(t){this.ok(t)}.bind(this))},ok:function(){if(this.appointPerson.getValue()==""){this.app.notice(this.app.lp.workTask.appoint.personEmpty,"error");return false}if(this.appointOpinion.get("value")==""){this.app.notice(this.app.lp.workTask.appoint.opinionEmpty,"error");return false}var t={workId:this.data.workId,undertakerIdentity:this.appointPerson.getValue(","),authorizeOpinion:this.appointOpinion.get("value")};this.actions.appointBaseWork(t,function(t){this.app.notice(this.app.lp.WorkDeploy.prompt.authorizeBaseWork,"success");this.close();this.fireEvent("reloadView")}.bind(this),function(t,e,i){var o=i;if(t)errorMessage=t.responseText;var n=JSON.parse(errorMessage);if(n.message){this.app.notice(n.message,"error")}else{this.app.notice(o,"error")}}.bind(this),false)},selectPerson:function(t,e,i){MWF.xDesktop.requireApp("Selector","package",null,false);this.fireEvent("querySelect",this);var o=t.get("value").split(this.valSeparator);var n={type:e,title:this.app.lp.workTask.appoint.appointTitle,count:i,values:o||[],onComplete:function(e){var i=[];e.each(function(t){i.push(t.data.distinguishedName)}.bind(this));t.set("value",i.join(","))}.bind(this)};var s=new MWF.O2Selector(this.app.content,n)}});